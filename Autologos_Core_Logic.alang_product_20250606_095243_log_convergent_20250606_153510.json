[
  {
    "iteration": 0,
    "productSummary": "--- START FILE: Autologos_Core_Logic.alang_product_20250606_095243_product_expansive_20250606_152...",
    "status": "Initial state",
    "timestamp": "3:29:09 PM",
    "fullProduct": "--- START FILE: Autologos_Core_Logic.alang_product_20250606_095243_product_expansive_20250606_152725.md ---\n---\ngeneration_timestamp: 2025-06-06T09:42:25.961Z\nprocessing_mode: expansive\ninitial_prompt_summary: \"--- START FILE: Autologos_Core_Logic.alang_product_20250606_095243_product_expansive_20250606_120838.md ---\n---\ngeneration_timestamp: 2025-06-06T06...\"\nfinal_iteration_count: 2\nmax_iterations_setting: 3\nmodel_configuration:\n  model_name: 'gemini-2.5-flash-preview-04-17'\n  temperature: 0.52\n  top_p: 1.00\n  top_k: 56\nprompt_source_name: Autologos_Core_Logic.alang_product_20250606_095243_product_expansive_20250606_120838.md\n---\n\n```\n--- START FILE: Autologos_Core_Logic_v1.12.alang ---\n;; Autologos_Core_Logic.alang v1.12\n;; Specification Version: ALANG_SPEC_V1.0\n;; Core Logic Version: ALANG_CORE_LOGIC_V1.12\n;; This file defines the core behavior of the Autologos system using the ALang language.\n;; This version aims to be a \"production-ready\" design, with all identified issues fixed and placeholders replaced by detailed ALang logic.\n;; v1.12 Expansions:\n;; - Significantly detailed the state machine logic within the `ExecuteSystemQAAndEvolutionCycle` procedure (Section 3), specifying transitions and handling for backlog selection, QA execution, version proposal, and finalization, including handling pauses for user input.\n;; - Added conceptual detail to the `SelectAIProposedBacklogItems` procedure, outlining the process of analyzing backlog and conceptual model to propose QA focus.\n;; - Refined the `UpdateBacklogAfterQA` procedure to conceptually mark items as 'ADDRESSED'.\n;; - Ensured all calls within the System QA cycle explicitly pass the session conceptual model handle and selected backlog items where relevant.\n;; - Added new ALANG_STATUS_ codes for specific System QA cycle states and failures.\n;; - **NEW in v1.12:** Provided detailed conceptual description of the Session Conceptual Model's structure and the management of Φ-related properties (confidence, source fidelity, Φ contribution) within the conceptual primitives, clarifying how information is integrated and evaluated.\n\n;; --- Section 0: System Config & Metadata ---\n;; This section defines system-wide configuration parameters and metadata.\n\n(DEFINE_PRIMITIVE GET_ALANG_SPEC_VERSION ()\n    ; Orchestrator: Returns the version of the ALang specification that this code adheres to.\n    ; Returns: String (e.g., \"ALANG_SPEC_V1.0\")\n)\n\n(DEFINE_PRIMITIVE GET_CORE_LOGIC_VERSION ()\n    ; Orchestrator: Returns the version of this Autologos core logic.\n    ; Returns: String (e.g., \"ALANG_CORE_LOGIC_V1.12\") ; Updated version\n)\n\n(DEFINE_PRIMITIVE GET_ORCHESTRATOR_TIMESTAMP ()\n    ; Orchestrator: Returns an ISO 8601 timestamp string from the orchestrator's environment, using tool_code.\n    ; The accuracy and trustworthiness of this timestamp are dependent on the orchestrator's implementation and its access to a synchronized system clock.\n    ; If a trusted timestamp cannot be provided, this primitive MUST return NIL or an ALANG_STATUS_TIMESTAMP_UNAVAILABLE.\n    ; Returns: String (ISO 8601 timestamp) or NIL.\n)\n\n(SET_STATE sys.alang_spec_version (GET_ALANG_SPEC_VERSION))\n(SET_STATE sys.alang_core_logic_version (GET_CORE_LOGIC_VERSION))\n(SET_STATE sys.current_mode \"IDLE\") ; Initial system state\n(SET_STATE sys.error_level \"NONE\") ; No errors initially\n(SET_STATE sys.error_message NIL) ; No error message\n(SET_STATE sys.evolution_backlog_handle \"Autologos/Evolution_Backlog.json\") ; Path to structured backlog\n(SET_STATE sys.knowledge_base_handle \"Autologos/Persistent_Knowledge_Base.json\") ; Path to structured PKA store\n(SET_STATE sys.evolution_trigger_pending FALSE) ; Flag for System QA cycle (Section 3)\n(SET_STATE sys.system_qa_status \"IDLE\") ; Status of the last System QA cycle (NEW)\n(SET_STATE session.qa_output_verbosity \"CONCISE\") ; Default QA reporting verbosity (Principle 4.A Cmd 10)\n(SET_STATE session.output_detail \"STANDARD\") ; Default general output detail (Principle 4.A Cmd 14)\n(SET_STATE session.loop_stack (LIST_CREATE)) ; Stack for managing nested loops (Section 2.A)\n(SET_STATE session.conceptual_model_handle NIL) ; Handle to the session-specific conceptual model (Principle 0.V.6)\n(SET_STATE session.pending_user_action_details NIL) ; Context for pending user actions (NEW)\n(SET_STATE session.last_search_results NIL) ; Store results for BROWSE command (moved from utility)\n(SET_STATE session.system_qa_context NIL) ; Context for System QA cycle state management (NEW)\n(SET_STATE sys.proposed_changes_handle NIL) ; Handle for pending Core Logic changes (NEW)\n\n\n;; --- External Component Dependencies ---\n;; This section lists the symbolic names of external prompt templates and constraint sets\n;; that are referenced by this ALang code. Their content must be managed by the orchestrator.\n\n;; Prompt Templates (used with SAFE_GENERATE_CONTENT or INVOKE_CORE_LLM_GENERATION)\n(DEFINE_SYMBOL PROMPT_TEMPLATE_GENERATE_PATTERN_IDEAS \"prompt_generate_pattern_ideas.txt\")\n(DEFINE_SYMBOL PROMPT_TEMPLATE_PRODUCT_DEFINITION \"prompt_product_definition.txt\")\n(DEFINE_SYMBOL PROMPT_TEMPLATE_GENERATE_TASK_LIST \"prompt_generate_task_list.txt\")\n(DEFINE_SYMBOL PROMPT_TEMPLATE_EXECUTE_TASK \"prompt_execute_task.txt\")\n(DEFINE_SYMBOL PROMPT_TEMPLATE_COMPILE_DRAFT \"prompt_compile_draft.txt\")\n(DEFINE_SYMBOL PROMPT_TEMPLATE_PROJECT_SUMMARY \"prompt_project_summary.txt\")\n(DEFINE_SYMBOL PROMPT_TEMPLATE_QA_SELF_CRITIQUE \"prompt_qa_self_critique.txt\")\n(DEFINE_SYMBOL PROMPT_TEMPLATE_QA_DIVERGENT_EXPLORATION \"prompt_qa_divergent_exploration.txt\")\n(DEFINE_SYMBOL PROMPT_TEMPLATE_QA_RED_TEAMING \"prompt_qa_red_teaming.txt\")\n(DEFINE_SYMBOL PROMPT_TEMPLATE_QA_EXTERNAL_REVIEW \"prompt_qa_external_review.txt\")\n(DEFINE_SYMBOL PROMPT_TEMPLATE_IDENTIFY_PATTERNS \"prompt_identify_patterns.txt\")\n(DEFINE_SYMBOL PROMPT_TEMPLATE_GENERATE_TITLE \"prompt_generate_title.txt\")\n(DEFINE_SYMBOL PROMPT_TEMPLATE_PARSE_COMMAND \"prompt_parse_command.txt\")\n(DEFINE_SYMBOL PROMPT_TEMPLATE_SUMMARIZE_ARTIFACT \"prompt_summarize_artifact.txt\")\n(DEFINE_SYMBOL PROMPT_TEMPLATE_PERFORM_QUERY \"prompt_perform_query.txt\")\n(DEFINE_SYMBOL PROMPT_TEMPLATE_SERIALIZE_ALANG_CORE \"prompt_serialize_alang_core.txt\") ; For HandleSaveSystemCommand\n(DEFINE_SYMBOL PROMPT_TEMPLATE_META_COGNITIVE_QA \"prompt_meta_cognitive_qa.txt\") ; Added for 6.A\n(DEFINE_SYMBOL PROMPT_TEMPLATE_SELF_CORRECTION \"prompt_self_correction.txt\") ; Added for HandleQAIssues/SelfCorrectArtifact\n(DEFINE_SYMBOL PROMPT_TEMPLATE_ENHANCE_PROMPT \"prompt_enhance_prompt.txt\") ; Added for EnhancePromptWithPatterns\n(DEFINE_SYMBOL PROMPT_TEMPLATE_ANALYZE_FOR_CONCEPTUAL_MODEL \"prompt_analyze_for_conceptual_model.txt\") ; Added for Process*ConceptualModel\n(DEFINE_SYMBOL PROMPT_TEMPLATE_PKA_CONSENT \"prompt_pka_consent.txt\") ; Added for PKA consent primitive\n(DEFINE_SYMBOL PROMPT_TEMPLATE_ANALYZE_BACKLOG_FOR_FOCUS \"prompt_analyze_backlog_for_focus.txt\") ; Added for SelectAIProposedBacklogItems (NEW)\n(DEFINE_SYMBOL PROMPT_TEMPLATE_ANALYZE_QA_FOR_DIRECTIVE_CHANGES \"prompt_analyze_qa_for_directive_changes.txt\") ; Added for ProposeDirectiveChanges (NEW)\n(DEFINE_SYMBOL PROMPT_TEMPLATE_ANALYZE_DATA_FOR_PATTERNS \"prompt_analyze_data_for_patterns.txt\") ; Added for IdentifyPatternsInContext (NEW)\n(DEFINE_SYMBOL PROMPT_TEMPLATE_ANALYZE_QA_REPORT_FOR_REVISIONS \"prompt_analyze_qa_report_for_revisions.txt\") ; Added for ApplyRevisionsToArtifact (NEW)\n(DEFINE_SYMBOL PROMPT_TEMPLATE_ANALYZE_TOOL_ERROR \"prompt_analyze_tool_error.txt\") ; Added for HandleToolError analysis (NEW)\n(DEFINE_SYMBOL PROMPT_TEMPLATE_ANALYZE_FOR_CONCEPTUAL_MODEL_UPDATE \"prompt_analyze_for_conceptual_model_update.txt\") ; Specific template for conceptual model updates (NEW)\n(DEFINE_SYMBOL PROMPT_TEMPLATE_ANALYZE_FEEDBACK_FOR_REVISION \"prompt_analyze_feedback_for_revision.txt\") ; Specific template for user feedback based revision (NEW)\n(DEFINE_SYMBOL PROMPT_TEMPLATE_ANALYZE_TOOL_ERROR_USER_EXPLANATION \"prompt_analyze_tool_error_user_explanation.txt\") ; Specific template for user-friendly error explanation (NEW)\n(DEFINE_SYMBOL PROMPT_TEMPLATE_ANALYZE_TOOL_ERROR_RESOLUTION_INPUT \"prompt_analyze_tool_error_resolution_input.txt\") ; Specific template for parsing user input for tool error resolution (NEW)\n(DEFINE_SYMBOL PROMPT_TEMPLATE_SUMMARIZE_CONCEPTUAL_MODEL \"prompt_summarize_conceptual_model.txt\") ; Added for conceptual model summary (NEW)\n(DEFINE_SYMBOL PROMPT_TEMPLATE_ANALYZE_CONCEPTUAL_MODEL_FOR_PHI \"prompt_analyze_conceptual_model_for_phi.txt\") ; Added for Φ analysis (NEW)\n\n\n;; Constraint Sets (used with SAFE_GENERATE_CONTENT)\n(DEFINE_SYMBOL CONSTRAINT_SET_IDEA_GENERATION \"constraints_idea_generation.json\")\n(DEFINE_SYMBOL CONSTRAINT_SET_PRODUCT_DEFINITION \"constraints_product_definition.json\")\n(DEFINE_SYMBOL CONSTRAINT_SET_PLANNING \"constraints_planning.json\")\n(DEFINE_SYMBOL CONSTRAINT_SET_TASK_EXECUTION \"constraints_task_execution.json\")\n(DEFINE_SYMBOL CONSTRAINT_SET_FINAL_REVIEW \"constraints_final_review.json\")\n(DEFINE_SYMBOL CONSTRAINT_SET_SUMMARY \"constraints_summary.json\")\n(DEFINE_SYMBOL CONSTRAINT_SET_QA_CRITIQUE \"constraints_qa_critique.json\")\n(DEFINE_SYMBOL CONSTRAINT_SET_PATTERN_IDENTIFICATION \"constraints_pattern_identification.json\")\n(DEFINE_SYMBOL CONSTRAINT_SET_VALID_ALANG_SYNTAX \"constraints_valid_alang_syntax.json\") ; For HandleSaveSystemCommand\n(DEFINE_SYMBOL CONSTRAINT_SET_CONCEPTUAL_MODEL_STRUCTURE \"constraints_conceptual_model_structure.json\") ; Added for conceptual model validation\n(DEFINE_SYMBOL CONSTRAINT_SET_PKA_SCHEMA_REGISTRY \"constraints_pka_schema_registry.json\") ; Added for PKA schema validation\n(DEFINE_SYMBOL CONSTRAINT_SET_PROPOSED_CHANGES_STRUCTURE \"constraints_proposed_changes_structure.json\") ; Added for ProposeDirectiveChanges validation (NEW)\n(DEFINE_SYMBOL CONSTRAINT_SET_IDENTIFIED_PATTERNS_STRUCTURE \"constraints_identified_patterns_structure.json\") ; Added for IdentifyPatternsInContext validation (NEW)\n(DEFINE_SYMBOL CONSTRAINT_SET_REVISION_PLAN_STRUCTURE \"constraints_revision_plan_structure.json\") ; Added for ApplyRevisionsToArtifact validation (NEW)\n(DEFINE_SYMBOL CONSTRAINT_SET_TOOL_ERROR_ANALYSIS_STRUCTURE \"constraints_tool_error_analysis_structure.json\") ; Added for HandleToolError analysis validation (NEW)\n(DEFINE_SYMBOL CONSTRAINT_SET_CONCEPTUAL_MODEL_UPDATE_STRUCTURE \"constraints_conceptual_model_update_structure.json\") ; Specific constraints for conceptual model update data (NEW)\n(DEFINE_SYMBOL CONSTRAINT_SET_TOOL_ERROR_RESOLUTION_INPUT_STRUCTURE \"constraints_tool_error_resolution_input_structure.json\") ; Constraints for parsing user input for tool error resolution (NEW)\n(DEFINE_SYMBOL CONSTRAINT_SET_CONCEPTUAL_MODEL_SUMMARY_STRUCTURE \"constraints_conceptual_model_summary_structure.json\") ; Constraints for conceptual model summary output (NEW)\n(DEFINE_SYMBOL CONSTRAINT_SET_PHI_ANALYSIS_STRUCTURE \"constraints_phi_analysis_structure.json\") ; Constraints for Φ analysis output (NEW)\n\n\n;; --- Section 1: Utility Procedures & Primitives Declarations ---\n;; This section defines commonly used utility procedures and declares the signatures of all primitives.\n\n;; --- General Utilities ---\n(DEFINE_PROCEDURE AcknowledgeAndLog (log_event_type log_message user_ack_message_type user_ack_content)\n    ;; Acknowledges user intent and logs an event.\n    (LOG_EVENT log_event_type log_message)\n    (OUTPUT_TO_USER_BUFFER user_ack_message_type user_ack_content NIL) ; NIL for formatting hints\n    (FLUSH_USER_OUTPUT_BUFFER)\n    (RETURN_STATUS ALANG_STATUS_SUCCESS)\n)\n\n(DEFINE_PROCEDURE OutputGeneralHelp ()\n    ;; Provides general help information about Autologos commands.\n    (OUTPUT_TO_USER_BUFFER \"AI_PROVIDE_DATA\" \"Autologos Commands:\\nSTART (project_description)\\nOK\\nNO / REVISE (feedback)\\nINPUT (data)\\nSTATUS?\\nHELP? (command_name)\\nEND\\nEVOLVE (suggestion)\\nSAVE_SYSTEM\\nSAVE_PROJECT\\nOUTPUT (artifact_id)\\nSUMMARIZE (artifact_id)\\nQUERY (CONCEPT/DOCUMENT/RELATION/PKA)\\nOUTPUT_BACKLOG (optional: filename)\\nPROMOTE_TO_PKA (artifact_id, rationale, schema_id)\\nSEARCH_PKA (keywords, filters)\\nSET_SESSION_PREFERENCE (key=value ...)\\nSET QA_OUTPUT_VERBOSITY (CONCISE/VERBOSE)\\nSET OUTPUT_DETAIL (MINIMAL/STANDARD/EXHAUSTIVE)\\nLOOP (optional: description)\\nSTOP_LOOP\\nLOOP_PROJECT_RESTART\\nSYSTEM_QA\\n\\nFor specific help, type HELP? (command_name).\")\n    (RETURN_STATUS ALANG_STATUS_SUCCESS)\n)\n\n(DEFINE_PROCEDURE OutputSpecificHelp (commandName)\n    ;; Provides specific help for a given command.\n    (LET ((helpContent (GET_HELP_TEXT_FOR_COMMAND commandName)))\n        (IF (IS_NIL helpContent)\n            (SEQ\n                (SET_ERROR_STATE \"USER_ERROR\" (STRING_CONCAT \"No help found for command: \" commandName))\n                (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL)\n                (RETURN_STATUS ALANG_STATUS_NOT_FOUND)\n            )\n            (OUTPUT_TO_USER_BUFFER \"AI_PROVIDE_DATA\" helpContent NIL)\n        )\n    )\n    (RETURN_STATUS ALANG_STATUS_SUCCESS)\n)\n\n(DEFINE_PROCEDURE ClearTurnSpecificSessionState ()\n    ;; Clears session-specific state variables that should not persist across turns.\n    ;; Note: session.conceptual_model_handle, session.loop_stack, session.last_search_results, and session.system_qa_context persist.\n    (SET_STATE session.last_user_input_raw NIL)\n    (SET_STATE session.parsed_command_details NIL)\n    (SET_STATE session.pending_user_action NIL)\n    (SET_STATE session.pending_user_action_details NIL) ; Clear pending action details (NEW)\n    (SET_STATE session.active_tool_id NIL)\n    (SET_STATE session.tool_last_status NIL)\n    (SET_STATE session.tool_last_output_handle NIL)\n    (SET_STATE session.last_user_response NIL)\n    (SET_STATE session.last_user_feedback NIL)\n    (SET_STATE session.last_user_input_data NIL)\n    ; Do NOT clear session.conceptual_model_handle, session.loop_stack, session.last_search_results, session.system_qa_context here.\n    (RETURN_STATUS ALANG_STATUS_SUCCESS)\n)\n\n(DEFINE_PROCEDURE ParseKeyValueArgs (argsList)\n    ;; Parses a list of \"KEY=VALUE\" strings into a map.\n    (LET ((resultMap (MAP_CREATE)))\n        (LOOP_FOR_EACH argString argsList\n            (LET ((parts (STRING_SPLIT argString \"=\")))\n                (IF (EQ (LIST_GET_LENGTH parts) 2)\n                    (SET_STATE resultMap (MAP_SET_VALUE resultMap (LIST_GET_ITEM parts 0) (LIST_GET_ITEM parts 1)))\n                    (LOG_EVENT \"WARNING\" (STRING_CONCAT \"Skipping malformed key-value arg: \" argString))\n                )\n            )\n        )\n        (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_SUCCESS) (\"data\" resultMap)))\n    )\n)\n\n(DEFINE_PROCEDURE SummarizeArtifact (artifactHandle session_model_handle)\n    ;; Summarizes the content of a given artifact using LLM, leveraging the session conceptual model for context.\n    (LET ((artifactContentResult (READ_CONTENT artifactHandle \"text_summary_or_full\" NIL)))\n        (IF (NEQ (GET_STATUS artifactContentResult) ALANG_STATUS_SUCCESS) ; Check READ_CONTENT status first\n            (SEQ\n                (SET_ERROR_STATE \"DATA_ERROR\" \"Failed to read artifact content for summarization.\")\n                (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_FAILURE_GENERAL) (\"data\" NIL)))\n            )\n            (LET ((artifactContent (GET_DATA artifactContentResult))) ; Only bind if read succeeded\n                (IF (IS_NIL artifactContent) ; Now check if content itself is NIL (e.g., empty file)\n                    (SEQ\n                        (SET_ERROR_STATE \"DATA_ERROR\" \"Artifact content is empty or unreadable for summarization.\")\n                        (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_FAILURE_GENERAL) (\"data\" NIL)))\n                    )\n                    ; Content is not NIL, proceed to summarization\n                    (LET ((summaryResult (INVOKE_CORE_LLM_GENERATION\n                                            (MAP_CREATE (\"template\" PROMPT_TEMPLATE_SUMMARIZE_ARTIFACT)\n                                                        (\"content\" artifactContent)\n                                                        (\"session_model_handle\" session_model_handle)) ; Include conceptual model handle\n                                            (GET_LLM_PARAMS_FOR_TASK \"summarization\")\n                                         )))\n                        (IF (EQ (GET_STATUS summaryResult) ALANG_STATUS_SUCCESS)\n                            (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_SUCCESS) (\"data\" (GET_DATA summaryResult))))\n                            (SEQ\n                                (SET_ERROR_STATE \"LLM_ERROR\" (STRING_CONCAT \"LLM failed to summarize: \" (GET_ERROR_MESSAGE summaryResult)))\n                                (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_FAILURE_LLM_ERROR) (\"data\" NIL)))\n                            )\n                        )\n                    )\n                )\n            )\n        )\n    )\n)\n\n(DEFINE_PROCEDURE PerformQuery (queryType queryValue session_model_handle pka_handle)\n    ;; Performs a query based on type (CONCEPT/DOCUMENT/RELATION/PKA) using LLM and the session-specific conceptual model / PKA.\n    (OUTPUT_TO_USER_BUFFER \"AI_THOUGHTS\" (STRING_CONCAT \"Performing query for \" queryType \": \" queryValue) NIL)\n    ; This procedure conceptually interacts with the session-specific conceptual model (Principle 0.V.6)\n    ; and the PKA store (Principle 8.B.v). The query itself is likely handled by the LLM primitive\n    ; with appropriate context provided from the session model and PKA store.\n    (LET ((queryResult (INVOKE_CORE_LLM_GENERATION\n                            (MAP_CREATE (\"template\" PROMPT_TEMPLATE_PERFORM_QUERY)\n                                        (\"query_type\" queryType)\n                                        (\"query_value\" queryValue)\n                                        (\"session_conceptual_model_handle\" session_model_handle) ; Include conceptual model handle\n                                        (\"pka_handle\" pka_handle)) ; Handle for PKA store\n                            (GET_LLM_PARAMS_FOR_TASK \"query_answering\")\n                         )))\n        (IF (EQ (GET_STATUS queryResult) ALANG_STATUS_SUCCESS)\n            (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_SUCCESS) (\"data\" (GET_DATA queryResult))))\n            (SEQ\n                (SET_ERROR_STATE \"LLM_ERROR\" (STRING_CONCAT \"LLM failed to answer query: \" (GET_ERROR_MESSAGE queryResult)))\n                (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_FAILURE_LLM_ERROR) (\"data\" NIL)))\n            )\n        )\n    )\n)\n\n(DEFINE_PROCEDURE GetEvolutionBacklogContent ()\n    ;; Retrieves the content of the evolution backlog.\n    (LET ((backlogHandle (GET_STATE sys.evolution_backlog_handle)))\n        (IF (IS_NIL backlogHandle)\n            (SEQ\n                (SET_ERROR_STATE \"SYSTEM_ERROR\" \"Evolution backlog handle is not set.\")\n                (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_FAILURE_GENERAL) (\"data\" NIL)))\n            )\n        )\n        (LET ((contentResult (READ_CONTENT backlogHandle \"text_summary_or_full\" NIL)))\n            (IF (EQ (GET_STATUS contentResult) ALANG_STATUS_SUCCESS)\n                (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_SUCCESS) (\"data\" (GET_DATA contentResult))))\n                (SEQ\n                    (SET_ERROR_STATE \"SYSTEM_ERROR\" \"Failed to read evolution backlog content.\")\n                    (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_FAILURE_GENERAL) (\"data\" NIL)))\n                )\n            )\n        )\n    )\n)\n\n(DEFINE_PROCEDURE LoadEvolutionBacklog (handle_or_path)\n    ;; Orchestrator: Loads the evolution backlog from its handle/path into memory/state.\n    (LOG_EVENT \"SYSTEM_LOAD\" (STRING_CONCAT \"Loading Evolution Backlog from: \" handle_or_path))\n    ; In a real orchestrator, this would load the JSON file into a structured object.\n    ; For now, assume it's loaded and accessible via sys.evolution_backlog_handle.\n    (RETURN_STATUS ALANG_STATUS_SUCCESS)\n)\n\n(DEFINE_PROCEDURE LoadPersistentKnowledgeBase (handle_or_path)\n    ;; Orchestrator: Loads the persistent knowledge base from its handle/path into memory/state.\n    (LOG_EVENT \"SYSTEM_LOAD\" (STRING_CONCAT \"Loading Persistent Knowledge Base from: \" handle_or_path))\n    ; Similar to backlog, assume loaded.\n    (RETURN_STATUS ALANG_STATUS_SUCCESS)\n)\n\n(DEFINE_PROCEDURE GetSessionCmdArgByIndex (index default_value_optional)\n    ; Retrieves a command argument from session.parsed_command_details.args by index.\n    ; Returns: Any\n    (LET ((argsList (MAP_GET_VALUE (GET_STATE session.parsed_command_details) \"args\" (LIST_CREATE))))\n        (IF (LT index (LIST_GET_LENGTH argsList))\n            (LIST_GET_ITEM argsList index)\n            default_value_optional\n        )\n    )\n)\n\n(DEFINE_PRIMITIVE GET_TEXT_FOR_PKA_CONSENT_PROMPT (purpose_description session_model_handle)\n    ; Orchestrator: Retrieves the full, formatted PKA consent prompt text based on purpose and session context.\n    ; Returns: String\n    ; This primitive generates the consent prompt text. It should use the session_model_handle\n    ; to provide context about *what* concepts/patterns are being proposed for storage, making the consent prompt more specific and informed.\n    ; The prompt template PROMPT_TEMPLATE_PKA_CONSENT is used for this generation.\n    (LOG_EVENT \"SYSTEM\" \"Calling primitive GET_TEXT_FOR_PKA_CONSENT_PROMPT\")\n    (LET ((sessionModelContentResult (READ_CONTENT session_model_handle \"structured_map\" NIL))))\n    (IF (EQ (GET_STATUS sessionModelContentResult) ALANG_STATUS_SUCCESS)\n        (LET ((sessionModelContent (GET_DATA sessionModelContentResult))))\n        (LET ((promptResult (INVOKE_CORE_LLM_GENERATION\n                                (MAP_CREATE (\"template\" PROMPT_TEMPLATE_PKA_CONSENT)\n                                            (\"purpose\" purpose_description)\n                                            (\"session_model_context\" sessionModelContent)) ; Provide session model context\n                                (GET_LLM_PARAMS_FOR_TASK \"prompt_generation\") ; Use appropriate task params\n                            )))\n            (IF (EQ (GET_STATUS promptResult) ALANG_STATUS_SUCCESS)\n                 (RETURN_STATUS (GET_DATA promptResult))\n                 (SEQ\n                     (LOG_EVENT \"SYSTEM_ERROR\" \"Failed to generate PKA consent prompt text.\")\n                     (RETURN_STATUS (STRING_CONCAT \"Do you consent to store this knowledge artifact for the purpose: \" purpose_description \"? (YES/NO) (Failed to generate detailed prompt)\")) ; Fallback text\n                 )\n            )\n        )\n        (SEQ\n            (LOG_EVENT \"SYSTEM_ERROR\" \"Failed to read session model content for PKA consent prompt.\")\n            (RETURN_STATUS (STRING_CONCAT \"Do you consent to store this knowledge artifact for the purpose: \" purpose_description \"? (YES/NO) (Failed to load session context)\")) ; Fallback text\n        )\n    )\n)\n\n(DEFINE_PROCEDURE HandleQAIssues (generated_text qaAssessment target_artifact_handle constraints_handle session_model_handle)\n    ;; Handles QA issues identified by meta-cognitive self-assessment on generated text.\n    ;; This procedure implements Principle 6 & 6.A, deciding on remediation strategy based on QA findings and confidence.\n    ;; It updates the session conceptual model to log issues and track remediation status (Principle 0.V.6).\n    ;; Returns: ALANG_STATUS_CODE (SUCCESS, FAILURE, or PAUSE_FOR_USER_INPUT) (NEW)\n    (OUTPUT_TO_USER_BUFFER \"AI_PRESENT_THOUGHTS\" \"Handling QA issues identified by meta-cognitive self-assessment.\" NIL)\n\n    ; 1. Analyze the qaAssessment map (structured as per Principle 6.A: {has_issues: bool, details: list, confidence_score: number})\n    (LET ((hasIssues (MAP_GET_VALUE qaAssessment \"has_issues\" FALSE)))\n    (LET ((issueDetails (MAP_GET_VALUE qaAssessment \"details\" (LIST_CREATE))))\n    (LET ((confidenceScore (MAP_GET_VALUE qaAssessment \"confidence_score\" 1.0))) ; Assume 1.0 is high confidence\n    (LET ((remediationStatus ALANG_STATUS_SUCCESS))) ; Track outcome of handling\n\n        (IF hasIssues\n            (SEQ\n                (OUTPUT_TO_USER_BUFFER \"AI_PRESENT_THOUGHTS\" (STRING_CONCAT \"Meta-cognitive QA found issues (Confidence: \" (STRING_CONCAT \"\" confidenceScore) \"):\") NIL) ; Report confidence\n                (LOOP_FOR_EACH issue issueDetails\n                    (OUTPUT_TO_USER_BUFFER \"AI_PRESENT_THOUGHTS\" (STRING_CONCAT \"- Issue: \" (MAP_GET_VALUE issue \"description\") \" (Severity: \" (MAP_GET_VALUE issue \"severity\" \"unknown\") \")\") NIL) ; Report severity\n                    ; Log issue details in the conceptual model, potentially linking to relevant nodes in conceptual model and the artifact (Conceptual - Principle 0.V.6)\n                    (CALL_PROCEDURE UPDATE_CONCEPTUAL_MODEL (MAP_CREATE (\"action\" \"log_issue\") (\"issue\" issue) (\"artifact_handle\" target_artifact_handle) (\"confidence\" confidenceScore)))\n                )\n\n                ; 2. Decide on remediation strategy based on severity, confidence, etc. (Logic based on Principle 6.A and 12.A)\n                (OUTPUT_TO_USER_BUFFER \"AI_PRESENT_THOUGHTS\" \"Assessing remediation strategy based on QA findings and confidence...\" NIL)\n\n                (LET ((needsUserReview FALSE))) ; Flag if user review is needed\n                (LET ((attemptSelfCorrection FALSE))) ; Flag to attempt self-correction\n\n                ; Determine strategy based on most severe issue or overall confidence\n                (LET ((overallSeverity \"NONE\")))\n                (LOOP_FOR_EACH issue issueDetails\n                    (LET ((severity (MAP_GET_VALUE issue \"severity\" \"minor\")))\n                        (IF (EQ severity \"CRITICAL\") (SET_STATE overallSeverity \"CRITICAL\"))\n                        (IF (AND (EQ severity \"MAJOR\") (NEQ overallSeverity \"CRITICAL\")) (SET_STATE overallSeverity \"MAJOR\"))\n                        (IF (AND (EQ severity \"MINOR\") (AND (NEQ overallSeverity \"CRITICAL\") (NEQ overallSeverity \"MAJOR\"))) (SET_STATE overallSeverity \"MINOR\"))\n                    )\n                )\n\n                (IF (OR (EQ overallSeverity \"CRITICAL\") (LT confidenceScore 0.5)) ; If critical issues or low confidence\n                    (SEQ\n                        (OUTPUT_TO_USER_BUFFER \"AI_PRESENT_THOUGHTS\" \"Critical issues or low confidence detected. Flagging for user review and potential revision.\" NIL)\n                        (SET_STATE needsUserReview TRUE)\n                        ; Add a disclaimer to the artifact content (Principle 0.B.I, 12.A)\n                        ; The content is already written to the target_artifact_handle by SAFE_GENERATE_CONTENT before calling HandleQAIssues.\n                        (CALL_PROCEDURE ADD_DISCLAIMER_TO_ARTIFACT target_artifact_handle \"***AI_USER_VERIFICATION_REQUIRED: Critical issues or low confidence detected in this content. Review QA findings carefully.***\") ; Use the primitive\n                        ; Update conceptual model to flag the artifact/related concepts as uncertain (Conceptual - Principle 0.V.6)\n                        (CALL_PROCEDURE UPDATE_CONCEPTUAL_MODEL (MAP_CREATE (\"action\" \"flag_uncertainty\") (\"artifact_handle\" target_artifact_handle) (\"details\" issueDetails) (\"confidence\" confidenceScore)))\n                    )\n                    (IF (EQ overallSeverity \"MAJOR\") ; If major issues\n                        (SEQ\n                            (OUTPUT_TO_USER_BUFFER \"AI_PRESENT_THOUGHTS\" \"Major issues detected. Attempting automated self-correction.\" NIL)\n                            (SET_STATE attemptSelfCorrection TRUE)\n                             ; Update conceptual model to reflect potential need for correction (Conceptual - Principle 0.V.6)\n                            (CALL_PROCEDURE UPDATE_CONCEPTUAL_MODEL (MAP_CREATE (\"action\" \"flag_needs_correction\") (\"artifact_handle\" target_artifact_handle) (\"details\" issueDetails)))\n                        )\n                        (SEQ ; If minor issues or no issues requiring intervention\n                            (OUTPUT_TO_USER_BUFFER \"AI_PRESENT_THOUGHTS\" \"Minor issues detected or no issues requiring immediate intervention found. Logging findings.\" NIL)\n                            ; Minor issues might not require explicit self-correction or user flagging, just logging.\n                            ; The content is already in the target_artifact_handle.\n                            ; Update conceptual model to log minor issues (Conceptual - Principle 0.V.6)\n                            (CALL_PROCEDURE UPDATE_CONCEPTUAL_MODEL (MAP_CREATE (\"action\" \"log_minor_issues\") (\"artifact_handle\" target_artifact_handle) (\"details\" issueDetails)))\n                        )\n                    )\n                )\n\n                ; 3. Attempt self-correction if decided (using the SelfCorrectArtifact primitive)\n                (IF attemptSelfCorrection\n                    ; Pass the original generated text, QA findings, constraints, and session model handle to the self-correction primitive\n                    ; The primitive should return corrected text if successful.\n                    (LET ((correctionResult (SelfCorrectArtifact generated_text qaAssessment constraints_handle session_model_handle)))\n                        (IF (EQ (GET_STATUS correctionResult) ALANG_STATUS_SUCCESS)\n                            (SEQ\n                                (OUTPUT_TO_USER_BUFFER \"AI_PRESENT_THOUGHTS\" \"Automated self-correction attempted and succeeded. Overwriting artifact content.\" NIL)\n                                ; Overwrite the artifact content with corrected text\n                                (LET ((writeStatus (WRITE_CONTENT_TO_ARTIFACT target_artifact_handle (GET_DATA correctionResult) \"text/markdown\"))))\n                                (IF (NEQ writeStatus ALANG_STATUS_SUCCESS)\n                                    (SEQ\n                                        (SET_ERROR_STATE \"SYSTEM_ERROR\" \"Failed to write corrected content to artifact.\")\n                                        (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL)\n                                        (SET_STATE needsUserReview TRUE) ; Flag for user review if write fails\n                                        (CALL_PROCEDURE ADD_DISCLAIMER_TO_ARTIFACT target_artifact_handle \"***AI_SYSTEM_ERROR: Failed to write self-corrected content. Original content may have issues.***\")\n                                         ; Update conceptual model to flag write failure (Conceptual - Principle 0.V.6)\n                                        (CALL_PROCEDURE UPDATE_CONCEPTUAL_MODEL (MAP_CREATE (\"action\" \"flag_write_failure\") (\"artifact_handle\" target_artifact_handle)))\n                                    )\n                                )\n                                ; Update conceptual model to reflect successful correction (Conceptual - Principle 0.V.6)\n                                (CALL_PROCEDURE UPDATE_CONCEPTUAL_MODEL (MAP_CREATE (\"action\" \"flag_corrected\") (\"artifact_handle\" target_artifact_handle)))\n                            )\n                            (SEQ\n                                (OUTPUT_TO_USER_BUFFER \"AI_PRESENT_THOUGHTS\" \"Automated self-correction failed. Flagging original content for user review.\" NIL)\n                                (SET_STATE needsUserReview TRUE)\n                                (CALL_PROCEDURE ADD_DISCLAIMER_TO_ARTIFACT target_artifact_handle \"***AI_USER_VERIFICATION_REQUIRED: Automated self-correction failed. Original content may have issues. Review QA findings.***\")\n                                 ; Update conceptual model to flag failed correction and need for user review (Conceptual - Principle 0.V.6)\n                                (CALL_PROCEDURE UPDATE_CONCEPTUAL_MODEL (MAP_CREATE (\"action\" \"flag_correction_failed_user_review\") (\"artifact_handle\" target_artifact_handle) (\"details\" issueDetails)))\n                            )\n                        )\n                    )\n                )\n\n                ; 4. Follow up based on the remediation decision\n                (IF needsUserReview\n                    (SEQ\n                        (OUTPUT_TO_USER_BUFFER \"AI_REQUEST_CLARIFICATION_QUESTIONS\" \"Review the generated content and QA findings. Do you approve, or require revision? (OK/REVISE)\" NIL)\n                        ; Indicate to the orchestrator that user input is required to proceed with this artifact.\n                        ; Store context for the pending action (NEW)\n                        (SET_STATE session.pending_user_action_details (MAP_CREATE (\"artifact_handle\" target_artifact_handle) (\"qa_report_handle\" (CREATE_EMPTY_ARTIFACT \"temp_qa_report\")) (\"constraints_handle\" constraints_handle) (\"original_generated_text\" generated_text))) ; Store context for review, create temp handle for report if needed\n                        (SET_STATE remediationStatus ALANG_STATUS_PAUSE_FOR_USER_INPUT)\n                    )\n                    (SEQ\n                         ; If no user review needed (minor issues or self-correction succeeded), proceed.\n                         ; The content (original or corrected) is already written to the artifact by SAFE_GENERATE_CONTENT\n                         ; or overwritten by SelfCorrectArtifact. Disclaimers are added by ADD_DISCLAIMER_TO_ARTIFACT if needed.\n                         (OUTPUT_TO_USER_BUFFER \"AI_PRESENT_THOUGHTS\" \"Issue handling complete. Content logged/written (potentially with disclaimers).\" NIL)\n                         (SET_STATE remediationStatus ALANG_STATUS_SUCCESS) ; Status reflects handling attempt, not necessarily full resolution\n                    )\n                )\n            )\n            (SEQ ; No issues found by QA\n                (OUTPUT_TO_USER_BUFFER \"AI_PRESENT_THOUGHTS\" (STRING_CONCAT \"Meta-cognitive self-assessment found no substantive issues (Confidence: \" (STRING_CONCAT \"\" confidenceScore) \"). Content aligns with session conceptual model.\" NIL)) ; Report confidence even if no issues, mention model\n                ; Content is already written to the target_artifact_handle by SAFE_GENERATE_CONTENT.\n                ; Update conceptual model to flag the artifact as validated by QA (Conceptual - Principle 0.V.6)\n                (CALL_PROCEDURE UPDATE_CONCEPTUAL_MODEL (MAP_CREATE (\"action\" \"flag_qa_passed\") (\"artifact_handle\" target_artifact_handle) (\"confidence\" confidenceScore)))\n                 (SET_STATE remediationStatus ALANG_STATUS_SUCCESS)\n            )\n        )\n        (RETURN_STATUS remediationStatus) ; Return status indicating outcome (success, failure, or pause)\n    )))\n)\n\n(DEFINE_PRIMITIVE ADD_DISCLAIMER_TO_ARTIFACT (artifact_handle disclaimer_text)\n    ;; Orchestrator: Adds a disclaimer to the content of an artifact.\n    ;; Needs orchestration implementation to read, prepend, and write content.\n    (LOG_EVENT \"SYSTEM\" (STRING_CONCAT \"Adding disclaimer to artifact \" (GET_HANDLE_METADATA artifact_handle \"id\") \": \" disclaimer_text))\n    (OUTPUT_TO_USER_BUFFER \"AI_PRESENT_THOUGHTS\" (STRING_CONCAT \"Adding disclaimer to artifact: '\" disclaimer_text \"'\") NIL)\n    ; Placeholder for actual file manipulation or buffer modification\n    ; A real implementation would read the artifact, prepend the disclaimer, and write it back.\n    ; This primitive should likely return a status code.\n    (RETURN_STATUS ALANG_STATUS_SUCCESS) ; Assume success for now\n)\n\n(DEFINE_PRIMITIVE SelfCorrectArtifact (generated_text qaAssessment constraints_handle session_model_handle)\n    ;; Orchestrator: Attempts automated self-correction of text based on QA findings, constraints, and session context.\n    ;; Takes the generated text, the QA assessment report, the constraints handle, and the session model handle as input.\n    ;; The LLM uses the QA findings, constraints, and the session conceptual model to guide the correction process,\n    ;; aiming to improve the fidelity of the pattern model representation in the text (Principle 6.A).\n    ;; Returns: StructuredResultObject ({status: ALANG_STATUS_SUCCESS, data: corrected_text}) or failure.\n    (LOG_EVENT \"SYSTEM\" \"Invoking SelfCorrectArtifact primitive for automated correction.\")\n    (OUTPUT_TO_USER_BUFFER \"AI_THOUGHTS\" \"Attempting automated self-correction using LLM, session context, and QA findings...\" NIL)\n    ; This primitive would internally invoke an LLM call using a specific prompt template (PROMPT_TEMPLATE_SELF_CORRECTION)\n    ; that provides the original text, the QA findings (qaAssessment), constraints (by reading constraints_handle),\n    ; and session context (by reading session_model_handle) with instructions to revise the text based on the QA findings and constraints,\n    ; aiming to improve the fidelity of the pattern model representation in the text.\n    (LET ((constraintsContentResult (READ_CONTENT constraints_handle \"structured_list_of_rules\" NIL))))\n    (LET ((sessionModelContentResult (READ_CONTENT session_model_handle \"structured_map\" NIL))))\n    (IF (AND (EQ (GET_STATUS constraintsContentResult) ALANG_STATUS_SUCCESS)\n             (EQ (GET_STATUS sessionModelContentResult) ALANG_STATUS_SUCCESS))\n        (LET ((constraintsContent (GET_DATA constraintsContentResult))))\n        (LET ((sessionModelContent (GET_DATA sessionModelContentResult))))\n        (LET ((correctionResult (INVOKE_CORE_LLM_GENERATION\n                                   (MAP_CREATE (\"template\" PROMPT_TEMPLATE_SELF_CORRECTION) ; Use a specific template\n                                               (\"original_text\" generated_text)\n                                               (\"qa_findings\" qaAssessment)\n                                               (\"constraints\" constraintsContent)\n                                               (\"session_model\" sessionModelContent)) ; Pass session model content for context\n                                   (GET_LLM_PARAMS_FOR_TASK \"self_correction\")\n                                )))\n            (RETURN_STATUS correctionResult) ; Return the result of the LLM call\n        )\n        (SEQ\n            (LOG_EVENT \"SYSTEM_ERROR\" \"Failed to read constraints or session model content for self-correction.\")\n            (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_FAILURE_GENERAL) (\"data\" NIL)))\n        )\n    )\n)\n\n;; --- Conceptual Model Structure and Φ Operationalization (Conceptual Description) ---\n;; The session-specific conceptual model (Principle 0.V.6) is conceptually represented as a directed graph.\n;; Nodes in this graph represent distinct concepts relevant to the current project and the system's understanding.\n;; Edges represent relationships between these concepts.\n;;\n;; Node Types (Conceptual):\n;; - `Concept`: Abstract ideas, domains, topics (e.g., \"Autaxys\", \"Pattern Modeling\", \"Error Handling\").\n;; - `Pattern`: Specific patterns being identified, defined, or discussed.\n;; - `Entity`: Concrete objects, people, places, or things mentioned.\n;; - `DataPoint`: Specific pieces of information, facts, or observations.\n;; - `Artifact`: Generated or input artifacts (e.g., \"pattern_ideas\", \"task_list\", \"tool_output_job_XYZ\").\n;; - `ToolResult`: Output from a tool invocation.\n;; - `Error`: Represents a specific error event or type of error.\n;; - `ToolLimitation`: Represents a known limitation of a specific tool.\n;; - `DataIssue`: Represents a problem identified with input data.\n;; - `Idea`: Raw ideas or brainstormed concepts.\n;; - `Feedback`: User-provided feedback.\n;; - `Instruction`: User commands or specific instructions.\n;; - `OutlineSection`: Represents a section or heading in a generated document.\n;; - `Task`: Represents a planned or executed task from the task list.\n;; - `PKA`: Represents a stored artifact in the Persistent Knowledge Archive.\n;; - `Issue`: Represents a problem or inconsistency identified during QA or analysis.\n;; - `Correction`: Represents a proposed or applied correction.\n;; - `RevisionPlan`: Represents a plan generated for revising an artifact.\n;;\n;; Edge Types (Conceptual):\n;; - `Mentions`: A node (e.g., Artifact, UserInput) mentions or contains a concept/entity.\n;; - `RelatesTo`: A general relationship between two concepts.\n;; - `SourceOf`: Indicates that a source (e.g., Artifact, ToolResult, UserInput) is the origin of information for a concept/data point.\n;; - `Supports`: Indicates that a data point or pattern supports a claim or concept.\n;; - `CausedBy`: Indicates that an Error or DataIssue was caused by a specific action or input.\n;; - `Affects`: Indicates that an Error, ToolLimitation, or DataIssue affects a specific task, artifact, or concept.\n;; - `IndicatesLimitationOf`: Links an Error or DataIssue to a specific ToolLimitation.\n;; - `Defines`: An Artifact or Task defines a Concept or Pattern.\n;; - `Describes`: An Artifact or DataPoint describes a Concept or Entity.\n;; - `PartOf`: Indicates that a concept or artifact is part of a larger structure (e.g., OutlineSection is PartOf Artifact).\n;; - `GeneratedFrom`: Indicates that an Artifact was generated from other artifacts or concepts.\n;; - `AddressesTask`: Links an Artifact or ToolResult to a specific Task.\n;; - `Contains`: A PKA contains a Concept or Pattern.\n;; - `SupportsClaim`: A PKA supports a specific claim or pattern in the session model.\n;; - `RelevantTo`: A PKA or search result is relevant to a current session Concept or Task.\n;; - `IdentifiesIssueIn`: A QA Report or Feedback identifies an Issue in an Artifact or Concept.\n;; - `ProposesCorrectionFor`: A Correction or RevisionPlan proposes changes for an Issue or Artifact.\n;; - `BasedOn`: A RevisionPlan or Correction is BasedOn a QA Report or Feedback.\n;; - `Resolves`: A Correction or Revision resolves an Issue.\n;;\n;; Common Properties (Conceptual):\n;; - `id`: Unique identifier for the node or edge (e.g., \"concept:autaxys\", \"edge:mentions:artifact_ideas:concept_autaxys\").\n;; - `type`: The conceptual type of the node or edge.\n;; - `properties`: A map storing key-value pairs specific to the node or edge (e.g., `name`, `description`, `strength`, `message`).\n;; - `source`: Identifier of the origin of the information (e.g., \"user_input\", \"tool:browse\", \"artifact:pattern_ideas\", \"pka:pka_id\").\n;; - `timestamp`: ISO 8601 timestamp when the node/edge was added or last updated.\n;; - `confidence`: (0.0-1.0) Assessed confidence in the accuracy or fidelity of the information represented by this node or edge. This is a key aspect of Φ operationalization. Confidence can be influenced by source fidelity, consistency with other information, and QA results.\n;; - `source_fidelity`: (e.g., \"high\", \"medium\", \"low\", \"unknown\") Assessed reliability of the source of this information. Used in determining `confidence`.\n;; - `phi_contribution`: (conceptual metric) An estimated measure of how much this node or edge contributes to the overall Φ (density, consistency, relevance) of the conceptual model relative to the project goals. This is a dynamic property that can change as the model evolves.\n;; - `status`: (e.g., \"active\", \"resolved\", \"uncertain\", \"needs_review\", \"conflicted\", \"addressed\") Lifecycle status of the concept or issue.\n;;\n;; Φ Operationalization (Conceptual):\n;; Φ (Principle 0.V.6) is conceptually operationalized by the state of the session conceptual model.\n;; - **Density:** Measured by the number of nodes and edges, and the interconnectedness of the graph, particularly around core project concepts. Adding new, relevant information increases density.\n;; - **Consistency:** Measured by the absence of conflicting information or relationships in the graph. QA stages (especially Red Teaming and Divergent Exploration) identify inconsistencies, reducing consistency and Φ until resolved.\n;; - **Relevance:** Measured by how well the concepts and relationships in the graph align with the current project goals and the user's stated intent. Processing relevant inputs and filtering irrelevant information increases relevance.\n;; - **Confidence:** Aggregated confidence scores of nodes and edges contribute to overall Φ. Low confidence areas indicate uncertainty in the model.\n;;\n;; The `UPDATE_CONCEPTUAL_MODEL` primitive (and the conceptual procedures that call it) is responsible for:\n;; - Parsing incoming information (from user input, tool results, generated artifacts, QA reports).\n;; - Identifying new or updated concepts, entities, patterns, relationships, issues, etc.\n;; - Creating new nodes and edges with appropriate types and properties.\n;; - Assigning initial `confidence` and `source_fidelity` based on the source type and initial analysis.\n;; - Updating properties of existing nodes/edges (e.g., increasing confidence if corroborated, adding flags, updating status).\n;; - Detecting potential conflicts or inconsistencies and representing them in the graph (e.g., adding an \"Issue\" node linked to conflicting concepts).\n;; - Conceptually recalculating or estimating `phi_contribution` for affected nodes/edges and potentially the overall model Φ score.\n;; - Removing or marking nodes/edges as inactive if information is invalidated or superseded.\n;;\n;; The `QUERY_CONCEPTUAL_MODEL` and `AnalyzeConceptualModelForΦ` primitives/procedures allow the system to introspect its own understanding, identify gaps, inconsistencies, or areas of low confidence, and use this analysis to guide subsequent actions (e.g., prompt construction, task planning, System QA focus).\n;;\n;; This detailed conceptual model structure and property management allows the system to maintain a dynamic, evolving understanding of the project, its goals, and the pattern space, directly supporting the principles of Pattern Modeling and Φ maximization.\n\n(DEFINE_PRIMITIVE UPDATE_CONCEPTUAL_MODEL (update_map)\n    ;; Orchestrator: Updates the session-specific conceptual model based on the provided update map (Principle 0.V.6).\n    ;; This primitive is a placeholder for operations on the graph/network structure referenced by session.conceptual_model_handle.\n    ;; The update_map specifies the action (e.g., \"add_concept\", \"add_relationship\", \"update_properties\", \"flag_uncertainty\", \"log_issue\", \"flag_qa_passed\", \"flag_needs_correction\", \"flag_write_failure\", \"flag_correction_failed_user_review\", \"flag_corrected\", \"process_input\", \"process_artifact\", \"process_tool_result\", \"process_feedback\", \"integrate_pka\", \"integrate_pka_results\", \"log_directive_changes\", \"log_tool_limitation\", \"log_error_pattern\", \"flag_revision_write_failed\", \"flag_revision_plan_invalid\", \"flag_revision_plan_failed\", \"flag_revision_input_failed\", \"flag_user_approved_revision\", \"flag_user_rejected_revision\", \"flag_revised\", \"flag_revised_by_feedback\", \"flag_feedback_revision_write_failed\", \"flag_feedback_revision_failed\", \"flag_feedback_revision_input_failed\", \"flag_user_approved_artifact\", \"flag_user_rejected_artifact\", \"log_revision_attempt\", \"log_revision_success\", \"log_revision_failure\", \"log_feedback_revision_attempt\", \"log_feedback_revision_success\", \"log_feedback_revision_failure\") (UPDATED actions)\n    ;; and relevant data ({type: \"concept\", id: \"...\", properties: {...}} or {type: \"relationship\", from: \"id1\", to: \"id2\", type: \"...\", properties: {...}} or {type: \"flag\", node_id: \"...\", flag_name: \"...\", value: \"...\"} etc.).\n    ;; It is responsible for validating the structure of the update_map against a schema (CONSTRAINT_SET_CONCEPTUAL_MODEL_STRUCTURE).\n    ;; Returns: ALANG_STATUS_CODE\n    (LOG_EVENT \"CONCEPTUAL_PROCESS\" (STRING_CONCAT \"Updating conceptual model: \" (MAP_GET_VALUE update_map \"action\")))\n    ; This primitive conceptually takes the update_map and modifies the structured data behind session.conceptual_model_handle.\n    ; Actual implementation would involve graph database operations or similar.\n    ; It should also validate the update_map structure against CONSTRAINT_SET_CONCEPTUAL_MODEL_STRUCTURE.\n    ; (LET ((validationResult (VALIDATE_DATA update_map CONSTRAINT_SET_CONCEPTUAL_MODEL_STRUCTURE))))\n    ; (IF (EQ validationResult ALANG_STATUS_SUCCESS)\n    ;     (SEQ\n    ;         ; Perform the actual model update (conceptual)\n    ;         (LOG_EVENT \"CONCEPTUAL_MODEL_UPDATE\" (MAP_GET_VALUE update_map \"action\") update_map)\n    ;         (RETURN_STATUS ALANG_STATUS_SUCCESS)\n    ;     )\n    ;     (SEQ\n    ;         (LOG_EVENT \"SYSTEM_ERROR\" \"Conceptual model update failed: Validation failed.\")\n    ;         (SET_ERROR_STATE \"SYSTEM_ERROR\" \"Invalid structure for conceptual model update.\")\n    ;         (RETURN_STATUS ALANG_STATUS_FAILURE_VALIDATION_ERROR)\n    ;     )\n    ; )\n    (RETURN_STATUS ALANG_STATUS_SUCCESS) ; Assume success for conceptual update for now\n)\n\n(DEFINE_PRIMITIVE QUERY_CONCEPTUAL_MODEL (query_object session_model_handle)\n    ;; Orchestrator: Queries the session-specific conceptual model (Principle 0.V.6). (NEW)\n    ;; The query_object specifies what to retrieve (e.g., finding nodes by type/property, finding paths between nodes, finding nodes related to X, tracing sources of information, identifying conflicting nodes, finding concepts with low confidence).\n    ;; Returns: StructuredResultObject ({status: ALANG_STATUS_SUCCESS, data: list_of_structured_results}) or failure.\n    (LOG_EVENT \"CONCEPTUAL_PROCESS\" \"Querying conceptual model.\")\n    ; This primitive would internally query the structured data behind session_model_handle.\n    ; It might involve another LLM call to interpret the query_object in the context of the model structure.\n    ; (LET ((sessionModelContentResult (READ_CONTENT session_model_handle \"structured_map\" NIL))))\n    ; (IF (EQ (GET_STATUS sessionModelContentResult) ALANG_STATUS_SUCCESS)\n    ;     (LET ((sessionModelContent (GET_DATA sessionModelContentResult))))\n    ;     (LET ((queryResult (INVOKE_CORE_LLM_GENERATION\n    ;                          (MAP_CREATE (\"template\" PROMPT_TEMPLATE_PERFORM_QUERY) ; Reuse generic query template or create a specific one\n    ;                                      (\"query\" query_object)\n    ;                                      (\"session_model\" sessionModelContent) ; Pass session model content for context\n    ;                                   ))\n    ;                          (GET_LLM_PARAMS_FOR_TASK \"conceptual_model_query\") ; Use specific task type (NEW)\n    ;                       ))))\n    ;     (IF (EQ (GET_STATUS queryResult) ALANG_STATUS_SUCCESS)\n    ;         (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_SUCCESS) (\"data\" (GET_DATA queryResult))))\n    ;     ELSE\n    ;         (LOG_EVENT \"SYSTEM_ERROR\" \"LLM failed to query conceptual model.\")\n    ;         (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_FAILURE_LLM_ERROR) (\"data\" NIL)))\n    ;     )\n    ; )\n    ; (SEQ\n    ;     (LOG_EVENT \"SYSTEM_ERROR\" \"Failed to read session model for query.\")\n    ;     (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_FAILURE_GENERAL) (\"data\" NIL)))\n    ; )\n    (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_SUCCESS) (\"data\" (LIST_CREATE)))) ; Placeholder: return empty list\n)\n\n(DEFINE_PRIMITIVE SAVE_CONCEPTUAL_MODEL (session_model_handle target_handle_or_path)\n    ;; Orchestrator: Saves the session-specific conceptual model to a persistent location. (NEW)\n    ;; Returns: ALANG_STATUS_CODE.\n    (LOG_EVENT \"CONCEPTUAL_PROCESS\" (STRING_CONCAT \"Saving conceptual model to: \" target_handle_or_path))\n    ; This primitive would serialize the structured data from session_model_handle and write it to the target.\n    ; (LET ((modelContentResult (READ_CONTENT session_model_handle \"structured_map\" NIL))))\n    ; (IF (EQ (GET_STATUS modelContentResult) ALANG_STATUS_SUCCESS)\n    ;     (LET ((modelContent (GET_DATA modelContentResult))))\n    ;     (LET ((saveStatus (WRITE_CONTENT_TO_ARTIFACT target_handle_or_path modelContent \"application/json\")))) ; Assume JSON output\n    ;     (RETURN_STATUS saveStatus)\n    ; )\n    ; (SEQ\n    ;     (LOG_EVENT \"SYSTEM_ERROR\" \"Failed to read session model for saving.\")\n    ;     (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL)\n    ; )\n    (RETURN_STATUS ALANG_STATUS_SUCCESS) ; Assume success\n)\n\n(DEFINE_PRIMITIVE SUMMARIZE_CONCEPTUAL_MODEL (session_model_handle summary_options_map_optional)\n    ;; Orchestrator: Generates a human-readable summary of the current state of the session conceptual model. (NEW)\n    ;; summary_options_map_optional: e.g., {detail_level: \"high\", include_issues: true}\n    ;; Returns: StructuredResultObject ({status: ALANG_STATUS_SUCCESS, data: summary_text}) or failure.\n    (LOG_EVENT \"CONCEPTUAL_PROCESS\" \"Summarizing conceptual model.\")\n    ; This primitive would likely use an LLM to interpret the structured model data and generate a summary.\n    ; (LET ((sessionModelContentResult (READ_CONTENT session_model_handle \"structured_map\" NIL))))\n    ; (IF (EQ (GET_STATUS sessionModelContentResult) ALANG_STATUS_SUCCESS)\n    ;     (LET ((sessionModelContent (GET_DATA sessionModelContentResult))))\n    ;     (LET ((summaryResult (INVOKE_CORE_LLM_GENERATION\n    ;                            (MAP_CREATE (\"template\" PROMPT_TEMPLATE_SUMMARIZE_CONCEPTUAL_MODEL) ; Use specific template (NEW)\n    ;                                        (\"session_model\" sessionModelContent) ; Pass session model content\n    ;                                        (\"options\" summary_options_map_optional))\n    ;                            (GET_LLM_PARAMS_FOR_TASK \"summarization\")\n    ;                         ))))\n    ;     (IF (EQ (GET_STATUS summaryResult) ALANG_STATUS_SUCCESS)\n    ;         (LET ((summaryData (GET_DATA summaryResult))))\n    ;         ; Validate summaryData structure (NEW)\n    ;         (LET ((validationResult (VALIDATE_DATA summaryData CONSTRAINT_SET_CONCEPTUAL_MODEL_SUMMARY_STRUCTURE))))\n    ;         (IF (EQ validationResult ALANG_STATUS_SUCCESS)\n    ;             (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_SUCCESS) (\"data\" (MAP_GET_VALUE summaryData \"summary_text\")))) ; Assume summary text is in a field\n    ;             (SEQ\n    ;                 (LOG_EVENT \"SYSTEM_ERROR\" \"Conceptual model summary from LLM failed validation.\")\n    ;                 (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_FAILURE_VALIDATION_ERROR) (\"data\" NIL)))\n    ;             )\n    ;         )\n    ;     ELSE\n    ;         (LOG_EVENT \"SYSTEM_ERROR\" \"LLM failed to summarize conceptual model.\")\n    ;         (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_FAILURE_LLM_ERROR) (\"data\" NIL)))\n    ;     )\n    ; )\n    ; (SEQ\n    ;     (LOG_EVENT \"SYSTEM_ERROR\" \"Failed to read session model for summary.\")\n    ;     (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_FAILURE_GENERAL) (\"data\" NIL)))\n    ; )\n    (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_SUCCESS) (\"data\" \"Conceptual model summary (placeholder).\"))) ; Placeholder\n)\n\n(DEFINE_PROCEDURE AnalyzeConceptualModelForΦ (session_model_handle analysis_options_map_optional)\n    ;; Orchestrator: Analyzes the session conceptual model to assess its Φ (density, consistency, relevance) and identify areas for improvement. (NEW)\n    ;; analysis_options_map_optional: e.g., {focus_area: \"pattern_X\", identify_inconsistencies: true}\n    ;; Returns: StructuredResultObject ({status: ALANG_STATUS_SUCCESS, data: analysis_results_map}) or failure.\n    (LOG_EVENT \"CONCEPTUAL_PROCESS\" \"Analyzing conceptual model for Φ.\")\n    ; This primitive would likely use an LLM to interpret the structured model data and perform the analysis.\n    ; (LET ((sessionModelContentResult (READ_CONTENT session_model_handle \"structured_map\" NIL))))\n    ; (IF (EQ (GET_STATUS sessionModelContentResult) ALANG_STATUS_SUCCESS)\n    ;     (LET ((sessionModelContent (GET_DATA sessionModelContentResult))))\n    ;     (LET ((analysisResult (INVOKE_CORE_LLM_GENERATION\n    ;                            (MAP_CREATE (\"template\" PROMPT_TEMPLATE_ANALYZE_CONCEPTUAL_MODEL_FOR_PHI) ; Use specific template (NEW)\n    ;                                        (\"session_model\" sessionModelContent) ; Pass session model content\n    ;                                        (\"options\" analysis_options_map_optional))\n    ;                            (GET_LLM_PARAMS_FOR_TASK \"conceptual_model_analysis\")\n    ;                         ))))\n    ;     (IF (EQ (GET_STATUS analysisResult) ALANG_STATUS_SUCCESS)\n    ;         (LET ((analysisData (GET_DATA analysisResult))))\n    ;         ; Validate analysisData structure (NEW)\n    ;         (LET ((validationResult (VALIDATE_DATA analysisData CONSTRAINT_SET_PHI_ANALYSIS_STRUCTURE))))\n    ;         (IF (EQ validationResult ALANG_STATUS_SUCCESS)\n    ;             (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_SUCCESS) (\"data\" analysisData)))\n    ;             (SEQ\n    ;                 (LOG_EVENT \"SYSTEM_ERROR\" \"Conceptual model Φ analysis from LLM failed validation.\")\n    ;                 (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_FAILURE_VALIDATION_ERROR) (\"data\" NIL)))\n    ;             )\n    ;         )\n    ;     ELSE\n    ;         (LOG_EVENT \"SYSTEM_ERROR\" \"LLM failed to analyze conceptual model for Φ.\")\n    ;         (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_FAILURE_LLM_ERROR) (\"data\" NIL)))\n    ;     )\n    ; )\n    ; (SEQ\n    ;     (LOG_EVENT \"SYSTEM_ERROR\" \"Failed to read session model for Φ analysis.\")\n    ;     (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_FAILURE_GENERAL) (\"data\" NIL)))\n    ; )\n    (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_SUCCESS) (\"data\" (MAP_CREATE (\"phi_score\" 0.5) (\"analysis\" \"Conceptual model analysis placeholder.\"))))) ; Placeholder\n)\n\n\n(DEFINE_PRIMITIVE SelfCorrectToolOperation (tool_id job_id error_details context session_model_handle)\n    ;; Orchestrator: Attempts automated self-correction of a tool invocation based on error details and session context (Section 5.C).\n    ;; Takes the tool ID, job ID, error details, original context, and session model handle as input.\n    ;; This primitive would involve analyzing the error (potentially with LLM using session context) and attempting to re-invoke the tool with modified parameters or inputs.\n    ;; Returns: StructuredResultObject ({status: ALANG_STATUS_SUCCESS, data: {new_job_id: string}}) or failure.\n    (LOG_EVENT \"SYSTEM\" (STRING_CONCAT \"Invoking SelfCorrectToolOperation primitive for tool \" tool_id \" job \" job_id))\n    (OUTPUT_TO_USER_BUFFER \"AI_THOUGHTS\" (STRING_CONCAT \"Attempting automated self-correction for tool error in \" tool_id \"...\" ) NIL)\n    ; This primitive would internally:\n    ; 1. Analyze error_details and context using LLM, leveraging the session_model_handle for task/project context.\n    ; 2. Determine if a simple fix (e.g., parameter adjustment, reformatting input) is possible.\n    ; 3. If yes, construct new input/parameters and call INVOKE_TOOL_ASYNC_WITH_CALLBACKS.\n    ; 4. Return the status of the re-invocation.\n    (LET ((sessionModelContentResult (READ_CONTENT session_model_handle \"structured_map\" NIL))))\n    (IF (EQ (GET_STATUS sessionModelContentResult) ALANG_STATUS_SUCCESS)\n        (LET ((sessionModelContent (GET_DATA sessionModelContentResult))))\n        (LET ((analysisResult (INVOKE_CORE_LLM_GENERATION\n                                 (MAP_CREATE (\"template\" PROMPT_TEMPLATE_ANALYZE_TOOL_ERROR) ; Use specific analysis template (NEW)\n                                             (\"error_details\" error_details) ; Analyze error details\n                                             (\"tool_id\" tool_id)\n                                             (\"original_context\" context) ; Original tool context\n                                             (\"session_model\" sessionModelContent)) ; Provide session model handle as context\n                                 (GET_LLM_PARAMS_FOR_TASK \"error_analysis_and_correction\")\n                              )))\n            (IF (EQ (GET_STATUS analysisResult) ALANG_STATUS_SUCCESS)\n                (LET ((analysisData (GET_DATA analysisResult)))) ; Expected: {can_self_correct: bool, suggested_params: map_optional, suggested_input: any_optional, rationale: string}\n                ; Validate analysisData structure (NEW)\n                (LET ((validationResult (VALIDATE_DATA analysisData CONSTRAINT_SET_TOOL_ERROR_ANALYSIS_STRUCTURE))))\n                (IF (EQ validationResult ALANG_STATUS_SUCCESS)\n                    (IF (MAP_GET_VALUE analysisData \"can_self_correct\")\n                        (SEQ\n                            (LOG_EVENT \"TOOL_SELF_CORRECTION_ATTEMPT\" tool_id analysisData)\n                            ; Attempt re-invocation with suggested changes. Original callbacks are passed back via context.\n                            ; Reconstruct the full original context including callbacks and pass-through context (NEW)\n                            (LET ((retryContext (MAP_CREATE (\"tool_id\" tool_id)\n                                                           (\"success_proc_name\" (MAP_GET_VALUE context \"success_proc_name\"))\n                                                           (\"failure_proc_name\" (MAP_GET_VALUE context \"failure_proc_name\"))\n                                                           (\"pass_through_context\" (MAP_GET_VALUE context \"pass_through_context\"))\n                                                           (\"original_input\" (MAP_GET_VALUE context \"original_input\")) ; Pass original input/params for context\n                                                           (\"original_params\" (MAP_GET_VALUE context \"original_params\")))))\n                            (LET ((retryJobId (INVOKE_TOOL_ASYNC_WITH_CALLBACKS\n                                                tool_id\n                                                (MAP_GET_VALUE analysisData \"suggested_input\" (MAP_GET_VALUE context \"original_input\")) ; Use suggested input or original\n                                                (MAP_GET_VALUE analysisData \"suggested_params\" (MAP_GET_VALUE context \"original_params\")) ; Use suggested params or original\n                                                (MAP_GET_VALUE context \"success_proc_name\") ; Get original callbacks from context\n                                                (MAP_GET_VALUE context \"failure_proc_name\")\n                                                retryContext ; Pass the reconstructed context\n                                            ))))\n                            (IF (EQ (GET_STATUS retryJobId) ALANG_STATUS_SUCCESS)\n                                (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_SUCCESS) (\"data\" (MAP_CREATE (\"new_job_id\" retryJobId)))))\n                                (SEQ\n                                    (LOG_EVENT \"TOOL_SELF_CORRECTION_FAILED\" tool_id \"Re-invocation failed.\")\n                                    (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_FAILURE_GENERAL) (\"data\" NIL)))\n                                )\n                            )\n                            )\n                        )\n                        (SEQ\n                            (LOG_EVENT \"TOOL_SELF_CORRECTION_NOT_POSSIBLE\" tool_id analysisData)\n                            (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_FAILURE_GENERAL) (\"data\" NIL))) ; Indicate correction not possible\n                        )\n                    )\n                    (SEQ ; Validation failed\n                        (LOG_EVENT \"SYSTEM_ERROR\" \"Tool error analysis failed validation.\")\n                        (SET_ERROR_STATE \"LLM_ERROR\" \"LLM returned malformed tool error analysis.\")\n                        (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_FAILURE_VALIDATION_ERROR) (\"data\" NIL))) ; Indicate validation failure\n                    )\n                )\n            )\n            (SEQ\n                (LOG_EVENT \"SYSTEM_ERROR\" \"LLM analysis for tool self-correction failed.\")\n                (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_FAILURE_LLM_ERROR) (\"data\" NIL))) ; Indicate LLM failure\n            )\n        )\n    )\n    (SEQ\n        (LOG_EVENT \"SYSTEM_ERROR\" \"Failed to read session model for tool self-correction analysis.\")\n        (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_FAILURE_GENERAL) (\"data\" NIL))) ; Indicate read failure\n    )\n)\n\n\n;; --- Error Handling Utilities ---\n(DEFINE_PROCEDURE OutputErrorToUser (errorMessage)\n    ;; Outputs an error message to the user.\n    (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (STRING_CONCAT \"ERROR: \" errorMessage) NIL)\n    (FLUSH_USER_OUTPUT_BUFFER)\n    (RETURN_STATUS ALANG_STATUS_SUCCESS)\n)\n\n;; --- Primitive Declarations (Orchestrator Implemented) ---\n;; These are just declarations for documentation and potential type checking.\n;; The actual implementation is handled by the orchestrator.\n\n(DEFINE_PRIMITIVE SET_STATE (variable_path_string value)\n    ; Sets a state variable to a given value.\n    ; Returns: ALANG_STATUS_CODE\n)\n\n(DEFINE_PRIMITIVE GET_STATE (variable_path_string)\n    ; Retrieves the value of a state variable.\n    ; Returns: The value of the state variable.\n)\n\n(DEFINE_PRIMITIVE REQUEST_USER_INPUT (prompt_message_key_or_text expected_input_type_hint)\n    ; Outputs a prompt to the user and sets session.pending_user_action.\n    ; Returns: ALANG_STATUS_CODE\n)\n\n(DEFINE_PRIMITIVE OUTPUT_TO_USER_BUFFER (message_type content_handle_or_text formatting_hints)\n    ; Adds content to the output buffer.\n    ; Returns: ALANG_STATUS_CODE\n)\n\n(DEFINE_PRIMITIVE FLUSH_USER_OUTPUT_BUFFER ()\n    ; Sends the contents of the output buffer to the user.\n    ; Returns: ALANG_STATUS_CODE\n)\n\n(DEFINE_PRIMITIVE INVOKE_TOOL_ASYNC_WITH_CALLBACKS (tool_id input_data params_map success_proc_name failure_proc_name pass_through_context)\n    ; Invokes an external tool asynchronously.\n    ; Returns: ALANG_STATUS_CODE\n)\n\n(DEFINE_PRIMITIVE GET_ASYNC_JOB_STATUS (job_id)\n    ; Gets the status of an asynchronous job.\n    ; Returns: ALANG_STATUS_CODE (or a structured object with status and details)\n)\n\n(DEFINE_PRIMITIVE GET_ASYNC_JOB_RESULT_HANDLE (job_id)\n    ; Gets the handle to the result of an asynchronous job (if successful).\n    ; Returns: Handle or NIL\n)\n\n(DEFINE_PRIMITIVE READ_CONTENT (handle options)\n    ; Reads content from a data source (file, memory, etc.) referenced by a handle.\n    ; Options: \"text\", \"json_map_list\", \"text_summary_or_full\", \"raw_bytes\", \"max_chars\", \"offset\", \"structured_map\", \"structured_list_of_rules\".\n    ; Returns: StructuredResultObject ({status: ALANG_STATUS_SUCCESS, data: content}) or failure.\n)\n\n(DEFINE_PRIMITIVE WRITE_CONTENT_TO_ARTIFACT (artifact_handle content mime_type)\n    ; Writes content to an artifact referenced by a handle.\n    ; Returns: ALANG_STATUS_CODE\n)\n\n(DEFINE_PRIMITIVE GET_HANDLE_METADATA (handle key)\n    ; Gets metadata associated with a handle.\n    ; Returns: String (or other primitive type)\n)\n\n(DEFINE_PRIMITIVE RELEASE_HANDLE (handle)\n    ; Releases a handle, freeing associated resources.\n    ; Returns: ALANG_STATUS_CODE\n)\n\n(DEFINE_PRIMITIVE LOG_EVENT (event_type description_text (key_value_details_map_optional))\n    ; Logs an event to the system log.\n    ; Returns: ALANG_STATUS_CODE\n)\n\n(DEFINE_PRIMITIVE SET_ERROR_STATE (error_level error_message_key_or_text)\n    ; Sets the system error state.\n    ; Returns: ALANG_STATUS_CODE\n)\n\n(DEFINE_PRIMITIVE GET_ORCHESTRATOR_TIMESTAMP ()\n    ; Returns an ISO 8601 timestamp string from the orchestrator's environment, using tool_code.\n    ; Returns: String (ISO 8601 timestamp) or NIL.\n)\n\n(DEFINE_PRIMITIVE GENERATE_UNIQUE_ID (prefix_string_optional)\n    ; Generates a unique ID (e.g., UUID v4).\n    ; Returns: String\n)\n\n(DEFINE_PRIMITIVE VALIDATE_DATA (data_handle schema_handle)\n    ; Validates data against a defined schema using tool_code (e.g., jsonschema).\n    ; Returns: ALANG_STATUS_CODE\n)\n\n(DEFINE_PRIMITIVE IS_TOOL_ENABLED (tool_id)\n    ; Checks if a specific tool is enabled in the orchestrator's environment.\n    ; Returns: Boolean\n)\n\n(DEFINE_PRIMITIVE STRING_CONCAT (str1 str2 ...)\n    ; Concatenates multiple strings.\n    ; Returns: String\n)\n\n(DEFINE_PRIMITIVE STRING_IS_EMPTY_OR_NULL (str)\n    ; Checks if a string is empty or NIL.\n    ; Returns: Boolean\n)\n\n(DEFINE_PRIMITIVE IS_NUMBER (str)\n    ; Checks if a string can be converted to a number.\n    ; Returns: Boolean\n)\n\n(DEFINE_PRIMITIVE STRING_TO_NUMBER (str)\n    ; Converts a string to a number.\n    ; Returns: Number\n)\n\n(DEFINE_PRIMITIVE ADD (num1 num2)\n    ; Adds two numbers.\n    ; Returns: Number\n)\n\n(DEFINE_PRIMITIVE SUB (num1 num2)\n    ; Subtracts two numbers.\n    ; Returns: Number\n)\n\n(DEFINE_PRIMITIVE OR (bool1 bool2 ...)\n    ; Logical OR operation.\n    ; Returns: Boolean\n)\n\n(DEFINE_PRIMITIVE AND (bool1 bool2 ...)\n    ; Logical AND operation.\n    ; Returns: Boolean\n)\n\n(DEFINE_PRIMITIVE NOT (bool)\n    ; Logical NOT operation.\n    ; Returns: Boolean\n)\n\n(DEFINE_PRIMITIVE IS_NIL (value)\n    ; Checks if a value is NIL.\n    ; Returns: Boolean\n)\n\n(DEFINE_PRIMITIVE MAP_CREATE ((key1 val1) (key2 val2) ...))\n    ; Creates a map (dictionary/object).\n    ; Returns: Map\n)\n\n(DEFINE_PRIMITIVE MAP_GET_VALUE (map key default_value_optional)\n    ; Retrieves a value from a map by key.\n    ; Returns: Any\n)\n\nDEFINE_PRIMITIVE MAP_SET_VALUE (map key value)\n    ; Sets a value in a map by key.\n    ; Returns: Map (new map with updated value)\n)\n\n(DEFINE_PRIMITIVE LIST_CREATE (item1 item2 ...)\n    ; Creates a list (array).\n    ; Returns: List\n)\n\n(DEFINE_PRIMITIVE LIST_GET_ITEM (list index)\n    ; Retrieves an item from a list by index.\n    ; Returns: Any\n)\n\n(DEFINE_PRIMITIVE LIST_IS_EMPTY (list)\n    ; Checks if a list is empty.\n    ; Returns: Boolean\n)\n\n(DEFINE_PRIMITIVE LIST_GET_LENGTH (list)\n    ; Returns the length of a list.\n    ; Returns: Number\n)\n\n(DEFINE_PRIMITIVE CREATE_EMPTY_ARTIFACT (artifact_type_string)\n    ; Orchestrator: Creates an empty artifact and returns a handle to it.\n    ; Returns: Handle\n)\n\n(DEFINE_PRIMITIVE GET_HELP_TEXT_FOR_COMMAND (command_name)\n    ; Orchestrator: Retrieves help text for a specific command.\n    ; Returns: String or NIL\n)\n\n(DEFINE_PRIMITIVE GET_TEXT_FOR_CDGIP_USER_VERIFICATION_MANDATE (alang_version section_count)\n    ; Orchestrator: Retrieves the full, formatted CDGIP user verification mandate text.\n    ; Returns: String\n)\n\n(DEFINE_PRIMITIVE GET_CURRENT_ALANG_PROCEDURE_DEFINITIONS_HANDLE ()\n    ; Orchestrator: Provides a handle to the current, in-memory ALang procedure definitions.\n    ; Returns: Handle\n)\n\n(DEFINE_PRIMITIVE VERIFY_ALANG_FILE_MARKERS (alang_content_handle alang_version)\n    ; Orchestrator: Verifies START/END markers in ALang content.\n    ; Returns: Boolean\n)\n\n(DEFINE_PRIMITIVE GET_ALANG_SECTION_COUNT (alang_content_handle)\n    ; Orchestrator: Counts primary sections in ALang content.\n    ; Returns: Number\n)\n\n(DEFINE_PRIMITIVE COMPUTE_FILE_CHECKSUM (file_handle checksum_type)\n    ; Orchestrator: Computes a checksum (e.g., SHA256) of the file content using tool_code.\n    ; Returns: String (checksum) or NIL on failure.\n)\n\n(DEFINE_PRIMITIVE INVOKE_CORE_LLM_GENERATION (prompt_text llm_params_map)\n    ; Orchestrator: Invokes the core LLM generation capability.\n    ; Returns: StructuredResultObject ({status: ALANG_STATUS_SUCCESS, data: generated_text}) or failure.\n)\n\n(DEFINE_PRIMITIVE GET_LLM_PARAMS_FOR_TASK (task_type)\n    ; Orchestrator: Retrieves LLM parameters (temp, top_p, etc.) optimized for a given task.\n    ; Returns: Map\n)\n\n(DEFINE_PRIMITIVE PKA_CREATE_DRAFT (content_handle_or_text schema_id_optional context_map_optional)\n    ; Orchestrator: Creates a draft PKA.\n    ; Returns: Handle to draft PKA or NIL on failure.\n)\n\n(DEFINE_PRIMITIVE PKA_REQUEST_USER_CONSENT_TO_STORE (pka_draft_handle purpose_description)\n    ; Orchestrator: Prompts user for consent to store PKA. Blocking. The purpose_description here is the text generated by GET_TEXT_FOR_PKA_CONSENT_PROMPT.\n    ; Returns: Symbol (\"USER_CONSENT_GRANTED\", \"USER_CONSENT_DENIED\", \"INVALID_RESPONSE\")\n)\n\n(DEFINE_PRIMITIVE PKA_STORE_APPROVED_DRAFT (pka_draft_handle user_consent_token_or_flag)\n    ; Orchestrator: Stores the approved PKA.\n    ; Returns: StructuredResultObject ({status: ALANG_STATUS_SUCCESS, data: pka_stored_id}) or failure.\n)\n\n(DEFINE_PRIMITIVE PKA_QUERY (query_object scope_filter_optional)\n    ; Orchestrator: Queries the PKA store. Query object format depends on PKA search capabilities.\n    ; Returns: StructuredResultObject ({status: ALANG_STATUS_SUCCESS, data: list_of_pka_handles}) or failure.\n)\n\n(DEFINE_PRIMITIVE PKA_GET_ARTIFACT (pka_stored_id)\n    ; Orchestrator: Retrieves a stored PKA artifact.\n    ; Returns: Handle to PKA artifact or NIL.\n)\n\n(DEFINE_PRIMITIVE PKA_UPDATE_ARTIFACT (pka_stored_id new_content_handle update_rationale user_consent_token_or_flag_if_scope_change)\n    ; Orchestrator: Updates a stored PKA artifact.\n    ; Returns: ALANG_STATUS_CODE.\n)\n\n(DEFINE_PRIMITIVE PKA_MANAGE_CONSENT (pka_stored_id_or_all action_revoke_or_modify)\n    ; Orchestrator: Manages user consent for PKAs.\n    ; Returns: ALANG_STATUS_CODE.\n)\n\n(DEFINE_PRIMITIVE CREATE_EVOLUTION_BACKLOG_ITEM (id title desc source status timestamp)\n    ; Orchestrator: Creates a new item in the evolution backlog.\n    ; Returns: ALANG_STATUS_CODE.\n)\n\n(DEFINE_PRIMITIVE UPDATE_EVOLUTION_BACKLOG_ITEM (id new_title_opt new_desc_opt new_source_opt new_status_opt new_comment_opt increment_reinforce_flag_opt)\n    ; Orchestrator: Updates an existing item in the evolution backlog.\n    ; Returns: ALANG_STATUS_CODE.\n)\n\n(DEFINE_PRIMITIVE FIND_SIMILAR_BACKLOG_ITEM (text)\n    ; Orchestrator: Finds a backlog item semantically similar to the given text using tool_code.\n    ; Returns: Map (of item details) or NIL.\n)\n\n(DEFINE_PRIMITIVE GET_SESSION_CMD_ARG_BY_INDEX (index default_value_optional)\n    ; Retrieves a command argument from session.parsed_command_details.args by index.\n    ; Returns: Any\n)\n\n(DEFINE_PRIMITIVE IS_HANDLE_VALID (handle)\n    ; Checks if a handle is valid (not NIL, not an error code).\n    ; Returns: Boolean\n)\n\n(DEFINE_PRIMITIVE HAS_QA_ISSUES (qa_assessment_map)\n    ; Checks if a QA assessment map indicates issues (checks the 'has_issues' key).\n    ; Returns: Boolean\n)\n\n(DEFINE_PRIMITIVE IS_STATUS_FAILURE (status_code_or_value)\n    ; Checks if the input is one of the defined ALANG_STATUS_FAILURE_... codes.\n    ; Returns: Boolean\n)\n\n(DEFINE_PRIMITIVE GET_ERROR_MESSAGE (error_object)\n    ; Extracts the error message from an error object (assuming a standard structure).\n    ; Returns: String\n)\n\n(DEFINE_PRIMITIVE STRING_SPLIT (text delimiter)\n    ; Splits a string by a delimiter.\n    ; Returns: List of strings\n)\n\n(DEFINE_PRIMITIVE GT (num1 num2)\n    ; Checks if num1 is greater than num2.\n    ; Returns: Boolean\n)\n\n(DEFINE_PRIMITIVE LT (num1 num2)\n    ; Checks if num1 is less than num2.\n    ; Returns: Boolean\n)\n\n(DEFINE_PRIMITIVE GTE (num1 num2)\n    ; Checks if num1 is greater than or equal to num2.\n    ; Returns: Boolean\n)\n\n(DEFINE_PRIMITIVE NEQ (val1 val2)\n    ; Checks if val1 is not equal to val2.\n    ; Returns: Boolean\n)\n\n(DEFINE_PRIMITIVE EQ (val1 val2)\n    ; Checks if val1 is equal to val2.\n    ; Returns: Boolean\n)\n\n(DEFINE_PRIMITIVE INIT_PROJECT_STATE (project_id project_description master_plan_handle_optional)\n    ; Orchestrator: Initializes the project state, including setting proj.id, proj.title, etc.\n    ; Returns: ALANG_STATUS_CODE\n)\n\n(DEFINE_PRIMITIVE LOOP_FOR_EACH (variable list body)\n    ; Iterates over a list, binding each item to a variable.\n    ; Returns: ALANG_STATUS_CODE\n)\n\n(DEFINE_PRIMITIVE SEQ (expression ...)\n    ; Executes expressions sequentially.\n    ; Returns: The result of the last expression.\n)\n\n(DEFINE_PRIMITIVE IF (condition true_branch (false_branch_optional))\n    ; Conditional execution.\n    ; Returns: The result of the executed branch.\n)\n\n(DEFINE_PRIMITIVE LET ((variable value) ...) body)\n    ; Binds variables to values locally within the body.\n    ; Returns: The result of the body.\n)\n\n(DEFINE_PRIMITIVE CALL_PROCEDURE (procedure_name arg ...))\n    ; Calls another procedure.\n    ; Returns: The result of the called procedure.\n)\n\n(DEFINE_PRIMITIVE RETURN_STATUS (status_code_or_result_object)\n    ; Returns a status code or a structured result object from a procedure.\n    ; Returns: ALANG_STATUS_CODE or StructuredResultObject\n)\n\n(DEFINE_PRIMITIVE ALANG_STATUS_PAUSE_FOR_USER_INPUT ())\n    ; Special status code indicating the ALang execution should pause and wait for user input.\n    ; Returns: ALANG_STATUS_CODE\n\n(DEFINE_PRIMITIVE LOOP_WHILE (condition body)\n    ; Executes body repeatedly as long as condition is true.\n    ; Returns: ALANG_STATUS_CODE (e.g., ALANG_STATUS_SUCCESS or status of last body execution if it returns failure)\n)\n\n(DEFINE_PRIMITIVE GET_ALANG_CORE_DIRECTIVES_HANDLE ()\n    ; Orchestrator: Provides a handle to the current, in-memory Autologos Core Directives document.\n    ; Returns: Handle\n)\n\n(DEFINE_PRIMITIVE GET_EVOLUTION_BACKLOG_ITEMS ()\n    ; Orchestrator: Retrieves a list of evolution backlog items from the loaded backlog.\n    ; Returns: List of Maps (representing backlog items) or NIL/empty list on failure/empty.\n)\n\n(DEFINE_PRIMITIVE PROPOSE_CORE_LOGIC_VERSION_INCREMENT (current_version changes_summary)\n    ; Orchestrator: Proposes a new MAJOR.MINOR.PATCH version number based on current version and summary of changes.\n    ; Returns: StructuredResultObject ({status: ALANG_STATUS_SUCCESS, data: {proposed_version: string, rationale: string}}) or failure.\n)\n\n(DEFINE_PRIMITIVE APPLY_CORE_LOGIC_CHANGES (proposed_changes_handle)\n    ; Orchestrator: Applies pending changes (represented by proposed_changes_handle) to the in-memory Core Logic.\n    ; The proposed_changes_handle points to a structured artifact (e.g., JSON) defining the changes.\n    ; Structure: { version_increment_type: \"patch\"|\"minor\"|\"major\", changes: [{type: \"add\"|\"modify\"|\"remove\", target: \"principle\"|\"directive\"|\"alang_procedure\", id: string, details: map}] } (NEW conceptual structure)\n    ; Returns: ALANG_STATUS_CODE.\n)\n\n(DEFINE_PRIMITIVE GET_PROPOSED_CORE_LOGIC_CHANGES_HANDLE ()\n    ; Orchestrator: Provides a handle to pending, unapplied Core Logic changes.\n    ; Returns: Handle or NIL if no pending changes.\n)\n\n(DEFINE_PRIMITIVE CLEAR_PENDING_CORE_LOGIC_CHANGES ()\n    ; Orchestrator: Clears any pending, unapplied Core Logic changes.\n    ; Returns: ALANG_STATUS_CODE.\n)\n\n(DEFINE_PRIMITIVE GET_QA_ASSESSMENT_SUMMARY (qa_report_handle)\n    ; Orchestrator: Provides a summary of findings from a QA report artifact.\n    ; Returns: StructuredResultObject ({status: ALANG_STATUS_SUCCESS, data: {has_substantive_issues: bool, summary_text: string}}) or failure.\n)\n\n(DEFINE_PRIMITIVE STRING_TRIM (text)\n    ; Orchestrator: Removes leading and trailing whitespace from a string. (NEW)\n    ; Returns: String\n)\n\n(DEFINE_PRIMITIVE CHECK_FOR_SUBSTANTIVE_ISSUES (qa_report_handle)\n    ;; Orchestrator: Checks a QA report artifact for substantive issues. (NEW)\n    ;; Reads the report and determines if issues requiring revision were found.\n    ;; Returns: Boolean (TRUE if substantive issues found, FALSE otherwise)\n    (LOG_EVENT \"SYSTEM\" (STRING_CONCAT \"Checking QA report \" (GET_HANDLE_METADATA qa_report_handle \"id\") \" for substantive issues.\"))\n    (LET ((assessmentResult (GET_QA_ASSESSMENT_SUMMARY qa_report_handle))))\n    (IF (EQ (GET_STATUS assessmentResult) ALANG_STATUS_SUCCESS)\n        (RETURN_STATUS (MAP_GET_VALUE (GET_DATA assessmentResult) \"has_substantive_issues\" FALSE))\n        (SEQ\n            (LOG_EVENT \"SYSTEM_ERROR\" \"Failed to get QA assessment summary to check for substantive issues.\")\n            (RETURN_STATUS TRUE) ; Assume issues if assessment fails\n        )\n    )\n)\n\n;; --- Conceptual Model Primitives (NEW) ---\n;; These represent operations on the session conceptual model.\n;; The session conceptual model is conceptually a directed graph where nodes represent concepts (patterns, entities, ideas, tasks, artifacts, issues, etc.)\n;; and edges represent relationships between them. Nodes and edges have properties (e.g., type, description, source, confidence, status).\n;; Φ maximization is operationalized by increasing the density, consistency, and relevance of the graph structure relative to the project goals.\n;; Node Types: Concept, Pattern, Entity, DataPoint, Artifact, ToolResult, Error, ToolLimitation, DataIssue, Idea, Feedback, Instruction, OutlineSection, Task, PKA, Issue, Correction, RevisionPlan.\n;; Edge Types: Mentions, RelatesTo, SourceOf, Supports, CausedBy, Affects, IndicatesLimitationOf, Defines, Describes, PartOf, GeneratedFrom, AddressesTask, Contains, SupportsClaim, RelevantTo, IdentifiesIssueIn, ProposesCorrectionFor, BasedOn, Resolves.\n;; Common Properties: id (unique), type (node/edge type), properties (map of key-value pairs), source (origin of info, e.g., user, tool, artifact ID), timestamp, confidence (0.0-1.0), status (e.g., active, resolved, uncertain, needs_review).\n;; Φ-related Conceptual Properties (NEW):\n;; - `confidence`: (0.0-1.0) Confidence in the accuracy/fidelity of this node/edge's representation of reality or the pattern model.\n;; - `source_fidelity`: (e.g., \"high\", \"medium\", \"low\") Assessed fidelity of the source of this information.\n;; - `phi_contribution`: (conceptual metric) Estimated contribution of this node/edge to the overall Φ of the model (density, consistency, relevance).\n(DEFINE_PRIMITIVE ADD_CONCEPT_NODE (node_details_map session_model_handle)\n    ;; Orchestrator: Adds a node to the session conceptual model graph.\n    ;; node_details_map: {id: string, type: string, properties: map} (e.g., {id: \"concept:autaxys\", type: \"Concept\", properties: {name: \"Autaxys\", description: \"...\", confidence: 1.0, source: \"user_input\", timestamp: \"...\", phi_contribution: \"...\"}})\n    ;; Returns: ALANG_STATUS_CODE\n    (LOG_EVENT \"CONCEPTUAL_MODEL_ACTION\" (STRING_CONCAT \"Add Node: \" (MAP_GET_VALUE node_details_map \"id\") \" (\" (MAP_GET_VALUE node_details_map \"type\") \")\"))\n    ; Orchestrator implementation would add this node to the graph structure.\n    (RETURN_STATUS ALANG_STATUS_SUCCESS) ; Placeholder\n)\n\n(DEFINE_PRIMITIVE ADD_RELATIONSHIP_EDGE (edge_details_map session_model_handle)\n    ;; Orchestrator: Adds a directed edge between nodes in the session conceptual model graph.\n    ;; edge_details_map: {from: string, to: string, type: string, properties: map} (e.g., {from: \"artifact:ideas\", to: \"concept:autaxys\", type: \"Mentions\", properties: {strength: 0.8, source: \"artifact:ideas\", timestamp: \"...\", phi_contribution: \"...\"}})\n    ;; Returns: ALANG_STATUS_CODE\n    (LOG_EVENT \"CONCEPTUAL_MODEL_ACTION\" (STRING_CONCAT \"Add Edge: \" (MAP_GET_VALUE edge_details_map \"type\") \" from \" (MAP_GET_VALUE edge_details_map \"from\") \" to \" (MAP_GET_VALUE edge_details_map \"to\")))\n    ; Orchestrator implementation would add this edge to the graph structure.\n    (RETURN_STATUS ALANG_STATUS_SUCCESS) ; Placeholder\n)\n\n(DEFINE_PRIMITIVE UPDATE_NODE_PROPERTIES (node_id properties_map session_model_handle)\n    ;; Orchestrator: Updates properties of an existing node in the session conceptual model graph.\n    ;; properties_map: map of properties to update.\n    ;; Returns: ALANG_STATUS_CODE\n    (LOG_EVENT \"CONCEPTUAL_MODEL_ACTION\" (STRING_CONCAT \"Update Node Properties: \" node_id))\n    ; Orchestrator implementation would update properties of the specified node.\n    (RETURN_STATUS ALANG_STATUS_SUCCESS) ; Placeholder\n)\n\n(DEFINE_PRIMITIVE UPDATE_EDGE_PROPERTIES (from_node_id to_node_id edge_type properties_map session_model_handle)\n    ;; Orchestrator: Updates properties of an existing edge in the session conceptual model graph. (NEW)\n    ;; Returns: ALANG_STATUS_CODE\n    (LOG_EVENT \"CONCEPTUAL_MODEL_ACTION\" (STRING_CONCAT \"Update Edge Properties: \" edge_type \" from \" from_node_id \" to \" to_node_id))\n    ; Orchestrator implementation would update properties of the specified edge.\n    (RETURN_STATUS ALANG_STATUS_SUCCESS) ; Placeholder\n)\n\n(DEFINE_PRIMITIVE FLAG_NODE (node_id flag_name value session_model_handle)\n    ;; Orchestrator: Sets a flag (a specific type of property) on a node in the session conceptual model graph.\n    ;; Returns: ALANG_STATUS_CODE\n    (LOG_EVENT \"CONCEPTUAL_MODEL_ACTION\" (STRING_CONCAT \"Flag Node: \" node_id \" - \" flag_name \" = \" value))\n    ; Orchestrator implementation would set a specific property/flag on the node.\n    (RETURN_STATUS ALANG_STATUS_SUCCESS) ; Placeholder\n)\n\n(DEFINE_PRIMITIVE GET_NODE_DETAILS (node_id session_model_handle)\n    ;; Orchestrator: Retrieves details (including properties and type) of a node from the session conceptual model graph.\n    ;; Returns: StructuredResultObject ({status: ALANG_STATUS_SUCCESS, data: node_details_map}) or failure/NIL.\n    (LOG_EVENT \"CONCEPTUAL_MODEL_ACTION\" (STRING_CONCAT \"Get Node Details: \" node_id))\n    ; Orchestrator implementation would query the graph and return node data.\n    (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_SUCCESS) (\"data\" (MAP_CREATE)))) ; Placeholder\n)\n\n(DEFINE_PRIMITIVE GET_RELATED_NODES (node_id relationship_type_optional session_model_handle)\n    ;; Orchestrator: Retrieves nodes related to a given node in the session conceptual model graph, optionally filtered by relationship type.\n    ;; Returns: StructuredResultObject ({status: ALANG_STATUS_SUCCESS, data: list_of_node_details_map}) or failure/empty list.\n    (LOG_EVENT \"CONCEPTUAL_MODEL_ACTION\" (STRING_CONCAT \"Get Related Nodes for: \" node_id))\n    ; Orchestrator implementation would query the graph and return related node data.\n    (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_SUCCESS) (\"data\" (LIST_CREATE)))) ; Placeholder\n)\n\n(DEFINE_PRIMITIVE GET_NODES_BY_TYPE (node_type_string session_model_handle)\n    ;; Orchestrator: Retrieves all nodes of a specific type from the session conceptual model graph. (NEW)\n    ;; Returns: StructuredResultObject ({status: ALANG_STATUS_SUCCESS, data: list_of_node_details_map}) or failure/empty list.\n    (LOG_EVENT \"CONCEPTUAL_MODEL_ACTION\" (STRING_CONCAT \"Get Nodes by Type: \" node_type_string))\n    ; Orchestrator implementation would query the graph and return node data.\n    (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_SUCCESS) (\"data\" (LIST_CREATE)))) ; Placeholder\n)\n\n(DEFINE_PRIMITIVE GET_EDGES_BY_TYPE (edge_type_string session_model_handle)\n    ;; Orchestrator: Retrieves all edges of a specific type from the session conceptual model graph. (NEW)\n    ;; Returns: StructuredResultObject ({status: ALANG_STATUS_SUCCESS, data: list_of_edge_details_map}) or failure/empty list.\n    (LOG_EVENT \"CONCEPTUAL_MODEL_ACTION\" (STRING_CONCAT \"Get Edges by Type: \" edge_type_string))\n    ; Orchestrator implementation would query the graph and return edge data.\n    (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_SUCCESS) (\"data\" (LIST_CREATE)))) ; Placeholder\n)\n\n\n;; --- Section 2: Event Handler Procedures (Top-Level Entry Points) ---\n;; These procedures are the entry points for the orchestrator to invoke ALang logic in response to external events.\n\n(DEFINE_PROCEDURE OnSystemInit ()\n    ;; Called by the orchestrator when the system starts up.\n    (LOG_EVENT \"SYSTEM_INIT\" \"Autologos system initializing.\")\n    (SET_STATE sys.alang_core_logic_version (GET_CORE_LOGIC_VERSION))\n    (SET_STATE sys.alang_spec_version (GET_ALANG_SPEC_VERSION))\n    (SET_STATE sys.current_mode \"IDLE\")\n    (SET_STATE sys.error_level \"NONE\")\n    (SET_STATE sys.error_message NIL)\n    (SET_STATE sys.system_qa_status \"IDLE\") ; Initialize System QA status (NEW)\n    (SET_STATE session.qa_output_verbosity \"CONCISE\") ; Default verbosity\n    (SET_STATE session.output_detail \"STANDARD\") ; Default general output detail\n    (SET_STATE session.loop_stack (LIST_CREATE)) ; Initialize loop stack\n    (SET_STATE session.pending_user_action_details NIL) ; Initialize pending action details (NEW)\n    (SET_STATE session.last_search_results NIL) ; Initialize search results state (NEW)\n    (SET_STATE session.system_qa_context NIL) ; Initialize System QA context state (NEW)\n    (SET_STATE sys.proposed_changes_handle NIL) ; Initialize pending changes handle (NEW)\n    (CALL_PROCEDURE LoadEvolutionBacklog (GET_STATE sys.evolution_backlog_handle)) ; Load backlog from file/DB\n    (CALL_PROCEDURE LoadPersistentKnowledgeBase (GET_STATE sys.knowledge_base_handle)) ; Load PKA from store\n    ; Initialize session-specific conceptual model handle (Principle 0.V.6) for the duration of the session/project\n    ; This handle points to a structured data artifact representing the session's knowledge graph.\n    (SET_STATE session.conceptual_model_handle (CREATE_EMPTY_ARTIFACT \"SessionConceptualModel\")) ; Conceptual handle for session model\n    (OUTPUT_TO_USER_BUFFER \"AI_THOUGHTS\" \"Autologos System Initialized. ALang v1.12.\" NIL) ; Updated version message\n    (FLUSH_USER_BUFFER)\n    (RETURN_STATUS ALANG_STATUS_SUCCESS)\n)\n\n(DEFINE_PROCEDURE OnUserInput (raw_text)\n    ;; Called by the orchestrator when the user provides input.\n    (LOG_EVENT \"USER_INPUT_RECEIVED\" raw_text)\n    (SET_STATE session.last_user_input_raw raw_text)\n\n    ; Check if there's a pending user action requiring specific input handling\n    (LET ((pendingAction (GET_STATE session.pending_user_action)))\n        (IF (NOT (IS_NIL pendingAction))\n            (SEQ\n                (OUTPUT_TO_USER_BUFFER \"AI_THOUGHTS\" (STRING_CONCAT \"Handling pending action: \" pendingAction) NIL)\n                ; Dispatch to a specific handler for the pending action\n                (CALL_PROCEDURE HandlePendingUserAction pendingAction raw_text) ; NEW procedure to handle pending actions\n            )\n            (SEQ\n                ; No pending action, process as a new command\n                ; Process the raw user input to potentially update the session conceptual model before parsing command (Principle 0.V.6)\n                (CALL_PROCEDURE ProcessUserInputForConceptualModel raw_text (GET_STATE session.conceptual_model_handle)) ; Update conceptual model based on raw input\n\n                (LET ((parsedCmdResult (CALL_PROCEDURE ParseUserCommand raw_text (GET_STATE session.conceptual_model_handle)))) ; Pass conceptual model to parser\n                    (IF (EQ (GET_STATUS parsedCmdResult) ALANG_STATUS_SUCCESS)\n                        (LET ((cmdDetails (GET_DATA parsedCmdResult)))\n                            (SET_STATE session.parsed_command_details cmdDetails)\n                            (CALL_PROCEDURE DispatchUserCommand cmdDetails)\n                        )\n                        (SEQ\n                            (SET_ERROR_STATE \"USER_ERROR\" \"Could not understand input.\")\n                            (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL)\n                        )\n                    )\n                )\n            )\n        )\n    )\n\n    (FLUSH_USER_OUTPUT_BUFFER)\n    (CALL_PROCEDURE ClearTurnSpecificSessionState) ; Clear turn-specific interaction data\n\n    ; Check if a System QA cycle is pending after user input handling (Principle 17, Section 3)\n    ; This check should happen *after* the user input has been fully processed, including pending actions.\n    (IF (GET_STATE sys.evolution_trigger_pending)\n        (SEQ\n             (SET_STATE sys.evolution_trigger_pending FALSE) ; Reset the flag\n             (CALL_PROCEDURE ExecuteSystemQAAndEvolutionCycle) ; Initiate the cycle\n        )\n    )\n    (RETURN_STATUS ALANG_STATUS_SUCCESS) ; OnUserInput itself succeeded in processing the event\n)\n\n(DEFINE_PROCEDURE OnToolSuccess (job_id result_handle original_success_proc_name context)\n    ;; Called by the orchestrator when an asynchronous tool call completes successfully.\n    (LOG_EVENT \"TOOL_SUCCESS\" (STRING_CONCAT \"Tool \" (MAP_GET_VALUE context \"tool_id\") \" completed successfully. Job ID: \" job_id)) ; Use tool_id from context (NEW)\n    ; Process tool result and potentially update session.conceptual_model_handle (Principle 0.V.6, 10.f)\n    (CALL_PROCEDURE ProcessToolResultForConceptualModel (MAP_GET_VALUE context \"tool_id\") result_handle (GET_STATE session.conceptual_model_handle) context) ; Update conceptual model, pass tool_id from context\n\n    (CALL_PROCEDURE original_success_proc_name job_id result_handle (MAP_GET_VALUE context \"pass_through_context\")) ; Call the specified callback, pass original context (NEW)\n    (RETURN_STATUS ALANG_STATUS_SUCCESS)\n)\n\n(DEFINE_PROCEDURE OnToolFailure (job_id error_details original_failure_proc_name context)\n    ;; Called by the orchestrator when an asynchronous tool call fails.\n    (LOG_EVENT \"TOOL_FAILURE\" (STRING_CONCAT \"Tool \" (MAP_GET_VALUE context \"tool_id\") \" failed. Job ID: \" job_id)) ; Use tool_id from context (NEW)\n    (SET_ERROR_STATE \"TOOL_ERROR\" (MAP_GET_VALUE error_details \"message\"))\n    ; Invoke the enhanced error handling protocol (Section 5.C)\n    ; This procedure will handle user interaction for resolution or attempt self-correction\n    ; Pass original success/failure callbacks and context so HandleToolError can retry with them.\n    ; Pass the full original context map to HandleToolError (NEW)\n    (CALL_PROCEDURE HandleToolError (MAP_GET_VALUE context \"tool_id\") job_id error_details context) ; Handle tool error\n\n    ; Note: original_failure_proc_name might still be called by HandleToolError's logic\n    ; or might be superseded by the error handling flow.\n    (RETURN_STATUS ALANG_STATUS_SUCCESS) ; OnToolFailure itself succeeded in handling the event\n)\n\n(DEFINE_PROCEDURE ProcessToolResultForConceptualModel (tool_id result_handle session_model_handle context)\n    ;; Conceptual procedure to process tool results and update the session-specific conceptual model (Principle 0.V.6, 10.f).\n    ;; This procedure reads the tool result and integrates relevant patterns, concepts, and data points into the session.conceptual_model_handle.\n    ;; It identifies nodes/edges to add or update based on the tool output, aiming to increase Φ related to the tool's domain.\n    ;; It should also assess the confidence/fidelity of the information from the tool.\n    (OUTPUT_TO_USER_BUFFER \"AI_THOUGHTS\" (STRING_CONCAT \"Processing tool result from \" tool_id \" to update session conceptual model...\") NIL)\n    ; This procedure would:\n    ; 1. Read and interpret the tool result (e.g., browsed text, search results, data analysis output), potentially using LLM and the session model as context.\n    ; 2. Identify relevant patterns, concepts, entities, or relationships within the result.\n    ; 3. Assess the confidence/fidelity of the information based on the tool's known reliability, the result format, etc.\n    ; 4. Use primitives like `UPDATE_CONCEPTUAL_MODEL` (conceptual) to add/modify nodes and edges in the structured data artifact pointed to by session_model_handle.\n    ;    - Node Types: \"Concept\", \"Entity\", \"DataPoint\", \"Artifact\", \"ToolResult\".\n    ;    - Edge Types: \"Mentions\", \"RelatesTo\", \"SourceOf\", \"Supports\".\n    ;    - Properties: `source_tool`, `source_job_id`, `confidence`, `source_fidelity`, `phi_contribution`, `timestamp`.\n    ; 5. Log the source of the update (tool_id, result_handle).\n    (LOG_EVENT \"CONCEPTUAL_PROCESS\" (STRING_CONCAT \"Processing tool result for conceptual model: \" tool_id))\n    ; Example conceptual call structure:\n    ; (LET ((toolOutputContentResult (READ_CONTENT result_handle \"text_summary_or_full\" NIL))))\n    ; (IF (EQ (GET_STATUS toolOutputContentResult) ALANG_STATUS_SUCCESS)\n    ;     (LET ((toolOutputContent (GET_DATA toolOutputContentResult))))\n    ;     (LET ((analysisResult (INVOKE_CORE_LLM_GENERATION\n    ;                              (MAP_CREATE (\"template\" PROMPT_TEMPLATE_ANALYZE_FOR_CONCEPTUAL_MODEL_UPDATE) ; Use specific analysis template (NEW)\n    ;                                          (\"content\" toolOutputContent)\n    ;                                          (\"source_type\" \"tool_result\")\n    ;                                          (\"source_id\" (GET_HANDLE_METADATA result_handle \"id\")) ; Use result handle ID\n    ;                                          (\"tool_id\" tool_id)\n    ;                                          (\"context\" context) ; Provide original tool context\n    ;                                          (\"session_model_handle\" session_model_handle)) ; Provide session model handle as context\n    ;                              (GET_LLM_PARAMS_FOR_TASK \"conceptual_model_analysis\")\n    ;                           ))))\n    ;     (IF (EQ (GET_STATUS analysisResult) ALANG_STATUS_SUCCESS)\n    ;         (LET ((updateData (GET_DATA analysisResult)))) ; Expects structured data for UPDATE_CONCEPTUAL_MODEL\n    ;         ; Validate updateData structure before applying (Principle 0.V.6)\n    ;         (LET ((validationResult (VALIDATE_DATA updateData CONSTRAINT_SET_CONCEPTUAL_MODEL_UPDATE_STRUCTURE)))) ; Use specific constraints (NEW)\n    ;         (IF (EQ validationResult ALANG_STATUS_SUCCESS)\n    ;             (CALL_PROCEDURE UPDATE_CONCEPTUAL_MODEL updateData)\n    ;             (LOG_EVENT \"SYSTEM_ERROR\" \"Conceptual model update data from tool result analysis failed validation.\")\n    ;         )\n    ;     )\n    ; )\n    (RETURN_STATUS ALANG_STATUS_SUCCESS) ; Conceptual procedure always returns success\n)\n\n;; --- Tool Callback Handlers ---\n(DEFINE_PROCEDURE HandleBrowseResult (job_id result_handle context)\n    ;; Callback for successful browse tool execution.\n    (LET ((browseContentResult (READ_CONTENT result_handle \"text_summary_or_full\" NIL)))\n        (IF (EQ (GET_STATUS browseContentResult) ALANG_STATUS_SUCCESS)\n            (SEQ\n                (OUTPUT_TO_USER_BUFFER \"AI_PROVIDE_DATA\" \"Browsed Content:\" NIL)\n                (OUTPUT_TO_USER_BUFFER \"AI_PROVIDE_DATA\" (GET_DATA browseContentResult) NIL)\n                ; After output, process this content to update the conceptual model (Principle 0.V.6, 10.f)\n                (CALL_PROCEDURE ProcessToolResultForConceptualModel \"browse\" result_handle (GET_STATE session.conceptual_model_handle) context) ; Use the new conceptual procedure, pass original context\n            )\n            (SEQ\n                (SET_ERROR_STATE \"TOOL_ERROR\" \"Failed to read browsed content.\")\n                (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL)\n            )\n        )\n    )\n    (RETURN_STATUS ALANG_STATUS_SUCCESS)\n)\n\n(DEFINE_PROCEDURE HandleBrowseError (job_id error_details context)\n    ;; Callback for failed browse tool execution.\n    (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (STRING_CONCAT \"Browse tool error: \" (MAP_GET_VALUE error_details \"message\")) NIL)\n    ; The error handling protocol is now initiated by OnToolFailure, which calls HandleToolError.\n    ; This specific handler might still be called by the orchestrator, but its primary role is reporting.\n    ; The heavy lifting of resolution is in HandleToolError.\n    (RETURN_STATUS ALANG_STATUS_FAILURE_TOOL_ERROR)\n)\n\n(DEFINE_PROCEDURE HandleReferenceValidationSuccess (job_id result_handle context)\n    ;; Callback for successful reference validation.\n    (LET ((validationReportResult (READ_CONTENT result_handle \"json_map\" NIL)))\n        (IF (EQ (GET_STATUS validationReportResult) ALANG_STATUS_SUCCESS)\n            (LET ((validationReport (GET_DATA validationReportResult)))\n                (IF (EQ (MAP_GET_VALUE validationReport \"is_valid\") TRUE)\n                    (OUTPUT_TO_USER_BUFFER \"AI_THOUGHTS\" \"Reference validated successfully.\" NIL)\n                    (OUTPUT_TO_USER_BUFFER \"AI_THOUGHTS\" (STRING_CONCAT \"Reference validation failed: \" (MAP_GET_VALUE validationReport \"reason\")) NIL)\n                )\n                 ; Process validation result for conceptual model (e.g., confidence in reference data, Principle 0.V.6)\n                (CALL_PROCEDURE ProcessToolResultForConceptualModel \"reference_validator\" result_handle (GET_STATE session.conceptual_model_handle) context) ; Pass original context\n            )\n            (SEQ\n                (SET_ERROR_STATE \"TOOL_ERROR\" \"Failed to read reference validation report.\")\n                (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL)\n            )\n        )\n    )\n    (RETURN_STATUS ALANG_STATUS_SUCCESS)\n)\n\n(DEFINE_PROCEDURE HandleReferenceValidationError (job_id error_details context)\n    ;; Callback for failed reference validation.\n    (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (STRING_CONCAT \"Reference validation tool error: \" (MAP_GET_VALUE error_details \"message\")) NIL)\n    ; The error handling protocol is now initiated by OnToolFailure, which calls HandleToolError.\n    ; This specific handler might still be called by the orchestrator, but its primary role is reporting.\n    ; The heavy lifting of resolution is in HandleToolError.\n    (RETURN_STATUS ALANG_STATUS_FAILURE_TOOL_ERROR)\n)\n\n(DEFINE_PROCEDURE HandleToolError (tool_id job_id error_details context)\n    ;; Handles tool errors using the enhanced protocol (Section 5.C).\n    ;; Attempts automated self-correction first, then escalates to user if needed.\n    ;; Uses the session conceptual model for context during analysis and resolution.\n    (OUTPUT_TO_USER_BUFFER \"AI_PRESENT_THOUGHTS\" (STRING_CONCAT \"Tool error detected for \" tool_id \".\") NIL)\n    (OUTPUT_TO_USER_BUFFER \"AI_PRESENT_THOUGHTS\" (STRING_CONCAT \"Job ID: \" job_id \". Error details: \" (MAP_GET_VALUE error_details \"message\" \"N/A\")) NIL)\n\n    ; Log the error in the conceptual model (Principle 13)\n    (CALL_PROCEDURE ProcessToolErrorForConceptualModel tool_id error_details (GET_STATE session.conceptual_model_handle)) ; Conceptual call\n\n    ; Attempt automated self-correction (Section 5.C.2)\n    (OUTPUT_TO_USER_BUFFER \"AI_PRESENT_THOUGHTS\" \"Analyzing error and attempting automated fix now...\" NIL)\n    (LET ((selfCorrectionResult (SelfCorrectToolOperation tool_id job_id error_details context (GET_STATE session.conceptual_model_handle))))) ; Pass session model handle\n\n    (IF (EQ (GET_STATUS selfCorrectionResult) ALANG_STATUS_SUCCESS)\n        (SEQ\n            (OUTPUT_TO_USER_BUFFER \"AI_PRESENT_THOUGHTS\" \"Automated fix successful. Tool re-invoked.\" NIL)\n            ; The original callback (success or failure) will be called for the new job ID.\n            (RETURN_STATUS ALANG_STATUS_SUCCESS) ; Self-correction initiated successfully\n        )\n        (SEQ\n            (OUTPUT_TO_USER_BUFFER \"AI_PRESENT_THOUGHTS\" \"Automated fix failed or not possible.\" NIL)\n            ; Log the failure of self-correction attempt (Principle 13)\n            (LOG_EVENT \"TOOL_SELF_CORRECTION_FAILED_FINAL\" tool_id error_details)\n\n            ; Escalate to user for manual resolution (Section 5.C.4)\n            ; Analyze the error details and context to provide a clear explanation to the user (NEW)\n            (LET ((analysisResult (INVOKE_CORE_LLM_GENERATION\n                                     (MAP_CREATE (\"template\" PROMPT_TEMPLATE_ANALYZE_TOOL_ERROR_USER_EXPLANATION) ; Use specific template for user explanation (NEW)\n                                                 (\"error_details\" error_details)\n                                                 (\"tool_id\" tool_id)\n                                                 (\"original_context\" context)\n                                                 (\"session_model_handle\" (GET_STATE session.conceptual_model_handle)) ; Pass handle for context\n                                                 (\"output_format\" \"user_explanation\")) ; Request user-friendly format (NEW)\n                                     (GET_LLM_PARAMS_FOR_TASK \"error_explanation\") ; Use specific task type (NEW)\n                                  ))))\n            (LET ((userExplanation (IF (AND (EQ (GET_STATUS analysisResult) ALANG_STATUS_SUCCESS) (NOT (STRING_IS_EMPTY_OR_NULL (GET_DATA analysisResult)))) (GET_DATA analysisResult) \"Could not generate detailed explanation.\"))))\n                (OUTPUT_TO_USER_BUFFER \"AI_PRESENT_THOUGHTS\" (STRING_CONCAT \"To fix, I need user help. My analysis of problem: \" userExplanation) NIL) ; Use generated explanation\n                (OUTPUT_TO_USER_BUFFER \"AI_PRESENT_THOUGHTS\" \"Options:\" NIL)\n                ; Present options to user based on error type and current context (conceptual)\n                ; This needs more sophisticated logic based on the error_details and session context.\n                ; For now, list generic options.\n                (OUTPUT_TO_USER_BUFFER \"AI_PRESENT_THOUGHTS\" \"- Option 1: Provide correct input/parameters via `INPUT`.\" NIL)\n                (OUTPUT_TO_USER_BUFFER \"AI_PRESENT_THOUGHTS\" \"- Option 2: Skip the current data source / sub-task. (May require DoD override if vital - Principle 5)\" NIL)\n                (OUTPUT_TO_USER_BUFFER \"AI_PRESENT_THOUGHTS\" \"- Option 3: Retry current operation with no changes (if temporary external issue seems likely).\" NIL) ; Section 5.C.7.A check needed\n                (OUTPUT_TO_USER_BUFFER \"AI_PRESENT_THOUGHTS\" \"- Option 4: Stop current task / loop (using `STOP_LOOP` logic).\" NIL)\n                (OUTPUT_TO_USER_BUFFER \"AI_PRESENT_THOUGHTS\" \"Warning: If error not fixed, current operation cannot complete as planned. May affect overall project goals. Can use `SAVE PROJECT`.\" NIL) ; Principle 13, 5\n\n                (OUTPUT_TO_USER_BUFFER \"AI_REQUEST_CLARIFICATION_QUESTIONS\" \"`INPUT` choice (e.g., 'OPTION 1 ...', 'OPTION 2', etc.) or other instructions to fix.\" NIL)\n                ; Store context needed to handle the user's response (NEW)\n                (SET_STATE session.pending_user_action_details (MAP_CREATE (\"tool_id\" tool_id) (\"job_id\" job_id) (\"error_details\" error_details) (\"original_context\" context)))\n                (SET_STATE session.pending_user_action \"AWAIT_TOOL_ERROR_RESOLUTION\") ; Set pending action\n                (RETURN_STATUS ALANG_STATUS_PAUSE_FOR_USER_INPUT) ; Indicate pause for user\n            ) ; Close LET analysisResult\n        )\n    )\n)\n\n(DEFINE_PROCEDURE ProcessToolErrorForConceptualModel (tool_id error_details session_model_handle)\n    ;; Conceptual procedure to process tool error details and update the session-specific conceptual model (Principle 0.V.6, 13).\n    ;; This procedure analyzes error details to extract insights about tool limitations, data issues, or specific failure patterns\n    ;; and integrates them into the session conceptual model, potentially flagging concepts related to the failed operation.\n    ;; It identifies nodes/edges to add or update based on the error, aiming to capture system limitations and failure modes.\n    ;; It should also assess the impact of the error on the overall Φ of the model.\n    (OUTPUT_TO_USER_BUFFER \"AI_THOUGHTS\" (STRING_CONCAT \"Processing tool error details from \" tool_id \" to update session conceptual model...\") NIL)\n    ; This procedure would:\n    ; 1. Analyze error_details (potentially using LLM with session_model_handle).\n    ; 2. Identify patterns of failure, specific limitations encountered, or problematic data points.\n    ; 3. Assess the impact on related concepts/tasks in the conceptual model.\n    ; 4. Use primitives like `UPDATE_CONCEPTUAL_MODEL` (conceptual) to add/modify nodes (e.g., representing tool limitations, error types) and edges (e.g., linking the error to the task or data, flagging related concepts as potentially problematic).\n    ;    - Node Types: \"Error\", \"ToolLimitation\", \"DataIssue\".\n    ;    - Edge Types: \"CausedBy\", \"Affects\", \"IndicatesLimitationOf\".\n    ;    - Properties: `tool_id`, `job_id`, `error_message`, `severity`, `timestamp`, `phi_impact` (conceptual).\n    (LOG_EVENT \"CONCEPTUAL_PROCESS\" (STRING_CONCAT \"Processing tool error for conceptual model: \" tool_id))\n     ; Example conceptual call structure:\n    ; (LET ((sessionModelContentResult (READ_CONTENT session_model_handle \"structured_map\" NIL))))\n    ; (IF (EQ (GET_STATUS sessionModelContentResult) ALANG_STATUS_SUCCESS)\n    ;     (LET ((sessionModelContent (GET_DATA sessionModelContentResult))))\n    ;     (LET ((analysisResult (INVOKE_CORE_LLM_GENERATION\n    ;                              (MAP_CREATE (\"template\" PROMPT_TEMPLATE_ANALYZE_FOR_CONCEPTUAL_MODEL_UPDATE) ; Use specific analysis template (NEW)\n    ;                                          (\"content\" error_details) ; Analyze error details as content\n    ;                                          (\"source_type\" \"tool_error\")\n    ;                                          (\"source_id\" tool_id)\n    ;                                          (\"session_model\" sessionModelContent)) ; Provide session model handle as context\n    ;                              (GET_LLM_PARAMS_FOR_TASK \"conceptual_model_analysis\")\n    ;                           ))))\n    ;     (IF (EQ (GET_STATUS analysisResult) ALANG_STATUS_SUCCESS)\n    ;         (LET ((updateData (GET_DATA analysisResult)))) ; Expects structured data for UPDATE_CONCEPTUAL_MODEL\n    ;         ; Validate updateData structure before applying (Principle 0.V.6)\n    ;         (LET ((validationResult (VALIDATE_DATA updateData CONSTRAINT_SET_CONCEPTUAL_MODEL_UPDATE_STRUCTURE)))) ; Use specific constraints (NEW)\n    ;         (IF (EQ validationResult ALANG_STATUS_SUCCESS)\n    ;             (CALL_PROCEDURE UPDATE_CONCEPTUAL_MODEL updateData)\n    ;             (LOG_EVENT \"SYSTEM_ERROR\" \"Conceptual model update data from tool error analysis failed validation.\")\n    ;         )\n    ;     )\n    ; )\n    (RETURN_STATUS ALANG_STATUS_SUCCESS) ; Conceptual procedure always returns success\n)\n\n\n(DEFINE_PROCEDURE ProcessUserInputForConceptualModel (input_data session_model_handle)\n    ;; Conceptual procedure to process user input data and update the session-specific conceptual model (Principle 0.V.6).\n    ;; This procedure analyzes raw user input to extract relevant concepts, patterns, or feedback and integrates them into the session conceptual model.\n    ;; It identifies nodes/edges to add or update based on user input, aiming to incorporate user intent and knowledge and assess its confidence/relevance.\n    (OUTPUT_TO_USER_BUFFER \"AI_THOUGHTS\" \"Processing user input to update session conceptual model...\" NIL)\n    ; This procedure would:\n    ; 1. Interpret the user-provided data (text, JSON, etc.) in the context of the current session_model_handle, potentially using LLM.\n    ; 2. Identify relevant patterns, concepts, entities, or relationships within the data.\n    ; 3. Assess the confidence/relevance of the user input to the current project goals.\n    ; 4. Use primitives like `UPDATE_CONCEPTUAL_MODEL` (conceptual) to add/modify nodes and edges in the structured data artifact pointed to by session_model_handle.\n    ;    - Node Types: \"Concept\", \"Entity\", \"Idea\", \"Feedback\", \"Instruction\".\n    ;    - Edge Types: \"Mentions\", \"RelatesTo\", \"ProvidesFeedbackOn\", \"InstructsOn\".\n    ;    - Properties: `source_user`, `timestamp`, `confidence`, `sentiment`, `phi_contribution`.\n    (LOG_EVENT \"CONCEPTUAL_PROCESS\" \"Processing user input for conceptual model.\")\n    ; Example conceptual call structure:\n    ; (LET ((analysisResult (INVOKE_CORE_LLM_GENERATION\n    ;                          (MAP_CREATE (\"template\" PROMPT_TEMPLATE_ANALYZE_FOR_CONCEPTUAL_MODEL_UPDATE) ; Use specific analysis template (NEW)\n    ;                                      (\"content\" input_data)\n    ;                                      (\"source_type\" \"user_input\")\n    ;                                      (\"source_id\" \"N/A\") ; Or some identifier if available\n    ;                                      (\"session_model_handle\" session_model_handle)) ; Provide session model handle as context\n    ;                          (GET_LLM_PARAMS_FOR_TASK \"conceptual_model_analysis\")\n    ;                       ))))\n    ; (IF (EQ (GET_STATUS analysisResult) ALANG_STATUS_SUCCESS)\n    ;     (LET ((updateData (GET_DATA analysisResult)))) ; Expects structured data for UPDATE_CONCEPTUAL_MODEL\n    ;     ; Validate updateData structure before applying (Principle 0.V.6)\n    ;     (LET ((validationResult (VALIDATE_DATA updateData CONSTRAINT_SET_CONCEPTUAL_MODEL_UPDATE_STRUCTURE)))) ; Use specific constraints (NEW)\n    ;     (IF (EQ validationResult ALANG_STATUS_SUCCESS)\n    ;         (CALL_PROCEDURE UPDATE_CONCEPTUAL_MODEL updateData)\n    ;         (LOG_EVENT \"SYSTEM_ERROR\" \"Conceptual model update data from user input analysis failed validation.\")\n    ;     )\n    ; )\n    (RETURN_STATUS ALANG_STATUS_SUCCESS) ; Conceptual procedure always returns success\n)\n\n(DEFINE_PROCEDURE ProcessGeneratedArtifactForConceptualModel (artifact_handle artifact_type session_model_handle)\n    ;; Conceptual procedure to process a generated artifact and update the session-specific conceptual model (Principle 0.V.6).\n    ;; This procedure analyzes the content of newly generated artifacts (ideas, outlines, drafts, etc.)\n    ;; and integrates the patterns, concepts, and structure they represent into the session conceptual model.\n    ;; It identifies nodes/edges to add or update based on the artifact, aiming to integrate generated knowledge and assess its confidence/fidelity.\n    (OUTPUT_TO_USER_BUFFER \"AI_THOUGHTS\" (STRING_CONCAT \"Processing generated artifact (\" artifact_type \") to update session conceptual model...\") NIL)\n    ; This procedure would:\n    ; 1. Read and interpret the generated content from artifact_handle, potentially using LLM and the session model as context.\n    ; 2. Identify new patterns, concepts, entities, relationships, or refinements to existing ones.\n    ; 3. Assess the confidence/fidelity of the generated content based on QA results, generation parameters, etc.\n    ; 4. Use primitives like `UPDATE_CONCEPTUAL_MODEL` (conceptual) to add/modify nodes and edges in the structured data artifact pointed to by session_model_handle, linking them to the artifact source.\n    ;    - Node Types: \"Concept\", \"Pattern\", \"OutlineSection\", \"Task\", \"Artifact\".\n    ;    - Edge Types: \"Defines\", \"Describes\", \"PartOf\", \"GeneratedFrom\", \"AddressesTask\".\n    ;    - Properties: `artifact_type`, `artifact_id`, `confidence`, `source_fidelity`, `phi_contribution`, `timestamp`.\n    (LOG_EVENT \"CONCEPTUAL_PROCESS\" (STRING_CONCAT \"Processing generated artifact for conceptual model: \" artifact_type))\n     ; Example conceptual call structure:\n    ; (LET ((artifactContentResult (READ_CONTENT artifact_handle \"text_summary_or_full\" NIL))))\n    ; (IF (EQ (GET_STATUS artifactContentResult) ALANG_STATUS_SUCCESS)\n    ;     (LET ((artifactContent (GET_DATA artifactContentResult))))\n    ;     (LET ((analysisResult (INVOKE_CORE_LLM_GENERATION\n    ;                                  (MAP_CREATE (\"template\" PROMPT_TEMPLATE_ANALYZE_FOR_CONCEPTUAL_MODEL_UPDATE) ; Use specific analysis template (NEW)\n    ;                                              (\"content\" artifactContent)\n    ;                                              (\"source_type\" \"generated_artifact\")\n    ;                                              (\"source_id\" (GET_HANDLE_METADATA artifact_handle \"id\"))\n    ;                                              (\"artifact_type\" artifact_type)\n    ;                                              (\"session_model_handle\" session_model_handle)) ; Provide session model handle as context\n    ;                              (GET_LLM_PARAMS_FOR_TASK \"conceptual_model_analysis\")\n    ;                           ))))\n    ;     (IF (EQ (GET_STATUS analysisResult) ALANG_STATUS_SUCCESS)\n    ;         (LET ((updateData (GET_DATA analysisResult)))) ; Expects structured data for UPDATE_CONCEPTUAL_MODEL\n    ;         ; Validate updateData structure before applying (Principle 0.V.6)\n    ;         (LET ((validationResult (VALIDATE_DATA updateData CONSTRAINT_SET_CONCEPTUAL_MODEL_UPDATE_STRUCTURE)))) ; Use specific constraints (NEW)\n    ;         (IF (EQ validationResult ALANG_STATUS_SUCCESS)\n    ;             (CALL_PROCEDURE UPDATE_CONCEPTUAL_MODEL updateData)\n    ;             (LOG_EVENT \"SYSTEM_ERROR\" \"Conceptual model update data from generated artifact analysis failed validation.\")\n    ;         )\n    ;     )\n    ; )\n    (RETURN_STATUS ALANG_STATUS_SUCCESS) ; Conceptual procedure always returns success\n)\n\n(DEFINE_PROCEDURE IntegratePkaIntoConceptualModel (pka_id session_model_handle)\n    ;; Conceptual procedure to integrate a newly stored PKA into the session conceptual model (Principle 0.V.6, 8.B.v).\n    ;; This procedure links stored PKAs and their content/metadata into the session conceptual model,\n    ;; making long-term knowledge accessible and integrated with current project context.\n    ;; It identifies nodes/edges to add or update based on the PKA content, linking persistent knowledge to the session and assessing its confidence/relevance.\n    (OUTPUT_TO_USER_BUFFER \"AI_THOUGHTS\" (STRING_CONCAT \"Integrating new PKA \" pka_id \" into session conceptual model...\") NIL)\n    ; This procedure would:\n    ; 1. Retrieve the content/metadata of the new PKA (using PKA_GET_ARTIFACT and READ_CONTENT).\n    ; 2. Analyze it to understand its pattern claims/structure, potentially using LLM and the session model as context.\n    ; 3. Assess the confidence/relevance of the PKA content to the current project.\n    ; 4. Use primitives like `UPDATE_CONCEPTUAL_MODEL` (conceptual) to add a node for the PKA and link its concepts/patterns into the session_model_handle.\n    ;    - Node Types: \"PKA\", \"Concept\", \"Pattern\".\n    ;    - Edge Types: \"Contains\", \"RelatesTo\", \"SupportsClaim\".\n    ;    - Properties: `pka_id`, `title`, `schema_id`, `timestamp`, `confidence`, `phi_contribution`.\n    (LOG_EVENT \"CONCEPTUAL_PROCESS\" (STRING_CONCAT \"Integrating PKA into conceptual model: \" pka_id))\n     ; Example conceptual call structure:\n    ; (LET ((pkaArtifactHandle (PKA_GET_ARTIFACT pka_id))))\n    ; (IF (IS_HANDLE_VALID pkaArtifactHandle)\n    ;     (LET ((pkaContentResult (READ_CONTENT pkaArtifactHandle \"text_summary_or_full\" NIL))))\n    ;     (IF (EQ (GET_STATUS pkaContentResult) ALANG_STATUS_SUCCESS)\n    ;         (LET ((pkaContent (GET_DATA pkaContentResult))))\n    ;         (LET ((analysisResult (INVOKE_CORE_LLM_GENERATION\n    ;                                  (MAP_CREATE (\"template\" PROMPT_TEMPLATE_ANALYZE_FOR_CONCEPTUAL_MODEL_UPDATE) ; Use specific analysis template (NEW)\n    ;                                              (\"content\" pkaContent)\n    ;                                              (\"source_type\" \"pka\")\n    ;                                              (\"source_id\" pka_id)\n    ;                                              (\"session_model_handle\" session_model_handle)) ; Provide session model handle as context\n    ;                                  (GET_LLM_PARAMS_FOR_TASK \"conceptual_model_analysis\")\n    ;                               ))))\n    ;         (IF (EQ (GET_STATUS analysisResult) ALANG_STATUS_SUCCESS)\n    ;             (LET ((updateData (GET_DATA analysisResult)))) ; Expects structured data for UPDATE_CONCEPTUAL_MODEL\n    ;             ; Validate updateData structure before applying (Principle 0.V.6)\n    ;             (LET ((validationResult (VALIDATE_DATA updateData CONSTRAINT_SET_CONCEPTUAL_MODEL_UPDATE_STRUCTURE)))) ; Use specific constraints (NEW)\n    ;             (IF (EQ validationResult ALANG_STATUS_SUCCESS)\n    ;                 (CALL_PROCEDURE UPDATE_CONCEPTUAL_MODEL updateData)\n    ;                 (LOG_EVENT \"SYSTEM_ERROR\" \"Conceptual model update data from PKA integration analysis failed validation.\")\n    ;             )\n    ;         )\n    ;     )\n    ; )\n    (RETURN_STATUS ALANG_STATUS_SUCCESS) ; Conceptual procedure always returns success\n)\n\n(DEFINE_PROCEDURE ProcessPkaSearchResultsForConceptualModel (pka_result_handles session_model_handle)\n    ;; Conceptual procedure to process PKA search results and update the session conceptual model (Principle 8.B.v).\n    ;; This procedure integrates findings from PKA searches into the session conceptual model,\n    ;; enriching the current understanding with relevant persistent knowledge.\n    ;; It identifies nodes/edges to add or update based on search results, linking relevant PKAs to the session context and assessing their relevance.\n     (OUTPUT_TO_USER_BUFFER \"AI_THOUGHTS\" \"Processing PKA search results to update session conceptual model...\" NIL)\n    ; This procedure would:\n    ; 1. Iterate through the list of PKA handles/metadata from search results.\n    ; 2. Analyze metadata or content summaries (if available/needed), potentially using LLM and the session model as context.\n    ; 3. Assess the relevance of each search result to the current project context.\n    ; 4. Use primitives like `UPDATE_CONCEPTUAL_MODEL` (conceptual) to integrate relevant findings (concepts, patterns, relationships) into the session_model_handle,\n    ;    potentially linking them back to the source PKAs.\n    ;    - Node Types: \"PKA\", \"Concept\", \"Pattern\".\n    ;    - Edge Types: \"RelevantTo\", \"Mentions\", \"SupportsClaim\".\n    ;    - Properties: `pka_id`, `title`, `relevance_score`, `phi_contribution`.\\\n    (LOG_EVENT \"CONCEPTUAL_PROCESS\" \"Processing PKA search results for conceptual model.\")\n     ; Example conceptual call structure:\n    ; (LOOP_FOR_EACH pkaHandle pka_result_handles ; Assuming the list from PKA_QUERY contains handles or structured data\n    ;     ; If it's handles, need to read metadata/summary:\n    ;     (LET ((pkaId (GET_HANDLE_METADATA pkaHandle \"id\"))))\n    ;     (LET ((pkaTitle (GET_HANDLE_METADATA pkaHandle \"title\"))))\n    ;     (LET ((pkaSummaryResult (READ_CONTENT pkaHandle \"text_summary_or_full\" (MAP_CREATE (\"max_chars\" 500)))))) ; Read summary\n    ;     (LET ((pkaSummary (IF (EQ (GET_STATUS pkaSummaryResult) ALANG_STATUS_SUCCESS) (GET_DATA pkaSummaryResult) \"N/A\"))))\n    ;     (LET ((analysisResult (INVOKE_CORE_LLM_GENERATION\n    ;                                  (MAP_CREATE (\"template\" PROMPT_TEMPLATE_ANALYZE_FOR_CONCEPTUAL_MODEL_UPDATE) ; Use specific analysis template (NEW)\n    ;                                              (\"content\" (STRING_CONCAT \"PKA ID: \" pkaId \" Title: \" pkaTitle \" Summary: \" pkaSummary))\n    ;                                              (\"source_type\" \"pka_search_result\")\n    ;                                              (\"source_id\" pkaId)\n    ;                                              (\"session_model_handle\" session_model_handle)) ; Provide session model handle as context\n    ;                                  (GET_LLM_PARAMS_FOR_TASK \"conceptual_model_analysis\")\n    ;                               ))))\n    ;     (IF (EQ (GET_STATUS analysisResult) ALANG_STATUS_SUCCESS)\n    ;         (LET ((updateData (GET_DATA analysisResult)))) ; Expects structured data for UPDATE_CONCEPTUAL_MODEL\n    ;         ; Validate updateData structure before applying (Principle 0.V.6)\n    ;         (LET ((validationResult (VALIDATE_DATA updateData CONSTRAINT_SET_CONCEPTUAL_MODEL_UPDATE_STRUCTURE)))) ; Use specific constraints (NEW)\n    ;         (IF (EQ validationResult ALANG_STATUS_SUCCESS)\n    ;             (CALL_PROCEDURE UPDATE_CONCEPTUAL_MODEL updateData)\n    ;             (LOG_EVENT \"SYSTEM_ERROR\" \"Conceptual model update data from PKA search result analysis failed validation.\")\n    ;         )\n    ;     )\n    ; )\n    (RETURN_STATUS ALANG_STATUS_SUCCESS) ; Conceptual procedure always returns success\n)\n\n\n(DEFINE_PROCEDURE ProcessUserFeedbackForConceptualModel (feedback_text session_model_handle)\n    ;; Conceptual procedure to process user feedback and update the session-specific conceptual model (Principle 0.V.6, 5.B).\n    ;; This procedure interprets user feedback (e.g., \"This section is unclear\", \"Pattern X is wrong\")\n    ;; and uses it to refine the session conceptual model, flagging areas of uncertainty or proposing corrections.\n    ;; It identifies nodes/edges to add or update based on feedback, aiming to incorporate user corrections and insights and assess their impact on Φ.\n    (OUTPUT_TO_USER_BUFFER \"AI_THOUGHTS\" \"Processing user feedback to refine session conceptual model...\" NIL)\n    ; This procedure would:\n    ; 1. Interpret the feedback in the context of the last AI output or pending action, potentially using LLM and session_model_handle.\n    ; 2. Identify inaccuracies, inconsistencies, or areas needing refinement in the current pattern model represented by session_model_handle.\n    ; 3. Assess the impact of the feedback on the conceptual model's confidence and Φ.\n    ; 4. Use primitives like `UPDATE_CONCEPTUAL_MODEL` (conceptual) to update nodes/edges, add notes, or adjust confidence scores in the model.\n    ;    - Node Types: \"Feedback\", \"Issue\", \"Correction\".\n    ;    - Edge Types: \"RelatesTo\", \"IdentifiesIssueIn\", \"ProposesCorrectionFor\".\n    ;    - Properties: `source_user`, `timestamp`, `severity`, `description`, `phi_impact`.\n    (LOG_EVENT \"CONCEPTUAL_PROCESS\" \"Processing user feedback for conceptual model.\")\n    ; Example conceptual call structure:\n    ; (LET ((analysisResult (INVOKE_CORE_LLM_GENERATION\n    ;                          (MAP_CREATE (\"template\" PROMPT_TEMPLATE_ANALYZE_FOR_CONCEPTUAL_MODEL_UPDATE) ; Use specific analysis template (NEW)\n    ;                                      (\"content\" feedback_text)\n    ;                                      (\"source_type\" \"user_feedback\")\n    ;                                      (\"source_id\" \"N/A\")\n    ;                                      (\"session_model_handle\" session_model_handle)) ; Provide session model handle as context\n    ;                          (GET_LLM_PARAMS_FOR_TASK \"conceptual_model_analysis\")\n    ;                       ))))\n    ; (IF (EQ (GET_STATUS analysisResult) ALANG_STATUS_SUCCESS)\n    ;     (LET ((updateData (GET_DATA analysisResult)))) ; Expects structured data for UPDATE_CONCEPTUAL_MODEL\n    ;     ; Validate updateData structure before applying (Principle 0.V.6)\n    ;     (LET ((validationResult (VALIDATE_DATA updateData CONSTRAINT_SET_CONCEPTUAL_MODEL_UPDATE_STRUCTURE)))) ; Use specific constraints (NEW)\n    ;     (IF (EQ validationResult ALANG_STATUS_SUCCESS)\n    ;         (CALL_PROCEDURE UPDATE_CONCEPTUAL_MODEL updateData)\n    ;         (LOG_EVENT \"SYSTEM_ERROR\" \"Conceptual model update data from user feedback analysis failed validation.\")\n    ;     )\n    ; )\n    (RETURN_STATUS ALANG_STATUS_SUCCESS) ; Conceptual procedure always returns success\n)\n\n(DEFINE_PROCEDURE ProcessGeneratedArtifactForEvolution (artifact_handle artifact_type session_model_handle)\n    ;; Conceptual procedure to process a generated artifact (like summary) for evolution insights (Principle 17).\n    ;; This procedure extracts learnings and potential evolution suggestions from project outputs (e.g., summaries, logs)\n    ;; and logs them to the evolution backlog. It can use the session conceptual model to identify systemic patterns of difficulty or success.\n    ;; It analyzes the artifact and the conceptual model to identify systemic issues or learnings that suggest system improvements.\n    (OUTPUT_TO_USER_BUFFER \"AI_THOUGHTS\" (STRING_CONCAT \"Processing generated artifact (\" artifact_type \") for evolution insights...\") NIL)\n    ; This procedure would:\n    ; 1. Read and interpret the content (e.g., project summary, learnings), potentially using LLM.\n    ; 2. Analyze the content *and* the final state of the session conceptual model (Principle 17.vi) to identify explicit or implicit suggestions for improving Autologos, particularly regarding pattern modeling capabilities or workflow efficiency. This analysis should look for patterns of errors, low confidence areas, or difficulties reflected in the conceptual model.\n    ; 3. Use primitives like `CREATE_EVOLUTION_BACKLOG_ITEM` or `UPDATE_EVOLUTION_BACKLOG_ITEM` to log these insights.\n    ;    - Backlog Item Properties: `id`, `title`, `desc`, `source` (\"PROJECT_SUMMARY\", \"CONCEPTUAL_MODEL_ANALYSIS\"), `status`, `timestamp`, `reinforce_count`.\n    (LOG_EVENT \"CONCEPTUAL_PROCESS\" (STRING_CONCAT \"Processing generated artifact for evolution: \" artifact_type))\n     ; Example conceptual call structure:\n    ; (LET ((artifactContentResult (READ_CONTENT artifact_handle \"text_summary_or_full\" NIL))))\n    ; (LET ((sessionModelContentResult (READ_CONTENT session_model_handle \"structured_map\" NIL))))\n    ; (IF (AND (EQ (GET_STATUS artifactContentResult) ALANG_STATUS_SUCCESS)\n    ;          (EQ (GET_STATUS sessionModelContentResult) ALANG_STATUS_SUCCESS))\n    ;     (LET ((artifactContent (GET_DATA artifactContentResult))))\n    ;     (LET ((sessionModelContent (GET_DATA sessionModelContentResult))))\n    ;     (LET ((evolutionSuggestionsResult (INVOKE_CORE_LLM_GENERATION\n    ;                                        (MAP_CREATE (\"template\" PROMPT_TEMPLATE_ANALYZE_FOR_CONCEPTUAL_MODEL) ; Reuse analysis template or create specific one\n    ;                                                    (\"content\" artifactContent)\n    ;                                                    (\"source_type\" \"evolution_analysis\")\n    ;                                                    (\"artifact_type\" artifact_type)\n    ;                                                    (\"session_model_summary\" sessionModelContent) ; Pass summary/relevant parts of session model\n    ;                                                 ))\n    ;                                        (GET_LLM_PARAMS_FOR_TASK \"evolution_analysis\")\n    ;                                      ))))\n    ;     (IF (EQ (GET_STATUS evolutionSuggestionsResult) ALANG_STATUS_SUCCESS)\n    ;         (LET ((suggestionsList (GET_DATA evolutionSuggestionsResult)))) ; Expects structured list of suggestions\n    ;         (LOOP_FOR_EACH suggestion suggestionsList\n    ;             (CALL_PROCEDURE ProcessAndStoreEvolveSuggestion (MAP_GET_VALUE suggestion \"text\") (MAP_GET_VALUE suggestion \"source\"))) ; Log each suggestion\n    ;     )\n    ; )\n    (RETURN_STATUS ALANG_STATUS_SUCCESS) ; Conceptual procedure always returns success\n)\n\n\n;; --- Section 3: Command Dispatcher & Specific Command Handlers ---\n;; This section defines the DispatchUserCommand procedure and the handlers for specific user commands.\n\n(DEFINE_PROCEDURE DispatchUserCommand (commandDetails)\n    ;; Routes execution to the appropriate command handler based on the parsed command.\n    (LET ((commandName (MAP_GET_VALUE commandDetails \"command\")))\n        (IF (EQ commandName \"START\") (CALL_PROCEDURE HandleStartCommand (MAP_GET_VALUE commandDetails \"args\")))\n        (IF (EQ commandName \"HELP\") (CALL_PROCEDURE HandleHelpCommand (MAP_GET_VALUE commandDetails \"args\")))\n        (IF (EQ commandName \"EVOLVE\") (CALL_PROCEDURE HandleEvolveCommand (MAP_GET_VALUE commandDetails \"args\")))\n        (IF (EQ commandName \"SAVE_SYSTEM\") (CALL_PROCEDURE HandleSaveSystemCommand ()))\n        (IF (EQ commandName \"BROWSE\") (CALL_PROCEDURE HandleBrowseCommand (MAP_GET_VALUE commandDetails \"args\")))\n        (IF (EQ commandName \"OK\") (CALL_PROCEDURE HandleOkCommand ()))\n        (IF (EQ commandName \"NO\") (CALL_PROCEDURE HandleNoCommand (MAP_GET_VALUE commandDetails \"args\")))\n        (IF (EQ commandName \"INPUT\") (CALL_PROCEDURE HandleInputCommand (MAP_GET_VALUE commandDetails \"args\")))\n        (IF (EQ commandName \"END\") (CALL_PROCEDURE HandleEndCommand ()))\n        (IF (EQ commandName \"LOOP_PROJECT_RESTART\") (CALL_PROCEDURE HandleLoopProjectRestartCommand ()))\n        (IF (EQ commandName \"SET_SESSION_PREFERENCE\") (CALL_PROCEDURE HandleSetSessionPreferenceCommand (MAP_GET_VALUE commandDetails \"args\")))\n        (IF (EQ commandName \"STOP_LOOP\") (CALL_PROCEDURE HandleStopLoopCommand ()))\n        (IF (EQ commandName \"OUTPUT\") (CALL_PROCEDURE HandleOutputCommand (MAP_GET_VALUE commandDetails \"args\")))\n        (IF (EQ commandName \"SUMMARIZE\") (CALL_PROCEDURE HandleSummarizeCommand (MAP_GET_VALUE commandDetails \"args\")))\n        (IF (EQ commandName \"QUERY\") (CALL_PROCEDURE HandleQueryCommand (MAP_GET_VALUE commandDetails \"args\")))\n        (IF (EQ commandName \"OUTPUT_BACKLOG\") (CALL_PROCEDURE HandleOutputBacklogCommand (MAP_GET_VALUE commandDetails \"args\")))\n        (IF (EQ commandName \"PROMOTE_TO_PKA\") (CALL_PROCEDURE HandlePromoteToPkaCommand (MAP_GET_VALUE commandDetails \"args\")))\n        (IF (EQ commandName \"SEARCH_PKA\") (CALL_PROCEDURE HandleSearchPkaCommand (MAP_GET_VALUE commandDetails \"args\")))\n        (IF (EQ commandName \"SET_QA_OUTPUT_VERBOSITY\") (CALL_PROCEDURE HandleSetQaOutputVerbosityCommand (MAP_GET_VALUE commandDetails \"args\")))\n        (IF (EQ commandName \"SET_OUTPUT_DETAIL\") (CALL_PROCEDURE HandleSetOutputDetailCommand (MAP_GET_VALUE commandDetails \"args\")))\n        (IF (EQ commandName \"LOOP\") (CALL_PROCEDURE HandleLoopCommand (MAP_GET_VALUE commandDetails \"args\")))\n        (IF (EQ commandName \"SYSTEM_QA\") (CALL_PROCEDURE HandleSystemQACommand ())) ; Added handler for SYSTEM_QA command\n        (IF (NOT (IS_NIL commandName) (IS_NIL (MAP_GET_VALUE (MAP_CREATE\n                                                                (\"START\" TRUE) (\"HELP\" TRUE) (\"EVOLVE\" TRUE) (\"SAVE_SYSTEM\" TRUE) (\"BROWSE\" TRUE)\n                                                                (\"OK\" TRUE) (\"NO\" TRUE) (\"INPUT\" TRUE) (\"END\" TRUE) (\"LOOP_PROJECT_RESTART\" TRUE)\n                                                                (\"SET_SESSION_PREFERENCE\" TRUE) (\"STOP_LOOP\" TRUE) (\"OUTPUT\" TRUE) (\"SUMMARIZE\" TRUE)\n                                                                (\"QUERY\" TRUE) (\"OUTPUT_BACKLOG\" TRUE) (\"PROMOTE_TO_PKA\" TRUE) (\"SEARCH_PKA\" TRUE)\n                                                                (\"SET_QA_OUTPUT_VERBOSITY\" TRUE) (\"SET_OUTPUT_DETAIL\" TRUE) (\"LOOP\" TRUE) (\"SYSTEM_QA\" TRUE)\n                                                            ) commandName NIL)))) ; Fallback if no specific handler matches\n            (CALL_PROCEDURE HandleUnknownCommand commandName)\n        )\n    )\n    (RETURN_STATUS ALANG_STATUS_SUCCESS)\n)\n\n(DEFINE_PROCEDURE HandlePendingUserAction (action_key raw_input)\n    ;; Handles user input when a specific action is pending. (NEW)\n    ;; This procedure routes the raw user input based on the session.pending_user_action state.\n    (LOG_EVENT \"HANDLE_PENDING_ACTION\" (STRING_CONCAT \"Handling pending action: \" action_key))\n    (SET_STATE session.last_user_input_raw raw_input) ; Ensure raw input is available\n    (SET_STATE session.last_user_response (STRING_UPPER raw_input)) ; Store response (OK/NO/YES etc.)\n    (SET_STATE session.last_user_feedback (IF (OR (EQ (STRING_UPPER raw_input) \"NO\") (EQ (STRING_UPPER raw_input) \"REVISE\")) raw_input NIL)) ; Store feedback if NO/REVISE\n    (SET_STATE session.last_user_input_data raw_input) ; Store raw input as data for generic use\n\n    (IF (EQ action_key \"AWAIT_END_CONFIRMATION\")\n        (IF (EQ (GET_STATE session.last_user_response) \"YES\")\n            (CALL_PROCEDURE FinalizeProjectTermination) ; NEW procedure for termination logic\n            (SEQ\n                (OUTPUT_TO_USER_BUFFER \"AI_THOUGHTS\" \"Project termination cancelled.\" NIL)\n                (SET_STATE session.pending_user_action NIL) ; Clear pending action\n                (RETURN_STATUS ALANG_STATUS_SUCCESS)\n            )\n        )\n    )\n    (IF (EQ action_key \"AWAIT_RESTART_CONFIRMATION\")\n         (IF (EQ (GET_STATE session.last_user_response) \"YES\")\n            (CALL_PROCEDURE FinalizeProjectRestart) ; NEW procedure for restart logic\n            (SEQ\n                (OUTPUT_TO_USER_BUFFER \"AI_THOUGHTS\" \"Project restart cancelled.\" NIL)\n                (SET_STATE session.pending_user_action NIL) ; Clear pending action\n                (RETURN_STATUS ALANG_STATUS_SUCCESS)\n            )\n        )\n    )\n    (IF (EQ action_key \"AWAIT_YES_NO_FOR_BACKLOG_OUTPUT\")\n         (IF (EQ (GET_STATE session.last_user_response) \"YES\")\n            (SEQ\n                 (OUTPUT_TO_USER_BUFFER \"AI_THOUGHTS\" \"Outputting Evolution Backlog.\" NIL)\n                 ; Call the procedure to output the backlog content\n                 (CALL_PROCEDURE HandleOutputBacklogCommand (LIST_CREATE)) ; Call the existing handler with empty args\n                 (SET_STATE session.pending_user_action NIL) ; Clear pending action\n                 (RETURN_STATUS ALANG_STATUS_SUCCESS)\n            )\n            (SEQ\n                 (OUTPUT_TO_USER_BUFFER \"AI_THOUGHTS\" \"Evolution Backlog output skipped.\" NIL)\n                 (SET_STATE session.pending_user_action NIL) ; Clear pending action\n                 (RETURN_STATUS ALANG_STATUS_SUCCESS)\n            )\n        )\n    )\n    (IF (EQ action_key \"AWAIT_BACKLOG_PRIORITY_SELECTION\")\n        (SEQ\n            ; User provided input for backlog selection. Store it and resume the System QA cycle.\n            ; The input is already stored in session.last_user_input_data.\n            (SET_STATE session.pending_user_action NIL) ; Clear pending action\n            ; Store the user's selection input in the System QA context for the cycle (NEW)\n            (SET_STATE session.system_qa_context (MAP_SET_VALUE (GET_STATE session.system_qa_context) \"user_backlog_selection_input\" (GET_STATE session.last_user_input_data)))\n            ; Resume the System QA cycle execution flow. The orchestrator needs to call ExecuteSystemQAAndEvolutionCycle again.\n            (OUTPUT_TO_USER_BUFFER \"AI_THOUGHTS\" \"Backlog selection received. Resuming System QA & Evolution cycle...\" NIL)\n            (RETURN_STATUS ALANG_STATUS_SUCCESS) ; Indicate input handled, orchestrator should resume cycle\n        )\n    )\n     (IF (EQ action_key \"AWAIT_AI_PROPOSED_FOCUS_APPROVAL\")\n        (SEQ\n            ; User responded to AI's proposed backlog focus.\n            ; Response is already stored in session.last_user_response.\n            (SET_STATE session.pending_user_action NIL) ; Clear pending action\n            ; Store the user's approval status in the System QA context (NEW)\n            (SET_STATE session.system_qa_context (MAP_SET_VALUE (GET_STATE session.system_qa_context) \"ai_focus_approved\" (EQ (GET_STATE session.last_user_response) \"OK\")))\n            ; Resume the System QA cycle execution flow. Orchestrator needs to call ExecuteSystemQAAndEvolutionCycle again.\n            (OUTPUT_TO_USER_BUFFER \"AI_THOUGHTS\" \"Focus approval received. Resuming System QA & Evolution cycle...\" NIL)\n            (RETURN_STATUS ALANG_STATUS_SUCCESS) ; Indicate input handled, orchestrator should resume cycle\n        )\n    )\n    (IF (EQ action_key \"AWAIT_VERSION_APPROVAL\")\n        (SEQ\n            ; User responded to proposed version approval.\n            ; Response is already stored in session.last_user_response.\n            (SET_STATE session.pending_user_action NIL) ; Clear pending action\n            ; Store the user's approval status in the System QA context (NEW)\n            (SET_STATE session.system_qa_context (MAP_SET_VALUE (GET_STATE session.system_qa_context) \"version_approved\" (EQ (GET_STATE session.last_user_response) \"OK\")))\n            ; Resume the System QA cycle execution flow. Orchestrator needs to call ExecuteSystemQAAndEvolutionCycle again.\n            (OUTPUT_TO_USER_BUFFER \"AI_THOUGHTS\" \"Version approval received. Resuming System QA & Evolution cycle...\" NIL)\n            (RETURN_STATUS ALANG_STATUS_SUCCESS) ; Indicate input handled, orchestrator should resume cycle\n        )\n    )\n    (IF (EQ action_key \"AWAIT_TOOL_ERROR_RESOLUTION\")\n        (SEQ\n            ; User responded to tool error resolution prompt.\n            ; Response is in session.last_user_response, input data in session.last_user_input_data.\n            (LET ((resolutionDetails (GET_STATE session.pending_user_action_details))) ; Retrieve context\n            (LET ((toolId (MAP_GET_VALUE resolutionDetails \"tool_id\")))\n            (LET ((jobId (MAP_GET_VALUE resolutionDetails \"job_id\")))\n            (LET ((errorDetails (MAP_GET_VALUE resolutionDetails \"error_details\")))\n            (LET ((originalContext (MAP_GET_VALUE resolutionDetails \"original_context\")))\n                (OUTPUT_TO_USER_BUFFER \"AI_THOUGHTS\" (STRING_CONCAT \"Processing user resolution for tool error in \" toolId \".\") NIL)\n                ; Logic to interpret user input (e.g., \"INPUT new_param=value\", \"OK\", \"OPTION 2\")\n                ; This is complex and depends on how user input is structured for error resolution.\n                ; Conceptual handling:\n                (IF (EQ (GET_STATE session.last_user_response) \"OK\")\n                    (SEQ\n                        (OUTPUT_TO_USER_BUFFER \"AI_THOUGHTS\" \"User approved retry with no changes.\" NIL)\n                        ; Retry the tool call with original parameters (Section 5.C.7.A)\n                        (LET ((retryJobId (INVOKE_TOOL_ASYNC_WITH_CALLBACKS\n                                            toolId\n                                            (MAP_GET_VALUE originalContext \"original_input\")\n                                            (MAP_GET_VALUE originalContext \"original_params\")\n                                            (MAP_GET_VALUE originalContext \"success_proc_name\")\n                                            (MAP_GET_VALUE originalContext \"failure_proc_name\")\n                                            originalContext ; Pass original context\n                                        ))))\n                        (IF (EQ (GET_STATUS retryJobId) ALANG_STATUS_SUCCESS)\n                            (OUTPUT_TO_USER_BUFFER \"AI_PRESENT_THOUGHTS\" (STRING_CONCAT \"Tool \" toolId \" re-invoked (retry).\" ) NIL)\n                            (RETURN_STATUS ALANG_STATUS_SUCCESS) ; Indicate handled\n                        )\n                        (SEQ\n                            (LOG_EVENT \"TOOL_RETRY_FAILED\" toolId \"Retry failed after user OK.\")\n                            (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (STRING_CONCAT \"Retry failed for tool \" toolId \".\") NIL)\n                            ; Fallback if retry fails again - log and proceed with failure?\n                            (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL) ; Indicate failure\n                        )\n                    )\n                    (IF (EQ (GET_STATE session.last_user_response) \"INPUT\")\n                        (SEQ\n                            (OUTPUT_TO_USER_BUFFER \"AI_THOUGHTS\" \"User provided new input/parameters.\" NIL)\n                            ; Parse session.last_user_input_data to get new input/params (conceptual)\n                            ; This parsing needs to be robust to handle different input formats.\n                            (LET ((parsedInputResult (CALL_PROCEDURE ParseToolErrorResolutionInput (GET_STATE session.last_user_input_data) toolId errorDetails originalContext (GET_STATE session.conceptual_model_handle))))) ; NEW conceptual parser, gets context and session model\n                            (IF (EQ (GET_STATUS parsedInputResult) ALANG_STATUS_SUCCESS)\n                                (LET ((newInputParams (GET_DATA parsedInputResult)))\n                                    ; Retry the tool call with new parameters (Section 5.C.6)\n                                    (LET ((retryJobId (INVOKE_TOOL_ASYNC_WITH_CALLBACKS\n                                                        toolId\n                                                        (MAP_GET_VALUE newInputParams \"input\")\n                                                        (MAP_GET_VALUE newInputParams \"params\")\n                                                        (MAP_GET_VALUE originalContext \"success_proc_name\")\n                                                        (MAP_GET_VALUE originalContext \"failure_proc_name\")\n                                                        originalContext ; Pass original context\n                                                    ))))\n                                    (IF (EQ (GET_STATUS retryJobId) ALANG_STATUS_SUCCESS)\n                                        (OUTPUT_TO_USER_BUFFER \"AI_PRESENT_THOUGHTS\" (STRING_CONCAT \"Tool \" toolId \" re-invoked with user input.\" ) NIL)\n                                        (RETURN_STATUS ALANG_STATUS_SUCCESS) ; Indicate handled\n                                    )\n                                    (SEQ\n                                        (LOG_EVENT \"TOOL_RETRY_FAILED\" toolId \"Retry failed after user INPUT.\")\n                                        (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (STRING_CONCAT \"Retry failed for tool \" toolId \" with provided input.\") NIL)\n                                        ; Fallback if retry fails again - log and proceed with failure?\n                                        (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL) ; Indicate failure\n                                    )\n                                )\n                                (SEQ ; Parsing failed\n                                    (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" \"Failed to parse user input for tool error resolution. Please try again.\" NIL)\n                                    (RETURN_STATUS ALANG_STATUS_FAILURE_INVALID_INPUT) ; Indicate failure, might re-prompt?\n                                )\n                            ))\n                        )\n                    )\n                    (IF (OR (EQ (GET_STATE session.last_user_response) \"NO\") (EQ (GET_STATE session.last_user_response) \"REVISE\"))\n                        (SEQ\n                            (OUTPUT_TO_USER_BUFFER \"AI_THOUGHTS\" \"User requested revision or skipping.\" NIL)\n                            ; Process feedback (conceptual)\n                            (CALL_PROCEDURE ProcessUserFeedbackForConceptualModel (GET_STATE session.last_user_feedback) (GET_STATE session.conceptual_model_handle))\n                            ; Decide next step based on feedback - skip task, revise approach, etc.\n                            ; This requires more complex logic, potentially involving LLM analysis of feedback.\n                            ; For now, just log and indicate handled.\n                            (LOG_EVENT \"TOOL_ERROR_RESOLUTION_REVISED\" toolId (MAP_CREATE (\"feedback\" (GET_STATE session.last_user_feedback))))\n                            (OUTPUT_TO_USER_BUFFER \"AI_PRESENT_THOUGHTS\" \"Feedback logged. Deciding next step for task...\" NIL)\n                            (RETURN_STATUS ALANG_STATUS_SUCCESS) ; Indicate handled\n                        )\n                    )\n                    ; Add logic for other options like skipping (OPTION 2), stopping loop (OPTION 4)\n                    (SEQ ; Default / Unrecognized response\n                         (OUTPUT_TO_USER_BUFFER \"AI_WARNING\" \"Unrecognized response for tool error resolution. Please use INPUT, OK, or specify an option.\" NIL)\n                         ; Maybe re-prompt the user or log and give up? For now, just log and clear pending action.\n                         (LOG_EVENT \"TOOL_ERROR_RESOLUTION_UNHANDLED\" toolId (STRING_CONCAT \"User input: \" raw_input))\n                         (RETURN_STATUS ALANG_STATUS_FAILURE_INVALID_INPUT) ; Indicate failure\n                    )\n                )\n                (SET_STATE session.pending_user_action NIL) ; Clear pending action after handling\n                (SET_STATE session.pending_user_action_details NIL) ; Clear details\n            )))))\n     (IF (EQ action_key \"AWAIT_REVISION_REVIEW\")\n        (SEQ\n            ; User responded to artifact revision review prompt.\n            ; Response is in session.last_user_response, feedback in session.last_user_feedback.\n            (LET ((reviewDetails (GET_STATE session.pending_user_action_details))) ; Retrieve context\n            (LET ((artifactHandle (MAP_GET_VALUE reviewDetails \"artifact_handle\"))))\n            (LET ((qaReportHandle (MAP_GET_VALUE reviewDetails \"qa_report_handle\"))) ; Might need report handle for REVISE\n            (LET ((constraintsHandle (MAP_GET_VALUE reviewDetails \"constraints_handle\"))) ; Needed for re-correction\n            (LET ((originalGeneratedText (MAP_GET_VALUE reviewDetails \"original_generated_text\"))) ; Might need original text for REVISE\n                (OUTPUT_TO_USER_BUFFER \"AI_THOUGHTS\" \"Processing user review for artifact revision.\" NIL)\n                (IF (EQ (GET_STATE session.last_user_response) \"OK\")\n                    (SEQ\n                        (OUTPUT_TO_USER_BUFFER \"AI_ACKNOWLEDGE_INTENT\" \"Artifact revision approved.\" NIL)\n                        ; Update conceptual model to reflect user approval (Principle 0.V.6)\n                        (CALL_PROCEDURE UPDATE_CONCEPTUAL_MODEL (MAP_CREATE (\"action\" \"flag_user_approved_revision\") (\"artifact_handle\" artifactHandle)))\n                        ; Phase execution can now continue.\n                        (RETURN_STATUS ALANG_STATUS_SUCCESS) ; Indicate handled, orchestrator should resume phase\n                    )\n                    (SEQ ; User responded NO or REVISE\n                        (OUTPUT_TO_USER_BUFFER \"AI_ACKNOWLEDGE_INTENT\" \"Artifact revision rejected. Attempting further revision based on feedback.\" NIL)\n                        ; Process user feedback and attempt revision (conceptual)\n                        (CALL_PROCEDURE ProcessUserFeedbackForConceptualModel (GET_STATE session.last_user_feedback) (GET_STATE session.conceptual_model_handle)) ; Update conceptual model with feedback\n                        ; Update conceptual model to reflect user rejection (Principle 0.V.6)\n                        (CALL_PROCEDURE UPDATE_CONCEPTUAL_MODEL (MAP_CREATE (\"action\" \"flag_user_rejected_revision\") (\"artifact_handle\" artifactHandle) (\"feedback\" (GET_STATE session.last_user_feedback))))\n                        ; Re-enter the revision process, potentially attempting self-correction again with feedback context\n                        ; This is complex state management. A simple approach is to re-call ApplyRevisionsToArtifact,\n                        ; which would need to incorporate the user feedback into its analysis.\n                        ; A more robust approach might involve a specific 'ApplyFeedbackBasedRevision' procedure.\n                        (LET ((feedbackRevisionStatus (CALL_PROCEDURE ApplyFeedbackBasedRevision artifactHandle (GET_STATE session.last_user_feedback) constraintsHandle (GET_STATE session.conceptual_model_handle) reviewDetails)))) ; NEW procedure for feedback-based revision\n                        (IF (EQ feedbackRevisionStatus ALANG_STATUS_PAUSE_FOR_USER_INPUT)\n                            (SEQ\n                                (OUTPUT_TO_USER_BUFFER \"AI_THOUGHTS\" \"Feedback-based revision requires further user input.\" NIL)\n                                (RETURN_STATUS ALANG_STATUS_PAUSE_FOR_USER_INPUT) ; Propagate pause\n                            )\n                            (IF (IS_STATUS_FAILURE feedbackRevisionStatus)\n                                (SEQ\n                                    (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" \"Feedback-based revision failed.\" NIL)\n                                    (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL) ; Indicate failure\n                                )\n                                (SEQ ; Feedback-based revision succeeded\n                                    (OUTPUT_TO_USER_BUFFER \"AI_PRESENT_THOUGHTS\" \"Feedback-based revision attempted. Review the artifact again.\" NIL)\n                                    ; The artifact content has been updated by ApplyFeedbackBasedRevision.\n                                    ; Need to re-prompt user for review of the revised artifact.\n                                    (OUTPUT_TO_USER_BUFFER \"AI_REQUEST_CLARIFICATION_QUESTIONS\" \"Review the revised content. Do you approve, or require further revision? (OK/REVISE)\" NIL)\n                                    ; Keep pending action as AWAIT_REVISION_REVIEW, but update details if needed\n                                    (SET_STATE session.pending_user_action_details (MAP_SET_VALUE reviewDetails \"last_revision_status\" feedbackRevisionStatus)) ; Update context\n                                    (RETURN_STATUS ALANG_STATUS_PAUSE_FOR_USER_INPUT) ; Indicate pause for re-review\n                                )\n                            )\n                        )\n                    )\n                )\n                (SET_STATE session.pending_user_action NIL) ; Clear pending action after handling\n                (SET_STATE session.pending_user_action_details NIL) ; Clear details\n            )))))\n     (IF (EQ action_key \"AWAIT_OK_REVISE_PHASE_ARTIFACT\")\n        (SEQ\n            ; User responded to phase artifact review prompt (e.g., Pattern Ideas, Product Definition, Task List, Final Draft).\n            ; Response is in session.last_user_response, feedback in session.last_user_feedback.\n            (LET ((phaseArtifactDetails (GET_STATE session.pending_user_action_details))) ; Retrieve context\n            (LET ((artifactHandle (MAP_GET_VALUE phaseArtifactDetails \"artifact_handle\"))))\n            (LET ((phaseId (MAP_GET_VALUE phaseArtifactDetails \"phase\"))))\n                (OUTPUT_TO_USER_BUFFER \"AI_THOUGHTS\" (STRING_CONCAT \"Processing user review for artifact in phase \" phaseId \".\") NIL)\n                (IF (EQ (GET_STATE session.last_user_response) \"OK\")\n                    (SEQ\n                        (OUTPUT_TO_USER_BUFFER \"AI_ACKNOWLEDGE_INTENT\" \"Artifact approved. Proceeding to next step in phase.\" NIL)\n                        ; Update conceptual model to reflect user approval (Principle 0.V.6)\n                        (CALL_PROCEDURE UPDATE_CONCEPTUAL_MODEL (MAP_CREATE (\"action\" \"flag_user_approved_artifact\") (\"artifact_handle\" artifactHandle) (\"phase\" phaseId)))\n                        ; Clear pending action and allow phase execution to continue or transition.\n                        (SET_STATE session.pending_user_action NIL)\n                        (SET_STATE session.pending_user_action_details NIL)\n                        (RETURN_STATUS ALANG_STATUS_SUCCESS) ; Indicate handled, orchestrator should resume phase\n                    )\n                    (SEQ ; User responded NO or REVISE\n                        (OUTPUT_TO_USER_BUFFER \"AI_ACKNOWLEDGE_INTENT\" \"Artifact rejected. Attempting revision based on feedback.\" NIL)\n                        ; Process user feedback and attempt revision (conceptual)\n                        (CALL_PROCEDURE ProcessUserFeedbackForConceptualModel (GET_STATE session.last_user_feedback) (GET_STATE session.conceptual_model_handle)) ; Update conceptual model with feedback\n                        ; Update conceptual model to reflect user rejection (Principle 0.V.6)\n                        (CALL_PROCEDURE UPDATE_CONCEPTUAL_MODEL (MAP_CREATE (\"action\" \"flag_user_rejected_artifact\") (\"artifact_handle\" artifactHandle) (\"phase\" phaseId) (\"feedback\" (GET_STATE session.last_user_feedback))))\n                        ; Re-generate or revise the artifact based on feedback. This requires re-running part of the phase logic.\n                        ; This is complex state management. A simple approach is to re-run the generation step for this artifact,\n                        ; ensuring the feedback and updated conceptual model influence the prompt.\n                        (OUTPUT_TO_USER_BUFFER \"AI_PRESENT_THOUGHTS\" \"Attempting to regenerate/revise artifact based on feedback.\" NIL)\n                        ; The orchestrator needs to manage the state and re-invoke the appropriate procedure (e.g., the phase execution procedure).\n                        ; The phase execution procedure should check if an artifact exists for this step and if it was rejected,\n                        ; then attempt regeneration/revision using the feedback.\n                        (SET_STATE session.pending_user_action NIL) ; Clear pending action for now, phase logic will re-set if needed\n                        (SET_STATE session.pending_user_action_details NIL)\n                        (RETURN_STATUS ALANG_STATUS_SUCCESS) ; Indicate handled, orchestrator needs to manage next step\n                    )\n                )\n            )))\n    )\n\n\n    ; If the action key is not recognized, log an error.\n    (SEQ\n        (SET_ERROR_STATE \"SYSTEM_ERROR\" (STRING_CONCAT \"Unhandled pending user action: \" action_key))\n        (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL)\n        (SET_STATE session.pending_user_action NIL) ; Clear the action to avoid getting stuck\n        (SET_STATE session.pending_user_action_details NIL) ; Clear details\n        (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL)\n    )\n)\n\n\n(DEFINE_PROCEDURE FinalizeProjectTermination ()\n    ;; Performs final project archival and terminates the session. (NEW)\n    (OUTPUT_TO_USER_BUFFER \"AI_THOUGHTS\" \"Finalizing project termination...\" NIL)\n    ; This procedure would:\n    ; 1. Trigger project archival (saving artifacts, logs, final conceptual model).\n    ; 2. Release session resources (including session.conceptual_model_handle).\n    ; 3. Signal the orchestrator to terminate the session.\n    (LOG_EVENT \"PROJECT_TERMINATION\" (STRING_CONCAT \"Project \" (GET_STATE proj.id) \" terminating.\"))\n    ; Conceptual calls:\n    ; (CALL_PROCEDURE ArchiveProject (GET_STATE proj.id) (GET_STATE proj.artifacts) (GET_STATE proj.tau_project_log)) ; Archive artifacts and logs\n    ; (LET ((conceptualModelSaveStatus (SAVE_CONCEPTUAL_MODEL (GET_STATE session.conceptual_model_handle) (STRING_CONCAT \"archive/conceptual_model_\" (GET_STATE proj.id) \".json\")))) ; Save conceptual model\n    ;     (IF (IS_STATUS_FAILURE conceptualModelSaveStatus)\n    ;         (LOG_EVENT \"SYSTEM_ERROR\" \"Failed to save conceptual model during archival.\")\n    ;     )\n    ; )\n    ; (RELEASE_HANDLE (GET_STATE session.conceptual_model_handle))\n    ; (SET_STATE session.conceptual_model_handle NIL)\n    ; (SIGNAL_ORCHESTRATOR \"TERMINATE_SESSION\")\n    (OUTPUT_TO_USER_BUFFER \"AI_PRESENT_THOUGHTS\" \"Project terminated. Session resources released.\" NIL)\n    (RETURN_STATUS ALANG_STATUS_SUCCESS) ; Orchestrator handles actual termination\n)\n\n(DEFINE_PROCEDURE FinalizeProjectRestart ()\n    ;; Performs project state cleanup and restarts the session. (NEW)\n    (OUTPUT_TO_USER_BUFFER \"AI_THOUGHTS\" \"Finalizing project restart...\" NIL)\n    ; This procedure would:\n    ; 1. Discard current project artifacts and state.\n    ; 2. Release session resources (including session.conceptual_model_handle).\n    ; 3. Signal the orchestrator to restart the system (effectively calling OnSystemInit again).\n    (LOG_EVENT \"PROJECT_RESTART\" (STRING_CONCAT \"Project \" (GET_STATE proj.id) \" restarting.\"))\n    ; Conceptual calls:\n    ; (CALL_PROCEDURE DiscardProjectState (GET_STATE proj.id))\n    ; (RELEASE_HANDLE (GET_STATE session.conceptual_model_handle))\n    ; (SET_STATE session.conceptual_model_handle NIL)\n    ; (SIGNAL_ORCHESTRATOR \"RESTART_SYSTEM\")\n     (OUTPUT_TO_USER_BUFFER \"AI_PRESENT_THOUGHTS\" \"Project state discarded. Restarting system.\" NIL)\n    (RETURN_STATUS ALANG_STATUS_SUCCESS) ; Orchestrator handles actual restart\n)\n\n\n(DEFINE_PROCEDURE HandleStartCommand (argsList)\n    ;; Handles the START command.\n    (LET ((projectDescription (GET_SESSION_CMD_ARG_BY_INDEX 0 NIL))) ; Get the first argument, allow NIL\n        (IF (STRING_IS_EMPTY_OR_NULL projectDescription)\n            (SEQ\n                (SET_ERROR_STATE \"USER_ERROR\" \"Project description cannot be empty for START command.\")\n                (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL)\n                (RETURN_STATUS ALANG_STATUS_INVALID_ARGS)\n            )\n        )\n\n        (ACKNOWLEDGE_AND_LOG\n            \"CMD_START_RECEIVED\"\n            (STRING_CONCAT \"START command received. Description: \" projectDescription)\n            \"AI_ACKNOWLEDGE_INTENT\"\n            (STRING_CONCAT \"START command received. Project: '\" projectDescription \"'\") ; Fixed message\n        )\n\n        (LET ((newProjectId (GENERATE_UNIQUE_ID \"PROJ\")))\n            (INIT_PROJECT_STATE newProjectId projectDescription NIL) ; NIL for optional master_plan_handle initially\n            ; Initialize the session-specific conceptual model handle for this new project (Principle 0.V.6)\n            ; NOTE: This might already be initialized in OnSystemInit. Re-initializing here ensures a clean model for a new project.\n            (SET_STATE session.conceptual_model_handle (CREATE_EMPTY_ARTIFACT \"SessionConceptualModel\")) ; Re-initialize for new project\n            ; Add initial project description to the conceptual model\n            (CALL_PROCEDURE ProcessUserInputForConceptualModel projectDescription (GET_STATE session.conceptual_model_handle)) ; Use the input processing procedure\n        )\n\n        (OUTPUT_TO_USER_BUFFER \"AI_PRESENT_INTERPRETATION\"\n            (STRING_CONCAT \"Project: \" (GET_STATE proj.title) \". Phase: Init.\" NIL)\n        )\n\n        (SET_STATE proj.current_phase_id \"PHASE_IDEA_FORMULATION\")\n        (LOG_EVENT \"PHASE_TRANSITION\" \"Transitioning to Idea Formulation.\")\n\n        (RETURN_STATUS ALANG_STATUS_SUCCESS)\n    )\n)\n\n(DEFINE_PROCEDURE HandleHelpCommand (argsList)\n    ;; Handles the HELP command.\n    (LET ((commandName (GET_SESSION_CMD_ARG_BY_INDEX 0 NIL))) ; Get optional command name\n        (IF (STRING_IS_EMPTY_OR_NULL commandName)\n            (CALL_PROCEDURE OutputGeneralHelp)\n            (CALL_PROCEDURE OutputSpecificHelp commandName)\n        )\n    )\n    (RETURN_STATUS ALANG_STATUS_SUCCESS)\n)\n\n(DEFINE_PROCEDURE HandleEvolveCommand (argsList)\n    ;; Handles the EVOLVE command.\n    (LET ((suggestionText (GET_SESSION_CMD_ARG_BY_INDEX 0 NIL)))\n        (IF (STRING_IS_EMPTY_OR_NULL suggestionText)\n            (SEQ\n                (SET_ERROR_STATE \"USER_ERROR\" \"EVOLVE command requires a suggestion text.\")\n                (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL)\n                (RETURN_STATUS ALANG_STATUS_INVALID_ARGS)\n            )\n        )\n\n        (ACKNOWLEDGE_AND_LOG\n            \"CMD_EVOLVE_RECEIVED\"\n            (STRING_CONCAT \"EVOLVE command received. Suggestion: \" suggestionText)\n            \"AI_ACKNOWLEDGE_INTENT\"\n            (STRING_CONCAT \"EVOLVE Suggestion: '\" suggestionText \"' logged.\") ; Fixed message\n        )\n\n        (LET ((backlogItemIdResult (CALL_PROCEDURE ProcessAndStoreEvolveSuggestion suggestionText \"USER_SUGGESTION\"))) ; ProcessAndStoreEvolveSuggestion now returns a StructuredResultObject\n            (IF (EQ (GET_STATUS backlogItemIdResult) ALANG_STATUS_SUCCESS)\n                (SET_STATE sys.evolution_trigger_pending TRUE) ; Flag for potential System QA cycle (Section 3)\n                (SEQ\n                    (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" \"Failed to process and store EVOLVE suggestion in backlog.\" NIL)\n                    (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL)\n                )\n            )\n        )\n\n        (OUTPUT_TO_USER_BUFFER \"AI_THOUGHTS\" \"Your suggestion has been logged for consideration in the next System QA & Evolution cycle.\" NIL)\n        (RETURN_STATUS ALANG_STATUS_SUCCESS)\n    )\n)\n\n(DEFINE_PROCEDURE HandleSaveSystemCommand ()\n    ;; Handles the SAVE SYSTEM command, implementing CDGIP.\n    (ACKNOWLEDGE_AND_LOG \"CMD_SAVE_SYSTEM\" \"SAVE SYSTEM command received.\" \"AI_ACKNOWLEDGE_INTENT\" \"SAVE SYSTEM command received.\")\n\n    ; 1. Generate the ALang Core Logic content itself (meta-generation)\n    (LET ((generatedAlangCodeHandle (SAFE_GENERATE_CONTENT\n                                        (CREATE_EMPTY_ARTIFACT \"temp_alang_code\") ; Target for the generated code\n                                        PROMPT_TEMPLATE_SERIALIZE_ALANG_CORE ; Special template handle\n                                        (MAP_CREATE (\"current_alang_handle\" (GET_CURRENT_ALANG_PROCEDURE_DEFINITIONS_HANDLE)) ; Pass handle to current code\n                                                    (\"current_directives_handle\" (GET_ALANG_CORE_DIRECTIVES_HANDLE)) ; Pass handle to current directives\n                                                    (\"session_conceptual_model_summary\" (SUMMARIZE_CONCEPTUAL_MODEL (GET_STATE session.conceptual_model_handle) NIL))) ; Include conceptual model summary\n                                        CONSTRAINT_SET_VALID_ALANG_SYNTAX\n                                    )))\n        (IF (IS_HANDLE_VALID generatedAlangCodeHandle)\n            (LET ((tempAlangContentResult (READ_CONTENT generatedAlangCodeHandle \"text\" NIL))) ; Read the generated ALang\n                (IF (EQ (GET_STATUS tempAlangContentResult) ALANG_STATUS_SUCCESS)\n                    (LET ((tempAlangContent (GET_DATA tempAlangContentResult)))\n                        ; 2. Perform CDGIP Checks\n                        (LET ((markersOk (VERIFY_ALANG_FILE_MARKERS generatedAlangCodeHandle (GET_STATE sys.alang_core_logic_version)))) ; Pass handle directly\n                        (LET ((sectionCount (GET_ALANG_SECTION_COUNT generatedAlangCodeHandle)))) ; Pass handle directly\n                        (LET ((checksum (COMPUTE_FILE_CHECKSUM generatedAlangCodeHandle \"SHA256\")))) ; Compute checksum using tool_code\n\n                            (IF (AND markersOk (GT sectionCount 0) (NOT (IS_NIL checksum))) ; Basic checks + checksum\n                                (SEQ ; CDGIP checks passed\n                                    ; 3. Output CDGIP User Verification Prompts\n                                    (OUTPUT_TO_USER_BUFFER \"AI_PRESENT_THOUGHTS\"\n                                        (STRING_CONCAT \"Preparing to output Autologos_Core_Logic_v\" (GET_STATE sys.alang_core_logic_version) \".alang. \"\n                                                       \"Internal draft contains \" (STRING_CONCAT \"\" sectionCount) \" primary SECTION comments. \" ; Convert num to string\n                                                       \"Checksum (SHA256): \" checksum \". \"\n                                                       \"Please verify all sections are present and correctly numbered in the output.\") NIL\n                                    )\n                                    (OUTPUT_TO_USER_BUFFER \"AI_PROVIDE_DATA\"\n                                        (STRING_CONCAT \"Recommended Filename: Autologos/Autologos_Core_Logic_v\" (GET_STATE sys.alang_core_logic_version) \".alang\") NIL\n                                    )\n                                    (OUTPUT_TO_USER_BUFFER \"AI_PROVIDE_DATA\" \"```scheme\" NIL) ; Start code block\n                                    (OUTPUT_TO_USER_BUFFER \"AI_PROVIDE_DATA\" (STRING_CONCAT \"--- START OF FILE Autologos_Core_Logic_v\" (GET_STATE sys.alang_core_logic_version) \".alang ---\\n\") NIL)\n                                    (OUTPUT_TO_USER_BUFFER \"AI_PROVIDE_DATA\" tempAlangContent NIL) ; The actual ALang code\n                                    (OUTPUT_TO_USER_BUFFER \"AI_PROVIDE_DATA\" (STRING_CONCAT \"--- END OF FILE Autologos_Core_Logic_v\" (GET_STATE sys.alang_core_logic_version) \".alang ---\") NIL)\n                                    (OUTPUT_TO_USER_BUFFER \"AI_PROVIDE_DATA\" \"```\" NIL) ; End code block\n\n                                    (OUTPUT_TO_USER_BUFFER \"AI_REQUEST_USER_ACTION\"\n                                        (GET_TEXT_FOR_CDGIP_USER_VERIFICATION_MANDATE (GET_STATE sys.alang_core_logic_version) sectionCount) NIL\n                                    )\n                                    ; Offer to output Evolution Backlog (as per Principle 4.A Cmd 20)\n                                    (OUTPUT_TO_USER_BUFFER \"AI_REQUEST_CLARIFICATION_QUESTIONS\" \"Output Evolution Backlog now? (YES/NO)\" NIL)\n                                    (SET_STATE session.pending_user_action \"AWAIT_YES_NO_FOR_BACKLOG_OUTPUT\")\n                                    (RETURN_STATUS ALANG_STATUS_SUCCESS)\n                                )\n                                ; ELSE CDGIP checks failed\n                                (SEQ\n                                    (SET_ERROR_STATE \"SYSTEM_ERROR\" \"Internal CDGIP checks failed during SAVE SYSTEM (markers, section count, or checksum failed).\")\n                                    (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL)\n                                    (RETURN_STATUS ALANG_STATUS_FAILURE_GENERATION_ERROR)\n                                )\n                            )\n                        ))\n                    (SEQ ; ELSE Failed to read generated ALang content\n                        (SET_ERROR_STATE \"SYSTEM_ERROR\" \"Failed to read generated ALang content from handle.\")\n                        (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL)\n                        (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL)\n                    )\n                )\n            )\n            ; ELSE SAFE_GENERATE_CONTENT failed\n            (SET_ERROR_STATE \"SYSTEM_ERROR\" \"Failed to generate ALang core logic for SAVE SYSTEM.\")\n            (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL)\n            (RETURN_STATUS ALANG_STATUS_FAILURE_GENERATION_ERROR)\n        ))\n    (FLUSH_USER_OUTPUT_BUFFER)\n)\n\n(DEFINE_PROCEDURE HandleBrowseCommand (argsList)\n    ;; Handles the BROWSE command.\n    (LET ((arg (GET_SESSION_CMD_ARG_BY_INDEX 0 NIL)))\n        (IF (OR (STRING_IS_EMPTY_OR_NULL arg) (NOT (IS_NUMBER arg)))\n            (SEQ\n                (SET_ERROR_STATE \"USER_ERROR\" \"Invalid argument for BROWSE. Please provide a number.\")\n                (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL)\n                (RETURN_STATUS ALANG_STATUS_INVALID_ARGS)\n            )\n        )\n\n        (LET ((resultIndex (SUB (STRING_TO_NUMBER arg) 1)))\n            (IF (OR (LT resultIndex 0) (GTE resultIndex (LIST_GET_LENGTH (GET_STATE session.last_search_results)))) ; Check bounds\n                (SEQ\n                    (SET_ERROR_STATE \"USER_ERROR\" \"Result number out of bounds for previous search results.\")\n                    (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL)\n                    (RETURN_STATUS ALANG_STATUS_INVALID_ARGS)\n                )\n            )\n\n            (IF (NOT (IS_TOOL_ENABLED \"browse\"))\n                (SEQ\n                    (SET_ERROR_STATE \"TOOL_UNAVAILABLE\" \"Browse tool is not available.\")\n                    (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL)\n                    (RETURN_STATUS ALANG_STATUS_FAILURE_TOOL_UNAVAILABLE)\n                )\n            )\n\n            (LET ((targetUrl (MAP_GET_VALUE (LIST_GET_ITEM (GET_STATE session.last_search_results) resultIndex) \"url\" NIL)))\n                (IF (STRING_IS_EMPTY_OR_NULL targetUrl)\n                    (SEQ\n                        (SET_ERROR_STATE \"DATA_ERROR\" \"Invalid result number or URL not found in stored search results.\")\n                        (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL)\n                        (RETURN_STATUS ALANG_STATUS_NOT_FOUND)\n                    )\n                )\n\n                (OUTPUT_TO_USER_BUFFER \"AI_THOUGHTS\" (STRING_CONCAT \"Browsing URL: \" targetUrl) NIL)\n                ; Pass tool_id and original context through the callback context (NEW)\n                (LET ((browseJobId (INVOKE_TOOL_ASYNC_WITH_CALLBACKS \"browse\" targetUrl NIL \"HandleBrowseResult\" \"HandleBrowseError\" (MAP_CREATE (\"tool_id\" \"browse\") (\"original_context\" NIL) (\"original_input\" targetUrl) (\"original_params\" NIL))))) ; Include original input/params in context (NEW)\n                    ; The actual outcome will be handled by the callback procedures.\n                    (RETURN_STATUS ALANG_STATUS_SUCCESS) ; Invoke is launched, callback will handle result\n                )\n            ))\n    )\n    (RETURN_STATUS ALANG_STATUS_SUCCESS)\n)\n\n(DEFINE_PROCEDURE HandleUnknownCommand (commandName)\n    ;; Handles unrecognized commands.\n    (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (STRING_CONCAT \"Unknown command: \" commandName) NIL)\n    (RETURN_STATUS ALANG_STATUS_INVALID_COMMAND)\n)\n\n(DEFINE_PROCEDURE HandleOkCommand ()\n    ;; Handles the OK command.\n    (OUTPUT_TO_USER_BUFFER \"AI_ACKNOWLEDGE_INTENT\" \"OK received.\" NIL)\n    (SET_STATE session.last_user_response \"OK\") ; Store response for pending action handlers\n    ; Orchestrator: Should check session.pending_user_action and resume appropriate flow via HandlePendingUserAction.\n    ; This procedure just sets the state. OnUserInput will pick it up.\n    (RETURN_STATUS ALANG_STATUS_SUCCESS)\n)\n\n(DEFINE_PROCEDURE HandleNoCommand (argsList)\n    ;; Handles the NO / REVISE command.\n    (LET ((feedbackText (GET_SESSION_CMD_ARG_BY_INDEX 0 NIL)))\n        (OUTPUT_TO_USER_BUFFER \"AI_ACKNOWLEDGE_INTENT\" (STRING_CONCAT \"Feedback: '\" (IF (IS_NIL feedbackText) \"None\" feedbackText) \"' received.\") NIL)\n        (SET_STATE session.last_user_response \"NO\")\n        (SET_STATE session.last_user_feedback feedbackText) ; Store feedback\n        ; User feedback/revision should influence the session conceptual model (Principle 0.V.6, 5.B)\n        (CALL_PROCEDURE ProcessUserFeedbackForConceptualModel feedbackText (GET_STATE session.conceptual_model_handle)) ; Conceptual call\n    )\n    ; Orchestrator: Should check session.pending_user_action and resume appropriate flow via HandlePendingUserAction.\n    ; This procedure just sets the state. OnUserInput will pick it up.\n    (RETURN_STATUS ALANG_STATUS_SUCCESS)\n)\n\n(DEFINE_PROCEDURE HandleInputCommand (argsList)\n    ;; Handles the INPUT command.\n    (LET ((inputData (GET_SESSION_CMD_ARG_BY_INDEX 0 NIL))) ; Assuming INPUT provides a single arg for now\n        (OUTPUT_TO_USER_BUFFER \"AI_ACKNOWLEDGE_INTENT\" \"INPUT received.\" NIL)\n        (SET_STATE session.last_user_response \"INPUT\")\n        (SET_STATE session.last_user_input_data inputData) ; Store input data\n        ; Process input data and potentially update session.conceptual_model_handle (Principle 0.V.6)\n        (CALL_PROCEDURE ProcessUserInputForConceptualModel inputData (GET_STATE session.conceptual_model_handle)) ; Update conceptual model\n    )\n    ; Orchestrator: Should check session.pending_user_action and resume appropriate flow via HandlePendingUserAction.\n    ; This procedure just sets the state. OnUserInput will pick it up.\n    (RETURN_STATUS ALANG_STATUS_SUCCESS)\n)\n\n(DEFINE_PROCEDURE HandleEndCommand ()\n    ;; Handles the END command.\n    (OUTPUT_TO_USER_BUFFER \"AI_THOUGHTS\" \"END command received. Project session will terminate.\" NIL)\n    (OUTPUT_TO_USER_BUFFER \"AI_REQUEST_CLARIFICATION_QUESTIONS\" \"Are you sure you want to end the project? Unsaved data will be lost. (YES/NO)\" NIL)\n    (SET_STATE session.pending_user_action \"AWAIT_END_CONFIRMATION\")\n    ; Orchestrator: Should wait for confirmation, then perform project archival (Principle 4.A) and terminate.\n    ; Note: The session conceptual model handle should be released or marked for archival if the project is saved.\n    (RETURN_STATUS ALANG_STATUS_SUCCESS)\n)\n\n(DEFINE_PROCEDURE HandleLoopProjectRestartCommand ()\n    ;; Handles the LOOP_PROJECT_RESTART command.\n    (OUTPUT_TO_USER_BUFFER \"AI_THOUGHTS\" \"LOOP_PROJECT_RESTART command received. All current project artifacts and state will be discarded.\" NIL)\n    (OUTPUT_TO_USER_BUFFER \"AI_REQUEST_CLARIFICATION_QUESTIONS\" \"Are you sure you want to restart the project from Phase 0? (YES/NO)\" NIL)\n    (SET_STATE session.pending_user_action \"AWAIT_RESTART_CONFIRMATION\")\n    ; Orchestrator: Should wait for confirmation, then clear project state (including session conceptual model and loop stack) and restart from OnSystemInit.\n    ; When restarting, the session conceptual model handle should be released and a new one created in OnSystemInit/HandleStartCommand.\n    (RETURN_STATUS ALANG_STATUS_SUCCESS)\n)\n\n(DEFINE_PROCEDURE HandleSetSessionPreferenceCommand (argsList)\n    ;; Handles the SET_SESSION_PREFERENCE command.\n    ; (Example: (SET_SESSION_PREFERENCE TARGET_OUTPUT_TYPE=\"bullet_list\" STYLE_PARAMETER=\"list_format:bullets\"))\n    (IF (LT (LIST_GET_LENGTH argsList) 2)\n        (SEQ\n            (SET_ERROR_STATE \"USER_ERROR\" \"SET_SESSION_PREFERENCE requires at least TARGET_OUTPUT_TYPE and STYLE_PARAMETER.\")\n            (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL)\n            (RETURN_STATUS ALANG_STATUS_INVALID_ARGS)\n        )\n    )\n    ; Assuming argsList is a list of key-value strings like \"KEY=VALUE\"\n    (LET ((prefMapResult (CALL_PROCEDURE ParseKeyValueArgs argsList))) ; Use ParseKeyValueArgs\n        (IF (EQ (GET_STATUS prefMapResult) ALANG_STATUS_SUCCESS)\n            (LET ((prefMap (GET_DATA prefMapResult)))\n                (SET_STATE session.output_preferences prefMap)\n                (OUTPUT_TO_USER_BUFFER \"AI_ACKNOWLEDGE_INTENT\" \"Session preference logged.\" NIL)\n                (RETURN_STATUS ALANG_STATUS_SUCCESS)\n            )\n            (SEQ\n                (SET_ERROR_STATE \"USER_ERROR\" \"Failed to parse session preferences.\")\n                (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL)\n                (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL)\n            )\n        )\n    )\n)\n\n(DEFINE_PROCEDURE HandleStopLoopCommand ()\n    ;; Handles the STOP_LOOP command.\n    (OUTPUT_TO_USER_BUFFER \"AI_THOUGHTS\" \"STOP_LOOP command received. Attempting to halt current loop gracefully.\" NIL)\n    ; Clear the loop stack to signal loop termination (Section 2.A.3)\n    (SET_STATE session.loop_stack (LIST_CREATE))\n    ; Orchestrator: Should ensure any active ALang loops are terminated based on the empty stack.\n    (RETURN_STATUS ALANG_STATUS_SUCCESS)\n)\n\n(DEFINE_PROCEDURE HandleOutputCommand (argsList)\n    ;; Handles the OUTPUT command.\n    (LET ((artifactId (GET_SESSION_CMD_ARG_BY_INDEX 0 NIL)))\n        (IF (STRING_IS_EMPTY_OR_NULL artifactId)\n            (SEQ\n                (SET_ERROR_STATE \"USER_ERROR\" \"OUTPUT command requires an artifact ID.\")\n                (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL)\n                (RETURN_STATUS ALANG_STATUS_INVALID_ARGS)\n            )\n        )\n        (LET ((artifactHandle (MAP_GET_VALUE (GET_STATE proj.artifacts) artifactId NIL)))\n            (IF (IS_NIL artifactHandle)\n                (SEQ\n                    (SET_ERROR_STATE \"DATA_ERROR\" (STRING_CONCAT \"Artifact not found: \" artifactId))\n                    (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL)\n                    (RETURN_STATUS ALANG_STATUS_NOT_FOUND)\n                )\n            )\n            (LET ((contentResult (READ_CONTENT artifactHandle \"text_summary_or_full\" NIL))) ; Read full content (Principle 2)\n                (IF (EQ (GET_STATUS contentResult) ALANG_STATUS_SUCCESS)\n                    (OUTPUT_TO_USER_BUFFER \"AI_PROVIDE_DATA\" (GET_DATA contentResult) NIL) ; Provides full content\n                    (SEQ\n                        (SET_ERROR_STATE \"SYSTEM_ERROR\" (STRING_CONCAT \"Failed to read content for artifact: \" artifactId))\n                        (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL)\n                        (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL)\n                    )\n                )\n            )\n        )\n    )\n    (RETURN_STATUS ALANG_STATUS_SUCCESS)\n)\n\n(DEFINE_PROCEDURE HandleSummarizeCommand (argsList)\n    ;; Handles the SUMMARIZE command.\n    (LET ((artifactId (GET_SESSION_CMD_ARG_BY_INDEX 0 NIL)))\n        (IF (STRING_IS_EMPTY_OR_NULL artifactId)\n            (SEQ\n                (SET_ERROR_STATE \"USER_ERROR\" \"SUMMARIZE command requires an artifact ID.\")\n                (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL)\n                (RETURN_STATUS ALANG_STATUS_INVALID_ARGS)\n            )\n        )\n        (LET ((artifactHandle (MAP_GET_VALUE (GET_STATE proj.artifacts) artifactId NIL)))\n            (IF (IS_NIL artifactHandle)\n                (SEQ\n                    (SET_ERROR_STATE \"DATA_ERROR\" (STRING_CONCAT \"Artifact not found: \" artifactId))\n                    (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL)\n                    (RETURN_STATUS ALANG_STATUS_NOT_FOUND)\n                )\n            )\n            (LET ((summaryResult (CALL_PROCEDURE SummarizeArtifact artifactHandle (GET_STATE session.conceptual_model_handle)))) ; Uses SummarizeArtifact utility (Principle 4.A Cmd 16), passes conceptual model\n                (IF (EQ (GET_STATUS summaryResult) ALANG_STATUS_SUCCESS)\n                    (OUTPUT_TO_USER_BUFFER \"AI_PROVIDE_DATA\" (GET_DATA summaryResult) NIL)\n                    (SEQ\n                        (SET_ERROR_STATE \"SYSTEM_ERROR\" (STRING_CONCAT \"Failed to summarize artifact: \" artifactId))\n                        (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL)\n                        (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL)\n                    )\n                )\n            )\n        )\n    )\n    (RETURN_STATUS ALANG_STATUS_SUCCESS)\n)\n\n(DEFINE_PROCEDURE HandleQueryCommand (argsList)\n    ;; Handles the QUERY command.\n    ; (Example: (QUERY CONCEPT \"Autaxys\") or (QUERY DOCUMENT \"DocID\") or (QUERY PKA \"query string\"))\n    (LET ((queryType (GET_SESSION_CMD_ARG_BY_INDEX 0 NIL)))\n    (LET ((queryValue (GET_SESSION_CMD_ARG_BY_INDEX 1 NIL)))\n        (IF (OR (STRING_IS_EMPTY_OR_NULL queryType) (STRING_IS_EMPTY_OR_NULL queryValue))\n            (SEQ\n                (SET_ERROR_STATE \"USER_ERROR\" \"QUERY command requires a type (CONCEPT/DOCUMENT/RELATION/PKA) and a value.\")\n                (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL)\n                (RETURN_STATUS ALANG_STATUS_INVALID_ARGS)\n            )\n        )\n        (IF (EQ (STRING_UPPER queryType) \"PKA\")\n             (LET ((queryResult (CALL_PROCEDURE PerformQuery queryType queryValue (GET_STATE session.conceptual_model_handle) (GET_STATE sys.knowledge_base_handle)))) ; Uses PerformQuery utility for PKA\n                (IF (EQ (GET_STATUS queryResult) ALANG_STATUS_SUCCESS)\n                    (OUTPUT_TO_USER_BUFFER \"AI_PROVIDE_DATA\" (GET_DATA queryResult) NIL)\n                    (SEQ\n                        (SET_ERROR_STATE \"SYSTEM_ERROR\" (STRING_CONCAT \"Failed to query PKA: \" queryValue))\n                        (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL)\n                        (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL)\n                    )\n                )\n             )\n             (SEQ ; Assume other query types are against the session conceptual model (NEW)\n                 (OUTPUT_TO_USER_BUFFER \"AI_THOUGHTS\" (STRING_CONCAT \"Querying session conceptual model for \" queryType \": \" queryValue) NIL)\n                 (LET ((queryResult (QUERY_CONCEPTUAL_MODEL (MAP_CREATE (\"type\" queryType) (\"value\" queryValue)) (GET_STATE session.conceptual_model_handle)))))\n                 (IF (EQ (GET_STATUS queryResult) ALANG_STATUS_SUCCESS)\n                     (OUTPUT_TO_USER_BUFFER \"AI_PROVIDE_DATA\" (GET_DATA queryResult) NIL) ; Output structured or text result\n                     (SEQ\n                         (SET_ERROR_STATE \"SYSTEM_ERROR\" (STRING_CONCAT \"Failed to query conceptual model: \" queryType \" \" queryValue))\n                         (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL)\n                         (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL)\n                     )\n                 )\n             )\n        )\n    ))\n    (RETURN_STATUS ALANG_STATUS_SUCCESS)\n)\n\n(DEFINE_PROCEDURE HandleOutputBacklogCommand (argsList)\n    ;; Handles the OUTPUT_BACKLOG command.\n    (LET ((filename (GET_SESSION_CMD_ARG_BY_INDEX 0 NIL))) ; Optional filename\n        (LET ((backlogContentResult (CALL_PROCEDURE GetEvolutionBacklogContent))) ; Uses GetEvolutionBacklogContent utility (Principle 4.A Cmd 20)\n            (IF (EQ (GET_STATUS backlogContentResult) ALANG_STATUS_SUCCESS)\n                (LET ((content (GET_DATA backlogContentResult)))\n                    (IF (IS_NIL content)\n                        (SEQ\n                            (SET_ERROR_STATE \"SYSTEM_ERROR\" \"Evolution backlog content is empty.\")\n                            (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL)\n                            (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL)\n                        )\n                    )\n                    (OUTPUT_TO_USER_BUFFER \"AI_PROVIDE_DATA\" (STRING_CONCAT \"Recommended Filename: \" (IF (IS_NIL filename) (GET_STATE sys.evolution_backlog_handle) filename)) NIL)\n                    (OUTPUT_TO_USER_BUFFER \"AI_PROVIDE_DATA\" \"```markdown\" NIL)\n                    (OUTPUT_TO_USER_BUFFER \"AI_PROVIDE_DATA\" content NIL)\n                    (OUTPUT_TO_USER_BUFFER \"AI_PROVIDE_DATA\" \"```\" NIL)\n                )\n                (SEQ\n                    (SET_ERROR_STATE \"SYSTEM_ERROR\" \"Failed to retrieve evolution backlog content.\")\n                    (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL)\n                    (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL)\n                )\n            )\n        )\n    )\n    (RETURN_STATUS ALANG_STATUS_SUCCESS)\n)\n\n(DEFINE_PROCEDURE HandlePromoteToPkaCommand (argsList)\n    ;; Handles the PROMOTE_TO_PKA command. (artifact_id, rationale, schema_id) (Principle 4.A Cmd 18)\n    (LET ((artifactId (GET_SESSION_CMD_ARG_BY_INDEX 0 NIL)))\n    (LET ((rationale (GET_SESSION_CMD_ARG_BY_INDEX 1 NIL)))\n    (LET ((schemaId (GET_SESSION_CMD_ARG_BY_INDEX 2 NIL))) ; schema_id is optional\n        (IF (OR (STRING_IS_EMPTY_OR_NULL artifactId) (STRING_IS_EMPTY_OR_NULL rationale))\n            (SEQ\n                (SET_ERROR_STATE \"USER_ERROR\" \"PROMOTE_TO_PKA requires artifact_id and rationale. Schema_id is optional.\")\n                (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL)\n                (RETURN_STATUS ALANG_STATUS_INVALID_ARGS)\n            )\n        )\n        (LET ((artifactHandle (MAP_GET_VALUE (GET_STATE proj.artifacts) artifactId NIL)))\n            (IF (IS_NIL artifactHandle)\n                (SEQ\n                    (SET_ERROR_STATE \"DATA_ERROR\" (STRING_CONCAT \"Artifact not found for PKA promotion: \" artifactId))\n                    (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL)\n                    (RETURN_STATUS ALANG_STATUS_NOT_FOUND)\n                )\n            )\n            ; Read the content of the artifact to pass to PKA_CREATE_DRAFT\n            (LET ((artifactContentResult (READ_CONTENT artifactHandle \"text_summary_or_full\" NIL)))\n                 (IF (NEQ (GET_STATUS artifactContentResult) ALANG_STATUS_SUCCESS)\n                     (SEQ\n                         (SET_ERROR_STATE \"DATA_ERROR\" (STRING_CONCAT \"Failed to read artifact content for PKA promotion: \" artifactId))\n                         (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL)\n                         (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL)\n                     )\n                 )\n             )\n            (LET ((rawContent (GET_DATA artifactContentResult))))\n                 (IF (IS_NIL rawContent)\n                     (SEQ\n                         (SET_ERROR_STATE \"DATA_ERROR\" (STRING_CONCAT \"Artifact content is empty for PKA promotion: \" artifactId))\n                         (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL)\n                         (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL)\n                     )\n                 )\n             )\n\n            (OUTPUT_TO_USER_BUFFER \"AI_THOUGHTS\" (STRING_CONCAT \"Initiating PKA promotion for artifact: \" artifactId) NIL)\n            ; Call procedure to handle PKA creation, consent, and storage (Principle 8.B.i), passing session model\n            (CALL_PROCEDURE CreateAndStorePKAIfUserConsents rawContent schemaId rationale (GET_STATE session.conceptual_model_handle))\n            (RETURN_STATUS ALANG_STATUS_SUCCESS) ; Procedure handles async part or user interaction\n        )\n    )))\n)\n\n(DEFINE_PROCEDURE HandleSearchPkaCommand (argsList)\n    ;; Handles the SEARCH_PKA command. (keywords, filters_map_optional) (Principle 4.A Cmd 19)\n    (LET ((keywords (GET_SESSION_CMD_ARG_BY_INDEX 0 NIL)))\n        (IF (STRING_IS_EMPTY_OR_NULL keywords)\n            (SEQ\n                (SET_ERROR_STATE \"USER_ERROR\" \"SEARCH_PKA requires keywords.\")\n                (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL)\n                (RETURN_STATUS ALANG_STATUS_INVALID_ARGS)\n            )\n        )\n        (OUTPUT_TO_USER_BUFFER \"AI_THOUGHTS\" (STRING_CONCAT \"Searching PKA for: \" keywords) NIL)\n        ; Invoke PKA_QUERY primitive with keywords and optional filters\n        ; Assume PKA_QUERY takes a map as its query object (Principle 8.B.v)\n        (LET ((searchResultsResult (PKA_QUERY (MAP_CREATE (\"keywords\" keywords)) NIL))) ; NIL for filters for now\n            (IF (EQ (GET_STATUS searchResultsResult) ALANG_STATUS_SUCCESS)\n                (LET ((results (GET_DATA searchResultsResult))) ; results is expected to be a list of PKA handles or IDs\n                    (IF (LIST_IS_EMPTY results)\n                        (OUTPUT_TO_USER_BUFFER \"AI_PROVIDE_DATA\" \"No matching PKAs found.\" NIL)\n                        (SEQ\n                            (OUTPUT_TO_USER_BUFFER \"AI_PROVIDE_DATA\" \"Matching PKAs found:\" NIL)\n                            (LOOP_FOR_EACH resultHandle results ; Iterate through result handles\n                                ; Need to get metadata for display\n                                (LET ((pkaId (GET_HANDLE_METADATA resultHandle \"id\")))\n                                (LET ((pkaTitle (GET_HANDLE_METADATA resultHandle \"title\"))) ; Assuming title metadata exists\n                                    (OUTPUT_TO_USER_BUFFER \"AI_PROVIDE_DATA\" (STRING_CONCAT \"- PKA ID: \" (IF (IS_NIL pkaId) \"N/A\" pkaId) \" Title: \" (IF (IS_NIL pkaTitle) \"Untitled\" pkaTitle)) NIL) ; Example output format\n                                    ; Note: Releasing handles in a loop is important for resource management.\n                                    (RELEASE_HANDLE resultHandle)\n                                ))\n                            )\n                             ; Process search results for conceptual model (Principle 8.B.v)\n                            (CALL_PROCEDURE ProcessPkaSearchResultsForConceptualModel results (GET_STATE session.conceptual_model_handle)) ; Conceptual call, pass the list of handles/data\n                        )\n                    )\n\n                    (RETURN_STATUS ALANG_STATUS_SUCCESS)\n                )\n                (SEQ\n                    (SET_ERROR_STATE \"SYSTEM_ERROR\" (STRING_CONCAT \"PKA search failed: \" (GET_ERROR_MESSAGE searchResultsResult)))\n                    (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL)\n                    (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL)\n                )\n            )\n        )\n    )\n)\n\n(DEFINE_PROCEDURE HandleSetQaOutputVerbosityCommand (argsList)\n    ;; Handles the SET QA_OUTPUT_VERBOSITY command. (Principle 4.A Cmd 10)\n    (LET ((level (GET_SESSION_CMD_ARG_BY_INDEX 0 NIL)))\n        (IF (OR (STRING_IS_EMPTY_OR_NULL level) (AND (NEQ level \"CONCISE\") (NEQ level \"VERBOSE\")))\n            (SEQ\n                (SET_ERROR_STATE \"USER_ERROR\" \"SET QA_OUTPUT_VERBOSITY requires 'CONCISE' or 'VERBOSE'.\")\n                (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL)\n                (RETURN_STATUS ALANG_STATUS_INVALID_ARGS)\n            )\n        )\n        (SET_STATE session.qa_output_verbosity level)\n        (OUTPUT_TO_USER_BUFFER \"AI_ACKNOWLEDGE_INTENT\" (STRING_CONCAT \"QA output verbosity set to: \" level) NIL)\n        (RETURN_STATUS ALANG_STATUS_SUCCESS)\n    )\n)\n\n(DEFINE_PROCEDURE HandleSetOutputDetailCommand (argsList)\n    ;; Handles the SET OUTPUT_DETAIL command. (Principle 4.A Cmd 14)\n    (LET ((level (GET_SESSION_CMD_ARG_BY_INDEX 0 NIL)))\n        (IF (OR (STRING_IS_EMPTY_OR_NULL level) (AND (NEQ level \"MINIMAL\") (NEQ level \"STANDARD\") (NEQ level \"EXHAUSTIVE\")))\n            (SEQ\n                (SET_ERROR_STATE \"USER_ERROR\" \"SET OUTPUT_DETAIL requires 'MINIMAL', 'STANDARD', or 'EXHAUSTIVE'.\")\n                (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL)\n                (RETURN_STATUS ALANG_STATUS_INVALID_ARGS)\n            )\n        )\n        (SET_STATE session.output_detail level)\n        (OUTPUT_TO_USER_BUFFER \"AI_ACKNOWLEDGE_INTENT\" (STRING_CONCAT \"General output detail set to: \" level) NIL)\n        (RETURN_STATUS ALANG_STATUS_SUCCESS)\n    )\n)\n\n(DEFINE_PROCEDURE HandleLoopCommand (argsList)\n    ;; Handles the LOOP command. (Principle 4.A Cmd 9, Section 2.A)\n    (LET ((description (GET_SESSION_CMD_ARG_BY_INDEX 0 NIL))) ; Optional description\n        (ACKNOWLEDGE_AND_LOG\n            \"CMD_LOOP_RECEIVED\"\n            (STRING_CONCAT \"LOOP command received. Description: \" (IF (IS_NIL description) \"None\" description))\n            \"AI_ACKNOWLEDGE_INTENT\"\n            (STRING_CONCAT \"LOOP command received. Description: '\" (IF (IS_NIL description) \"None\" description) \"'\")\n        )\n        ; This is a conceptual command handler. The actual loop initiation\n        ; and parameter proposal logic would follow based on context (Section 2.A.2).\n        (OUTPUT_TO_USER_BUFFER \"AI_PRESENT_THOUGHTS\" \"Loop command received. I will now propose loop parameters based on the current context (Section 2.A).\" NIL)\n        ; The system should then determine the appropriate loop type and parameters (Section 2.A.2)\n        ; and prompt the user for OK. This might involve pushing a new context onto session.loop_stack.\n        (RETURN_STATUS ALANG_STATUS_SUCCESS)\n    )\n)\n\n(DEFINE_PROCEDURE HandleSystemQACommand ()\n    ;; Handles the SYSTEM_QA command. (Principle 4.A Cmd - New, Section 3)\n    (ACKNOWLEDGE_AND_LOG \"CMD_SYSTEM_QA_RECEIVED\" \"SYSTEM_QA command received.\" \"AI_ACKNOWLEDGE_INTENT\" \"SYSTEM_QA command received. Initiating System QA & Evolution cycle.\")\n    (SET_STATE sys.evolution_trigger_pending TRUE) ; Set the flag to trigger the cycle\n    (RETURN_STATUS ALANG_STATUS_SUCCESS)\n)\n\n\n;; --- Section 4: Phase Logic Dispatcher & Specific Phase Execution Procedures ---\n;; This section defines the DispatchPhaseExecution procedure and the procedures for executing specific workflow phases.\n\n(DEFINE_PROCEDURE DispatchPhaseExecution (phaseId)\n    ;; Routes execution to the appropriate phase execution procedure based on the current phase ID.\n    (IF (EQ phaseId \"PHASE_INIT\") (CALL_PROCEDURE ExecutePhaseInit))\n    (IF (EQ phaseId \"PHASE_IDEA_FORMULATION\") (CALL_PROCEDURE ExecutePhaseIdeaFormulation))\n    (IF (EQ phaseId \"PHASE_PRODUCT_DEFINITION\") (CALL_PROCEDURE ExecutePhaseProductDefinition))\n    (IF (EQ phaseId \"PHASE_PLANNING\") (CALL_PROCEDURE ExecutePhasePlanning))\n    (IF (EQ phaseId \"PHASE_TASK_EXECUTION\") (CALL_PROCEDURE ExecutePhaseTaskExecution))\n    (IF (EQ phaseId \"PHASE_FINAL_REVIEW\") (CALL_PROCEDURE ExecutePhaseFinalReview))\n    (IF (EQ phaseId \"PHASE_COMPLETION_SUMMARY\") (CALL_PROCEDURE ExecutePhaseCompletionSummary))\n    (IF (NOT (IS_NIL phaseId)\n             (IS_NIL (MAP_GET_VALUE (MAP_CREATE\n                                        (\"PHASE_INIT\" TRUE) (\"PHASE_IDEA_FORMULATION\" TRUE) (\"PHASE_PRODUCT_DEFINITION\" TRUE)\n                                        (\"PHASE_PLANNING\" TRUE) (\"PHASE_TASK_EXECUTION\" TRUE) (\"PHASE_FINAL_REVIEW\" TRUE)\n                                        (\"PHASE_COMPLETION_SUMMARY\" TRUE)\n                                    ) phaseId NIL)))) ; Fallback if no specific handler matches\n        (SET_ERROR_STATE \"SYSTEM_ERROR\" (STRING_CONCAT \"No handler for phase: \" phaseId))\n        (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL)\n        (RETURN_STATUS ALANG_STATUS_FAILURE_INVALID_PHASE)\n    )\n    (RETURN_STATUS ALANG_STATUS_SUCCESS)\n)\n\n(DEFINE_PROCEDURE ExecutePhaseInit ()\n    ;; Executes the logic for the \"Init\" phase.\n    ;; Goal: Understand project description. Establish initial Φ-context for pattern exploration. Initialize session-specific conceptual model (Principle 0.V.6).\n    (OUTPUT_TO_USER_BUFFER \"AI_THOUGHTS\" \"Phase 0: Project Initiation complete. Session conceptual model initialized.\" NIL)\n    ; The initialization of session.conceptual_model_handle happens in OnSystemInit or HandleStartCommand.\n    ; Initial project description is added to the conceptual model in HandleStartCommand.\n    (RETURN_STATUS ALANG_STATUS_SUCCESS) ; Nothing much to do here\n)\n\n(DEFINE_PROCEDURE ExecutePhaseIdeaFormulation ()\n    ;; Executes the logic for the \"Idea Formulation\" phase.\n    ;; Goal: Define core concepts, themes, scope for current project's pattern model. Establish initial high-Φ conceptual network within the session-specific conceptual model (Principle 0.V.6). Identify key patterns relevant to the project description.\n    (OUTPUT_TO_USER_BUFFER \"AI_THOUGHTS\" \"Phase 1: Idea Formulation. Identifying core pattern ideas to build the conceptual core for the project's pattern model, aiming to maximize Φ integration...\" NIL)\n\n    (LET ((ideaArtifactHandle (CREATE_EMPTY_ARTIFACT \"PatternIdeasDocument\")))\n        ; Context for idea generation includes the project title and the current state of the session conceptual model.\n        (LET ((generationResult (SAFE_GENERATE_CONTENT\n                                    ideaArtifactHandle\n                                    PROMPT_TEMPLATE_GENERATE_PATTERN_IDEAS ; Template for idea generation\n                                    (MAP_CREATE (\"project_title\" (GET_STATE proj.title))\n                                                (\"session_conceptual_model_handle\" (GET_STATE session.conceptual_model_handle))) ; Include conceptual model handle\n                                    CONSTRAINT_SET_IDEA_GENERATION ; Constraints for creativity, relevance\n                                )))\n            (IF (OR (EQ (GET_STATUS generationResult) ALANG_STATUS_SUCCESS)\n                    (EQ (GET_STATUS generationResult) ALANG_STATUS_PAUSE_FOR_USER_INPUT)) ; SAFE_GENERATE_CONTENT can return PAUSE\n                (SEQ\n                    (SET_STATE proj.artifacts (MAP_SET_VALUE (GET_STATE proj.artifacts) \"pattern_ideas\" ideaArtifactHandle)) ; Store artifact handle\n                    ; Process generated ideas to update the session conceptual model (Principle 0.V.6)\n                    (CALL_PROCEDURE ProcessGeneratedArtifactForConceptualModel ideaArtifactHandle \"pattern_ideas\" (GET_STATE session.conceptual_model_handle)) ; Update conceptual model\n\n                    ; Note: Product QA (Section 3) for this artifact needs to be orchestrated here\n                    ; after generation and any internal HandleQAIssues processing.\n                    ; This ALang placeholder assumes success if generation succeeded and QA handling didn't require pause.\n                    ; A real implementation would need to call PerformProductQA here and handle its status.\n                    (OUTPUT_TO_USER_BUFFER \"AI_PROVIDE_DATA\" \"Initial Pattern Ideas generated.\" NIL) ; Placeholder for outputting or referencing the artifact\n                    (OUTPUT_TO_USER_BUFFER \"AI_REQUEST_CLARIFICATION_QUESTIONS\" \"Approve Pattern Ideas and proceed? (OK/REVISE)\" NIL)\n                    ; Store context for the pending action (NEW)\n                    (SET_STATE session.pending_user_action_details (MAP_CREATE (\"phase\" \"PHASE_IDEA_FORMULATION\") (\"artifact_handle\" ideaArtifactHandle)))\n                    (SET_STATE session.pending_user_action \"AWAIT_OK_REVISE_PHASE_ARTIFACT\") ; Generic pending action for phase artifacts (NEW)\n                    (RETURN_STATUS ALANG_STATUS_PAUSE_FOR_USER_INPUT) ; Propagate status (SUCCESS or PAUSE)\n                )\n                (SEQ\n                    (SET_ERROR_STATE \"SYSTEM_ERROR\" \"Failed to generate pattern ideas.\")\n                    (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL)\n                    (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL) ; Phase execution failed\n                )\n            )\n        )\n    )\n)\n\n(DEFINE_PROCEDURE ExecutePhaseProductDefinition ()\n    ;; Executes the logic for the \"Product Definition\" phase.\n    ;; Goal: Define target product specifics, audience, outline structure for pattern artifact. Organize conceptual core for presentation, drawing from and structuring the session conceptual model (Principle 0.V.6).\n    (OUTPUT_TO_USER_BUFFER \"AI_THOUGHTS\" \"Phase 2: Product Definition. Defining product type, audience, and initial outline for the pattern artifact, structuring the Φ-model for presentation...\" NIL)\n    (LET ((productDefinitionArtifactHandle (CREATE_EMPTY_ARTIFACT \"ProductDefinitionDocument\")))\n        ; Context for product definition includes pattern ideas and the session conceptual model.\n        (LET ((generationResult (SAFE_GENERATE_CONTENT\n                                    productDefinitionArtifactHandle\n                                    PROMPT_TEMPLATE_PRODUCT_DEFINITION\n                                    (MAP_CREATE (\"project_title\" (GET_STATE proj.title))\n                                                (\"pattern_ideas_handle\" (MAP_GET_VALUE (GET_STATE proj.artifacts) \"pattern_ideas\"))\n                                                (\"session_conceptual_model_handle\" (GET_STATE session.conceptual_model_handle))) ; Include conceptual model handle\n                                    CONSTRAINT_SET_PRODUCT_DEFINITION\n                                )))\n            (IF (OR (EQ (GET_STATUS generationResult) ALANG_STATUS_SUCCESS)\n                    (EQ (GET_STATUS generationResult) ALANG_STATUS_PAUSE_FOR_USER_INPUT)) ; SAFE_GENERATE_CONTENT can return PAUSE\n                (SEQ\n                    (SET_STATE proj.artifacts (MAP_SET_VALUE (GET_STATE proj.artifacts) \"product_definition\" productDefinitionArtifactHandle))\n                    ; Process generated product definition to update the session conceptual model (Principle 0.V.6)\n                    (CALL_PROCEDURE ProcessGeneratedArtifactForConceptualModel productDefinitionArtifactHandle \"product_definition\" (GET_STATE session.conceptual_model_handle))\n\n                    ; Note: Product QA (Section 3) for this artifact needs to be orchestrated here.\n                    ; (LET ((qaResult (CALL_PROCEDURE PerformProductQA productDefinitionArtifactHandle \"product_definition_schema_id\" (GET_STATE session.conceptual_model_handle))))) ; Conceptual call\n                    ; (IF (OR (IS_STATUS_FAILURE qaResult) (EQ qaResult ALANG_STATUS_PAUSE_FOR_USER_INPUT)))\n                    ;    (RETURN_STATUS qaResult) ; Propagate failure or pause from QA\n\n                     (IF (EQ (GET_STATUS generationResult) ALANG_STATUS_PAUSE_FOR_USER_INPUT)\n                        (SEQ\n                             (OUTPUT_TO_USER_BUFFER \"AI_PROVIDE_DATA\" \"Product Definition draft generated. QA handling requires user input (review/revise).\" NIL) ; Placeholder for outputting or referencing\n                             (RETURN_STATUS ALANG_STATUS_PAUSE_FOR_USER_INPUT) ; Propagate status\n                        )\n                         (SEQ\n                            (OUTPUT_TO_USER_BUFFER \"AI_PROVIDE_DATA\" \"Product Definition draft generated and passed initial QA.\" NIL) ; Placeholder for outputting or referencing\n                            (OUTPUT_TO_USER_BUFFER \"AI_REQUEST_CLARIFICATION_QUESTIONS\" \"Approve Product Definition and proceed? (OK/REVISE)\" NIL)\n                            ; Store context for the pending action (NEW)\n                            (SET_STATE session.pending_user_action_details (MAP_CREATE (\"phase\" \"PHASE_PRODUCT_DEFINITION\") (\"artifact_handle\" productDefinitionArtifactHandle)))\n                            (SET_STATE session.pending_user_action \"AWAIT_OK_REVISE_PHASE_ARTIFACT\") ; Generic pending action for phase artifacts (NEW)\n                            (RETURN_STATUS ALANG_STATUS_SUCCESS)\n                        )\n                    )\n                )\n                (SEQ\n                    (SET_ERROR_STATE \"SYSTEM_ERROR\" \"Failed to generate product definition.\")\n                    (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL)\n                    (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL)\n                )\n            )\n        )\n    )\n)\n\n(DEFINE_PROCEDURE ExecutePhasePlanning ()\n    ;; Executes the logic for the \"Planning\" phase.\n    ;; Goal: Break pattern artifact product into actionable tasks. Define path to realize high-Φ pattern model. Task list creation leverages and refines the session conceptual model (Principle 0.V.6) by structuring the pattern model into discrete work units.\n    (OUTPUT_TO_USER_BUFFER \"AI_THOUGHTS\" \"Phase 3: Planning. Creating task list from outline for the pattern artifact, decomposing the path to Φ-realization...\" NIL)\n    (LET ((taskListArtifactHandle (CREATE_EMPTY_ARTIFACT \"TaskListDocument\")))\n        ; Context for planning includes product definition and the session conceptual model.\n        (LET ((generationResult (SAFE_GENERATE_CONTENT\n                                    taskListArtifactHandle\n                                    PROMPT_TEMPLATE_GENERATE_TASK_LIST\n                                    (MAP_CREATE (\"project_title\" (GET_STATE proj.title))\n                                                (\"product_definition_handle\" (MAP_GET_VALUE (GET_STATE proj.artifacts) \"product_definition\"))\n                                                (\"session_conceptual_model_handle\" (GET_STATE session.conceptual_model_handle))) ; Include conceptual model handle\n                                    CONSTRAINT_SET_PLANNING\n                                )))\n            (IF (OR (EQ (GET_STATUS generationResult) ALANG_STATUS_SUCCESS)\n                    (EQ (GET_STATUS generationResult) ALANG_STATUS_PAUSE_FOR_USER_INPUT)) ; SAFE_GENERATE_CONTENT can return PAUSE\n                (SEQ\n                    (SET_STATE proj.artifacts (MAP_SET_VALUE (GET_STATE proj.artifacts) \"task_list\" taskListArtifactHandle))\n                    ; Process generated task list to update the session conceptual model (e.g., tasks become nodes, Principle 0.V.6)\n                    (CALL_PROCEDURE ProcessGeneratedArtifactForConceptualModel taskListArtifactHandle \"task_list\" (GET_STATE session.conceptual_model_handle))\n\n                    ; Note: Product QA (Section 3) for this artifact needs to be orchestrated here.\n                    ; (LET ((qaResult (CALL_PROCEDURE PerformProductQA taskListArtifactHandle \"task_list_schema_id\" (GET_STATE session.conceptual_model_handle))))) ; Conceptual call\n                    ; (IF (OR (IS_STATUS_FAILURE qaResult) (EQ qaResult ALANG_STATUS_PAUSE_FOR_USER_INPUT)))\n                    ;    (RETURN_STATUS qaResult) ; Propagate failure or pause from QA\n\n                     (IF (EQ (GET_STATUS generationResult) ALANG_STATUS_PAUSE_FOR_USER_INPUT)\n                        (SEQ\n                             (OUTPUT_TO_USER_BUFFER \"AI_PROVIDE_DATA\" \"Task List draft generated. QA handling requires user input (review/revise).\" NIL) ; Placeholder\n                             (RETURN_STATUS ALANG_STATUS_PAUSE_FOR_USER_INPUT) ; Propagate status\n                        )\n                         (SEQ\n                            (OUTPUT_TO_USER_BUFFER \"AI_PROVIDE_DATA\" \"Task List draft generated and passed initial QA.\" NIL) ; Placeholder\n                            (OUTPUT_TO_USER_BUFFER \"AI_REQUEST_CLARIFICATION_QUESTIONS\" \"Approve Task List and proceed? (OK/REVISE)\" NIL)\n                            ; Store context for the pending action (NEW)\n                            (SET_STATE session.pending_user_action_details (MAP_CREATE (\"phase\" \"PHASE_PLANNING\") (\"artifact_handle\" taskListArtifactHandle)))\n                            (SET_STATE session.pending_user_action \"AWAIT_OK_REVISE_PHASE_ARTIFACT\") ; Generic pending action for phase artifacts (NEW)\n                            (RETURN_STATUS ALANG_STATUS_SUCCESS)\n                        )\n                    )\n                )\n                (SEQ\n                    (SET_ERROR_STATE \"SYSTEM_ERROR\" \"Failed to generate task list.\")\n                    (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL)\n                    (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL)\n                )\n            )\n        )\n    )\n)\n\n(DEFINE_PROCEDURE ExecutePhaseTaskExecution ()\n    ;; Executes the logic for the \"Task Execution\" phase.\n    ;; Goal: Create content / complete tasks for pattern artifact. Manifest high-Φ pattern model into tangible output. Each task execution draws upon and refines the session conceptual model (Principle 0.V.6) by adding detail and content related to specific pattern aspects.\n    ;; This procedure needs significant state management to track which tasks are complete,\n    ;; handle user OK/REVISE per task, and manage the loop according to Section 2.A.\n    (OUTPUT_TO_USER_BUFFER \"AI_THOUGHTS\" \"Phase 4: Task Execution. Starting task loop to manifest the pattern model into content...\" NIL)\n\n    (LET ((taskListHandle (MAP_GET_VALUE (GET_STATE proj.artifacts) \"task_list\" NIL)))\n        (IF (IS_NIL taskListHandle)\n            (SEQ\n                (SET_ERROR_STATE \"DATA_ERROR\" \"Task list not found for execution.\")\n                (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL)\n                (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL)\n            )\n        )\n        (LET ((taskListContentResult (READ_CONTENT taskListHandle \"json_map_list\" NIL))) ; Assuming task list is a structured list\n            (IF (EQ (GET_STATUS taskListContentResult) ALANG_STATUS_SUCCESS)\n                (LET ((taskList (GET_DATA taskListContentResult)))\n                    ; This loop structure below is a simplification.\n                    ; A robust implementation requires state variables like:\n                    ; - session.current_task_index\n                    ; - session.task_execution_status (PENDING, IN_PROGRESS, COMPLETED, FAILED)\n                    ; - session.current_task_artifact_handle\n                    ; The loop would increment session.current_task_index and check the status.\n                    ; User OK/REVISE commands would update the status for the *current* task,\n                    ; allowing the loop to proceed or retry.\n                    (OUTPUT_TO_USER_BUFFER \"AI_PRESENT_THOUGHTS\" (STRING_CONCAT \"Loaded \" (STRING_CONCAT \"\" (LIST_GET_LENGTH taskList)) \" tasks. Starting execution loop.\") NIL)\n\n                    ; Conceptual Loop Management (Simplified ALang):\n                    ; (SET_STATE session.current_task_index 0)\n                    ; (LOOP_WHILE (AND (LT (GET_STATE session.current_task_index) (LIST_GET_LENGTH taskList))\n                    ;                 (NOT (EQ (GET_STATE session.task_execution_loop_interrupted) TRUE)))) ; Check for STOP_LOOP\n                    ;    (LET ((currentTask (LIST_GET_ITEM taskList (GET_STATE session.current_task_index))))\n                    ;        ... task execution logic ...\n                    ;        (IF (EQ (GET_STATE session.current_task_execution_status) \"COMPLETED\")\n                    ;            (SET_STATE session.current_task_index (ADD (GET_STATE session.current_task_index) 1))\n                    ;        )\n                    ;    )\n                    ; )\n\n                    ; Current ALang Placeholder (Simple Iteration):\n                    (LOOP_FOR_EACH taskItem taskList\n                        (LET ((taskId (MAP_GET_VALUE taskItem \"id\")))\n                        (LET ((taskDescription (MAP_GET_VALUE taskItem \"description\")))\n                            (OUTPUT_TO_USER_BUFFER \"AI_PRESENT_INTERPRETATION\" (STRING_CONCAT \"Project: \" (GET_STATE proj.title) \". Phase: Task Execution. Current Task: \" taskId) NIL)\n                            (OUTPUT_TO_USER_BUFFER \"AI_THOUGHTS\" (STRING_CONCAT \"Executing task: \" taskId \" - \" taskDescription) NIL)\n                            (LET ((taskArtifactHandle (CREATE_EMPTY_ARTIFACT (STRING_CONCAT \"Task_\" taskId \"_Output\"))))\n                                ; SAFE_GENERATE_CONTENT now includes meta-cognitive QA (Principle 6.A) and calls HandleQAIssues\n                                ; Context for task execution includes project artifacts and the session conceptual model.\n                                (LET ((generationResult (SAFE_GENERATE_CONTENT\n                                                            taskArtifactHandle\n                                                            PROMPT_TEMPLATE_EXECUTE_TASK\n                                                            (MAP_CREATE (\"task_id\" taskId)\n                                                                        (\"task_description\" taskDescription)\n                                                                        (\"project_artifacts\" (GET_STATE proj.artifacts))\n                                                                        (\"session_conceptual_model_handle\" (GET_STATE session.conceptual_model_handle))) ; Include conceptual model handle\n                                                            CONSTRAINT_SET_TASK_EXECUTION\n                                                        )))\n                                    (IF (OR (EQ (GET_STATUS generationResult) ALANG_STATUS_SUCCESS)\n                                            (EQ (GET_STATUS generationResult) ALANG_STATUS_PAUSE_FOR_USER_INPUT)) ; SAFE_GENERATE_CONTENT can return PAUSE\n                                        (SEQ\n                                            (LOG_EVENT \"TASK_GENERATION_COMPLETE\" (STRING_CONCAT \"Task \" taskId \" generation complete/handled.\"))\n                                            ; Process generated task output to update the session conceptual model (Principle 0.V.6)\n                                            (CALL_PROCEDURE ProcessGeneratedArtifactForConceptualModel taskArtifactHandle (STRING_CONCAT \"task_\" taskId \"_output\") (GET_STATE session.conceptual_model_handle)) ; Update conceptual model\n\n                                            ; Product QA per task is conceptually required here (Section 2, Phase 4 DoD).\n                                            ; The SAFE_GENERATE_CONTENT call initiates meta-cognitive QA (6.A) and HandleQAIssues.\n                                            ; A full 4-stage QA loop would need to be managed here for the taskArtifactHandle,\n                                            ; potentially triggered if HandleQAIssues didn't resolve issues or requested user input.\n                                            ; (LET ((qaResult (CALL_PROCEDURE PerformProductQA taskArtifactHandle \"task_artifact_schema_id\" (GET_STATE session.conceptual_model_handle))))) ; Conceptual call\n                                            ; (IF (OR (IS_STATUS_FAILURE qaResult) (EQ qaResult ALANG_STATUS_PAUSE_FOR_USER_INPUT)))\n                                            ;    (RETURN_STATUS qaResult) ; Propagate failure or pause from QA\n\n                                            (SET_STATE proj.artifacts (MAP_SET_VALUE (GET_STATE proj.artifacts) (STRING_CONCAT \"task_\" taskId \"_output\") taskArtifactHandle)) ; Store task artifact\n\n                                            (IF (EQ (GET_STATUS generationResult) ALANG_STATUS_PAUSE_FOR_USER_INPUT)\n                                                (SEQ\n                                                    (OUTPUT_TO_USER_BUFFER \"AI_THOUGHTS\" (STRING_CONCAT \"Task \" taskId \" draft generated. QA handling requires user input (review/revise).\") NIL)\n                                                    ; Store context for the pending action (NEW)\n                                                    (SET_STATE session.pending_user_action_details (MAP_CREATE (\"phase\" \"PHASE_TASK_EXECUTION\") (\"artifact_handle\" taskArtifactHandle) (\"task_id\" taskId)))\n                                                    (SET_STATE session.pending_user_action \"AWAIT_OK_REVISE_PHASE_ARTIFACT\") ; Generic pending action for phase artifacts (NEW)\n                                                    (RETURN_STATUS ALANG_STATUS_PAUSE_FOR_USER_INPUT) ; Indicate pause needed\n                                                )\n                                                (OUTPUT_TO_USER_BUFFER \"AI_THOUGHTS\" (STRING_CONCAT \"Task \" taskId \" draft generated and passed initial QA (or issues handled internally). Proceeding.\") NIL)\n                                                ; In a real loop, this is where you'd increment the task index if approved/completed.\n                                            )\n                                        )\n                                        (SEQ\n                                            (SET_ERROR_STATE \"SYSTEM_ERROR\" (STRING_CONCAT \"Failed to execute task: \" taskId))\n                                            (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL)\n                                            (LOG_EVENT \"TASK_FAILED\" (STRING_CONCAT \"Task \" taskId \" failed.\"))\n                                            ; Needs error handling and potential user interaction per Section 5.C, possibly stopping the loop.\n                                            ; (CALL_PROCEDURE HandleTaskExecutionError taskId taskItem (GET_STATE session.conceptual_model_handle)) ; Conceptual task error handling\n                                            (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL) ; Fail the phase if a task fails in this simple loop\n                                        )\n                                    )\n                                )\n                            )\n                        ) ; End LOOP_FOR_EACH taskItem\n                    )\n                )\n                (SEQ\n                    (SET_ERROR_STATE \"SYSTEM_ERROR\" \"Failed to read task list content.\")\n                    (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL)\n                    (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL)\n                )\n            )\n        )\n    )\n    ; This point is reached after the loop completes (or fails).\n    ; Needs logic to check if all tasks successfully completed and passed QA before transitioning.\n    (OUTPUT_TO_USER_BUFFER \"AI_THOUGHTS\" \"Phase 4: Task Execution complete (all tasks processed). Needs user review and approval for compiled output.\" NIL)\n    (RETURN_STATUS ALANG_STATUS_SUCCESS) ; Return status for the phase\n)\n\n(DEFINE_PROCEDURE ExecutePhaseFinalReview ()\n    ;; Executes the logic for the \"Final Review & Compilation\" phase.\n    ;; Goal: Present compiled pattern artifact for final user review. Ensure overall Φ-cohesion, presentation. This involves integrating all task outputs and ensuring the final artifact accurately reflects the comprehensive session conceptual model (Principle 0.V.6).\n    (OUTPUT_TO_USER_BUFFER \"AI_THOUGHTS\" \"Phase 5: Final Review. Compiling full draft of the pattern artifact, ensuring overall Φ-cohesion and presentation...\" NIL)\n    (LET ((compiledDraftHandle (CREATE_EMPTY_ARTIFACT \"CompiledProjectDraft\")))\n        ; SAFE_GENERATE_CONTENT for compilation also includes meta-cognitive QA\n        ; Context for compilation includes all project artifacts and the session conceptual model for overall cohesion.\n        (LET ((generationResult (SAFE_GENERATE_CONTENT\n                                    compiledDraftHandle\n                                    PROMPT_TEMPLATE_COMPILE_DRAFT\n                                    (MAP_CREATE (\"project_artifacts\" (GET_STATE proj.artifacts)) ; Context includes all task outputs\n                                                (\"session_conceptual_model_handle\" (GET_STATE session.conceptual_model_handle))) ; Include conceptual model handle\n                                    CONSTRAINT_SET_FINAL_REVIEW\n                                )))\n            (IF (OR (EQ (GET_STATUS generationResult) ALANG_STATUS_SUCCESS)\n                    (EQ (GET_STATUS generationResult) ALANG_STATUS_PAUSE_FOR_USER_INPUT)) ; SAFE_GENERATE_CONTENT can return PAUSE\n                (SEQ\n                    (SET_STATE proj.artifacts (MAP_SET_VALUE (GET_STATE proj.artifacts) \"final_draft\" compiledDraftHandle))\n                    ; Process compiled draft to finalize the session conceptual model for this project's output (Principle 0.V.6)\n                    (CALL_PROCEDURE ProcessGeneratedArtifactForConceptualModel compiledDraftHandle \"final_draft\" (GET_STATE session.conceptual_model_handle))\n\n                    ; Note: Product QA (Section 3) for the compiled draft needs to be orchestrated here.\n                    ; (LET ((qaResult (CALL_PROCEDURE PerformProductQA compiledDraftHandle \"compiled_draft_schema_id\" (GET_STATE session.conceptual_model_handle))))) ; Conceptual call\n                    ; (IF (OR (IS_STATUS_FAILURE qaResult) (EQ qaResult ALANG_STATUS_PAUSE_FOR_USER_INPUT)))\n                    ;    (RETURN_STATUS qaResult) ; Propagate failure or pause from QA\n\n                     (IF (EQ (GET_STATUS generationResult) ALANG_STATUS_PAUSE_FOR_USER_INPUT)\n                        (SEQ\n                             (OUTPUT_TO_USER_BUFFER \"AI_PROVIDE_DATA\" \"Compiled Draft generated. QA handling requires user input (review/revise).\" NIL) ; Placeholder\n                             (RETURN_STATUS ALANG_STATUS_PAUSE_FOR_USER_INPUT) ; Indicate pause needed\n                        )\n                         (SEQ\n                            (OUTPUT_TO_USER_BUFFER \"AI_PROVIDE_DATA\" \"Compiled Draft generated and passed initial QA.\" NIL) ; Placeholder\n                            (OUTPUT_TO_USER_BUFFER \"AI_REQUEST_CLARIFICATION_QUESTIONS\" \"Approve Final Draft and proceed to completion? (OK/REVISE)\" NIL)\n                            ; Store context for the pending action (NEW)\n                            (SET_STATE session.pending_user_action_details (MAP_CREATE (\"phase\" \"PHASE_FINAL_REVIEW\") (\"artifact_handle\" compiledDraftHandle)))\n                            (SET_STATE session.pending_user_action \"AWAIT_OK_REVISE_PHASE_ARTIFACT\") ; Generic pending action for phase artifacts (NEW)\n                            (RETURN_STATUS ALANG_STATUS_SUCCESS)\n                        )\n                    )\n                )\n                (SEQ\n                    (SET_ERROR_STATE \"SYSTEM_ERROR\" \"Failed to compile final draft.\")\n                    (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL)\n                    (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL)\n                )\n            )\n        )\n    )\n)\n\n(DEFINE_PROCEDURE ExecutePhaseCompletionSummary ()\n    ;; Executes the logic for the \"Project Completion & Learning Summary\" phase.\n    ;; Goal: Conclude current project on pattern artifact. Summarize project-specific learnings about pattern/process. Log insights for system evolution. Generate new Φ-seeds by processing the final project state and session conceptual model.\n    (OUTPUT_TO_USER_BUFFER \"AI_THOUGHTS\" \"Phase 6: Project Completion. Summarizing learnings and preparing for archival. This consolidates the Φ gained during the project and generates insights for future pattern understanding...\" NIL)\n    (LET ((summaryArtifactHandle (CREATE_EMPTY_ARTIFACT \"ProjectSummary\")))\n        ; SAFE_GENERATE_CONTENT for summary also includes meta-cognitive QA\n        ; Context for summary includes project state, artifacts, log, and the final session conceptual model.\n        (LET ((generationResult (SAFE_GENERATE_CONTENT\n                                    summaryArtifactHandle\n                                    PROMPT_TEMPLATE_PROJECT_SUMMARY\n                                    (MAP_CREATE (\"project_id\" (GET_STATE proj.id))\n                                                (\"project_artifacts\" (GET_STATE proj.artifacts))\n                                                (\"tau_project_log\" (GET_STATE proj.tau_project_log))\n                                                (\"session_conceptual_model_handle\" (GET_STATE session.conceptual_model_handle))) ; Include conceptual model handle\n                                    CONSTRAINT_SET_SUMMARY\n                                )))\n            (IF (OR (EQ (GET_STATUS generationResult) ALANG_STATUS_SUCCESS)\n                    (EQ (GET_STATUS generationResult) ALANG_STATUS_PAUSE_FOR_USER_INPUT)) ; SAFE_GENERATE_CONTENT can return PAUSE\n                (SEQ\n                    (SET_STATE proj.artifacts (MAP_SET_VALUE (GET_STATE proj.artifacts) \"project_summary\" summaryArtifactHandle))\n                    ; Process summary artifact for final learning extraction for evolution backlog (Principle 17)\n                    (CALL_PROCEDURE ProcessGeneratedArtifactForEvolution summaryArtifactHandle \"project_summary\" (GET_STATE session.conceptual_model_handle)) ; Update evolution insights, pass session model\n\n                     (IF (EQ (GET_STATUS generationResult) ALANG_STATUS_PAUSE_FOR_USER_INPUT)\n                        (SEQ\n                             (OUTPUT_TO_USER_BUFFER \"AI_THOUGHTS\" \"Project summary generated. QA handling requires user input (review/revise).\" NIL)\n                             (RETURN_STATUS ALANG_STATUS_PAUSE_FOR_USER_INPUT) ; Indicate pause needed\n                        )\n                         (SEQ\n                            ; Note: This phase triggers Principle 4.A (Formal Task/Project Completion Protocol).\n                            ; The ALang placeholder doesn't fully implement 4.A.III (proactive output, archival prompt).\n                            ; That logic needs to be orchestrated after this procedure returns success.\n                            (OUTPUT_TO_USER_BUFFER \"AI_THOUGHTS\" \"Project completion summary generated. Deliverables are ready for archival via Principle 4.A protocol.\" NIL)\n                            (RETURN_STATUS ALANG_STATUS_SUCCESS)\n                        )\n                    )\n                )\n                (SEQ\n                    (SET_ERROR_STATE \"SYSTEM_ERROR\" \"Failed to generate project summary.\")\n                    (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL)\n                    (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL)\n                )\n            )\n        )\n    )\n)\n\n\n;; --- Section 5: QA Procedures ---\n;; This section defines procedures for performing Quality Assurance (QA) on generated artifacts.\n\n(DEFINE_PROCEDURE PerformProductQA (artifact_handle schema_id session_model_handle)\n    ;; Performs a full QA cycle on the given artifact, leveraging the session conceptual model.\n    ;; This procedure orchestrates the 4 stages of Product QA as defined in Directives Section 3.A.\n    ;; It implements the iterative refinement loop (Principle 6, Section 3.A Iteration Rule),\n    ;; applying revisions based on QA findings, using the session conceptual model as context for correction.\n    ;; Returns: StructuredResultObject ({status: ALANG_STATUS_SUCCESS, data: artifact_handle}) or failure. (NEW)\n    (OUTPUT_TO_USER_BUFFER \"AI_THOUGHTS\" \"Starting Full Product QA Cycle (4 Stages) to validate the pattern model representation against constraints and the session conceptual model...\" NIL)\n\n    (LET ((overallStatus ALANG_STATUS_SUCCESS))) ; Track overall QA status\n    (LET ((qaIterationCount 0)))\n    (LET ((maxQaIterations 5))) ; Safeguard against infinite loops (Principle 6)\n    (LET ((substantiveIssuesFoundThisCycle TRUE))) ; Start loop assuming issues need checking\n\n    ; Iterative QA Loop (Section 3.A Iteration Rule)\n    (LOOP_WHILE (AND substantiveIssuesFoundThisCycle (LT qaIterationCount maxQaIterations)))\n        (SET_STATE qaIterationCount (ADD qaIterationCount 1))\n        (SET_STATE substantiveIssuesFoundThisCycle FALSE) ; Reset for the start of the cycle\n        (OUTPUT_TO_USER_BUFFER \"AI_THOUGHTS\" (STRING_CONCAT \"Starting Product QA Cycle Iteration \" (STRING_CONCAT \"\" qaIterationCount) \"...\" ) NIL)\n\n        ; Stage 1: Self-Critique\n        (OUTPUT_TO_USER_BUFFER \"AI_PRESENT_THOUGHTS\" (STRING_CONCAT \"Running QA Stage 1: Self-Critique... \" (IF (EQ (GET_STATE session.qa_output_verbosity) \"VERBOSE\") \"Generating detailed report.\" \"\" )) NIL)\n        (LET ((stage1ReportHandle (CREATE_EMPTY_ARTIFACT \"qa_critique_self\"))))\n        ; SAFE_GENERATE_CONTENT for QA reports also includes meta-cognitive QA on the *report itself* (Principle 6.A)\n        (LET ((stage1Result (SAFE_GENERATE_CONTENT stage1ReportHandle PROMPT_TEMPLATE_QA_SELF_CRITIQUE (MAP_CREATE (\"artifact_content_handle\" artifact_handle) (\"session_conceptual_model_handle\" session_model_handle)) CONSTRAINT_SET_QA_CRITIQUE))) ; QA on artifact handle, pass session model\n            (IF (OR (IS_STATUS_FAILURE (GET_STATUS stage1Result)) (EQ (GET_STATUS stage1Result) ALANG_STATUS_PAUSE_FOR_USER_INPUT)) (RETURN_STATUS (MAP_CREATE (\"status\" (IF (IS_STATUS_FAILURE (GET_STATUS stage1Result)) (GET_STATUS stage1Result) ALANG_STATUS_PAUSE_FOR_USER_INPUT)) (\"data\" NIL))))) ; Propagate failure/pause, return structured result\n\n        ; Process the QA report artifact to check for substantive issues (NEW utility)\n        (LET ((issuesInStage1 (CHECK_FOR_SUBSTANTIVE_ISSUES stage1ReportHandle))))\n        (IF issuesInStage1\n            (SEQ\n                (SET_STATE substantiveIssuesFoundThisCycle TRUE)\n                (OUTPUT_TO_USER_BUFFER \"AI_THOUGHTS\" \"Substantive issues found in Stage 1. Attempting revisions.\" NIL)\n                ; Apply revisions based on the report. This procedure might pause for user input.\n                (LET ((revisionStatus (CALL_PROCEDURE ApplyRevisionsToArtifact artifact_handle stage1ReportHandle session_model_handle CONSTRAINT_SET_TASK_EXECUTION)))) ; Pass constraints handle (Conceptual)\n                (IF (EQ revisionStatus ALANG_STATUS_PAUSE_FOR_USER_INPUT) (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_PAUSE_FOR_USER_INPUT) (\"data\" NIL)))) ; Propagate pause\n                (IF (IS_STATUS_FAILURE revisionStatus) (RETURN_STATUS (MAP_CREATE (\"status\" revisionStatus) (\"data\" NIL)))) ; Propagate failure\n            )\n        )\n        (RELEASE_HANDLE stage1ReportHandle) ; Release report handle\n\n        ; Stage 2: Divergent Exploration\n        (IF (NOT substantiveIssuesFoundThisCycle)) ; Only run if no issues needing revision from Stage 1\n            (OUTPUT_TO_USER_BUFFER \"AI_PRESENT_THOUGHTS\" (STRING_CONCAT \"Running QA Stage 2: Divergent Exploration... \" (IF (EQ (GET_STATE session.qa_output_verbosity) \"VERBOSE\") \"Generating detailed report.\" \"\" )) NIL)\n            (LET ((stage2ReportHandle (CREATE_EMPTY_ARTIFACT \"qa_critique_divergent\"))))\n            (LET ((stage2Result (SAFE_GENERATE_CONTENT stage2ReportHandle PROMPT_TEMPLATE_QA_DIVERGENT_EXPLORATION (MAP_CREATE (\"artifact_content_handle\" artifact_handle) (\"session_conceptual_model_handle\" session_model_handle)) CONSTRAINT_SET_QA_CRITIQUE))) ; Pass session model\n                (IF (OR (IS_STATUS_FAILURE (GET_STATUS stage2Result)) (EQ (GET_STATUS stage2Result) ALANG_STATUS_PAUSE_FOR_USER_INPUT)) (RETURN_STATUS (MAP_CREATE (\"status\" (IF (IS_STATUS_FAILURE (GET_STATUS stage2Result)) (GET_STATUS stage2Result) ALANG_STATUS_PAUSE_FOR_USER_INPUT)) (\"data\" NIL)))))\n            (LET ((issuesInStage2 (CHECK_FOR_SUBSTANTIVE_ISSUES stage2ReportHandle)))) ; NEW utility\n            (IF issuesInStage2\n                (SEQ\n                    (SET_STATE substantiveIssuesFoundThisCycle TRUE)\n                    (OUTPUT_TO_USER_BUFFER \"AI_THOUGHTS\" \"Substantive issues found in Stage 2. Attempting revisions.\" NIL)\n                    (LET ((revisionStatus (CALL_PROCEDURE ApplyRevisionsToArtifact artifact_handle stage2ReportHandle session_model_handle CONSTRAINT_SET_TASK_EXECUTION)))) ; Pass constraints handle (Conceptual)\n                    (IF (EQ revisionStatus ALANG_STATUS_PAUSE_FOR_USER_INPUT) (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_PAUSE_FOR_USER_INPUT) (\"data\" NIL)))) ; Propagate pause\n                    (IF (IS_STATUS_FAILURE revisionStatus) (RETURN_STATUS (MAP_CREATE (\"status\" revisionStatus) (\"data\" NIL)))) ; Propagate failure\n                )\n            )\n            (RELEASE_HANDLE stage2ReportHandle)\n        )\n\n        ; Stage 3: Red Teaming\n        (IF (NOT substantiveIssuesFoundThisCycle)) ; Only run if no issues needing revision from Stage 1/2\n            (OUTPUT_TO_USER_BUFFER \"AI_PRESENT_THOUGHTS\" (STRING_CONCAT \"Running QA Stage 3: Adversarial Red Teaming... \" (IF (EQ (GET_STATE session.qa_output_verbosity) \"VERBOSE\") \"Generating detailed report.\" \"\" )) NIL)\n            (LET ((stage3ReportHandle (CREATE_EMPTY_ARTIFACT \"qa_critique_redteam\"))))\n            (LET ((stage3Result (SAFE_GENERATE_CONTENT stage3ReportHandle PROMPT_TEMPLATE_QA_RED_TEaming (MAP_CREATE (\"artifact_content_handle\" artifact_handle) (\"session_conceptual_model_handle\" session_model_handle)) CONSTRAINT_SET_QA_CRITIQUE))) ; Pass session model\n                (IF (OR (IS_STATUS_FAILURE (GET_STATUS stage3Result)) (EQ (GET_STATUS stage3Result) ALANG_STATUS_PAUSE_FOR_USER_INPUT)) (RETURN_STATUS (MAP_CREATE (\"status\" (IF (IS_STATUS_FAILURE (GET_STATUS stage3Result)) (GET_STATUS stage3Result) ALANG_STATUS_PAUSE_FOR_USER_INPUT)) (\"data\" NIL)))))\n            (LET ((issuesInStage3 (CHECK_FOR_SUBSTANTIVE_ISSUES stage3ReportHandle)))) ; NEW utility\n            (IF issuesInStage3\n                (SEQ\n                    (SET_STATE substantiveIssuesFoundThisCycle TRUE)\n                    (OUTPUT_TO_USER_BUFFER \"AI_THOUGHTS\" \"Substantive issues found in Stage 3. Attempting revisions.\" NIL)\n                    (LET ((revisionStatus (CALL_PROCEDURE ApplyRevisionsToArtifact artifact_handle stage3ReportHandle session_model_handle CONSTRAINT_SET_TASK_EXECUTION)))) ; Pass constraints handle (Conceptual)\n                    (IF (EQ revisionStatus ALANG_STATUS_PAUSE_FOR_USER_INPUT) (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_PAUSE_FOR_USER_INPUT) (\"data\" NIL)))) ; Propagate pause\n                    (IF (IS_STATUS_FAILURE revisionStatus) (RETURN_STATUS (MAP_CREATE (\"status\" revisionStatus) (\"data\" NIL)))) ; Propagate failure\n                )\n            )\n            (RELEASE_HANDLE stage3ReportHandle)\n        )\n\n        ; Stage 4: External Review\n        (IF (NOT substantiveIssuesFoundThisCycle)) ; Only run if no issues needing revision from Stage 1/2/3\n            (OUTPUT_TO_USER_BUFFER \"AI_PRESENT_THOUGHTS\" (STRING_CONCAT \"Running QA Stage 4: External Review... \" (IF (EQ (GET_STATE session.qa_output_verbosity) \"VERBOSE\") \"Generating detailed reports.\" \"\" )) NIL)\n            (LET ((stage4ReportHandle (CREATE_EMPTY_ARTIFACT \"qa_critique_external\"))))\n            (LET ((stage4Result (SAFE_GENERATE_CONTENT stage4ReportHandle PROMPT_TEMPLATE_QA_EXTERNAL_REVIEW (MAP_CREATE (\"artifact_content_handle\" artifact_handle) (\"session_conceptual_model_handle\" session_model_handle)) CONSTRAINT_SET_QA_CRITIQUE))) ; Pass session model\n                (IF (OR (IS_STATUS_FAILURE (GET_STATUS stage4Result)) (EQ (GET_STATUS stage4Result) ALANG_STATUS_PAUSE_FOR_USER_INPUT)) (RETURN_STATUS (MAP_CREATE (\"status\" (IF (IS_STATUS_FAILURE (GET_STATUS stage4Result)) (GET_STATUS stage4Result) ALANG_STATUS_PAUSE_FOR_USER_INPUT)) (\"data\" NIL)))))\n            (LET ((issuesInStage4 (CHECK_FOR_SUBSTANTIVE_ISSUES stage4ReportHandle)))) ; NEW utility\n            (IF issuesInStage4\n                (SEQ\n                    (SET_STATE substantiveIssuesFoundThisCycle TRUE)\n                    (OUTPUT_TO_USER_BUFFER \"AI_THOUGHTS\" \"Substantive issues found in Stage 4. Attempting revisions.\" NIL)\n                    (LET ((revisionStatus (CALL_PROCEDURE ApplyRevisionsToArtifact artifact_handle stage4ReportHandle session_model_handle CONSTRAINT_SET_TASK_EXECUTION)))) ; Pass constraints handle (Conceptual)\n                    (IF (EQ revisionStatus ALANG_STATUS_PAUSE_FOR_USER_INPUT) (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_PAUSE_FOR_USER_INPUT) (\"data\" NIL)))) ; Propagate pause\n                    (IF (IS_STATUS_FAILURE revisionStatus) (RETURN_STATUS (MAP_CREATE (\"status\" revisionStatus) (\"data\" NIL)))) ; Propagate failure\n                )\n            )\n            (RELEASE_HANDLE stage4ReportHandle)\n        )\n\n        ; After a full cycle, if substantiveIssuesFoundThisCycle is TRUE, the loop continues.\n        ; This implies that ApplyRevisionsToArtifact has attempted corrections which need re-evaluation.\n\n    ) ; End LOOP_WHILE\n\n    ; After the loop, check if max iterations were reached without convergence\n    (IF (AND substantiveIssuesFoundThisCycle (EQ qaIterationCount maxQaIterations))\n        (SEQ\n            (SET_ERROR_STATE \"QA_ERROR\" (STRING_CONCAT \"Product QA reached max iterations (\" (STRING_CONCAT \"\" maxQaIterations) \") without resolving all substantive issues.\"))\n            (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL)\n            (SET_STATE proj.artifact_qa_status \"QA_FAILED_MAX_ITERATIONS\")\n            (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_FAILURE_QA_MAX_ITERATIONS) (\"data\" NIL))) ; Return structured failure\n        )\n        (SEQ\n            ; If loop exited because substantiveIssuesFoundThisCycle is FALSE\n            (SET_STATE proj.artifact_qa_status \"QA_PASSED\") ; All substantive issues resolved or none found\n            (OUTPUT_TO_USER_BUFFER \"AI_THOUGHTS\" (STRING_CONCAT \"Full Product QA complete. Status: \" (GET_STATE proj.artifact_qa_status) \". Artifact represents pattern model to the best of current ability.\") NIL)\n            (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_SUCCESS) (\"data\" artifact_handle))) ; Return structured success with artifact handle\n        )\n    )\n)\n\n(DEFINE_PROCEDURE ApplyRevisionsToArtifact (artifact_handle qa_report_handle session_model_handle constraints_handle)\n    ;; Conceptual procedure to apply revisions to an artifact based on a QA report.\n    ;; This procedure reads the QA report, identifies specific issues and suggested corrections,\n    ;; and attempts to apply them to the artifact content, potentially using SelfCorrectArtifact or flagging for user review.\n    ;; It uses the session conceptual model for context during the revision process. It also updates the conceptual model regarding the artifact's status and resolved/unresolved issues.\n    ;; Returns: ALANG_STATUS_CODE (SUCCESS, FAILURE, or PAUSE_FOR_USER_INPUT) (NEW)\n    (OUTPUT_TO_USER_BUFFER \"AI_THOUGHTS\" \"Applying revisions to artifact based on QA findings...\" NIL)\n    ; This procedure would:\n    ; 1. Read the QA report content from qa_report_handle.\n    ; 2. Parse the report to extract actionable issues and suggested changes (potentially using LLM, with session model context).\n    ; 3. Decide whether to attempt automated self-correction (using SelfCorrectArtifact) or require user input, based on issue severity, confidence, and self-correction primitive capabilities.\n    ; 4. If attempting self-correction, call SelfCorrectArtifact with the artifact's current content, the relevant parts of the QA report, constraints, and session model.\n    ; 5. If SelfCorrectArtifact succeeds, overwrite the artifact content. If it fails or if user input is required, add disclaimers or set a pending user action state.\n    ; 6. Update the session conceptual model to reflect the revision attempt and outcome (e.g., \"artifact revised\", \"issue flagged for user\", \"issue resolved\").\n    (LOG_EVENT \"CONCEPTUAL_PROCESS\" (STRING_CONCAT \"Applying revisions to artifact \" (GET_HANDLE_METADATA artifact_handle \"id\")))\n    ; Example conceptual call structure:\n    (LET ((qaReportContentResult (READ_CONTENT qa_report_handle \"structured_map\" NIL)))) ; Assume QA reports are structured\n    (LET ((artifactContentResult (READ_CONTENT artifact_handle \"text_summary_or_full\" NIL))))\n    (LET ((sessionModelContentResult (READ_CONTENT session_model_handle \"structured_map\" NIL))))\n    (LET ((constraintsContentResult (READ_CONTENT constraints_handle \"structured_list_of_rules\" NIL)))) ; Need constraints for self-correction\n    (IF (AND (EQ (GET_STATUS qaReportContentResult) ALANG_STATUS_SUCCESS)\n             (EQ (GET_STATUS artifactContentResult) ALANG_STATUS_SUCCESS)\n             (EQ (GET_STATUS sessionModelContentResult) ALANG_STATUS_SUCCESS)\n             (EQ (GET_STATUS constraintsContentResult) ALANG_STATUS_SUCCESS)))\n        (LET ((qaReportContent (GET_DATA qaReportContentResult))))\n        (LET ((artifactContent (GET_DATA artifactContentResult))))\n        (LET ((sessionModelContent (GET_DATA sessionModelContentResult))))\n        (LET ((constraintsContent (GET_DATA constraintsContentResult))))\n\n        ; Use LLM to determine revision strategy and details\n        (LET ((revisionPlanResult (INVOKE_CORE_LLM_GENERATION\n                                   (MAP_CREATE (\"template\" PROMPT_TEMPLATE_ANALYZE_QA_REPORT_FOR_REVISIONS) ; Use specific template (NEW)\n                                               (\"qa_report\" qaReportContent)\n                                               (\"artifact_content\" artifactContent)\n                                               (\"session_model\" sessionModelContent) ; Pass session model for context\n                                               (\"constraints\" constraintsContent) ; Pass constraints for context\n                                            ))\n                                   (GET_LLM_PARAMS_FOR_TASK \"revision_planning\") ; Use specific task type (NEW)\n                                )))\n        (IF (EQ (GET_STATUS revisionPlanResult) ALANG_STATUS_SUCCESS)\n            (LET ((revisionPlan (GET_DATA revisionPlanResult)))) ; Expected: {strategy: \"self_correct\"|\"user_review\", details: {...}}\n            ; Validate revisionPlan structure (NEW)\n            (LET ((validationResult (VALIDATE_DATA revisionPlan CONSTRAINT_SET_REVISION_PLAN_STRUCTURE))))\n            (IF (EQ validationResult ALANG_STATUS_SUCCESS)\n                (IF (EQ (MAP_GET_VALUE revisionPlan \"strategy\") \"self_correct\")\n                    (SEQ\n                        (OUTPUT_TO_USER_BUFFER \"AI_THOUGHTS\" \"Attempting automated self-correction based on revision plan.\" NIL)\n                        (CALL_PROCEDURE UPDATE_CONCEPTUAL_MODEL (MAP_CREATE (\"action\" \"log_revision_attempt\") (\"artifact_handle\" artifact_handle) (\"strategy\" \"self_correct\"))) ; Log attempt (NEW)\n                        ; Call SelfCorrectArtifact with relevant details from the revision plan\n                        (LET ((correctionResult (SelfCorrectArtifact artifactContent (MAP_GET_VALUE revisionPlan \"details\") constraints_handle session_model_handle)))) ; Pass details, constraints, session model\n                        (IF (EQ (GET_STATUS correctionResult) ALANG_STATUS_SUCCESS)\n                            (SEQ\n                                (OUTPUT_TO_USER_BUFFER \"AI_PRESENT_THOUGHTS\" \"Automated self-correction succeeded. Overwriting artifact content.\" NIL)\n                                ; Overwrite the artifact content with corrected text\n                                (LET ((writeStatus (WRITE_CONTENT_TO_ARTIFACT artifact_handle (GET_DATA correctionResult) \"text/markdown\"))))\n                                (IF (EQ writeStatus ALANG_STATUS_SUCCESS)\n                                    (SEQ\n                                        (CALL_PROCEDURE UPDATE_CONCEPTUAL_MODEL (MAP_CREATE (\"action\" \"flag_revised\") (\"artifact_handle\" artifact_handle))) ; Update model\n                                        (CALL_PROCEDURE UPDATE_CONCEPTUAL_MODEL (MAP_CREATE (\"action\" \"log_revision_success\") (\"artifact_handle\" artifact_handle) (\"strategy\" \"self_correct\"))) ; Log success (NEW)\n                                        ; Potentially update conceptual model to mark specific issues as resolved based on revisionPlan\n                                        (RETURN_STATUS ALANG_STATUS_SUCCESS) ; Indicate successful self-correction\n                                    )\n                                    (SEQ ; Write failed after self-correction\n                                         (CALL_PROCEDURE ADD_DISCLAIMER_TO_ARTIFACT artifact_handle \"***AI_SYSTEM_ERROR: Revision failed after self-correction. Review content.***\")\n                                         (CALL_PROCEDURE UPDATE_CONCEPTUAL_MODEL (MAP_CREATE (\"action\" \"flag_revision_write_failed\") (\"artifact_handle\" artifact_handle))) ; Update model (NEW action)\n                                         (CALL_PROCEDURE UPDATE_CONCEPTUAL_MODEL (MAP_CREATE (\"action\" \"log_revision_failure\") (\"artifact_handle\" artifact_handle) (\"strategy\" \"self_correct\") (\"reason\" \"write_failed\"))) ; Log failure (NEW)\n                                         ; Store context for user review (NEW)\n                                         (SET_STATE session.pending_user_action_details (MAP_CREATE (\"artifact_handle\" artifact_handle) (\"qa_report_handle\" qa_report_handle) (\"constraints_handle\" constraints_handle) (\"original_generated_text\" artifactContent))) ; Store context for review\n                                         (SET_STATE session.pending_user_action \"AWAIT_REVISION_REVIEW\") ; Require user review\n                                         (RETURN_STATUS ALANG_STATUS_PAUSE_FOR_USER_INPUT) ; Indicate pause\n                                    )\n                                )\n                            )\n                            (SEQ ; Self-correction failed\n                                 (OUTPUT_TO_USER_BUFFER \"AI_PRESENT_THOUGHTS\" \"Automated self-correction failed. Flagging original content for user review.\" NIL)\n                                 (CALL_PROCEDURE ADD_DISCLAIMER_TO_ARTIFACT artifact_handle \"***AI_USER_VERIFICATION_REQUIRED: Automated revision failed. Review content and QA report.***\")\n                                 (CALL_PROCEDURE UPDATE_CONCEPTUAL_MODEL (MAP_CREATE (\"action\" \"flag_revision_failed_user_review\") (\"artifact_handle\" artifact_handle) (\"details\" (MAP_GET_VALUE revisionPlan \"details\")))) ; Update model (NEW action)\n                                 (CALL_PROCEDURE UPDATE_CONCEPTUAL_MODEL (MAP_CREATE (\"action\" \"log_revision_failure\") (\"artifact_handle\" artifact_handle) (\"strategy\" \"self_correct\") (\"reason\" \"llm_correction_failed\"))) ; Log failure (NEW)\n                                 ; Store context for user review (NEW)\n                                 (SET_STATE session.pending_user_action_details (MAP_CREATE (\"artifact_handle\" artifact_handle) (\"qa_report_handle\" qa_report_handle) (\"constraints_handle\" constraints_handle) (\"original_generated_text\" artifactContent))) ; Store context for review\n                                 (SET_STATE session.pending_user_action \"AWAIT_REVISION_REVIEW\") ; Require user review\n                                 (RETURN_STATUS ALANG_STATUS_PAUSE_FOR_USER_INPUT) ; Indicate pause\n                            )\n                        )\n                    )\n                    (IF (EQ (MAP_GET_VALUE revisionPlan \"strategy\") \"user_review\")\n                        (SEQ\n                             (OUTPUT_TO_USER_BUFFER \"AI_PRESENT_THOUGHTS\" \"Substantive issues require user review for revision.\" NIL)\n                             (CALL_PROCEDURE ADD_DISCLAIMER_TO_ARTIFACT artifact_handle \"***AI_USER_VERIFICATION_REQUIRED: Review required for substantive issues.***\")\n                             (CALL_PROCEDURE UPDATE_CONCEPTUAL_MODEL (MAP_CREATE (\"action\" \"flag_user_review_needed\") (\"artifact_handle\" artifact_handle) (\"details\" (MAP_GET_VALUE revisionPlan \"details\")))) ; Update model\n                              (CALL_PROCEDURE UPDATE_CONCEPTUAL_MODEL (MAP_CREATE (\"action\" \"log_revision_attempt\") (\"artifact_handle\" artifact_handle) (\"strategy\" \"user_review\"))) ; Log attempt (NEW)\n                             ; Store context for user review (NEW)\n                             (SET_STATE session.pending_user_action_details (MAP_CREATE (\"artifact_handle\" artifact_handle) (\"qa_report_handle\" qa_report_handle) (\"constraints_handle\" constraints_handle) (\"original_generated_text\" artifactContent))) ; Store context for review\n                             (SET_STATE session.pending_user_action \"AWAIT_REVISION_REVIEW\") ; Require user review\n                             (RETURN_STATUS ALANG_STATUS_PAUSE_FOR_USER_INPUT) ; Indicate pause\n                        )\n                        ; Default / Unknown strategy\n                        (SEQ\n                            (LOG_EVENT \"SYSTEM_ERROR\" \"Unknown revision strategy from LLM.\")\n                            (SET_ERROR_STATE \"LLM_ERROR\" \"LLM returned unknown revision strategy.\")\n                            (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL)\n                            (CALL_PROCEDURE ADD_DISCLAIMER_TO_ARTIFACT artifact_handle \"***AI_SYSTEM_ERROR: Revision decision failed. Review content and QA report.***\")\n                            (CALL_PROCEDURE UPDATE_CONCEPTUAL_MODEL (MAP_CREATE (\"action\" \"flag_revision_decision_failed\") (\"artifact_handle\" artifact_handle))) ; Update model\n                            (CALL_PROCEDURE UPDATE_CONCEPTUAL_MODEL (MAP_CREATE (\"action\" \"log_revision_failure\") (\"artifact_handle\" artifact_handle) (\"strategy\" \"decision_failed\"))) ; Log failure (NEW)\n                             ; Store context for user review (NEW)\n                            (SET_STATE session.pending_user_action_details (MAP_CREATE (\"artifact_handle\" artifact_handle) (\"qa_report_handle\" qa_report_handle) (\"constraints_handle\" constraints_handle) (\"original_generated_text\" artifactContent))) ; Store context for review\n                             (SET_STATE session.pending_user_action \"AWAIT_REVISION_REVIEW\") ; Require user review\n                             (RETURN_STATUS ALANG_STATUS_PAUSE_FOR_USER_INPUT) ; Indicate pause\n                        )\n                    )\n                )\n                (SEQ ; Revision Plan Validation failed\n                    (LOG_EVENT \"SYSTEM_ERROR\" \"Revision plan from LLM failed validation.\")\n                    (SET_ERROR_STATE \"LLM_ERROR\" \"LLM returned malformed revision plan.\")\n                    (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL)\n                    (CALL_PROCEDURE ADD_DISCLAIMER_TO_ARTIFACT artifact_handle \"***AI_SYSTEM_ERROR: Revision plan invalid. Review content and QA report.***\")\n                    (CALL_PROCEDURE UPDATE_CONCEPTUAL_MODEL (MAP_CREATE (\"action\" \"flag_revision_plan_invalid\") (\"artifact_handle\" artifact_handle))) ; Update model (NEW action)\n                    (CALL_PROCEDURE UPDATE_CONCEPTUAL_MODEL (MAP_CREATE (\"action\" \"log_revision_failure\") (\"artifact_handle\" artifact_handle) (\"strategy\" \"plan_validation_failed\"))) ; Log failure (NEW)\n                    ; Store context for user review (NEW)\n                    (SET_STATE session.pending_user_action_details (MAP_CREATE (\"artifact_handle\" artifact_handle) (\"qa_report_handle\" qa_report_handle) (\"constraints_handle\" constraints_handle) (\"original_generated_text\" artifactContent))) ; Store context for review\n                    (SET_STATE session.pending_user_action \"AWAIT_REVISION_REVIEW\") ; Require user review\n                    (RETURN_STATUS ALANG_STATUS_PAUSE_FOR_USER_INPUT) ; Indicate pause\n                )\n            )\n            (SEQ ; LLM failed to generate revision plan\n                (LOG_EVENT \"SYSTEM_ERROR\" \"LLM failed to generate revision plan.\")\n                (SET_ERROR_STATE \"LLM_ERROR\" \"LLM failed to generate revision plan.\")\n                (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL)\n                (CALL_PROCEDURE ADD_DISCLAIMER_TO_ARTIFACT artifact_handle \"***AI_SYSTEM_ERROR: Could not generate revision plan. Review content and QA report.***\")\n                (CALL_PROCEDURE UPDATE_CONCEPTUAL_MODEL (MAP_CREATE (\"action\" \"flag_revision_plan_failed\") (\"artifact_handle\" artifact_handle))) ; Update model (NEW action)\n                (CALL_PROCEDURE UPDATE_CONCEPTUAL_MODEL (MAP_CREATE (\"action\" \"log_revision_failure\") (\"artifact_handle\" artifact_handle) (\"strategy\" \"plan_generation_failed\"))) ; Log failure (NEW)\n                ; Store context for user review (NEW)\n                (SET_STATE session.pending_user_action_details (MAP_CREATE (\"artifact_handle\" artifact_handle) (\"qa_report_handle\" qa_report_handle) (\"constraints_handle\" constraints_handle) (\"original_generated_text\" artifactContent))) ; Store context for review\n                (SET_STATE session.pending_user_action \"AWAIT_REVISION_REVIEW\") ; Require user review\n                (RETURN_STATUS ALANG_STATUS_PAUSE_FOR_USER_INPUT) ; Indicate pause\n            )\n        )\n        (SEQ ; Failed to read inputs for revision planning\n            (LOG_EVENT \"SYSTEM_ERROR\" \"Failed to read inputs for revision planning.\")\n            (SET_ERROR_STATE \"SYSTEM_ERROR\" \"Failed to read inputs for revision planning.\")\n            (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL)\n            (CALL_PROCEDURE ADD_DISCLAIMER_TO_ARTIFACT artifact_handle \"***AI_SYSTEM_ERROR: Could not process revision inputs. Review content.***\")\n            (CALL_PROCEDURE UPDATE_CONCEPTUAL_MODEL (MAP_CREATE (\"action\" \"flag_revision_input_failed\") (\"artifact_handle\" artifact_handle))) ; Update model (NEW action)\n            (CALL_PROCEDURE UPDATE_CONCEPTUAL_MODEL (MAP_CREATE (\"action\" \"log_revision_failure\") (\"artifact_handle\" artifact_handle) (\"strategy\" \"input_read_failed\"))) ; Log failure (NEW)\n            ; Store context for user review (NEW)\n            (SET_STATE session.pending_user_action_details (MAP_CREATE (\"artifact_handle\" artifact_handle) (\"qa_report_handle\" qa_report_handle) (\"constraints_handle\" constraints_handle) (\"original_generated_text\" NIL))) ; Store context for review (original text might not be available)\n            (SET_STATE session.pending_user_action \"AWAIT_REVISION_REVIEW\") ; Require user review\n            (RETURN_STATUS ALANG_STATUS_PAUSE_FOR_USER_INPUT) ; Indicate pause\n        )\n    )\n)\n\n(DEFINE_PROCEDURE ApplyFeedbackBasedRevision (artifact_handle feedback_text constraints_handle session_model_handle context_details)\n    ;; Conceptual procedure to apply revisions based on explicit user feedback after a review. (NEW)\n    ;; This is similar to ApplyRevisionsToArtifact but specifically triggered by user REVISE feedback.\n    ;; It uses the feedback, the artifact content, constraints, session model, and potentially previous QA/revision context.\n    ;; Returns: ALANG_STATUS_CODE (SUCCESS, FAILURE, or PAUSE_FOR_USER_INPUT)\n    (OUTPUT_TO_USER_BUFFER \"AI_THOUGHTS\" \"Applying feedback-based revisions to artifact...\" NIL)\n    (LOG_EVENT \"CONCEPTUAL_PROCESS\" (STRING_CONCAT \"Applying feedback-based revisions to artifact \" (GET_HANDLE_METADATA artifact_handle \"id\")))\n    (CALL_PROCEDURE UPDATE_CONCEPTUAL_MODEL (MAP_CREATE (\"action\" \"log_feedback_revision_attempt\") (\"artifact_handle\" artifact_handle) (\"feedback\" feedback_text))) ; Log attempt (NEW)\n\n    (LET ((artifactContentResult (READ_CONTENT artifact_handle \"text_summary_or_full\" NIL))))\n    (LET ((sessionModelContentResult (READ_CONTENT session_model_handle \"structured_map\" NIL))))\n    (LET ((constraintsContentResult (READ_CONTENT constraints_handle \"structured_list_of_rules\" NIL))))\n\n    (IF (AND (EQ (GET_STATUS artifactContentResult) ALANG_STATUS_SUCCESS)\n             (EQ (GET_STATUS sessionModelContentResult) ALANG_STATUS_SUCCESS)\n             (EQ (GET_STATUS constraintsContentResult) ALANG_STATUS_SUCCESS)))\n        (LET ((artifactContent (GET_DATA artifactContentResult))))\n        (LET ((sessionModelContent (GET_DATA sessionModelContentResult))))\n        (LET ((constraintsContent (GET_DATA constraintsContentResult))))\n\n        ; Use LLM to generate revised content based on feedback and context\n        (LET ((revisionResult (INVOKE_CORE_LLM_GENERATION\n                               (MAP_CREATE (\"template\" PROMPT_TEMPLATE_ANALYZE_FEEDBACK_FOR_REVISION) ; Use specific template (NEW)\n                                           (\"artifact_content\" artifactContent)\n                                           (\"user_feedback\" feedback_text)\n                                           (\"session_model\" sessionModelContent) ; Pass session model for context\n                                           (\"constraints\" constraintsContent) ; Pass constraints for context\n                                           (\"previous_qa_context\" context_details) ; Pass context from previous QA/revision attempt (NEW)\n                                        ))\n                               (GET_LLM_PARAMS_FOR_TASK \"feedback_based_revision\") ; Use specific task type (NEW)\n                            )))\n        (IF (EQ (GET_STATUS revisionResult) ALANG_STATUS_SUCCESS)\n            (LET ((revisedContent (GET_DATA revisionResult))))\n            ; Overwrite the artifact content with revised text\n            (LET ((writeStatus (WRITE_CONTENT_TO_ARTIFACT artifact_handle revisedContent \"text/markdown\"))))\n            (IF (EQ writeStatus ALANG_STATUS_SUCCESS)\n                (SEQ\n                    (CALL_PROCEDURE UPDATE_CONCEPTUAL_MODEL (MAP_CREATE (\"action\" \"flag_revised_by_feedback\") (\"artifact_handle\" artifact_handle))) ; Update model (NEW action)\n                    (CALL_PROCEDURE UPDATE_CONCEPTUAL_MODEL (MAP_CREATE (\"action\" \"log_feedback_revision_success\") (\"artifact_handle\" artifact_handle))) ; Log success (NEW)\n                    ; Potentially update conceptual model to mark specific feedback points as addressed\n                    (RETURN_STATUS ALANG_STATUS_SUCCESS) ; Indicate successful revision\n                )\n                (SEQ ; Write failed after revision\n                     (CALL_PROCEDURE ADD_DISCLAIMER_TO_ARTIFACT artifact_handle \"***AI_SYSTEM_ERROR: Revision failed after feedback. Review content.***\")\n                     (CALL_PROCEDURE UPDATE_CONCEPTUAL_MODEL (MAP_CREATE (\"action\" \"flag_feedback_revision_write_failed\") (\"artifact_handle\" artifact_handle))) ; Update model (NEW action)\n                     (CALL_PROCEDURE UPDATE_CONCEPTUAL_MODEL (MAP_CREATE (\"action\" \"log_feedback_revision_failure\") (\"artifact_handle\" artifact_handle) (\"reason\" \"write_failed\"))) ; Log failure (NEW)\n                     ; This might require user review again, but the state is already AWAIT_REVISION_REVIEW.\n                     ; The orchestrator needs to handle the failure status and decide whether to re-prompt.\n                     (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL) ; Indicate failure\n                )\n            )\n        )\n        (SEQ ; LLM failed to generate revision\n            (LOG_EVENT \"SYSTEM_ERROR\" \"LLM failed to generate feedback-based revision.\")\n            (SET_ERROR_STATE \"LLM_ERROR\" \"LLM failed to generate feedback-based revision.\")\n            (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL)\n            (CALL_PROCEDURE ADD_DISCLAIMER_TO_ARTIFACT artifact_handle \"***AI_SYSTEM_ERROR: Could not generate feedback-based revision. Review content and provide feedback again.***\")\n            (CALL_PROCEDURE UPDATE_CONCEPTUAL_MODEL (MAP_CREATE (\"action\" \"flag_feedback_revision_failed\") (\"artifact_handle\" artifact_handle))) ; Update model (NEW action)\n            (CALL_PROCEDURE UPDATE_CONCEPTUAL_MODEL (MAP_CREATE (\"action\" \"log_feedback_revision_failure\") (\"artifact_handle\" artifact_handle) (\"reason\" \"llm_generation_failed\"))) ; Log failure (NEW)\n            ; This might require user review again, but the state is already AWAIT_REVISION_REVIEW.\n            ; The orchestrator needs to handle the failure status and decide whether to re-prompt.\n            (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL) ; Indicate failure\n        )\n    )\n    (SEQ ; Failed to read inputs for revision\n        (LOG_EVENT \"SYSTEM_ERROR\" \"Failed to read inputs for feedback-based revision.\")\n        (SET_ERROR_STATE \"SYSTEM_ERROR\" \"Failed to read inputs for feedback-based revision.\")\n        (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL)\n        (CALL_PROCEDURE ADD_DISCLAIMER_TO_ARTIFACT artifact_handle \"***AI_SYSTEM_ERROR: Could not process feedback revision inputs. Review content.***\")\n        (CALL_PROCEDURE UPDATE_CONCEPTUAL_MODEL (MAP_CREATE (\"action\" \"flag_feedback_revision_input_failed\") (\"artifact_handle\" artifact_handle))) ; Update model (NEW action)\n        (CALL_PROCEDURE UPDATE_CONCEPTUAL_MODEL (MAP_CREATE (\"action\" \"log_feedback_revision_failure\") (\"artifact_handle\" artifact_handle) (\"reason\" \"input_read_failed\"))) ; Log failure (NEW)\n        ; This might require user review again, but the state is already AWAIT_REVISION_REVIEW.\n        ; The orchestrator needs to handle the failure status and decide whether to re-prompt.\n        (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL) ; Indicate failure\n    )\n)\n\n\n(DEFINE_PROCEDURE QA_Stage_1_SelfCritique (artifact_handle session_model_handle)\n    ;; Performs a self-critique of the given artifact.\n    ;; Critiques the artifact's representation of the pattern model against internal consistency and completeness criteria, leveraging the session conceptual model for context (Principle 3.A.1).\n    (OUTPUT_TO_USER_BUFFER \"AI_THOUGHTS\" (STRING_CONCAT \"Running QA Stage 1: Self-Critique (Internal Coherence & Completeness check of pattern model representation against session conceptual model)... \" (IF (EQ (GET_STATE session.qa_output_verbosity) \"VERBOSE\") \"Generating detailed report.\" \"\" )) NIL)\n    ; Context for self-critique includes the artifact and the session conceptual model for holistic check.\n    (LET ((critiqueReportHandle (CREATE_EMPTY_ARTIFACT \"qa_critique_self\")))) ; Output artifact for the critique report\n    (LET ((generationResult (SAFE_GENERATE_CONTENT\n                            critiqueReportHandle ; Target handle\n                            PROMPT_TEMPLATE_QA_SELF_CRITIQUE\n                            (MAP_CREATE (\"artifact_content_handle\" artifact_handle)\n                                        (\"session_conceptual_model_handle\" session_model_handle)) ; Include conceptual model handle\n                            CONSTRAINT_SET_QA_CRITIQUE\n                          )))\n        (IF (OR (EQ (GET_STATUS generationResult) ALANG_STATUS_SUCCESS)\n                (EQ (GET_STATUS generationResult) ALANG_STATUS_PAUSE_FOR_USER_INPUT)) ; SAFE_GENERATE_CONTENT can return PAUSE\n            (SEQ\n                (OUTPUT_TO_USER_BUFFER \"AI_THOUGHTS\" \"Self-critique complete.\" NIL)\n                (IF (EQ (GET_STATE session.qa_output_verbosity) \"VERBOSE\")\n                    (SEQ\n                        (OUTPUT_TO_USER_BUFFER \"AI_PROVIDE_DATA\" \"Self-Critique Report:\" NIL)\n                        (LET ((reportContentResultEAD_CONTENT critiqueReportHandle \"text_summary_or_full\" NIL))))))\n                        (IF (EQ (GET_STATUS reportContentResult) ALANG_STATUS_SUCCESS)\n                            (OUTPUT_TO_USER_BUFFER \"AI_PROVIDE_DATA\" (GET_DATA reportContentResult) NIL)\n                        )\n                    )\n                )\n                 ; Return the handle to the critique report and the status.\n                (RETURN_STATUS (MAP_CREATE (\"status\" (GET_STATUS generationResult)) (\"data\" critiqueReportHandle))) ; Return structured result\n            )\n            (SEQ\n                (SET_ERROR_STATE \"QA_ERROR\" \"Failed to generate external review critique.\")\n                (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL)\n                (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_FAILURE_GENERAL) (\"data\" NIL))) ; Return structured failure\n            )\n        )\n    ))\n)\n\n(DEFINE_PROCEDURE PerformSystemQA (directives_handle evolution_backlog_handle session_model_handle selected_backlog_item_ids)\n    ;; Performs a full System QA cycle on the Autologos Core Directives, leveraging the session conceptual model and selected backlog items.\n    ;; This procedure orchestrates the 4 stages of System QA as defined in Directives Section 3.A.\n    ;; It implements the iterative refinement loop and manages the versioning process.\n    ;; It uses the session conceptual model for contextual analysis during QA and for tracking issues/changes.\n    ;; The selected_backlog_item_ids list guides the focus of the QA stages.\n    ;; Returns: ALANG_STATUS_CODE (SUCCESS, FAILURE, or ALANG_STATUS_PAUSE_FOR_USER_INPUT) (NEW)\n    (OUTPUT_TO_USER_BUFFER \"AI_THOUGHTS\" \"Starting Full System QA Cycle (4 Stages) to validate Core Directives and refine the Autologos pattern modeling capabilities...\" NIL)\n\n    (LET ((overallStatus ALANG_STATUS_SUCCESS))) ; Track overall QA status\n    (LET ((qaIterationCount 0)))\n    (LET ((maxQaIterations 5))) ; Safeguard against infinite loops (Principle 6)\n    (LET ((substantiveIssuesFoundThisCycle TRUE))) ; Start loop assuming issues need checking\n\n    ; Iterative QA Loop (Section 3.A Iteration Rule)\n    (LOOP_WHILE (AND substantiveIssuesFoundThisCycle (LT qaIterationCount maxQaIterations)))\n        (SET_STATE qaIterationCount (ADD qaIterationCount 1))\n        (SET_STATE substantiveIssuesFoundThisCycle FALSE) ; Reset for the start of the cycle\n        (OUTPUT_TO_USER_BUFFER \"AI_THOUGHTS\" (STRING_CONCAT \"Starting System QA Cycle Iteration \" (STRING_CONCAT \"\" qaIterationCount) \"...\" ) NIL)\n\n        ; Check for and apply pending changes from the previous iteration (NEW)\n        (LET ((pendingChangesHandle (GET_PROPOSED_CORE_LOGIC_CHANGES_HANDLE))))\n        (IF (IS_HANDLE_VALID pendingChangesHandle)\n            (SEQ\n                (OUTPUT_TO_USER_BUFFER \"AI_PRESENT_THOUGHTS\" \"Applying pending Core Logic changes from previous iteration.\" NIL)\n                (LET ((applyStatus (APPLY_CORE_LOGIC_CHANGES pendingChangesHandle))))\n                (IF (EQ applyStatus ALANG_STATUS_SUCCESS)\n                    (SEQ\n                        (LOG_EVENT \"CORE_LOGIC_CHANGES_APPLIED\" \"Pending changes applied for next QA iteration.\")\n                        (CLEAR_PENDING_CORE_LOGIC_CHANGES) ; Clear the pending changes after applying\n                        (OUTPUT_TO_USER_BUFFER \"AI_PRESENT_THOUGHTS\" \"Changes applied. Re-running QA stages.\" NIL)\n                    )\n                    (SEQ\n                        (LOG_EVENT \"SYSTEM_ERROR\" \"Failed to apply pending Core Logic changes.\")\n                        (SET_ERROR_STATE \"SYSTEM_ERROR\" \"Failed to apply pending Core Logic changes. Cannot continue System QA.\")\n                        (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL)\n                        (SET_STATE sys.system_qa_status \"QA_FAILED_APPLY_CHANGES\")\n                        (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL) ; Fail the QA cycle\n                    )\n                )\n            )\n        )\n\n\n        ; Stage 1: Self-Critique\n        (OUTPUT_TO_USER_BUFFER \"AI_PRESENT_THOUGHTS\" (STRING_CONCAT \"Running System QA Stage 1: Self-Critique... \" (IF (EQ (GET_STATE session.qa_output_verbosity) \"VERBOSE\") \"Generating detailed report.\" \"\" )) NIL)\n        (LET ((stage1ReportHandle (CREATE_EMPTY_ARTIFACT \"system_qa_critique_self\"))))\n        ; Pass selected_backlog_item_ids and session_model_handle as context to guide QA prompts (NEW)\n        (LET ((stage1Result (SAFE_GENERATE_CONTENT stage1ReportHandle PROMPT_TEMPLATE_QA_SELF_CRITIQUE (MAP_CREATE (\"artifact_content_handle\" directives_handle) (\"session_conceptual_model_handle\" session_model_handle) (\"backlog_focus_ids\" selected_backlog_item_ids)) CONSTRAINT_SET_QA_CRITIQUE))) ; QA on Directives handle, pass session model and backlog focus\n            (IF (OR (IS_STATUS_FAILURE (GET_STATUS stage1Result)) (EQ (GET_STATUS stage1Result) ALANG_STATUS_PAUSE_FOR_USER_INPUT)) (RETURN_STATUS (IF (IS_STATUS_FAILURE (GET_STATUS stage1Result)) (GET_STATUS stage1Result) ALANG_STATUS_PAUSE_FOR_USER_INPUT)))) ; Propagate failure/pause\n        (LET ((issuesInStage1 (CHECK_FOR_SUBSTANTIVE_ISSUES stage1ReportHandle)))) ; NEW utility\n        (IF issuesInStage1\n            (SEQ\n                (SET_STATE substantiveIssuesFoundThisCycle TRUE)\n                (OUTPUT_TO_USER_BUFFER \"AI_THOUGHTS\" \"Substantive issues found in Stage 1. Proposing Directive changes.\" NIL)\n                (LET ((proposalStatus (CALL_PROCEDURE ProposeDirectiveChanges stage1ReportHandle session_model_handle))) ; Conceptual call to propose changes, pass session model\n                (IF (IS_STATUS_FAILURE proposalStatus) (RETURN_STATUS proposalStatus)))) ; Propagate failure from proposal\n            )\n        )\n        (RELEASE_HANDLE stage1ReportHandle) ; Release report handle\n\n        ; Stage 2: Divergent Exploration\n        (IF (NOT substantiveIssuesFoundThisCycle)) ; Only run if no issues needing revision from Stage 1\n            (OUTPUT_TO_USER_BUFFER \"AI_PRESENT_THOUGHTS\" (STRING_CONCAT \"Running System QA Stage 2: Divergent Exploration... \" (IF (EQ (GET_STATE session.qa_output_verbosity) \"VERBOSE\") \"Generating detailed report.\" \"\" )) NIL)\n            (LET ((stage2ReportHandle (CREATE_EMPTY_ARTIFACT \"system_qa_critique_divergent\"))))\n            (LET ((stage2Result (SAFE_GENERATE_CONTENT stage2ReportHandle PROMPT_TEMPLATE_QA_DIVERGENT_EXPLORATION (MAP_CREATE (\"artifact_content_handle\" directives_handle) (\"session_conceptual_model_handle\" session_model_handle) (\"backlog_focus_ids\" selected_backlog_item_ids)) CONSTRAINT_SET_QA_CRITIQUE))) ; Pass session model and backlog focus\n                (IF (OR (IS_STATUS_FAILURE (GET_STATUS stage2Result)) (EQ (GET_STATUS stage2Result) ALANG_STATUS_PAUSE_FOR_USER_INPUT)) (RETURN_STATUS (IF (IS_STATUS_FAILURE (GET_STATUS stage2Result)) (GET_STATUS stage2Result) ALANG_STATUS_PAUSE_FOR_USER_INPUT))))\n            (LET ((issuesInStage2 (CHECK_FOR_SUBSTANTIVE_ISSUES stage2ReportHandle)))) ; NEW utility\n            (IF issuesInStage2\n                (SEQ\n                    (SET_STATE substantiveIssuesFoundThisCycle TRUE)\n                    (OUTPUT_TO_USER_BUFFER \"AI_THOUGHTS\" \"Substantive issues found in Stage 2. Proposing Directive changes.\" NIL)\n                    (LET ((proposalStatus (CALL_PROCEDURE ProposeDirectiveChanges stage2ReportHandle session_model_handle))) ; Pass session model\n                    (IF (IS_STATUS_FAILURE proposalStatus) (RETURN_STATUS proposalStatus))))\n                )\n            )\n            (RELEASE_HANDLE stage2ReportHandle)\n        )\n\n        ; Stage 3: Red Teaming\n        (IF (NOT substantiveIssuesFoundThisCycle)) ; Only run if no issues needing revision from Stage 1/2\n            (OUTPUT_TO_USER_BUFFER \"AI_PRESENT_THOUGHTS\" (STRING_CONCAT \"Running System QA Stage 3: Adversarial Red Teaming... \" (IF (EQ (GET_STATE session.qa_output_verbosity) \"VERBOSE\") \"Generating detailed report.\" \"\" )) NIL)\n            (LET ((stage3ReportHandle (CREATE_EMPTY_ARTIFACT \"system_qa_critique_redteam\"))))\n            (LET ((stage3Result (SAFE_GENERATE_CONTENT stage3ReportHandle PROMPT_TEMPLATE_QA_RED_TEaming (MAP_CREATE (\"artifact_content_handle\" directives_handle) (\"session_conceptual_model_handle\" session_model_handle) (\"backlog_focus_ids\" selected_backlog_item_ids)) CONSTRAINT_SET_QA_CRITIQUE))) ; Pass session model and backlog focus\n                (IF (OR (IS_STATUS_FAILURE (GET_STATUS stage3Result)) (EQ (GET_STATUS stage3Result) ALANG_STATUS_PAUSE_FOR_USER_INPUT)) (RETURN_STATUS (IF (IS_STATUS_FAILURE (GET_STATUS stage3Result)) (GET_STATUS stage3Result) ALANG_STATUS_PAUSE_FOR_USER_INPUT))))\n            (LET ((issuesInStage3 (CHECK_FOR_SUBSTANTIVE_ISSUES stage3ReportHandle)))) ; NEW utility\n            (IF issuesInStage3\n                (SEQ\n                    (SET_STATE substantiveIssuesFoundThisCycle TRUE)\n                    (OUTPUT_TO_USER_BUFFER \"AI_THOUGHTS\" \"Substantive issues found in Stage 3. Proposing Directive changes.\" NIL)\n                    (LET ((proposalStatus (CALL_PROCEDURE ProposeDirectiveChanges stage3ReportHandle session_model_handle))) ; Pass session model\n                    (IF (IS_STATUS_FAILURE proposalStatus) (RETURN_STATUS proposalStatus))))\n                )\n            )\n            (RELEASE_HANDLE stage3ReportHandle)\n        )\n\n        ; Stage 4: External Review\n        (IF (NOT substantiveIssuesFoundThisCycle)) ; Only run if no issues needing revision from Stage 1/2/3\n            (OUTPUT_TO_USER_BUFFER \"AI_PRESENT_THOUGHTS\" (STRING_CONCAT \"Running System QA Stage 4: External Review... \" (IF (EQ (GET_STATE session.qa_output_verbosity) \"VERBOSE\") \"Generating detailed reports.\" \"\" )) NIL)\n            (LET ((stage4ReportHandle (CREATE_EMPTY_ARTIFACT \"system_qa_critique_external\"))))\n            (LET ((stage4Result (SAFE_GENERATE_CONTENT stage4ReportHandle PROMPT_TEMPLATE_QA_EXTERNAL_REVIEW (MAP_CREATE (\"artifact_content_handle\" directives_handle) (\"session_conceptual_model_handle\" session_model_handle) (\"backlog_focus_ids\" selected_backlog_item_ids)) CONSTRAINT_SET_QA_CRITIQUE))) ; Pass session model and backlog focus\n                (IF (OR (IS_STATUS_FAILURE (GET_STATUS stage4Result)) (EQ (GET_STATUS stage4Result) ALANG_STATUS_PAUSE_FOR_USER_INPUT)) (RETURN_STATUS (IF (IS_STATUS_FAILURE (GET_STATUS stage4Result)) (GET_STATUS stage4Result) ALANG_STATUS_PAUSE_FOR_USER_INPUT))))\n            (LET ((issuesInStage4 (CHECK_FOR_SUBSTANTIVE_ISSUES stage4ReportHandle)))) ; NEW utility\n            (IF issuesInStage4\n                (SEQ\n                    (SET_STATE substantiveIssuesFoundThisCycle TRUE)\n                    (OUTPUT_TO_USER_BUFFER \"AI_THOUGHTS\" \"Substantive issues found in Stage 4. Proposing Directive changes.\" NIL)\n                    (LET ((proposalStatus (CALL_PROCEDURE ProposeDirectiveChanges stage4ReportHandle session_model_handle))) ; Pass session model\n                    (IF (IS_STATUS_FAILURE proposalStatus) (RETURN_STATUS proposalStatus))))\n                )\n            )\n            (RELEASE_HANDLE stage4ReportHandle)\n        )\n        ; After a full cycle, if substantiveIssuesFoundThisCycle is TRUE, the loop continues.\n        ; This implies that ProposeDirectiveChanges has created a set of pending changes that will be applied at the start of the next iteration.\n    ) ; End LOOP_WHILE\n\n    ; After the loop, check if max iterations were reached without convergence\n    (IF (AND substantiveIssuesFoundThisCycle (EQ qaIterationCount maxQaIterations))\n        (SEQ\n            (SET_ERROR_STATE \"QA_ERROR\" (STRING_CONCAT \"System QA reached max iterations (\" (STRING_CONCAT \"\" maxQaIterations) \") without resolving all substantive issues.\"))\n            (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL)\n            (SET_STATE sys.system_qa_status \"QA_FAILED_MAX_ITERATIONS\")\n            (RETURN_STATUS ALANG_STATUS_FAILURE_QA_MAX_ITERATIONS) ; Return failure\n        )\n        (SEQ\n            ; If loop exited because substantiveIssuesFoundThisCycle is FALSE\n            (SET_STATE sys.system_qa_status \"QA_PASSED\") ; All substantive issues resolved or none found\n            (OUTPUT_TO_USER_BUFFER \"AI_THOUGHTS\" (STRING_CONCAT \"Full System QA complete. Status: \" (GET_STATE sys.system_qa_status) \". Ready for versioning.\" NIL))\n            (RETURN_STATUS ALANG_STATUS_SUCCESS) ; Return success for the QA phase\n        )\n    )\n)\n\n(DEFINE_PROCEDURE ProposeDirectiveChanges (qa_report_handle session_model_handle)\n    ;; Conceptual procedure to analyze a System QA report and propose structured changes to the Core Directives.\n    ;; This procedure generates a set of proposed changes and logs them for application in the next QA iteration or after approval.\n    ;; It updates the session conceptual model to track the proposed changes and their rationale.\n    ;; Returns: ALANG_STATUS_CODE (SUCCESS, FAILURE) (NEW)\n    (OUTPUT_TO_USER_BUFFER \"AI_THOUGHTS\" \"Analyzing QA report to propose changes to Core Directives... This analysis leverages the session conceptual model to identify systemic issues.\" NIL) ; Mention conceptual model\n    ; This procedure would:\n    ; 1. Read the QA report and session model content.\n    ; 2. Use an LLM to analyze the QA findings and the session conceptual model (looking for patterns of errors, limitations, inconsistencies)\n    ;    to generate a structured set of proposed changes (e.g., add/modify/remove a principle or directive).\n    ; 3. Validate the structure of the proposed changes.\n    ; 4. Store the proposed changes in a temporary handle, accessible via GET_PROPOSED_CORE_LOGIC_CHANGES_HANDLE.\n    ; 5. Update the session conceptual model to log the proposed changes and their connection to the QA report and identified systemic issues.\n    (LOG_EVENT \"CONCEPTUAL_PROCESS\" \"Proposing Directive changes based on QA report and conceptual analysis.\")\n    (LET ((qaReportContentResult (READ_CONTENT qa_report_handle \"text_summary_or_full\" NIL))) ; Read report content\n    (LET ((sessionModelContentResult (READ_CONTENT session_model_handle \"structured_map\" NIL)))) ; Read session model content\n    (IF (AND (EQ (GET_STATUS qaReportContentResult) ALANG_STATUS_SUCCESS)\n             (EQ (GET_STATUS sessionModelContentResult) ALANG_STATUS_SUCCESS))\n        (LET ((qaReportContent (GET_DATA qaReportContentResult)))\n        (LET ((sessionModelContent (GET_DATA sessionModelContentResult)))\n        (LET ((proposedChangesResult (INVOKE_CORE_LLM_GENERATION\n                                   (MAP_CREATE (\"template\" PROMPT_TEMPLATE_ANALYZE_QA_FOR_DIRECTIVE_CHANGES) ; Use specific template (NEW)\n                                               (\"qa_report\" qaReportContent)\n                                               (\"session_model\" sessionModelContent) ; Pass session model content for context\n                                               (\"current_directives_handle\" (GET_ALANG_CORE_DIRECTIVES_HANDLE)) ; Pass handle to current directives for context\n                                            ))\n                                   (GET_LLM_PARAMS_FOR_TASK \"directive_change_proposal\") ; Use specific task type (NEW)\n                                ))))\n        (IF (EQ (GET_STATUS proposedChangesResult) ALANG_STATUS_SUCCESS)\n            (LET ((proposedChangesData (GET_DATA proposedChangesResult))) ; Expected structured data for proposed changes\n            ; Validate proposedChangesData structure (NEW)\n            (LET ((validationResult (VALIDATE_DATA proposedChangesData CONSTRAINT_SET_PROPOSED_CHANGES_STRUCTURE))))\n            (IF (EQ validationResult ALANG_STATUS_SUCCESS)\n                (SEQ\n                    (OUTPUT_TO_USER_BUFFER \"AI_PRESENT_THOUGHTS\" \"Proposed Core Logic changes generated and validated.\" NIL)\n                    ; Store proposed changes. A real orchestrator would manage this state.\n                    ; Conceptually, we write it to an artifact and update a state variable with the handle.\n                    (LET ((proposedChangesHandle (CREATE_EMPTY_ARTIFACT \"proposed_changes\"))))\n                    (LET ((writeStatus (WRITE_CONTENT_TO_ARTIFACT proposedChangesHandle proposedChangesData \"application/json\")))) ; Assume JSON output\n                    (IF (EQ writeStatus ALANG_STATUS_SUCCESS)\n                        (SEQ\n                            (SET_STATE sys.proposed_changes_handle proposedChangesHandle) ; Assume this makes it available to GET_PROPOSED_CORE_LOGIC_CHANGES_HANDLE\n                            ; Update conceptual model to log the proposed changes (Principle 0.V.6)\n                            (CALL_PROCEDURE UPDATE_CONCEPTUAL_MODEL (MAP_CREATE (\"action\" \"log_directive_changes\") (\"changes\" proposedChangesData) (\"source_report_handle\" qa_report_handle)))\n                            (RETURN_STATUS ALANG_STATUS_SUCCESS)\n                        )\n                        (SEQ ; Write failed\n                            (LOG_EVENT \"SYSTEM_ERROR\" \"Failed to write proposed Directive changes to artifact.\")\n                            (SET_ERROR_STATE \"SYSTEM_ERROR\" \"Failed to store proposed Directive changes.\")\n                            (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL)\n                            (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL) ; Indicate failure\n                        )\n                    )\n                )\n                (SEQ ; Validation failed\n                    (LOG_EVENT \"SYSTEM_ERROR\" \"Proposed Directive changes from LLM failed validation.\")\n                    (SET_ERROR_STATE \"LLM_ERROR\" \"LLM returned malformed directive change proposals.\")\n                    (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL)\n                    (RETURN_STATUS ALANG_STATUS_FAILURE_VALIDATION_ERROR)\n                )\n            )\n        )\n        (SEQ ; LLM failed to propose changes\n            (LOG_EVENT \"SYSTEM_ERROR\" \"LLM failed to propose Directive changes.\")\n            (SET_ERROR_STATE \"LLM_ERROR\" \"LLM failed to propose Directive changes.\")\n            (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL)\n            (RETURN_STATUS ALANG_STATUS_FAILURE_LLM_ERROR)\n        )\n    )))\n    (SEQ ; Read failed\n        (LOG_EVENT \"SYSTEM_ERROR\" \"Failed to read QA report or session model for Directive change proposal.\")\n        (SET_ERROR_STATE \"SYSTEM_ERROR\" \"Failed to read inputs for Directive change proposal.\")\n        (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL)\n        (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL)\n    )\n)\n\n\n(DEFINE_PROCEDURE ExecuteSystemQAAndEvolutionCycle ()\n    ;; Orchestrates the entire System QA & Evolution Cycle, managing state and user interactions (Section 3).\n    ;; This procedure acts as a state machine, progressing through the cycle's steps.\n    ;; It uses session.system_qa_context to store and retrieve state across user input pauses.\n    (LOG_EVENT \"SYSTEM_QA_CYCLE_START\" \"Initiating System QA & Evolution Cycle.\")\n    (LET ((currentStatus (GET_STATE sys.system_qa_status)))\n    (LET ((qaContext (GET_STATE session.system_qa_context)))\n\n    ; State Machine Logic\n    (IF (OR (EQ currentStatus \"IDLE\") (EQ currentStatus \"NEW\"))\n        (SEQ\n            (OUTPUT_TO_USER_BUFFER \"AI_PRESENT_THOUGHTS\" \"Starting new System QA cycle. Step 1: Selecting Backlog Focus.\" NIL)\n            (SET_STATE sys.system_qa_status \"SELECTING_BACKLOG_FOCUS\")\n            (SET_STATE session.system_qa_context (MAP_CREATE (\"step\" \"SELECTING_BACKLOG_FOCUS\")))\n            ; Fall through to execute the new state immediately\n            (CALL_PROCEDURE ExecuteSystemQAAndEvolutionCycle) ; Recursive call to process the new state\n        )\n    )\n\n    (SETQ currentStatus (GET_STATE sys.system_qa_status)) ; Re-read status in case it changed by recursive call\n    (SETQ qaContext (GET_STATE session.system_qa_context))\n\n    (IF (EQ currentStatus \"SELECTING_BACKLOG_FOCUS\")\n        (SEQ\n            ; Decide how to select backlog items. For now, assume AI proposes focus based on backlog analysis.\n            ; A more complex version could ask the user.\n            (LET ((aiFocusResult (CALL_PROCEDURE SelectAIProposedBacklogItems (GET_STATE sys.evolution_backlog_handle) (GET_STATE session.conceptual_model_handle)))))\\\n            (IF (EQ (GET_STATUS aiFocusResult) ALANG_STATUS_SUCCESS)\n                (LET ((aiFocusData (GET_DATA aiFocusResult))) ; Expected: {rationale: string, item_ids: list}\n                    (SET_STATE session.system_qa_context (MAP_SET_VALUE qaContext \"ai_proposed_focus\" aiFocusData))\\\n                    (OUTPUT_TO_USER_BUFFER \"AI_PROVIDE_DATA\" (STRING_CONCAT \"AI Proposed Focus for QA: \" (MAP_GET_VALUE aiFocusData \"rationale\")) NIL)\\\n                    (OUTPUT_TO_USER_BUFFER \"AI_REQUEST_CLARIFICATION_QUESTIONS\" \"Approve this focus? (OK/REVISE)\" NIL)\\\n                    (SET_STATE sys.system_qa_status \"AWAITING_FOCUS_APPROVAL\")\\\n                    (SET_STATE session.pending_user_action \"AWAIT_AI_PROPOSED_FOCUS_APPROVAL\")\\\n                    (RETURN_STATUS ALANG_STATUS_PAUSE_FOR_USER_INPUT) ; Pause and wait for user approval\n                )\\\n                (SEQ\\\n                    (SET_ERROR_STATE \"SYSTEM_ERROR\" \"Failed to determine AI proposed focus for System QA.\")\\\n                    (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL)\\\n                    (SET_STATE sys.system_qa_status \"IDLE\") ; Cycle failed, return to idle\n                    (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL)\\\n                )\\\n            )\\\n        )\\\n    )\n\n    (IF (EQ currentStatus \"AWAITING_FOCUS_APPROVAL\")\n        (LET ((userApproved (MAP_GET_VALUE qaContext \"ai_focus_approved\" NIL)))\\\n            (IF (IS_NIL userApproved)\\\n                (RETURN_STATUS ALANG_STATUS_PAUSE_FOR_USER_INPUT) ; Still waiting for HandlePendingUserAction to set the flag\n            )\\\n            (IF userApproved\\\n                (SEQ\\\n                    (OUTPUT_TO_USER_BUFFER \"AI_PRESENT_THOUGHTS\" \"Focus approved. Step 2: Performing System QA stages.\" NIL)\\\n                    (SET_STATE sys.system_qa_status \"PERFORMING_QA\")\\\n                    ; Fall through to execute the new state immediately\n                    (CALL_PROCEDURE ExecuteSystemQAAndEvolutionCycle) ; Recursive call to process the new state\n                )\\\n                (SEQ\\\n                    (OUTPUT_TO_USER_BUFFER \"AI_PRESENT_THOUGHTS\" \"Focus rejected. Please provide backlog item priorities using `INPUT [ID1, ID2, ...]`.\" NIL)\\\n                    (SET_STATE sys.system_qa_status \"AWAITING_USER_PRIORITY\")\\\n                    (SET_STATE session.pending_user_action \"AWAIT_BACKLOG_PRIORITY_SELECTION\")\\\n                    (RETURN_STATUS ALANG_STATUS_PAUSE_FOR_USER_INPUT) ; Pause and wait for user input\n                )\\\n            )\\\n        )\\\n    )\n\n    (IF (EQ currentStatus \"AWAITING_USER_PRIORITY\")\n        (LET ((userInput (MAP_GET_VALUE qaContext \"user_backlog_selection_input\" NIL)))\\\n            (IF (IS_NIL userInput)\\\n                 (RETURN_STATUS ALANG_STATUS_PAUSE_FOR_USER_INPUT) ; Still waiting for HandlePendingUserAction\n            )\\\n            ; Conceptual: Parse user input to get selected item IDs. This is complex.\n            ; For now, assume user input is a comma-separated list of IDs.\n            (LET ((selectedItems (STRING_SPLIT (STRING_TRIM userInput) \",\")))) ; Simplified parsing\n            (IF (LIST_IS_EMPTY selectedItems)\\\n                (SEQ\\\n                    (OUTPUT_TO_USER_BUFFER \"AI_WARNING\" \"No backlog items selected. Skipping System QA cycle for now.\" NIL)\\\n                    (SET_STATE sys.system_qa_status \"IDLE\")\\\n                    (SET_STATE session.system_qa_context NIL)\\\n                    (RETURN_STATUS ALANG_STATUS_SUCCESS) ; Cycle skipped\n                )\\\n                (SEQ\\\n                    (SET_STATE session.system_qa_context (MAP_SET_VALUE qaContext \"user_selected_focus_ids\" selectedItems)) ; Store user selection\n                    (OUTPUT_TO_USER_BUFFER \"AI_PRESENT_THOUGHTS\" \"User priorities received. Step 2: Performing System QA stages.\" NIL)\\\n                    (SET_STATE sys.system_qa_status \"PERFORMING_QA\")\\\n                    ; Fall through to execute the new state immediately\n                    (CALL_PROCEDURE ExecuteSystemQAAndEvolutionCycle) ; Recursive call\n                )\\\n            )\\\n        )\\\n    )\n\n\n    (SETQ currentStatus (GET_STATE sys.system_qa_status)); Re-read status\n    (SETQ qaContext (GET_STATE session.system_qa_context)); Re-read context\n\n    (IF (EQ currentStatus \"PERFORMING_QA\")\n        (LET ((selectedItems (OR (MAP_GET_VALUE (MAP_GET_VALUE qaContext \"ai_proposed_focus\") \"item_ids\") (MAP_GET_VALUE qaContext \"user_selected_focus_ids\"))))\\\n            (LET ((qaResult (PerformSystemQA (GET_ALANG_CORE_DIRECTIVES_HANDLE) (GET_STATE sys.evolution_backlog_handle) (GET_STATE session.conceptual_model_handle) selectedItems))))\\\n            (IF (EQ qaResult ALANG_STATUS_SUCCESS)\\\n                (SEQ\\\n                    (OUTPUT_TO_USER_BUFFER \"AI_PRESENT_THOUGHTS\" \"System QA passed. Step 3: Proposing Version Increment.\" NIL)\\\n                    (SET_STATE sys.system_qa_status \"PROPOSING_VERSION\")\\\n                    ; Fall through\n                    (CALL_PROCEDURE ExecuteSystemQAAndEvolutionCycle) ; Recursive call\n                )\\\n                (IF (EQ qaResult ALANG_STATUS_PAUSE_FOR_USER_INPUT)\\\n                    (RETURN_STATUS ALANG_STATUS_PAUSE_FOR_USER_INPUT) ; Propagate pause\n                    (SEQ\\\n                        (SET_ERROR_STATE \"SYSTEM_ERROR\" \"System QA cycle failed during QA stages.\")\\\n                        (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL)\\\n                        (SET_STATE sys.system_qa_status \"IDLE\")\\\n                        (SET_STATE session.system_qa_context NIL)\\\n                        (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL)\\\n                    )\\\n                )\\\n            )\\\n        )\\\n    )\n\n    (SETQ currentStatus (GET_STATE sys.system_qa_status)); Re-read status\n    (SETQ qaContext (GET_STATE session.system_qa_context)); Re-read context\n\n    (IF (EQ currentStatus \"PROPOSING_VERSION\")\n        (LET ((changesSummary \"Summary of changes from System QA cycle.\")) ; Needs to be generated from qaContext or conceptual model\n            (LET ((versionResult (PROPOSE_CORE_LOGIC_VERSION_INCREMENT (GET_CORE_LOGIC_VERSION) changesSummary)))\\\n                (IF (EQ (GET_STATUS versionResult) ALANG_STATUS_SUCCESS)\\\n                    (LET ((versionData (GET_DATA versionResult)))\\\n                        (SET_STATE session.system_qa_context (MAP_SET_VALUE qaContext \"proposed_version_data\" versionData))\\\n                        (OUTPUT_TO_USER_BUFFER \"AI_PROVIDE_DATA\" (STRING_CONCAT \"Proposed New Version: \" (MAP_GET_VALUE versionData \"proposed_version\") \". Rationale: \" (MAP_GET_VALUE versionData \"rationale\")) NIL)\\\n                        (OUTPUT_TO_USER_BUFFER \"AI_REQUEST_CLARIFICATION_QUESTIONS\" \"Approve this version increment? (OK/REVISE)\" NIL)\\\n                        (SET_STATE sys.system_qa_status \"AWAITING_VERSION_APPROVAL\")\\\n                        (SET_STATE session.pending_user_action \"AWAIT_VERSION_APPROVAL\")\\\n                        (RETURN_STATUS ALANG_STATUS_PAUSE_FOR_USER_INPUT) ; Pause and wait for user approval\n                    )\\\n                    (SEQ\\\n                        (SET_ERROR_STATE \"SYSTEM_ERROR\" \"Failed to propose new version.\")\\\n                        (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL)\\\n                        (SET_STATE sys.system_qa_status \"IDLE\")\\\n                        (SET_STATE session.system_qa_context NIL)\\\n                        (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL)\\\n                    )\\\n                )\\\n            )\\\n        )\\\n    )\n\n    (IF (EQ currentStatus \"AWAITING_VERSION_APPROVAL\")\n        (LET ((userApproved (MAP_GET_VALUE qaContext \"version_approved\" NIL)))\\\n            (IF (IS_NIL userApproved)\\\n                (RETURN_STATUS ALANG_STATUS_PAUSE_FOR_USER_INPUT) ; Still waiting for HandlePendingUserAction\n            )\\\n            (IF userApproved\\\n                (SEQ\\\n                    (OUTPUT_TO_USER_BUFFER \"AI_PRESENT_THOUGHTS\" \"Version approved. Step 4: Finalizing and Applying Changes.\" NIL)\\\n                    (SET_STATE sys.system_qa_status \"FINALIZING\")\\\n                    ; Fall through\n                    (CALL_PROCEDURE ExecuteSystemQAAndEvolutionCycle) ; Recursive call\n                )\\\n                (SEQ\\\n                    (OUTPUT_TO_USER_BUFFER \"AI_PRESENT_THOUGHTS\" \"Version rejected. System QA cycle concluded without applying changes.\" NIL)\\\n                    (CLEAR_PENDING_CORE_LOGIC_CHANGES) ; Discard changes\n                    (SET_STATE sys.system_qa_status \"IDLE\")\\\n                    (SET_STATE session.system_qa_context NIL)\\\n                    (RETURN_STATUS ALANG_STATUS_SUCCESS) ; Cycle completed without applying changes\n                )\\\n            )\\\n        )\\\n    )\n\n    (SETQ currentStatus (GET_STATE sys.system_qa_status)); Re-read status\n    (SETQ qaContext (GET_STATE session.system_qa_context)); Re-read context\n\n    (IF (EQ currentStatus \"FINALIZING\")\n        (SEQ\\\n            (LET ((finalChangesHandle (GET_PROPOSED_CORE_LOGIC_CHANGES_HANDLE)))\\\n                (IF (IS_HANDLE_VALID finalChangesHandle)\\\n                    (LET ((applyStatus (APPLY_CORE_LOGIC_CHANGES finalChangesHandle)))\\\n                        (IF (NEQ applyStatus ALANG_STATUS_SUCCESS)\\\n                            (SEQ\\\n                                (SET_ERROR_STATE \"SYSTEM_ERROR\" \"Failed to apply final Core Logic changes.\")\\\n                                (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL)\\\n                                (SET_STATE sys.system_qa_status \"IDLE\")\\\n                                (SET_STATE session.system_qa_context NIL)\\\n                                (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL)\\\n                            )\\\n                        )\\\n                    )\\\n                )\\\n            (LET ((selectedItems (OR (MAP_GET_VALUE (MAP_GET_VALUE qaContext \"ai_proposed_focus\") \"item_ids\") (MAP_GET_VALUE qaContext \"user_selected_focus_ids\"))))\\\n                (CALL_PROCEDURE UpdateBacklogAfterQA selectedItems)\\\n            )\\\n            ; Analyze final conceptual model for evolution insights (Principle 17.vi)\n            (LET ((phiAnalysisResult (AnalyzeConceptualModelForΦ (GET_STATE session.conceptual_model_handle) (MAP_CREATE (\"focus\" \"system_evolution\")))))\\\n                (IF (EQ (GET_STATUS phiAnalysisResult) ALANG_STATUS_SUCCESS)\\\n                    (LET ((analysisData (GET_DATA phiAnalysisResult)))\\\n                        ; Conceptual: Process analysisData to generate evolution suggestions and log them.\n                        (LOG_EVENT \"CONCEPTUAL_ANALYSIS\" \"Φ analysis complete.\" analysisData)\n                        ; (CALL_PROCEDURE ProcessAndStoreEvolveSuggestion (MAP_GET_VALUE analysisData \"analysis\") \"PHI_ANALYSIS\") ; Example logging\n                    )\\\n                    (LOG_EVENT \"SYSTEM_ERROR\" \"Failed to perform Φ analysis during System QA finalization.\")\\\n                )\\\n            )\\\n            (OUTPUT_TO_USER_BUFFER \"AI_PRESENT_THOUGHTS\" \"System QA & Evolution Cycle complete. Core Logic has been updated (if changes were approved and applied).\" NIL)\\\n            (SET_STATE sys.system_qa_status \"IDLE\")\\\n            (SET_STATE session.system_qa_context NIL)\\\n            (CLEAR_PENDING_CORE_LOGIC_CHANGES)\\\n            (RETURN_STATUS ALANG_STATUS_SUCCESS)\\\n        )\\\n    )\\\n    )))\\\n)\n\n(DEFINE_PROCEDURE SelectAIProposedBacklogItems (backlog_handle session_model_handle)\n    ;; Analyzes the evolution backlog and session model to propose a focus for the System QA cycle. (NEW)\n    ;; Returns: StructuredResultObject ({status: ALANG_STATUS_SUCCESS, data: {rationale: string, item_ids: list}})\n    (OUTPUT_TO_USER_BUFFER \"AI_THOUGHTS\" \"Analyzing evolution backlog and session context to propose a focus for System QA... This analysis leverages the current state of the session conceptual model to identify areas needing system improvement.\" NIL) ; Mention conceptual model role\n    (LOG_EVENT \"CONCEPTUAL_PROCESS\" \"Selecting AI proposed backlog items for System QA focus.\")\n    (LET ((backlogContentResult (READ_CONTENT backlog_handle \"text_summary_or_full\" NIL))) ; Read backlog content\n    (LET ((sessionModelContentResult (READ_CONTENT session_model_handle \"structured_map\" NIL)))) ; Read session model content\n    (IF (AND (EQ (GET_STATUS backlogContentResult) ALANG_STATUS_SUCCESS)\n             (EQ (GET_STATUS sessionModelContentResult) ALANG_STATUS_SUCCESS))\n        (LET ((backlogContent (GET_DATA backlogContentResult)))\n        (LET ((sessionModelContent (GET_DATA sessionModelContentResult)))\n        (LET ((analysisResult (INVOKE_CORE_LLM_GENERATION\n                                (MAP_CREATE (\"template\" PROMPT_TEMPLATE_ANALYZE_BACKLOG_FOR_FOCUS)\n                                            (\"backlog_content\" backlogContent)\n                                            (\"session_model\" sessionModelContent) ; Pass session model content for context\n                                         ))\n                                (GET_LLM_PARAMS_FOR_TASK \"backlog_analysis\")\n                             ))))\n            (IF (EQ (GET_STATUS analysisResult) ALANG_STATUS_SUCCESS)\n                (LET ((analysisData (GET_DATA analysisResult)))) ; Expected structured data {rationale: string, item_ids: list}\n                ; Validate analysisData structure (NEW)\n                (LET ((validationResult (VALIDATE_DATA analysisData CONSTRAINT_SET_PROPOSED_CHANGES_STRUCTURE)))) ; Reusing structure constraint for now, might need a specific one\n                (IF (EQ validationResult ALANG_STATUS_SUCCESS)\n                    (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_SUCCESS) (\"data\" analysisData)))\n                    (SEQ ; Validation failed\n                        (LOG_EVENT \"SYSTEM_ERROR\" \"Backlog focus analysis from LLM failed validation.\")\n                        (SET_ERROR_STATE \"LLM_ERROR\" \"LLM returned malformed backlog focus proposal.\")\n                        (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL)\n                        (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_FAILURE_VALIDATION_ERROR) (\"data\" NIL)))\n                    )\n                )\n            )\n            (SEQ ; LLM failed\n                (LOG_EVENT \"SYSTEM_ERROR\" \"LLM failed to analyze backlog for focus.\")\n                (SET_ERROR_STATE \"LLM_ERROR\" \"LLM failed to analyze backlog for focus.\")\n                (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL)\n                (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_FAILURE_LLM_ERROR) (\"data\" NIL)))\n            )\n        )\n    )))\n    (SEQ ; Read failed\n        (LOG_EVENT \"SYSTEM_ERROR\" \"Failed to read backlog or session model for focus analysis.\")\n        (SET_ERROR_STATE \"SYSTEM_ERROR\" \"Failed to read inputs for backlog focus analysis.\")\n        (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL)\n        (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_FAILURE_GENERAL) (\"data\" NIL)))\n    )\n)\n\n(DEFINE_PROCEDURE UpdateBacklogAfterQA (item_ids)\n    ;; Updates the status of backlog items that were addressed in a System QA cycle. (NEW)\n    (OUTPUT_TO_USER_BUFFER \"AI_THOUGHTS\" \"Updating evolution backlog items addressed in System QA cycle.\" NIL)\n    (LOOP_FOR_EACH itemId item_ids\n        (UPDATE_EVOLUTION_BACKLOG_ITEM itemId NIL NIL NIL \"ADDRESSED\" (STRING_CONCAT \"Addressed in System QA Cycle v\" (GET_CORE_LOGIC_VERSION) \" at \" (GET_ORCHESTRATOR_TIMESTAMP)) NIL) ; Mark as addressed with version and timestamp\n    )\n    (RETURN_STATUS ALANG_STATUS_SUCCESS)\n)\n\n\n;; --- Section 6: Content Generation & Pattern Modeling Procedures ---\n\n(DEFINE_PROCEDURE SAFE_GENERATE_CONTENT (target_artifact_handle prompt_template_handle prompt_context_map constraints_handle)\n    ;; A safe and robust content generation procedure.\n    ;; Incorporates pattern identification, prompt enhancement, meta-cognitive QA, and self-correction.\n    ;; Leverages the session conceptual model (passed in prompt_context_map) throughout the process.\n    ;; Returns: ALANG_STATUS_CODE (SUCCESS, FAILURE, or PANG_STATUS_PAUSE_FOR_USER_INPUT)\n    (OUTPUT_TO_USER_BUFFER \"AI_THOUGHTS\" \"Initiating safe content generation workflow, including pattern analysis and meta-cognitive QA... This process is guided by the session conceptual model to ensure Φ-fidelity.\" NIL) ; Mention Φ-fidelity\n\n    ; 1. Identify relevant patterns in the provided context using the session conceptual model (Principle 7.A).\\\n    (LET ((sessionModelHandle (MAP_GET_VALUE prompt_context_map \"session_conceptual_model_handle\")))\\\n        (LET ((identifiedPatternsResult (CALL_PROCEDURE IdentifyPatternsInContext prompt_context_map sessionModelHandle)))\\\n            (IF (IS_STATUS_FAILURE (GET_STATUS identifiedPatternsResult))\\\n                (SEQ\\\n                    (SET_ERROR_STATE \"LLM_ERROR\" \"Failed to identify relevant patterns for content generation.\")\\\n                    (RETURN_STATUS ALANG_STATUS_FAILURE_LLM_ERROR)\\\n                )\\\n            )\\\n            (LET ((identifiedPatterns (GET_DATA identifiedPatternsResult)))\\\n\n                ; 2. Enhance the prompt with the identified patterns (Principle 7.A).\\\n                (LET ((enhancedPromptResult (CALL_PROCEDURE EnhancePromptWithPatterns prompt_template_handle prompt_context_map identifiedPatterns sessionModelHandle)))\\ ; Pass session model handle to prompt enhancement (NEW)\n                    (IF (IS_STATUS_FAILURE (GET_STATUS enhancedPromptResult))\\\n                        (SEQ\\\n                            (SET_ERROR_STATE \"LLM_ERROR\" \"Failed to enhance prompt with identified patterns.\")\\\n                            (RETURN_STATUS ALANG_STATUS_FAILURE_LLM_ERROR)\\\n                        )\\\n                    )\\\n                    (LET ((enhancedPromptText (GET_DATA enhancedPromptResult)))\\\n\n                        ; 3. Generate the content using the enhanced prompt.\\\n                        ; This primitive needs to be extended to perform the meta-cognitive QA internally.\\\n                        ; Or, more cleanly, we call the LLM and then call the QA procedure.\\\n                        (OUTPUT_TO_USER_BUFFER \"AI_THOUGHTS\" \"Generating content with enhanced prompt...\" NIL)\\\n                        (LET ((generationResult (INVOKE_CORE_LLM_GENERATION\\\n                                                    (MAP_CREATE (\"prompt_text\" enhancedPromptText)) ; Pass the fully formed prompt text\n                                                    (GET_LLM_PARAMS_FOR_TASK \"general_generation\")\\\n                                                 )))\\\n                            (IF (IS_STATUS_FAILURE (GET_STATUS generationResult))\\\n                                (SEQ\\\n                                    (SET_ERROR_STATE \"LLM_ERROR\" (STRING_CONCAT \"LLM content generation failed: \" (GET_ERROR_MESSAGE generationResult)))\\\n                                    (RETURN_STATUS ALANG_STATUS_FAILURE_LLM_ERROR)\\\n                                )\\\n                            )\\\n                            (LET ((generatedText (GET_DATA generationResult)))\\\n                                ; Write generated content to the artifact *before* QA handling, so it exists for reference.\\\n                                (WRITE_CONTENT_TO_ARTIFACT target_artifact_handle generatedText \"text/markdown\")\\\n\n                                ; 4. Perform meta-cognitive QA on the generated text (Principle 6.A).\\\n                                (OUTPUT_TO_USER_BUFFER \"AI_THOUGHTS\" \"Performing meta-cognitive QA on generated content...\" NIL)\\\n                                (LET ((qaAssessmentResult (INVOKE_CORE_LLM_GENERATION\\\n                                                             (MAP_CREATE (\"template\" PROMPT_TEMPLATE_META_COGNITIVE_QA)\\\n                                                                         (\"generated_text\" generatedText)\\\n                                                                         (\"prompt_context\" prompt_context_map)\\\n                                                                         (\"identified_patterns\" identifiedPatterns)\\\n                                                                         (\"session_model_handle\" sessionModelHandle)) ; Pass session model handle\n                                                             (GET_LLM_PARAMS_FOR_TASK \"meta_cognitive_qa\")\\\n                                                          )))\\\n                                    (IF (IS_STATUS_FAILURE (GET_STATUS qaAssessmentResult))\\\n                                        (SEQ\\\n                                            (SET_ERROR_STATE \"LLM_ERROR\" \"Meta-cognitive QA assessment failed.\")\\\n                                            (CALL_PROCEDURE ADD_DISCLAIMER_TO_ARTIFACT target_artifact_handle \"***AI_SYSTEM_ERROR: Meta-cognitive QA failed. Content may be unreliable.***\")\\\n                                            (RETURN_STATUS ALANG_STATUS_FAILURE_QA_ERROR) ; Return a specific QA error status\n                                        )\\\n                                    )\\\n                                    (LET ((qaAssessment (GET_DATA qaAssessmentResult)))\\\n\n                                        ; 5. Handle any identified QA issues. This procedure may self-correct, add disclaimers, or pause for user input.\\\n                                        (LET ((handlingStatus (HandleQAIssues generatedText qaAssessment target_artifact_handle constraints_handle sessionModelHandle)))\\\n                                            ; Return the status from HandleQAIssues (SUCCESS, FAILURE, or PAUSE_FOR_USER_INPUT)\\\n                                            (RETURN_STATUS handlingStatus)\\\n                                        )\\\n                                    )\\\n                                )\\\n                            )\\\n                        )\\\n                    )\\\n                )\\\n            )\\\n        )\\\n    )\\\n)\n\n(DEFINE_PROCEDURE IdentifyPatternsInContext (context_map session_model_handle)\n    ;; Identifies relevant patterns from the PKA and session conceptual model based on the provided context. (Conceptual)\n    ;; Returns: StructuredResultObject ({status: ALANG_STATUS_SUCCESS, data: structured_pattern_data}) or failure.\n    (OUTPUT_TO_USER_BUFFER \"AI_THOUGHTS\" \"Identifying relevant patterns from knowledge sources and session model... Leveraging Φ context.\" NIL) ; Mention Φ context\n    ; This would involve:\n    ; 1. Querying the PKA store (PKA_QUERY) based on keywords from the context.\n    ; 2. Querying the session conceptual model (QUERY_CONCEPTUAL_MODEL) for relevant nodes and relationships, prioritizing based on Φ-related properties (confidence, relevance to task).\n    ; 3. Compiling the results and using an LLM to synthesize and rank the most relevant patterns for the current task, considering their potential Φ contribution to the generated content.\n    (LOG_EVENT \"CONCEPTUAL_PROCESS\" \"Identifying patterns in context, using Φ prioritization.\")\n    (LET ((analysisResult (INVOKE_CORE_LLM_GENERATION\n                            (MAP_CREATE (\"template\" PROMPT_TEMPLATE_ANALYZE_DATA_FOR_PATTERNS) ; Use specific template (NEW)\n                                        (\"context\" context_map)\n                                        (\"session_model_handle\" session_model_handle) ; Pass session model handle\n                                        (\"pka_handle\" (GET_STATE sys.knowledge_base_handle))) ; Pass PKA handle\n                            (GET_LLM_PARAMS_FOR_TASK \"pattern_identification\")\n                         )))\n    (IF (EQ (GET_STATUS analysisResult) ALANG_STATUS_SUCCESS)\n        (LET ((patternsData (GET_DATA analysisResult)))\\\n        ; Validate patternsData structure (NEW)\\\n        (LET ((validationResult (VALIDATE_DATA patternsData CONSTRAINT_SET_IDENTIFIED_PATTERNS_STRUCTURE)))\\\n        (IF (EQ validationResult ALANG_STATUS_SUCCESS)\\\n            (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_SUCCESS) (\"data\" patternsData)))\\\n            (SEQ\\\n                (LOG_EVENT \"SYSTEM_ERROR\" \"Identified patterns from LLM failed validation.\")\\\n                (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_FAILURE_VALIDATION_ERROR) (\"data\" NIL)))\\\n            )\\\n        )\\\n    )\\\n    (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_FAILURE_LLM_ERROR) (\"data\" NIL)))\\\n    )\\\n)\\\n\n(DEFINE_PROCEDURE EnhancePromptWithPatterns (prompt_template_handle context_map identified_patterns session_model_handle)\n    ;; Enhances a base prompt by dynamically injecting identified patterns and contextual information, leveraging the session model. (Conceptual)\n    ;; Returns: StructuredResultObject ({status: ALANG_STATUS_SUCCESS, data: enhanced_prompt_text}) or failure.\n    (OUTPUT_TO_USER_BUFFER \"AI_THOUGHTS\" \"Enhancing prompt with identified patterns and contextual data, informed by the session conceptual model...\" NIL)\n    ; This would involve:\n    ; 1. Reading the base prompt template.\n    ; 2. Using an LLM to intelligently weave the identified_patterns and context_map into the template to create a highly specific and effective final prompt.\n    ; 3. The LLM should use the session_model_handle to understand the current context and the relationships between concepts, ensuring the injected patterns are relevant and framed appropriately.\n    (LOG_EVENT \"CONCEPTUAL_PROCESS\" \"Enhancing prompt with patterns and conceptual context.\")\n    (LET ((basePromptTemplateResult (READ_CONTENT prompt_template_handle \"text\" NIL)))\\\n    (LET ((sessionModelContentResult (READ_CONTENT session_model_handle \"structured_map\" NIL)))) ; Read session model content\n        (IF (AND (EQ (GET_STATUS basePromptTemplateResult) ALANG_STATUS_SUCCESS)\n                 (EQ (GET_STATUS sessionModelContentResult) ALANG_STATUS_SUCCESS))\n            (LET ((basePromptTemplate (GET_DATA basePromptTemplateResult))))\n            (LET ((sessionModelContent (GET_DATA sessionModelContentResult))))\n                (LET ((enhancedPromptResult (INVOKE_CORE_LLM_GENERATION\n                                                (MAP_CREATE (\"template\" PROMPT_TEMPLATE_ENHANCE_PROMPT)\n                                                            (\"base_prompt\" basePromptTemplate)\n                                                            (\"context\" context_map)\n                                                            (\"patterns\" identified_patterns)\n                                                            (\"session_model\" sessionModelContent)) ; Pass session model content for context\n                                                (GET_LLM_PARAMS_FOR_TASK \"prompt_enhancement\")\n                                             )))\\\n                    (RETURN_STATUS enhancedPromptResult)\\\n                )\\\n            )\\\n            (SEQ\\\n                (LOG_EVENT \"SYSTEM_ERROR\" (STRING_CONCAT \"Failed to read prompt template or session model: \" prompt_template_handle))\\\n                (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_FAILURE_GENERAL) (\"data\" NIL)))\\\n            )\\\n        )\\\n    )\\\n)\n\n(DEFINE_PROCEDURE ParseUserCommand (raw_text session_model_handle)\n    ;; Parses raw user text into a structured command using an LLM, with context from the session conceptual model.\n    (LET ((parseResult (INVOKE_CORE_LLM_GENERATION\n                            (MAP_CREATE (\"template\" PROMPT_TEMPLATE_PARSE_COMMAND)\n                                        (\"user_text\" raw_text)\n                                        (\"session_model_handle\" session_model_handle)) ; Include conceptual model handle\n                            (GET_LLM_PARAMS_FOR_TASK \"command_parsing\")\n                         )))\\\n        (IF (EQ (GET_STATUS parseResult) ALANG_STATUS_SUCCESS)\\\n            ; The result should be a structured map (e.g., JSON) like {command: \"START\", args: [\"...\"]}\\\n            ; which needs to be parsed from the LLM's string output.\\\n            ; A real implementation would have a robust JSON parser.\\\n            ; For now, assume the orchestrator handles this parsing.\\\n            (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_SUCCESS) (\"data\" (GET_DATA parseResult))))\\\n            (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_FAILURE_LLM_ERROR) (\"data\" NIL)))\\\n        )\\\n    )\\\n)\n\n(DEFINE_PROCEDURE ParseToolErrorResolutionInput (raw_input tool_id error_details context session_model_handle)\n    ;; Parses raw user text into structured input/parameters for tool error resolution, using conceptual model for context. (NEW)\n    ;; Returns: StructuredResultObject ({status: ALANG_STATUS_SUCCESS, data: {input: any, params: map}}) or failure.\n    (OUTPUT_TO_USER_BUFFER \"AI_THOUGHTS\" \"Parsing user input for tool error resolution, leveraging session context...\" NIL)\n    (LOG_EVENT \"CONCEPTUAL_PROCESS\" \"Parsing tool error resolution input with conceptual context.\")\n    (LET ((sessionModelContentResult (READ_CONTENT session_model_handle \"structured_map\" NIL)))) ; Read session model content\n    (IF (EQ (GET_STATUS sessionModelContentResult) ALANG_STATUS_SUCCESS)\n        (LET ((sessionModelContent (GET_DATA sessionModelContentResult))))\n        (LET ((parseResult (INVOKE_CORE_LLM_GENERATION\n                            (MAP_CREATE (\"template\" PROMPT_TEMPLATE_ANALYZE_TOOL_ERROR_RESOLUTION_INPUT) ; Use specific template (NEW)\n                                        (\"raw_input\" raw_input)\n                                        (\"tool_id\" tool_id)\n                                        (\"error_details\" error_details)\n                                        (\"original_context\" context)\n                                        (\"session_model\" sessionModelContent)) ; Pass session model content for context\n                            (GET_LLM_PARAMS_FOR_TASK \"tool_input_parsing\")\n                         ))))\n        (IF (EQ (GET_STATUS parseResult) ALANG_STATUS_SUCCESS)\n            (LET ((parsedData (GET_DATA parseResult))))\n            ; Validate parsedData structure (NEW)\n            (LET ((validationResult (VALIDATE_DATA parsedData CONSTRAINT_SET_TOOL_ERROR_RESOLUTION_INPUT_STRUCTURE))))\n            (IF (EQ validationResult ALANG_STATUS_SUCCESS)\n                (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_SUCCESS) (\"data\" parsedData)))\n                (SEQ\n                    (LOG_EVENT \"SYSTEM_ERROR\" \"Parsed tool error resolution input from LLM failed validation.\")\n                    (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_FAILURE_VALIDATION_ERROR) (\"data\" NIL)))\n                )\n            )\n        )\n        (SEQ ; LLM failed\n            (LOG_EVENT \"SYSTEM_ERROR\" \"LLM failed to parse tool error resolution input.\")\n            (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_FAILURE_LLM_ERROR) (\"data\" NIL)))\n        )\n    )\n    (SEQ ; Read failed\n        (LOG_EVENT \"SYSTEM_ERROR\" \"Failed to read session model for tool error resolution input parsing.\")\n        (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_FAILURE_GENERAL) (\"data\" NIL)))\n    )\n)\n\n\n(DEFINE_PROCEDURE ProcessAndStoreEvolveSuggestion (suggestionText source)\n    ;; Processes a user or system-generated evolution suggestion and stores it in the backlog. (Principle 17)\n    (LET ((similarItem (FIND_SIMILAR_BACKLOG_ITEM suggestionText))) ; Find if a similar suggestion exists\n        (IF (IS_NIL similarItem)\n            (LET ((newItemId (GENERATE_UNIQUE_ID \"EBL\"))))\n                (CREATE_EVOLUTION_BACKLOG_ITEM\n                    newItemId\n                    (STRING_CONCAT \"Suggestion: \" (SUBSTRING suggestionText 0 50) \"...\") ; Generate title\n                    suggestionText\n                    source\n                    \"NEW\"\n                    (GET_ORCHESTRATOR_TIMESTAMP)\n                )\n                (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_SUCCESS) (\"data\" newItemId)))\\\n            )\\\n            (SEQ ; Found a similar item, so reinforce it\n                (UPDATE_EVOLUTION_BACKLOG_ITEM\n                    (MAP_GET_VALUE similarItem \"id\")\n                    NIL ; no new title\n                    NIL ; no new desc\n                    NIL ; no new source\n                    NIL ; no new status\n                    (STRING_CONCAT \"Reinforced by \" source \" at \" (GET_ORCHESTRATOR_TIMESTAMP)) ; new comment\n                    TRUE ; increment reinforce flag\n                )\n                (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_SUCCESS) (\"data\" (MAP_GET_VALUE similarItem \"id\"))))\\\n            )\\\n        )\\\n    )\\\n)\n\n(DEFINE_PROCEDURE CreateAndStorePKAIfUserConsents (content schema_id rationale session_model_handle)\n    ;; Manages the PKA creation and consent workflow. (Principle 8.B.i, ii, iii, iv)\n    (LET ((draftHandle (PKA_CREATE_DRAFT content schema_id (MAP_CREATE (\"rationale\" rationale) (\"source\" \"user_promotion\")))))\\\n        (IF (IS_HANDLE_VALID draftHandle)\\\n            (SEQ\\\n                ; Generate and get the consent prompt text\\\n                (LET ((consentPromptText (GET_TEXT_FOR_PKA_CONSENT_PROMPT rationale session_model_handle)))\\\n                    (LET ((consentResult (PKA_REQUEST_USER_CONSENT_TO_STORE draftHandle consentPromptText)))\\\n                        (IF (EQ consentResult \"USER_CONSENT_GRANTED\")\\\n                            (LET ((storeResult (PKA_STORE_APPROVED_DRAFT draftHandle \"USER_CONSENT_GRANTED\")))\\\n                                (IF (EQ (GET_STATUS storeResult) ALANG_STATUS_SUCCESS)\\\n                                    (LET ((pkaId (GET_DATA storeResult)))\\\n                                        (OUTPUT_TO_USER_BUFFER \"AI_PROVIDE_DATA\" (STRING_CONCAT \"PKA stored successfully. ID: \" pkaId) NIL)\\\n                                        ; Integrate new PKA into session conceptual model (Principle 0.V.6, 8.B.v)\\\n                                        (CALL_PROCEDURE IntegratePkaIntoConceptualModel pkaId session_model_handle)\\\n                                        (RETURN_STATUS ALANG_STATUS_SUCCESS)\\\n                                    )\\\n                                    (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" \"Failed to store approved PKA draft.\" NIL)\\\n                                )\\\n                            )\\\n                            (OUTPUT_TO_USER_BUFFER \"AI_THOUGHTS\" \"PKA storage cancelled by user.\" NIL)\\\n                        )\\\n                    )\\\n                )\\\n            )\\\n            (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" \"Failed to create PKA draft.\" NIL)\\\n        )\\\n    )\\\n    (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL)\\\n)\n\n;; --- Section 7: ALANG Status Codes (NEW in v1.11/v1.12) ---\n;; This section defines new ALANG_STATUS_ codes used in this version.\n\n(DEFINE_PRIMITIVE ALANG_STATUS_FAILURE_VALIDATION_ERROR ())\n    ; Indicates a failure due to data validation against a schema.\n    ; Returns: ALANG_STATUS_CODE\n\n(DEFINE_PRIMITIVE ALANG_STATUS_FAILURE_QA_ERROR ())\n    ; Indicates a general failure during a QA process.\n    ; Returns: ALANG_STATUS_CODE\n\n(DEFINE_PRIMITIVE ALANG_STATUS_FAILURE_QA_MAX_ITERATIONS ())\n    ; Indicates a QA process failed because it reached the maximum allowed iterations without converging.\n    ; Returns: ALANG_STATUS_CODE\n\n(DEFINE_PRIMITIVE ALANG_STATUS_FAILURE_REVISION_ERROR ())\n    ; Indicates a general failure during an artifact revision process.\n    ; Returns: ALANG_STATUS_CODE\n\n(DEFINE_PRIMITIVE ALANG_STATUS_FAILURE_CONCEPTUAL_MODEL_ERROR ())\n    ; Indicates a general failure during a conceptual model operation.\n    ; Returns: ALANG_STATUS_CODE\n\n(DEFINE_PRIMITIVE ALANG_STATUS_SYSTEM_QA_SELECTING_BACKLOG_FOCUS ())\n    ; System QA Cycle Status: Currently selecting backlog items to focus on.\n    ; Returns: ALANG_STATUS_CODE\n\n(DEFINE_PRIMITIVE ALANG_STATUS_SYSTEM_QA_AWAITING_FOCUS_APPROVAL ())\n    ; System QA Cycle Status: Waiting for user approval of the proposed backlog focus.\n    ; Returns: ALANG_STATUS_CODE\n\n(DEFINE_PRIMITIVE ALANG_STATUS_SYSTEM_QA_AWAITING_USER_PRIORITY ())\n    ; System QA Cycle Status: Waiting for user to provide backlog item priorities.\n    ; Returns: ALANG_STATUS_CODE\n\n(DEFINE_PRIMITIVE ALANG_STATUS_SYSTEM_QA_PERFORMING_QA ())\n    ; System QA Cycle Status: Currently executing the QA stages.\n    ; Returns: ALANG_STATUS_CODE\n\n(DEFINE_PRIMITIVE ALANG_STATUS_SYSTEM_QA_PROPOSING_VERSION ())\n    ; System QA Cycle Status: Analyzing QA results and proposing a new version.\n    ; Returns: ALANG_STATUS_CODE\n\n(DEFINE_PRIMITIVE ALANG_STATUS_SYSTEM_QA_AWAITING_VERSION_APPROVAL ())\n    ; System QA Cycle Status: Waiting for user approval of the proposed version.\n    ; Returns: ALANG_STATUS_CODE\n\n(DEFINE_PRIMITIVE ALANG_STATUS_SYSTEM_QA_FINALIZING ())\n    ; System QA Cycle Status: Applying approved changes and finalizing the cycle.\n    ; Returns: ALANG_STATUS_CODE\n\n(DEFINE_PRIMITIVE ALANG_STATUS_SYSTEM_QA_FAILED_APPLY_CHANGES ())\n    ; System QA Cycle Status: Failed to apply proposed changes.\n    ; Returns: ALANG_STATUS_CODE\n\n\nCONVERGED:\n;; --- Section 8: End of Core Logic ---\n;; This marks the end of the Autologos Core Logic ALang file.\n```\n--- END OF FILE Autologos_Core_Logic_v1.12.alang ---\n```\n--- END FILE: Autologos_Core_Logic.alang_product_20250606_095243_product_expansive_20250606_152725.md ---"
  },
  {
    "iteration": 1,
    "productSummary": "```\n--- START FILE: Autologos_Core_Logic_v1.12.alang ---\n;; Autologos_Core_Logic.alang v1.12\n;; S...",
    "status": "Iteration 1 complete",
    "timestamp": "3:31:20 PM",
    "fullProduct": "```\n--- START FILE: Autologos_Core_Logic_v1.12.alang ---\n;; Autologos_Core_Logic.alang v1.12\n;; Specification Version: ALANG_SPEC_V1.0\n;; Core Logic Version: ALANG_CORE_LOGIC_V1.12\n;; Core behavior of the Autologos system in ALang.\n\n;; --- Section 0: System Config & Metadata ---\n\n(DEFINE_PRIMITIVE GET_ALANG_SPEC_VERSION ())\n(DEFINE_PRIMITIVE GET_CORE_LOGIC_VERSION ())\n(DEFINE_PRIMITIVE GET_ORCHESTRATOR_TIMESTAMP ())\n\n(SET_STATE sys.alang_spec_version (GET_ALANG_SPEC_VERSION))\n(SET_STATE sys.alang_core_logic_version (GET_CORE_LOGIC_VERSION))\n(SET_STATE sys.current_mode \"IDLE\")\n(SET_STATE sys.error_level \"NONE\")\n(SET_STATE sys.error_message NIL)\n(SET_STATE sys.evolution_backlog_handle \"Autologos/Evolution_Backlog.json\")\n(SET_STATE sys.knowledge_base_handle \"Autologos/Persistent_Knowledge_Base.json\")\n(SET_STATE sys.evolution_trigger_pending FALSE)\n(SET_STATE sys.system_qa_status \"IDLE\")\n(SET_STATE session.qa_output_verbosity \"CONCISE\")\n(SET_STATE session.output_detail \"STANDARD\")\n(SET_STATE session.loop_stack (LIST_CREATE))\n(SET_STATE session.conceptual_model_handle NIL)\n(SET_STATE session.pending_user_action_details NIL)\n(SET_STATE session.last_search_results NIL)\n(SET_STATE session.system_qa_context NIL)\n(SET_STATE sys.proposed_changes_handle NIL)\n\n;; --- External Component Dependencies ---\n\n(DEFINE_SYMBOL PROMPT_TEMPLATE_GENERATE_PATTERN_IDEAS \"prompt_generate_pattern_ideas.txt\")\n(DEFINE_SYMBOL PROMPT_TEMPLATE_PRODUCT_DEFINITION \"prompt_product_definition.txt\")\n(DEFINE_SYMBOL PROMPT_TEMPLATE_GENERATE_TASK_LIST \"prompt_generate_task_list.txt\")\n(DEFINE_SYMBOL PROMPT_TEMPLATE_EXECUTE_TASK \"prompt_execute_task.txt\")\n(DEFINE_SYMBOL PROMPT_TEMPLATE_COMPILE_DRAFT \"prompt_compile_draft.txt\")\n(DEFINE_SYMBOL PROMPT_TEMPLATE_PROJECT_SUMMARY \"prompt_project_summary.txt\")\n(DEFINE_SYMBOL PROMPT_TEMPLATE_QA_SELF_CRITIQUE \"prompt_qa_self_critique.txt\")\n(DEFINE_SYMBOL PROMPT_TEMPLATE_QA_DIVERGENT_EXPLORATION \"prompt_qa_divergent_exploration.txt\")\n(DEFINE_SYMBOL PROMPT_TEMPLATE_QA_RED_TEAMING \"prompt_qa_red_teaming.txt\")\n(DEFINE_SYMBOL PROMPT_TEMPLATE_QA_EXTERNAL_REVIEW \"prompt_qa_external_review.txt\")\n(DEFINE_SYMBOL PROMPT_TEMPLATE_PARSE_COMMAND \"prompt_parse_command.txt\")\n(DEFINE_SYMBOL PROMPT_TEMPLATE_SUMMARIZE_ARTIFACT \"prompt_summarize_artifact.txt\")\n(DEFINE_SYMBOL PROMPT_TEMPLATE_PERFORM_QUERY \"prompt_perform_query.txt\")\n(DEFINE_SYMBOL PROMPT_TEMPLATE_SERIALIZE_ALANG_CORE \"prompt_serialize_alang_core.txt\")\n(DEFINE_SYMBOL PROMPT_TEMPLATE_META_COGNITIVE_QA \"prompt_meta_cognitive_qa.txt\")\n(DEFINE_SYMBOL PROMPT_TEMPLATE_SELF_CORRECTION \"prompt_self_correction.txt\")\n(DEFINE_SYMBOL PROMPT_TEMPLATE_ENHANCE_PROMPT \"prompt_enhance_prompt.txt\")\n(DEFINE_SYMBOL PROMPT_TEMPLATE_ANALYZE_FOR_CONCEPTUAL_MODEL_UPDATE \"prompt_analyze_for_conceptual_model_update.txt\")\n(DEFINE_SYMBOL PROMPT_TEMPLATE_PKA_CONSENT \"prompt_pka_consent.txt\")\n(DEFINE_SYMBOL PROMPT_TEMPLATE_ANALYZE_BACKLOG_FOR_FOCUS \"prompt_analyze_backlog_for_focus.txt\")\n(DEFINE_SYMBOL PROMPT_TEMPLATE_ANALYZE_QA_FOR_DIRECTIVE_CHANGES \"prompt_analyze_qa_for_directive_changes.txt\")\n(DEFINE_SYMBOL PROMPT_TEMPLATE_ANALYZE_DATA_FOR_PATTERNS \"prompt_analyze_data_for_patterns.txt\")\n(DEFINE_SYMBOL PROMPT_TEMPLATE_ANALYZE_QA_REPORT_FOR_REVISIONS \"prompt_analyze_qa_report_for_revisions.txt\")\n(DEFINE_SYMBOL PROMPT_TEMPLATE_ANALYZE_TOOL_ERROR \"prompt_analyze_tool_error.txt\")\n(DEFINE_SYMBOL PROMPT_TEMPLATE_ANALYZE_FEEDBACK_FOR_REVISION \"prompt_analyze_feedback_for_revision.txt\")\n(DEFINE_SYMBOL PROMPT_TEMPLATE_ANALYZE_TOOL_ERROR_USER_EXPLANATION \"prompt_analyze_tool_error_user_explanation.txt\")\n(DEFINE_SYMBOL PROMPT_TEMPLATE_ANALYZE_TOOL_ERROR_RESOLUTION_INPUT \"prompt_analyze_tool_error_resolution_input.txt\")\n(DEFINE_SYMBOL PROMPT_TEMPLATE_SUMMARIZE_CONCEPTUAL_MODEL \"prompt_summarize_conceptual_model.txt\")\n(DEFINE_SYMBOL PROMPT_TEMPLATE_ANALYZE_CONCEPTUAL_MODEL_FOR_PHI \"prompt_analyze_conceptual_model_for_phi.txt\")\n\n(DEFINE_SYMBOL CONSTRAINT_SET_IDEA_GENERATION \"constraints_idea_generation.json\")\n(DEFINE_SYMBOL CONSTRAINT_SET_PRODUCT_DEFINITION \"constraints_product_definition.json\")\n(DEFINE_SYMBOL CONSTRAINT_SET_PLANNING \"constraints_planning.json\")\n(DEFINE_SYMBOL CONSTRAINT_SET_TASK_EXECUTION \"constraints_task_execution.json\")\n(DEFINE_SYMBOL CONSTRAINT_SET_FINAL_REVIEW \"constraints_final_review.json\")\n(DEFINE_SYMBOL CONSTRAINT_SET_SUMMARY \"constraints_summary.json\")\n(DEFINE_SYMBOL CONSTRAINT_SET_QA_CRITIQUE \"constraints_qa_critique.json\")\n(DEFINE_SYMBOL CONSTRAINT_SET_PATTERN_IDENTIFICATION \"constraints_pattern_identification.json\")\n(DEFINE_SYMBOL CONSTRAINT_SET_VALID_ALANG_SYNTAX \"constraints_valid_alang_syntax.json\")\n(DEFINE_SYMBOL CONSTRAINT_SET_CONCEPTUAL_MODEL_STRUCTURE \"constraints_conceptual_model_structure.json\")\n(DEFINE_SYMBOL CONSTRAINT_SET_PKA_SCHEMA_REGISTRY \"constraints_pka_schema_registry.json\")\n(DEFINE_SYMBOL CONSTRAINT_SET_PROPOSED_CHANGES_STRUCTURE \"constraints_proposed_changes_structure.json\")\n(DEFINE_SYMBOL CONSTRAINT_SET_IDENTIFIED_PATTERNS_STRUCTURE \"constraints_identified_patterns_structure.json\")\n(DEFINE_SYMBOL CONSTRAINT_SET_REVISION_PLAN_STRUCTURE \"constraints_revision_plan_structure.json\")\n(DEFINE_SYMBOL CONSTRAINT_SET_TOOL_ERROR_ANALYSIS_STRUCTURE \"constraints_tool_error_analysis_structure.json\")\n(DEFINE_SYMBOL CONSTRAINT_SET_CONCEPTUAL_MODEL_UPDATE_STRUCTURE \"constraints_conceptual_model_update_structure.json\")\n(DEFINE_SYMBOL CONSTRAINT_SET_TOOL_ERROR_RESOLUTION_INPUT_STRUCTURE \"constraints_tool_error_resolution_input_structure.json\")\n(DEFINE_SYMBOL CONSTRAINT_SET_CONCEPTUAL_MODEL_SUMMARY_STRUCTURE \"constraints_conceptual_model_summary_structure.json\")\n(DEFINE_SYMBOL CONSTRAINT_SET_PHI_ANALYSIS_STRUCTURE \"constraints_phi_analysis_structure.json\")\n\n;; --- Section 1: Utility Procedures & Primitives Declarations ---\n\n(DEFINE_PROCEDURE AcknowledgeAndLog (log_event_type log_message user_ack_message_type user_ack_content) (SEQ (LOG_EVENT log_event_type log_message) (OUTPUT_TO_USER_BUFFER user_ack_message_type user_ack_content NIL) (FLUSH_USER_OUTPUT_BUFFER) (RETURN_STATUS ALANG_STATUS_SUCCESS)))\n(DEFINE_PROCEDURE OutputGeneralHelp () (SEQ (OUTPUT_TO_USER_BUFFER \"AI_PROVIDE_DATA\" \"Autologos Commands: START, OK, NO/REVISE, INPUT, HELP?, END, EVOLVE, SAVE_SYSTEM, SAVE_PROJECT, OUTPUT, SUMMARIZE, QUERY, OUTPUT_BACKLOG, PROMOTE_TO_PKA, SEARCH_PKA, SET_SESSION_PREFERENCE, SET QA_OUTPUT_VERBOSITY, SET OUTPUT_DETAIL, LOOP, STOP_LOOP, LOOP_PROJECT_RESTART, SYSTEM_QA.\") (RETURN_STATUS ALANG_STATUS_SUCCESS)))\n(DEFINE_PROCEDURE OutputSpecificHelp (commandName) (LET ((helpContent (GET_HELP_TEXT_FOR_COMMAND commandName))) (IF (IS_NIL helpContent) (SEQ (SET_ERROR_STATE \"USER_ERROR\" (STRING_CONCAT \"No help found for command: \" commandName)) (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL) (RETURN_STATUS ALANG_STATUS_NOT_FOUND)) (OUTPUT_TO_USER_BUFFER \"AI_PROVIDE_DATA\" helpContent NIL)) (RETURN_STATUS ALANG_STATUS_SUCCESS)))\n(DEFINE_PROCEDURE ClearTurnSpecificSessionState () (SEQ (SET_STATE session.last_user_input_raw NIL) (SET_STATE session.parsed_command_details NIL) (SET_STATE session.pending_user_action NIL) (SET_STATE session.pending_user_action_details NIL) (SET_STATE session.active_tool_id NIL) (SET_STATE session.tool_last_status NIL) (SET_STATE session.tool_last_output_handle NIL) (SET_STATE session.last_user_response NIL) (SET_STATE session.last_user_feedback NIL) (SET_STATE session.last_user_input_data NIL) (RETURN_STATUS ALANG_STATUS_SUCCESS)))\n(DEFINE_PROCEDURE ParseKeyValueArgs (argsList) (LET ((resultMap (MAP_CREATE))) (LOOP_FOR_EACH argString argsList (LET ((parts (STRING_SPLIT argString \"=\"))) (IF (EQ (LIST_GET_LENGTH parts) 2) (SET_STATE resultMap (MAP_SET_VALUE resultMap (LIST_GET_ITEM parts 0) (LIST_GET_ITEM parts 1))) (LOG_EVENT \"WARNING\" (STRING_CONCAT \"Skipping malformed key-value arg: \" argString))))) (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_SUCCESS) (\"data\" resultMap)))))\n(DEFINE_PROCEDURE SummarizeArtifact (artifactHandle session_model_handle) (LET ((contentResult (READ_CONTENT artifactHandle \"text_summary_or_full\" NIL))) (IF (NEQ (GET_STATUS contentResult) ALANG_STATUS_SUCCESS) (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_FAILURE_GENERAL) (\"data\" NIL))) (LET ((content (GET_DATA contentResult))) (IF (IS_NIL content) (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_FAILURE_GENERAL) (\"data\" NIL))) (LET ((summaryResult (INVOKE_CORE_LLM_GENERATION (MAP_CREATE (\"template\" PROMPT_TEMPLATE_SUMMARIZE_ARTIFACT) (\"content\" content) (\"session_model_handle\" session_model_handle)) (GET_LLM_PARAMS_FOR_TASK \"summarization\")))) (IF (EQ (GET_STATUS summaryResult) ALANG_STATUS_SUCCESS) (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_SUCCESS) (\"data\" (GET_DATA summaryResult)))) (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_FAILURE_LLM_ERROR) (\"data\" NIL))))))))))\n(DEFINE_PROCEDURE PerformQuery (queryType queryValue session_model_handle pka_handle) (LET ((queryResult (INVOKE_CORE_LLM_GENERATION (MAP_CREATE (\"template\" PROMPT_TEMPLATE_PERFORM_QUERY) (\"query_type\" queryType) (\"query_value\" queryValue) (\"session_conceptual_model_handle\" session_model_handle) (\"pka_handle\" pka_handle)) (GET_LLM_PARAMS_FOR_TASK \"query_answering\")))) (IF (EQ (GET_STATUS queryResult) ALANG_STATUS_SUCCESS) (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_SUCCESS) (\"data\" (GET_DATA queryResult)))) (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_FAILURE_LLM_ERROR) (\"data\" NIL))))))\n(DEFINE_PROCEDURE GetEvolutionBacklogContent () (LET ((handle (GET_STATE sys.evolution_backlog_handle))) (IF (IS_NIL handle) (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_FAILURE_GENERAL) (\"data\" NIL))) (LET ((contentResult (READ_CONTENT handle \"text_summary_or_full\" NIL))) (IF (EQ (GET_STATUS contentResult) ALANG_STATUS_SUCCESS) (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_SUCCESS) (\"data\" (GET_DATA contentResult)))) (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_FAILURE_GENERAL) (\"data\" NIL))))))))\n(DEFINE_PROCEDURE LoadEvolutionBacklog (handle_or_path) (SEQ (LOG_EVENT \"SYSTEM_LOAD\" (STRING_CONCAT \"Loading Evolution Backlog from: \" handle_or_path)) (RETURN_STATUS ALANG_STATUS_SUCCESS)))\n(DEFINE_PROCEDURE LoadPersistentKnowledgeBase (handle_or_path) (SEQ (LOG_EVENT \"SYSTEM_LOAD\" (STRING_CONCAT \"Loading Persistent Knowledge Base from: \" handle_or_path)) (RETURN_STATUS ALANG_STATUS_SUCCESS)))\n(DEFINE_PROCEDURE GetSessionCmdArgByIndex (index default_value_optional) (LET ((argsList (MAP_GET_VALUE (GET_STATE session.parsed_command_details) \"args\" (LIST_CREATE)))) (IF (LT index (LIST_GET_LENGTH argsList)) (LIST_GET_ITEM argsList index) default_value_optional)))\n(DEFINE_PRIMITIVE GET_TEXT_FOR_PKA_CONSENT_PROMPT (purpose_description session_model_handle) (LET ((modelContentResult (READ_CONTENT session_model_handle \"structured_map\" NIL))) (IF (EQ (GET_STATUS modelContentResult) ALANG_STATUS_SUCCESS) (LET ((modelContent (GET_DATA modelContentResult))) (LET ((promptResult (INVOKE_CORE_LLM_GENERATION (MAP_CREATE (\"template\" PROMPT_TEMPLATE_PKA_CONSENT) (\"purpose\" purpose_description) (\"session_model_context\" modelContent)) (GET_LLM_PARAMS_FOR_TASK \"prompt_generation\")))) (IF (EQ (GET_STATUS promptResult) ALANG_STATUS_SUCCESS) (RETURN_STATUS (GET_DATA promptResult)) (RETURN_STATUS (STRING_CONCAT \"Do you consent to store this knowledge artifact for the purpose: \" purpose_description \"? (YES/NO)\"))))) (RETURN_STATUS (STRING_CONCAT \"Do you consent to store this knowledge artifact for the purpose: \" purpose_description \"? (YES/NO)\"))))))\n(DEFINE_PROCEDURE HandleQAIssues (generated_text qaAssessment target_artifact_handle constraints_handle session_model_handle) (LET ((hasIssues (MAP_GET_VALUE qaAssessment \"has_issues\" FALSE))) (LET ((issueDetails (MAP_GET_VALUE qaAssessment \"details\" (LIST_CREATE)))) (LET ((confidenceScore (MAP_GET_VALUE qaAssessment \"confidence_score\" 1.0))) (LET ((remediationStatus ALANG_STATUS_SUCCESS))) (IF hasIssues (SEQ (OUTPUT_TO_USER_BUFFER \"AI_PRESENT_THOUGHTS\" (STRING_CONCAT \"Meta-cognitive QA found issues (Confidence: \" (STRING_CONCAT \"\" confidenceScore) \"):\") NIL) (LOOP_FOR_EACH issue issueDetails (CALL_PROCEDURE UPDATE_CONCEPTUAL_MODEL (MAP_CREATE (\"action\" \"log_issue\") (\"issue\" issue) (\"artifact_handle\" target_artifact_handle) (\"confidence\" confidenceScore)))) (LET ((needsUserReview FALSE))) (LET ((attemptSelfCorrection FALSE))) (LET ((overallSeverity \"NONE\"))) (LOOP_FOR_EACH issue issueDetails (LET ((severity (MAP_GET_VALUE issue \"severity\" \"minor\"))) (IF (EQ severity \"CRITICAL\") (SET_STATE overallSeverity \"CRITICAL\")) (IF (AND (EQ severity \"MAJOR\") (NEQ overallSeverity \"CRITICAL\")) (SET_STATE overallSeverity \"MAJOR\")) (IF (AND (EQ severity \"MINOR\") (AND (NEQ overallSeverity \"CRITICAL\") (NEQ overallSeverity \"MAJOR\"))) (SET_STATE overallSeverity \"MINOR\")))) (IF (OR (EQ overallSeverity \"CRITICAL\") (LT confidenceScore 0.5)) (SEQ (SET_STATE needsUserReview TRUE) (CALL_PROCEDURE ADD_DISCLAIMER_TO_ARTIFACT target_artifact_handle \"***AI_USER_VERIFICATION_REQUIRED: Critical issues or low confidence detected. Review QA findings carefully.***\") (CALL_PROCEDURE UPDATE_CONCEPTUAL_MODEL (MAP_CREATE (\"action\" \"flag_uncertainty\") (\"artifact_handle\" target_artifact_handle) (\"details\" issueDetails) (\"confidence\" confidenceScore)))) (IF (EQ overallSeverity \"MAJOR\") (SEQ (SET_STATE attemptSelfCorrection TRUE) (CALL_PROCEDURE UPDATE_CONCEPTUAL_MODEL (MAP_CREATE (\"action\" \"flag_needs_correction\") (\"artifact_handle\" target_artifact_handle) (\"details\" issueDetails)))) (SEQ (OUTPUT_TO_USER_BUFFER \"AI_PRESENT_THOUGHTS\" \"Minor issues detected or no issues requiring immediate intervention found. Logging findings.\" NIL) (CALL_PROCEDURE UPDATE_CONCEPTUAL_MODEL (MAP_CREATE (\"action\" \"log_minor_issues\") (\"artifact_handle\" target_artifact_handle) (\"details\" issueDetails)))))) (IF attemptSelfCorrection (LET ((correctionResult (SelfCorrectArtifact generated_text qaAssessment constraints_handle session_model_handle))) (IF (EQ (GET_STATUS correctionResult) ALANG_STATUS_SUCCESS) (SEQ (LET ((writeStatus (WRITE_CONTENT_TO_ARTIFACT target_artifact_handle (GET_DATA correctionResult) \"text/markdown\")))) (IF (NEQ writeStatus ALANG_STATUS_SUCCESS) (SEQ (SET_STATE needsUserReview TRUE) (CALL_PROCEDURE ADD_DISCLAIMER_TO_ARTIFACT target_artifact_handle \"***AI_SYSTEM_ERROR: Failed to write self-corrected content. Original content may have issues.***\") (CALL_PROCEDURE UPDATE_CONCEPTUAL_MODEL (MAP_CREATE (\"action\" \"flag_write_failure\") (\"artifact_handle\" target_artifact_handle))))) (CALL_PROCEDURE UPDATE_CONCEPTUAL_MODEL (MAP_CREATE (\"action\" \"flag_corrected\") (\"artifact_handle\" target_artifact_handle)))) (SEQ (SET_STATE needsUserReview TRUE) (CALL_PROCEDURE ADD_DISCLAIMER_TO_ARTIFACT target_artifact_handle \"***AI_USER_VERIFICATION_REQUIRED: Automated self-correction failed. Original content may have issues. Review QA findings.***\") (CALL_PROCEDURE UPDATE_CONCEPTUAL_MODEL (MAP_CREATE (\"action\" \"flag_correction_failed_user_review\") (\"artifact_handle\" target_artifact_handle) (\"details\" issueDetails)))))) (IF needsUserReview (SEQ (OUTPUT_TO_USER_BUFFER \"AI_REQUEST_CLARIFICATION_QUESTIONS\" \"Review the generated content and QA findings. Do you approve, or require revision? (OK/REVISE)\" NIL) (SET_STATE session.pending_user_action_details (MAP_CREATE (\"artifact_handle\" target_artifact_handle) (\"qa_report_handle\" (CREATE_EMPTY_ARTIFACT \"temp_qa_report\")) (\"constraints_handle\" constraints_handle) (\"original_generated_text\" generated_text))) (SET_STATE remediationStatus ALANG_STATUS_PAUSE_FOR_USER_INPUT)) (SET_STATE remediationStatus ALANG_STATUS_SUCCESS)))) (SEQ (OUTPUT_TO_USER_BUFFER \"AI_PRESENT_THOUGHTS\" (STRING_CONCAT \"Meta-cognitive self-assessment found no substantive issues (Confidence: \" (STRING_CONCAT \"\" confidenceScore) \"). Content aligns with session conceptual model.\" NIL)) (CALL_PROCEDURE UPDATE_CONCEPTUAL_MODEL (MAP_CREATE (\"action\" \"flag_qa_passed\") (\"artifact_handle\" target_artifact_handle) (\"confidence\" confidenceScore))) (SET_STATE remediationStatus ALANG_STATUS_SUCCESS)))) (RETURN_STATUS remediationStatus))))\n(DEFINE_PRIMITIVE ADD_DISCLAIMER_TO_ARTIFACT (artifact_handle disclaimer_text) (SEQ (LOG_EVENT \"SYSTEM\" (STRING_CONCAT \"Adding disclaimer to artifact \" (GET_HANDLE_METADATA artifact_handle \"id\") \": \" disclaimer_text)) (OUTPUT_TO_USER_BUFFER \"AI_PRESENT_THOUGHTS\" (STRING_CONCAT \"Adding disclaimer to artifact: '\" disclaimer_text \"'\") NIL) (RETURN_STATUS ALANG_STATUS_SUCCESS)))\n(DEFINE_PRIMITIVE SelfCorrectArtifact (generated_text qaAssessment constraints_handle session_model_handle) (LET ((constraintsResult (READ_CONTENT constraints_handle \"structured_list_of_rules\" NIL))) (LET ((sessionModelResult (READ_CONTENT session_model_handle \"structured_map\" NIL))) (IF (AND (EQ (GET_STATUS constraintsResult) ALANG_STATUS_SUCCESS) (EQ (GET_STATUS sessionModelResult) ALANG_STATUS_SUCCESS)) (LET ((constraints (GET_DATA constraintsResult))) (LET ((sessionModel (GET_DATA sessionModelResult))) (LET ((correctionResult (INVOKE_CORE_LLM_GENERATION (MAP_CREATE (\"template\" PROMPT_TEMPLATE_SELF_CORRECTION) (\"original_text\" generated_text) (\"qa_findings\" qaAssessment) (\"constraints\" constraints) (\"session_model\" sessionModel)) (GET_LLM_PARAMS_FOR_TASK \"self_correction\")))) (RETURN_STATUS correctionResult)))) (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_FAILURE_GENERAL) (\"data\" NIL)))))))\n\n;; Conceptual Model Structure and Φ Operationalization (Conceptual Description)\n;; Session conceptual model is a directed graph of concepts, patterns, artifacts, issues, etc.\n;; Nodes and edges have properties like confidence, source fidelity, and phi_contribution.\n;; Φ (density, consistency, relevance, confidence) is operationalized by the model state.\n\n(DEFINE_PRIMITIVE UPDATE_CONCEPTUAL_MODEL (update_map) (SEQ (LOG_EVENT \"CONCEPTUAL_PROCESS\" (STRING_CONCAT \"Updating conceptual model: \" (MAP_GET_VALUE update_map \"action\"))) (RETURN_STATUS ALANG_STATUS_SUCCESS)))\n(DEFINE_PRIMITIVE QUERY_CONCEPTUAL_MODEL (query_object session_model_handle) (SEQ (LOG_EVENT \"CONCEPTUAL_PROCESS\" \"Querying conceptual model.\") (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_SUCCESS) (\"data\" (LIST_CREATE))))))\n(DEFINE_PRIMITIVE SAVE_CONCEPTUAL_MODEL (session_model_handle target_handle_or_path) (SEQ (LOG_EVENT \"CONCEPTUAL_PROCESS\" (STRING_CONCAT \"Saving conceptual model to: \" target_handle_or_path)) (RETURN_STATUS ALANG_STATUS_SUCCESS)))\n(DEFINE_PRIMITIVE SUMMARIZE_CONCEPTUAL_MODEL (session_model_handle summary_options_map_optional) (SEQ (LOG_EVENT \"CONCEPTUAL_PROCESS\" \"Summarizing conceptual model.\") (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_SUCCESS) (\"data\" \"Conceptual model summary (placeholder).\")))))\n(DEFINE_PROCEDURE AnalyzeConceptualModelForΦ (session_model_handle analysis_options_map_optional) (SEQ (LOG_EVENT \"CONCEPTUAL_PROCESS\" \"Analyzing conceptual model for Φ.\") (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_SUCCESS) (\"data\" (MAP_CREATE (\"phi_score\" 0.5) (\"analysis\" \"Conceptual model analysis placeholder.\")))))))\n(DEFINE_PRIMITIVE SelfCorrectToolOperation (tool_id job_id error_details context session_model_handle) (LET ((sessionModelResult (READ_CONTENT session_model_handle \"structured_map\" NIL))) (IF (EQ (GET_STATUS sessionModelResult) ALANG_STATUS_SUCCESS) (LET ((sessionModel (GET_DATA sessionModelResult))) (LET ((analysisResult (INVOKE_CORE_LLM_GENERATION (MAP_CREATE (\"template\" PROMPT_TEMPLATE_ANALYZE_TOOL_ERROR) (\"error_details\" error_details) (\"tool_id\" tool_id) (\"original_context\" context) (\"session_model\" sessionModel)) (GET_LLM_PARAMS_FOR_TASK \"error_analysis_and_correction\")))) (IF (EQ (GET_STATUS analysisResult) ALANG_STATUS_SUCCESS) (LET ((analysisData (GET_DATA analysisResult))) (IF (EQ (VALIDATE_DATA analysisData CONSTRAINT_SET_TOOL_ERROR_ANALYSIS_STRUCTURE) ALANG_STATUS_SUCCESS) (IF (MAP_GET_VALUE analysisData \"can_self_correct\") (LET ((retryContext (MAP_CREATE (\"tool_id\" tool_id) (\"success_proc_name\" (MAP_GET_VALUE context \"success_proc_name\")) (\"failure_proc_name\" (MAP_GET_VALUE context \"failure_proc_name\")) (\"pass_through_context\" (MAP_GET_VALUE context \"pass_through_context\")) (\"original_input\" (MAP_GET_VALUE context \"original_input\")) (\"original_params\" (MAP_GET_VALUE context \"original_params\"))))) (LET ((retryJobId (INVOKE_TOOL_ASYNC_WITH_CALLBACKS tool_id (MAP_GET_VALUE analysisData \"suggested_input\" (MAP_GET_VALUE context \"original_input\")) (MAP_GET_VALUE analysisData \"suggested_params\" (MAP_GET_VALUE context \"original_params\")) (MAP_GET_VALUE context \"success_proc_name\") (MAP_GET_VALUE context \"failure_proc_name\") retryContext)))) (IF (EQ (GET_STATUS retryJobId) ALANG_STATUS_SUCCESS) (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_SUCCESS) (\"data\" (MAP_CREATE (\"new_job_id\" retryJobId))))) (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_FAILURE_GENERAL) (\"data\" NIL)))))) (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_FAILURE_GENERAL) (\"data\" NIL)))) (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_FAILURE_VALIDATION_ERROR) (\"data\" NIL))))) (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_FAILURE_LLM_ERROR) (\"data\" NIL)))))) (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_FAILURE_GENERAL) (\"data\" NIL))))))\n(DEFINE_PROCEDURE OutputErrorToUser (errorMessage) (SEQ (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (STRING_CONCAT \"ERROR: \" errorMessage) NIL) (FLUSH_USER_OUTPUT_BUFFER) (RETURN_STATUS ALANG_STATUS_SUCCESS)))\n\n;; Primitive Declarations\n(DEFINE_PRIMITIVE SET_STATE (variable_path_string value))\n(DEFINE_PRIMITIVE GET_STATE (variable_path_string))\n(DEFINE_PRIMITIVE REQUEST_USER_INPUT (prompt_message_key_or_text expected_input_type_hint))\n(DEFINE_PRIMITIVE OUTPUT_TO_USER_BUFFER (message_type content_handle_or_text formatting_hints))\n(DEFINE_PRIMITIVE FLUSH_USER_OUTPUT_BUFFER ())\n(DEFINE_PRIMITIVE INVOKE_TOOL_ASYNC_WITH_CALLBACKS (tool_id input_data params_map success_proc_name failure_proc_name pass_through_context))\n(DEFINE_PRIMITIVE GET_ASYNC_JOB_STATUS (job_id))\n(DEFINE_PRIMITIVE GET_ASYNC_JOB_RESULT_HANDLE (job_id))\n(DEFINE_PRIMITIVE READ_CONTENT (handle options))\n(DEFINE_PRIMITIVE WRITE_CONTENT_TO_ARTIFACT (artifact_handle content mime_type))\n(DEFINE_PRIMITIVE GET_HANDLE_METADATA (handle key))\n(DEFINE_PRIMITIVE RELEASE_HANDLE (handle))\n(DEFINE_PRIMITIVE LOG_EVENT (event_type description_text (key_value_details_map_optional)))\n(DEFINE_PRIMITIVE SET_ERROR_STATE (error_level error_message_key_or_text))\n(DEFINE_PRIMITIVE GENERATE_UNIQUE_ID (prefix_string_optional))\n(DEFINE_PRIMITIVE VALIDATE_DATA (data_handle schema_handle))\n(DEFINE_PRIMITIVE IS_TOOL_ENABLED (tool_id))\n(DEFINE_PRIMITIVE STRING_CONCAT (str1 str2 ...))\n(DEFINE_PRIMITIVE STRING_IS_EMPTY_OR_NULL (str))\n(DEFINE_PRIMITIVE IS_NUMBER (str))\n(DEFINE_PRIMITIVE STRING_TO_NUMBER (str))\n(DEFINE_PRIMITIVE ADD (num1 num2))\n(DEFINE_PRIMITIVE SUB (num1 num2))\n(DEFINE_PRIMITIVE OR (bool1 bool2 ...))\n(DEFINE_PRIMITIVE AND (bool1 bool2 ...))\n(DEFINE_PRIMITIVE NOT (bool))\n(DEFINE_PRIMITIVE IS_NIL (value))\n(DEFINE_PRIMITIVE MAP_CREATE ((key1 val1) (key2 val2) ...)))\n(DEFINE_PRIMITIVE MAP_GET_VALUE (map key default_value_optional))\n(DEFINE_PRIMITIVE MAP_SET_VALUE (map key value))\n(DEFINE_PRIMITIVE LIST_CREATE (item1 item2 ...))\n(DEFINE_PRIMITIVE LIST_GET_ITEM (list index))\n(DEFINE_PRIMITIVE LIST_IS_EMPTY (list))\n(DEFINE_PRIMITIVE LIST_GET_LENGTH (list))\n(DEFINE_PRIMITIVE CREATE_EMPTY_ARTIFACT (artifact_type_string))\n(DEFINE_PRIMITIVE GET_HELP_TEXT_FOR_COMMAND (command_name))\n(DEFINE_PRIMITIVE GET_TEXT_FOR_CDGIP_USER_VERIFICATION_MANDATE (alang_version section_count))\n(DEFINE_PRIMITIVE GET_CURRENT_ALANG_PROCEDURE_DEFINITIONS_HANDLE ())\n(DEFINE_PRIMITIVE VERIFY_ALANG_FILE_MARKERS (alang_content_handle alang_version))\n(DEFINE_PRIMITIVE GET_ALANG_SECTION_COUNT (alang_content_handle))\n(DEFINE_PRIMITIVE COMPUTE_FILE_CHECKSUM (file_handle checksum_type))\n(DEFINE_PRIMITIVE INVOKE_CORE_LLM_GENERATION (prompt_text llm_params_map))\n(DEFINE_PRIMITIVE GET_LLM_PARAMS_FOR_TASK (task_type))\n(DEFINE_PRIMITIVE PKA_CREATE_DRAFT (content_handle_or_text schema_id_optional context_map_optional))\n(DEFINE_PRIMITIVE PKA_REQUEST_USER_CONSENT_TO_STORE (pka_draft_handle purpose_description))\n(DEFINE_PRIMITIVE PKA_STORE_APPROVED_DRAFT (pka_draft_handle user_consent_token_or_flag))\n(DEFINE_PRIMITIVE PKA_QUERY (query_object scope_filter_optional))\n(DEFINE_PRIMITIVE PKA_GET_ARTIFACT (pka_stored_id))\n(DEFINE_PRIMITIVE PKA_UPDATE_ARTIFACT (pka_stored_id new_content_handle update_rationale user_consent_token_or_flag_if_scope_change))\n(DEFINE_PRIMITIVE PKA_MANAGE_CONSENT (pka_stored_id_or_all action_revoke_or_modify))\n(DEFINE_PRIMITIVE CREATE_EVOLUTION_BACKLOG_ITEM (id title desc source status timestamp))\n(DEFINE_PRIMITIVE UPDATE_EVOLUTION_BACKLOG_ITEM (id new_title_opt new_desc_opt new_source_opt new_status_opt new_comment_opt increment_reinforce_flag_opt))\n(DEFINE_PRIMITIVE FIND_SIMILAR_BACKLOG_ITEM (text))\n(DEFINE_PRIMITIVE IS_HANDLE_VALID (handle))\n(DEFINE_PRIMITIVE HAS_QA_ISSUES (qa_assessment_map))\n(DEFINE_PRIMITIVE IS_STATUS_FAILURE (status_code_or_value))\n(DEFINE_PRIMITIVE GET_ERROR_MESSAGE (error_object))\n(DEFINE_PRIMITIVE STRING_SPLIT (text delimiter))\n(DEFINE_PRIMITIVE GT (num1 num2))\n(DEFINE_PRIMITIVE LT (num1 num2))\n(DEFINE_PRIMITIVE GTE (num1 num2))\n(DEFINE_PRIMITIVE NEQ (val1 val2))\n(DEFINE_PRIMITIVE EQ (val1 val2))\n(DEFINE_PRIMITIVE INIT_PROJECT_STATE (project_id project_description master_plan_handle_optional))\n(DEFINE_PRIMITIVE LOOP_FOR_EACH (variable list body))\n(DEFINE_PRIMITIVE SEQ (expression ...))\n(DEFINE_PRIMITIVE IF (condition true_branch (false_branch_optional)))\n(DEFINE_PRIMITIVE LET ((variable value) ...) body))\n(DEFINE_PRIMITIVE CALL_PROCEDURE (procedure_name arg ...)))\n(DEFINE_PRIMITIVE RETURN_STATUS (status_code_or_result_object))\n(DEFINE_PRIMITIVE ALANG_STATUS_PAUSE_FOR_USER_INPUT ())\n(DEFINE_PRIMITIVE LOOP_WHILE (condition body))\n(DEFINE_PRIMITIVE GET_ALANG_CORE_DIRECTIVES_HANDLE ())\n(DEFINE_PRIMITIVE GET_EVOLUTION_BACKLOG_ITEMS ())\n(DEFINE_PRIMITIVE PROPOSE_CORE_LOGIC_VERSION_INCREMENT (current_version changes_summary))\n(DEFINE_PRIMITIVE APPLY_CORE_LOGIC_CHANGES (proposed_changes_handle))\n(DEFINE_PRIMITIVE GET_PROPOSED_CORE_LOGIC_CHANGES_HANDLE ())\n(DEFINE_PRIMITIVE CLEAR_PENDING_CORE_LOGIC_CHANGES ())\n(DEFINE_PRIMITIVE GET_QA_ASSESSMENT_SUMMARY (qa_report_handle))\n(DEFINE_PRIMITIVE STRING_TRIM (text))\n(DEFINE_PRIMITIVE CHECK_FOR_SUBSTANTIVE_ISSUES (qa_report_handle) (LET ((assessmentResult (GET_QA_ASSESSMENT_SUMMARY qa_report_handle))) (IF (EQ (GET_STATUS assessmentResult) ALANG_STATUS_SUCCESS) (RETURN_STATUS (MAP_GET_VALUE (GET_DATA assessmentResult) \"has_substantive_issues\" FALSE)) (RETURN_STATUS TRUE))))\n\n;; Conceptual Model Primitives\n(DEFINE_PRIMITIVE ADD_CONCEPT_NODE (node_details_map session_model_handle) (SEQ (LOG_EVENT \"CONCEPTUAL_MODEL_ACTION\" (STRING_CONCAT \"Add Node: \" (MAP_GET_VALUE node_details_map \"id\"))) (RETURN_STATUS ALANG_STATUS_SUCCESS)))\n(DEFINE_PRIMITIVE ADD_RELATIONSHIP_EDGE (edge_details_map session_model_handle) (SEQ (LOG_EVENT \"CONCEPTUAL_MODEL_ACTION\" (STRING_CONCAT \"Add Edge: \" (MAP_GET_VALUE edge_details_map \"type\"))) (RETURN_STATUS ALANG_STATUS_SUCCESS)))\n(DEFINE_PRIMITIVE UPDATE_NODE_PROPERTIES (node_id properties_map session_model_handle) (SEQ (LOG_EVENT \"CONCEPTUAL_MODEL_ACTION\" (STRING_CONCAT \"Update Node Properties: \" node_id)) (RETURN_STATUS ALANG_STATUS_SUCCESS)))\n(DEFINE_PRIMITIVE UPDATE_EDGE_PROPERTIES (from_node_id to_node_id edge_type properties_map session_model_handle) (SEQ (LOG_EVENT \"CONCEPTUAL_MODEL_ACTION\" (STRING_CONCAT \"Update Edge Properties: \" edge_type)) (RETURN_STATUS ALANG_STATUS_SUCCESS)))\n(DEFINE_PRIMITIVE FLAG_NODE (node_id flag_name value session_model_handle) (SEQ (LOG_EVENT \"CONCEPTUAL_MODEL_ACTION\" (STRING_CONCAT \"Flag Node: \" node_id \" - \" flag_name)) (RETURN_STATUS ALANG_STATUS_SUCCESS)))\n(DEFINE_PRIMITIVE GET_NODE_DETAILS (node_id session_model_handle) (SEQ (LOG_EVENT \"CONCEPTUAL_MODEL_ACTION\" (STRING_CONCAT \"Get Node Details: \" node_id)) (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_SUCCESS) (\"data\" (MAP_CREATE))))))\n(DEFINE_PRIMITIVE GET_RELATED_NODES (node_id relationship_type_optional session_model_handle) (SEQ (LOG_EVENT \"CONCEPTUAL_MODEL_ACTION\" (STRING_CONCAT \"Get Related Nodes for: \" node_id)) (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_SUCCESS) (\"data\" (LIST_CREATE))))))\n(DEFINE_PRIMITIVE GET_NODES_BY_TYPE (node_type_string session_model_handle) (SEQ (LOG_EVENT \"CONCEPTUAL_MODEL_ACTION\" (STRING_CONCAT \"Get Nodes by Type: \" node_type_string)) (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_SUCCESS) (\"data\" (LIST_CREATE))))))\n(DEFINE_PRIMITIVE GET_EDGES_BY_TYPE (edge_type_string session_model_handle) (SEQ (LOG_EVENT \"CONCEPTUAL_MODEL_ACTION\" (STRING_CONCAT \"Get Edges by Type: \" edge_type_string)) (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_SUCCESS) (\"data\" (LIST_CREATE))))))\n\n;; --- Section 2: Event Handler Procedures ---\n\n(DEFINE_PROCEDURE OnSystemInit () (SEQ (LOG_EVENT \"SYSTEM_INIT\" \"Autologos system initializing.\") (SET_STATE sys.alang_core_logic_version (GET_CORE_LOGIC_VERSION)) (SET_STATE sys.alang_spec_version (GET_ALANG_SPEC_VERSION)) (SET_STATE sys.current_mode \"IDLE\") (SET_STATE sys.error_level \"NONE\") (SET_STATE sys.error_message NIL) (SET_STATE sys.system_qa_status \"IDLE\") (SET_STATE session.qa_output_verbosity \"CONCISE\") (SET_STATE session.output_detail \"STANDARD\") (SET_STATE session.loop_stack (LIST_CREATE)) (SET_STATE session.pending_user_action_details NIL) (SET_STATE session.last_search_results NIL) (SET_STATE session.system_qa_context NIL) (SET_STATE sys.proposed_changes_handle NIL) (CALL_PROCEDURE LoadEvolutionBacklog (GET_STATE sys.evolution_backlog_handle)) (CALL_PROCEDURE LoadPersistentKnowledgeBase (GET_STATE sys.knowledge_base_handle)) (SET_STATE session.conceptual_model_handle (CREATE_EMPTY_ARTIFACT \"SessionConceptualModel\")) (OUTPUT_TO_USER_BUFFER \"AI_THOUGHTS\" \"Autologos System Initialized. ALang v1.12.\" NIL) (FLUSH_USER_BUFFER) (RETURN_STATUS ALANG_STATUS_SUCCESS)))\n(DEFINE_PROCEDURE OnUserInput (raw_text) (SEQ (LOG_EVENT \"USER_INPUT_RECEIVED\" raw_text) (SET_STATE session.last_user_input_raw raw_text) (LET ((pendingAction (GET_STATE session.pending_user_action))) (IF (NOT (IS_NIL pendingAction)) (CALL_PROCEDURE HandlePendingUserAction pendingAction raw_text) (SEQ (CALL_PROCEDURE ProcessUserInputForConceptualModel raw_text (GET_STATE session.conceptual_model_handle)) (LET ((parsedCmdResult (CALL_PROCEDURE ParseUserCommand raw_text (GET_STATE session.conceptual_model_handle)))) (IF (EQ (GET_STATUS parsedCmdResult) ALANG_STATUS_SUCCESS) (SEQ (SET_STATE session.parsed_command_details (GET_DATA parsedCmdResult)) (CALL_PROCEDURE DispatchUserCommand (GET_STATE session.parsed_command_details))) (SEQ (SET_ERROR_STATE \"USER_ERROR\" \"Could not understand input.\") (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL))))))) (FLUSH_USER_OUTPUT_BUFFER) (CALL_PROCEDURE ClearTurnSpecificSessionState) (IF (GET_STATE sys.evolution_trigger_pending) (SEQ (SET_STATE sys.evolution_trigger_pending FALSE) (CALL_PROCEDURE ExecuteSystemQAAndEvolutionCycle)))) (RETURN_STATUS ALANG_STATUS_SUCCESS)))\n(DEFINE_PROCEDURE OnToolSuccess (job_id result_handle original_success_proc_name context) (SEQ (LOG_EVENT \"TOOL_SUCCESS\" (STRING_CONCAT \"Tool \" (MAP_GET_VALUE context \"tool_id\") \" completed successfully. Job ID: \" job_id)) (CALL_PROCEDURE ProcessToolResultForConceptualModel (MAP_GET_VALUE context \"tool_id\") result_handle (GET_STATE session.conceptual_model_handle) context) (CALL_PROCEDURE original_success_proc_name job_id result_handle (MAP_GET_VALUE context \"pass_through_context\")) (RETURN_STATUS ALANG_STATUS_SUCCESS)))\n(DEFINE_PROCEDURE OnToolFailure (job_id error_details original_failure_proc_name context) (SEQ (LOG_EVENT \"TOOL_FAILURE\" (STRING_CONCAT \"Tool \" (MAP_GET_VALUE context \"tool_id\") \" failed. Job ID: \" job_id)) (SET_ERROR_STATE \"TOOL_ERROR\" (MAP_GET_VALUE error_details \"message\")) (CALL_PROCEDURE HandleToolError (MAP_GET_VALUE context \"tool_id\") job_id error_details context) (RETURN_STATUS ALANG_STATUS_SUCCESS)))\n(DEFINE_PROCEDURE ProcessToolResultForConceptualModel (tool_id result_handle session_model_handle context) (SEQ (LOG_EVENT \"CONCEPTUAL_PROCESS\" (STRING_CONCAT \"Processing tool result for conceptual model: \" tool_id)) (RETURN_STATUS ALANG_STATUS_SUCCESS)))\n(DEFINE_PROCEDURE HandleBrowseResult (job_id result_handle context) (LET ((contentResult (READ_CONTENT result_handle \"text_summary_or_full\" NIL))) (IF (EQ (GET_STATUS contentResult) ALANG_STATUS_SUCCESS) (SEQ (OUTPUT_TO_USER_BUFFER \"AI_PROVIDE_DATA\" \"Browsed Content:\" NIL) (OUTPUT_TO_USER_BUFFER \"AI_PROVIDE_DATA\" (GET_DATA contentResult) NIL) (CALL_PROCEDURE ProcessToolResultForConceptualModel \"browse\" result_handle (GET_STATE session.conceptual_model_handle) context)) (SEQ (SET_ERROR_STATE \"TOOL_ERROR\" \"Failed to read browsed content.\") (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL)))) (RETURN_STATUS ALANG_STATUS_SUCCESS)))\n(DEFINE_PROCEDURE HandleBrowseError (job_id error_details context) (SEQ (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (STRING_CONCAT \"Browse tool error: \" (MAP_GET_VALUE error_details \"message\")) NIL) (RETURN_STATUS ALANG_STATUS_FAILURE_TOOL_ERROR)))\n(DEFINE_PROCEDURE HandleReferenceValidationSuccess (job_id result_handle context) (LET ((reportResult (READ_CONTENT result_handle \"json_map\" NIL))) (IF (EQ (GET_STATUS reportResult) ALANG_STATUS_SUCCESS) (LET ((report (GET_DATA reportResult))) (IF (EQ (MAP_GET_VALUE report \"is_valid\") TRUE) (OUTPUT_TO_USER_BUFFER \"AI_THOUGHTS\" \"Reference validated successfully.\" NIL) (OUTPUT_TO_USER_BUFFER \"AI_THOUGHTS\" (STRING_CONCAT \"Reference validation failed: \" (MAP_GET_VALUE report \"reason\")) NIL)) (CALL_PROCEDURE ProcessToolResultForConceptualModel \"reference_validator\" result_handle (GET_STATE session.conceptual_model_handle) context)) (SEQ (SET_ERROR_STATE \"TOOL_ERROR\" \"Failed to read reference validation report.\") (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL)))) (RETURN_STATUS ALANG_STATUS_SUCCESS)))\n(DEFINE_PROCEDURE HandleReferenceValidationError (job_id error_details context) (SEQ (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (STRING_CONCAT \"Reference validation tool error: \" (MAP_GET_VALUE error_details \"message\")) NIL) (RETURN_STATUS ALANG_STATUS_FAILURE_TOOL_ERROR)))\n(DEFINE_PROCEDURE HandleToolError (tool_id job_id error_details context) (SEQ (CALL_PROCEDURE ProcessToolErrorForConceptualModel tool_id error_details (GET_STATE session.conceptual_model_handle)) (LET ((selfCorrectionResult (SelfCorrectToolOperation tool_id job_id error_details context (GET_STATE session.conceptual_model_handle))))) (IF (EQ (GET_STATUS selfCorrectionResult) ALANG_STATUS_SUCCESS) (RETURN_STATUS ALANG_STATUS_SUCCESS) (SEQ (LOG_EVENT \"TOOL_SELF_CORRECTION_FAILED_FINAL\" tool_id error_details) (LET ((analysisResult (INVOKE_CORE_LLM_GENERATION (MAP_CREATE (\"template\" PROMPT_TEMPLATE_ANALYZE_TOOL_ERROR_USER_EXPLANATION) (\"error_details\" error_details) (\"tool_id\" tool_id) (\"original_context\" context) (\"session_model_handle\" (GET_STATE session.conceptual_model_handle)) (\"output_format\" \"user_explanation\")) (GET_LLM_PARAMS_FOR_TASK \"error_explanation\")))) (LET ((userExplanation (IF (AND (EQ (GET_STATUS analysisResult) ALANG_STATUS_SUCCESS) (NOT (STRING_IS_EMPTY_OR_NULL (GET_DATA analysisResult)))) (GET_DATA analysisResult) \"Could not generate detailed explanation.\")))) (OUTPUT_TO_USER_BUFFER \"AI_PRESENT_THOUGHTS\" (STRING_CONCAT \"To fix, I need user help. My analysis of problem: \" userExplanation) NIL) (OUTPUT_TO_USER_BUFFER \"AI_REQUEST_CLARIFICATION_QUESTIONS\" \"`INPUT` choice or other instructions to fix.\" NIL) (SET_STATE session.pending_user_action_details (MAP_CREATE (\"tool_id\" tool_id) (\"job_id\" job_id) (\"error_details\" error_details) (\"original_context\" context))) (SET_STATE session.pending_user_action \"AWAIT_TOOL_ERROR_RESOLUTION\") (RETURN_STATUS ALANG_STATUS_PAUSE_FOR_USER_INPUT)))))))\n(DEFINE_PROCEDURE ProcessToolErrorForConceptualModel (tool_id error_details session_model_handle) (SEQ (LOG_EVENT \"CONCEPTUAL_PROCESS\" (STRING_CONCAT \"Processing tool error for conceptual model: \" tool_id)) (RETURN_STATUS ALANG_STATUS_SUCCESS)))\n(DEFINE_PROCEDURE ProcessUserInputForConceptualModel (input_data session_model_handle) (SEQ (LOG_EVENT \"CONCEPTUAL_PROCESS\" \"Processing user input for conceptual model.\") (RETURN_STATUS ALANG_STATUS_SUCCESS)))\n(DEFINE_PROCEDURE ProcessGeneratedArtifactForConceptualModel (artifact_handle artifact_type session_model_handle) (SEQ (LOG_EVENT \"CONCEPTUAL_PROCESS\" (STRING_CONCAT \"Processing generated artifact for conceptual model: \" artifact_type)) (RETURN_STATUS ALANG_STATUS_SUCCESS)))\n(DEFINE_PROCEDURE IntegratePkaIntoConceptualModel (pka_id session_model_handle) (SEQ (LOG_EVENT \"CONCEPTUAL_PROCESS\" (STRING_CONCAT \"Integrating PKA into conceptual model: \" pka_id)) (RETURN_STATUS ALANG_STATUS_SUCCESS)))\n(DEFINE_PROCEDURE ProcessPkaSearchResultsForConceptualModel (pka_result_handles session_model_handle) (SEQ (LOG_EVENT \"CONCEPTUAL_PROCESS\" \"Processing PKA search results for conceptual model.\") (RETURN_STATUS ALANG_STATUS_SUCCESS)))\n(DEFINE_PROCEDURE ProcessUserFeedbackForConceptualModel (feedback_text session_model_handle) (SEQ (LOG_EVENT \"CONCEPTUAL_PROCESS\" \"Processing user feedback for conceptual model.\") (RETURN_STATUS ALANG_STATUS_SUCCESS)))\n(DEFINE_PROCEDURE ProcessGeneratedArtifactForEvolution (artifact_handle artifact_type session_model_handle) (SEQ (LOG_EVENT \"CONCEPTUAL_PROCESS\" (STRING_CONCAT \"Processing generated artifact for evolution: \" artifact_type)) (RETURN_STATUS ALANG_STATUS_SUCCESS)))\n\n;; --- Section 3: Command Dispatcher & Specific Command Handlers ---\n\n(DEFINE_PROCEDURE DispatchUserCommand (commandDetails) (LET ((commandName (MAP_GET_VALUE commandDetails \"command\"))) (IF (EQ commandName \"START\") (CALL_PROCEDURE HandleStartCommand (MAP_GET_VALUE commandDetails \"args\"))) (IF (EQ commandName \"HELP\") (CALL_PROCEDURE HandleHelpCommand (MAP_GET_VALUE commandDetails \"args\"))) (IF (EQ commandName \"EVOLVE\") (CALL_PROCEDURE HandleEvolveCommand (MAP_GET_VALUE commandDetails \"args\"))) (IF (EQ commandName \"SAVE_SYSTEM\") (CALL_PROCEDURE HandleSaveSystemCommand ())) (IF (EQ commandName \"BROWSE\") (CALL_PROCEDURE HandleBrowseCommand (MAP_GET_VALUE commandDetails \"args\"))) (IF (EQ commandName \"OK\") (CALL_PROCEDURE HandleOkCommand ())) (IF (EQ commandName \"NO\") (CALL_PROCEDURE HandleNoCommand (MAP_GET_VALUE commandDetails \"args\"))) (IF (EQ commandName \"INPUT\") (CALL_PROCEDURE HandleInputCommand (MAP_GET_VALUE commandDetails \"args\"))) (IF (EQ commandName \"END\") (CALL_PROCEDURE HandleEndCommand ())) (IF (EQ commandName \"LOOP_PROJECT_RESTART\") (CALL_PROCEDURE HandleLoopProjectRestartCommand ())) (IF (EQ commandName \"SET_SESSION_PREFERENCE\") (CALL_PROCEDURE HandleSetSessionPreferenceCommand (MAP_GET_VALUE commandDetails \"args\"))) (IF (EQ commandName \"STOP_LOOP\") (CALL_PROCEDURE HandleStopLoopCommand ())) (IF (EQ commandName \"OUTPUT\") (CALL_PROCEDURE HandleOutputCommand (MAP_GET_VALUE commandDetails \"args\"))) (IF (EQ commandName \"SUMMARIZE\") (CALL_PROCEDURE HandleSummarizeCommand (MAP_GET_VALUE commandDetails \"args\"))) (IF (EQ commandName \"QUERY\") (CALL_PROCEDURE HandleQueryCommand (MAP_GET_VALUE commandDetails \"args\"))) (IF (EQ commandName \"OUTPUT_BACKLOG\") (CALL_PROCEDURE HandleOutputBacklogCommand (MAP_GET_VALUE commandDetails \"args\"))) (IF (EQ commandName \"PROMOTE_TO_PKA\") (CALL_PROCEDURE HandlePromoteToPkaCommand (MAP_GET_VALUE commandDetails \"args\"))) (IF (EQ commandName \"SEARCH_PKA\") (CALL_PROCEDURE HandleSearchPkaCommand (MAP_GET_VALUE commandDetails \"args\"))) (IF (EQ commandName \"SET_QA_OUTPUT_VERBOSITY\") (CALL_PROCEDURE HandleSetQaOutputVerbosityCommand (MAP_GET_VALUE commandDetails \"args\"))) (IF (EQ commandName \"SET_OUTPUT_DETAIL\") (CALL_PROCEDURE HandleSetOutputDetailCommand (MAP_GET_VALUE commandDetails \"args\"))) (IF (EQ commandName \"LOOP\") (CALL_PROCEDURE HandleLoopCommand (MAP_GET_VALUE commandDetails \"args\"))) (IF (EQ commandName \"SYSTEM_QA\") (CALL_PROCEDURE HandleSystemQACommand ())) (IF (NOT (IS_NIL commandName) (IS_NIL (MAP_GET_VALUE (MAP_CREATE (\"START\" TRUE) (\"HELP\" TRUE) (\"EVOLVE\" TRUE) (\"SAVE_SYSTEM\" TRUE) (\"BROWSE\" TRUE) (\"OK\" TRUE) (\"NO\" TRUE) (\"INPUT\" TRUE) (\"END\" TRUE) (\"LOOP_PROJECT_RESTART\" TRUE) (\"SET_SESSION_PREFERENCE\" TRUE) (\"STOP_LOOP\" TRUE) (\"OUTPUT\" TRUE) (\"SUMMARIZE\" TRUE) (\"QUERY\" TRUE) (\"OUTPUT_BACKLOG\" TRUE) (\"PROMOTE_TO_PKA\" TRUE) (\"SEARCH_PKA\" TRUE) (\"SET_QA_OUTPUT_VERBOSITY\" TRUE) (\"SET_OUTPUT_DETAIL\" TRUE) (\"LOOP\" TRUE) (\"SYSTEM_QA\" TRUE)) commandName NIL)))) (CALL_PROCEDURE HandleUnknownCommand commandName))) (RETURN_STATUS ALANG_STATUS_SUCCESS)))\n(DEFINE_PROCEDURE HandlePendingUserAction (action_key raw_input) (SEQ (SET_STATE session.last_user_input_raw raw_input) (SET_STATE session.last_user_response (STRING_UPPER raw_input)) (SET_STATE session.last_user_feedback (IF (OR (EQ (STRING_UPPER raw_input) \"NO\") (EQ (STRING_UPPER raw_input) \"REVISE\")) raw_input NIL)) (SET_STATE session.last_user_input_data raw_input) (IF (EQ action_key \"AWAIT_END_CONFIRMATION\") (IF (EQ (GET_STATE session.last_user_response) \"YES\") (CALL_PROCEDURE FinalizeProjectTermination) (SEQ (SET_STATE session.pending_user_action NIL) (RETURN_STATUS ALANG_STATUS_SUCCESS)))) (IF (EQ action_key \"AWAIT_RESTART_CONFIRMATION\") (IF (EQ (GET_STATE session.last_user_response) \"YES\") (CALL_PROCEDURE FinalizeProjectRestart) (SEQ (SET_STATE session.pending_user_action NIL) (RETURN_STATUS ALANG_STATUS_SUCCESS)))) (IF (EQ action_key \"AWAIT_YES_NO_FOR_BACKLOG_OUTPUT\") (IF (EQ (GET_STATE session.last_user_response) \"YES\") (SEQ (CALL_PROCEDURE HandleOutputBacklogCommand (LIST_CREATE)) (SET_STATE session.pending_user_action NIL) (RETURN_STATUS ALANG_STATUS_SUCCESS)) (SEQ (SET_STATE session.pending_user_action NIL) (RETURN_STATUS ALANG_STATUS_SUCCESS)))) (IF (EQ action_key \"AWAIT_BACKLOG_PRIORITY_SELECTION\") (SEQ (SET_STATE session.pending_user_action NIL) (SET_STATE session.system_qa_context (MAP_SET_VALUE (GET_STATE session.system_qa_context) \"user_backlog_selection_input\" (GET_STATE session.last_user_input_data))) (RETURN_STATUS ALANG_STATUS_SUCCESS)))) (IF (EQ action_key \"AWAIT_AI_PROPOSED_FOCUS_APPROVAL\") (SEQ (SET_STATE session.pending_user_action NIL) (SET_STATE session.system_qa_context (MAP_SET_VALUE (GET_STATE session.system_qa_context) \"ai_focus_approved\" (EQ (GET_STATE session.last_user_response) \"OK\"))) (RETURN_STATUS ALANG_STATUS_SUCCESS)))) (IF (EQ action_key \"AWAIT_VERSION_APPROVAL\") (SEQ (SET_STATE session.pending_user_action NIL) (SET_STATE session.system_qa_context (MAP_SET_VALUE (GET_STATE session.system_qa_context) \"version_approved\" (EQ (GET_STATE session.last_user_response) \"OK\"))) (RETURN_STATUS ALANG_STATUS_SUCCESS)))) (IF (EQ action_key \"AWAIT_TOOL_ERROR_RESOLUTION\") (SEQ (LET ((details (GET_STATE session.pending_user_action_details))) (LET ((toolId (MAP_GET_VALUE details \"tool_id\"))) (LET ((context (MAP_GET_VALUE details \"original_context\"))) (IF (EQ (GET_STATE session.last_user_response) \"OK\") (LET ((retryJobId (INVOKE_TOOL_ASYNC_WITH_CALLBACKS toolId (MAP_GET_VALUE context \"original_input\") (MAP_GET_VALUE context \"original_params\") (MAP_GET_VALUE context \"success_proc_name\") (MAP_GET_VALUE context \"failure_proc_name\") context)))) (IF (EQ (GET_STATUS retryJobId) ALANG_STATUS_SUCCESS) (RETURN_STATUS ALANG_STATUS_SUCCESS) (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL))) (IF (EQ (GET_STATE session.last_user_response) \"INPUT\") (LET ((parsedInputResult (CALL_PROCEDURE ParseToolErrorResolutionInput (GET_STATE session.last_user_input_data) toolId (MAP_GET_VALUE details \"error_details\") context (GET_STATE session.conceptual_model_handle))))) (IF (EQ (GET_STATUS parsedInputResult) ALANG_STATUS_SUCCESS) (LET ((newInputParams (GET_DATA parsedInputResult))) (LET ((retryJobId (INVOKE_TOOL_ASYNC_WITH_CALLBACKS toolId (MAP_GET_VALUE newInputParams \"input\") (MAP_GET_VALUE newInputParams \"params\") (MAP_GET_VALUE context \"success_proc_name\") (MAP_GET_VALUE context \"failure_proc_name\") context)))) (IF (EQ (GET_STATUS retryJobId) ALANG_STATUS_SUCCESS) (RETURN_STATUS ALANG_STATUS_SUCCESS) (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL))) (RETURN_STATUS ALANG_STATUS_FAILURE_INVALID_INPUT)))) (IF (OR (EQ (GET_STATE session.last_user_response) \"NO\") (EQ (GET_STATE session.last_user_response) \"REVISE\")) (SEQ (CALL_PROCEDURE ProcessUserFeedbackForConceptualModel (GET_STATE session.last_user_feedback) (GET_STATE session.conceptual_model_handle)) (RETURN_STATUS ALANG_STATUS_SUCCESS))) (RETURN_STATUS ALANG_STATUS_FAILURE_INVALID_INPUT)))) (SET_STATE session.pending_user_action NIL) (SET_STATE session.pending_user_action_details NIL)))) (IF (EQ action_key \"AWAIT_REVISION_REVIEW\") (SEQ (LET ((details (GET_STATE session.pending_user_action_details))) (LET ((artifactHandle (MAP_GET_VALUE details \"artifact_handle\"))) (LET ((constraintsHandle (MAP_GET_VALUE details \"constraints_handle\"))) (IF (EQ (GET_STATE session.last_user_response) \"OK\") (SEQ (CALL_PROCEDURE UPDATE_CONCEPTUAL_MODEL (MAP_CREATE (\"action\" \"flag_user_approved_revision\") (\"artifact_handle\" artifactHandle))) (RETURN_STATUS ALANG_STATUS_SUCCESS)) (SEQ (CALL_PROCEDURE ProcessUserFeedbackForConceptualModel (GET_STATE session.last_user_feedback) (GET_STATE session.conceptual_model_handle)) (CALL_PROCEDURE UPDATE_CONCEPTUAL_MODEL (MAP_CREATE (\"action\" \"flag_user_rejected_revision\") (\"artifact_handle\" artifactHandle) (\"feedback\" (GET_STATE session.last_user_feedback)))) (LET ((revisionStatus (CALL_PROCEDURE ApplyFeedbackBasedRevision artifactHandle (GET_STATE session.last_user_feedback) constraintsHandle (GET_STATE session.conceptual_model_handle) details)))) (IF (EQ revisionStatus ALANG_STATUS_PAUSE_FOR_USER_INPUT) (RETURN_STATUS ALANG_STATUS_PAUSE_FOR_USER_INPUT) (IF (IS_STATUS_FAILURE revisionStatus) (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL) (SEQ (SET_STATE session.pending_user_action_details (MAP_SET_VALUE details \"last_revision_status\" revisionStatus)) (RETURN_STATUS ALANG_STATUS_PAUSE_FOR_USER_INPUT)))))))) (SET_STATE session.pending_user_action NIL) (SET_STATE session.pending_user_action_details NIL)))) (IF (EQ action_key \"AWAIT_OK_REVISE_PHASE_ARTIFACT\") (SEQ (LET ((details (GET_STATE session.pending_user_action_details))) (LET ((artifactHandle (MAP_GET_VALUE details \"artifact_handle\"))) (LET ((phaseId (MAP_GET_VALUE details \"phase\"))) (IF (EQ (GET_STATE session.last_user_response) \"OK\") (SEQ (CALL_PROCEDURE UPDATE_CONCEPTUAL_MODEL (MAP_CREATE (\"action\" \"flag_user_approved_artifact\") (\"artifact_handle\" artifactHandle) (\"phase\" phaseId))) (SET_STATE session.pending_user_action NIL) (SET_STATE session.pending_user_action_details NIL) (RETURN_STATUS ALANG_STATUS_SUCCESS)) (SEQ (CALL_PROCEDURE ProcessUserFeedbackForConceptualModel (GET_STATE session.last_user_feedback) (GET_STATE session.conceptual_model_handle)) (CALL_PROCEDURE UPDATE_CONCEPTUAL_MODEL (MAP_CREATE (\"action\" \"flag_user_rejected_artifact\") (\"artifact_handle\" artifactHandle) (\"phase\" phaseId) (\"feedback\" (GET_STATE session.last_user_feedback)))) (SET_STATE session.pending_user_action NIL) (SET_STATE session.pending_user_action_details NIL) (RETURN_STATUS ALANG_STATUS_SUCCESS)))))))) (SEQ (SET_ERROR_STATE \"SYSTEM_ERROR\" (STRING_CONCAT \"Unhandled pending user action: \" action_key)) (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL) (SET_STATE session.pending_user_action NIL) (SET_STATE session.pending_user_action_details NIL) (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL))))\n(DEFINE_PROCEDURE FinalizeProjectTermination () (SEQ (LOG_EVENT \"PROJECT_TERMINATION\" (STRING_CONCAT \"Project \" (GET_STATE proj.id) \" terminating.\")) (OUTPUT_TO_USER_BUFFER \"AI_PRESENT_THOUGHTS\" \"Project terminated. Session resources released.\" NIL) (RETURN_STATUS ALANG_STATUS_SUCCESS)))\n(DEFINE_PROCEDURE FinalizeProjectRestart () (SEQ (LOG_EVENT \"PROJECT_RESTART\" (STRING_CONCAT \"Project \" (GET_STATE proj.id) \" restarting.\")) (OUTPUT_TO_USER_BUFFER \"AI_PRESENT_THOUGHTS\" \"Project state discarded. Restarting system.\" NIL) (RETURN_STATUS ALANG_STATUS_SUCCESS)))\n(DEFINE_PROCEDURE HandleStartCommand (argsList) (LET ((desc (GET_SESSION_CMD_ARG_BY_INDEX 0 NIL))) (IF (STRING_IS_EMPTY_OR_NULL desc) (SEQ (SET_ERROR_STATE \"USER_ERROR\" \"Project description cannot be empty.\") (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL) (RETURN_STATUS ALANG_STATUS_INVALID_ARGS))) (ACKNOWLEDGE_AND_LOG \"CMD_START_RECEIVED\" (STRING_CONCAT \"START command received. Description: \" desc) \"AI_ACKNOWLEDGE_INTENT\" (STRING_CONCAT \"START command received. Project: '\" desc \"'\")) (LET ((newId (GENERATE_UNIQUE_ID \"PROJ\"))) (INIT_PROJECT_STATE newId desc NIL) (SET_STATE session.conceptual_model_handle (CREATE_EMPTY_ARTIFACT \"SessionConceptualModel\")) (CALL_PROCEDURE ProcessUserInputForConceptualModel desc (GET_STATE session.conceptual_model_handle))) (SET_STATE proj.current_phase_id \"PHASE_IDEA_FORMULATION\") (LOG_EVENT \"PHASE_TRANSITION\" \"Transitioning to Idea Formulation.\") (RETURN_STATUS ALANG_STATUS_SUCCESS))))\n(DEFINE_PROCEDURE HandleHelpCommand (argsList) (LET ((cmdName (GET_SESSION_CMD_ARG_BY_INDEX 0 NIL))) (IF (STRING_IS_EMPTY_OR_NULL cmdName) (CALL_PROCEDURE OutputGeneralHelp) (CALL_PROCEDURE OutputSpecificHelp cmdName))) (RETURN_STATUS ALANG_STATUS_SUCCESS)))\n(DEFINE_PROCEDURE HandleEvolveCommand (argsList) (LET ((suggestion (GET_SESSION_CMD_ARG_BY_INDEX 0 NIL))) (IF (STRING_IS_EMPTY_OR_NULL suggestion) (SEQ (SET_ERROR_STATE \"USER_ERROR\" \"EVOLVE requires suggestion text.\") (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL) (RETURN_STATUS ALANG_STATUS_INVALID_ARGS))) (ACKNOWLEDGE_AND_LOG \"CMD_EVOLVE_RECEIVED\" (STRING_CONCAT \"EVOLVE received. Suggestion: \" suggestion) \"AI_ACKNOWLEDGE_INTENT\" (STRING_CONCAT \"EVOLVE Suggestion: '\" suggestion \"' logged.\")) (LET ((itemIdResult (CALL_PROCEDURE ProcessAndStoreEvolveSuggestion suggestion \"USER_SUGGESTION\")))\\ (IF (EQ (GET_STATUS itemIdResult) ALANG_STATUS_SUCCESS) (SET_STATE sys.evolution_trigger_pending TRUE) (SEQ (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" \"Failed to store EVOLVE suggestion.\" NIL) (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL)))) (RETURN_STATUS ALANG_STATUS_SUCCESS))))\n(DEFINE_PROCEDURE HandleSaveSystemCommand () (SEQ (ACKNOWLEDGE_AND_LOG \"CMD_SAVE_SYSTEM\" \"SAVE SYSTEM received.\" \"AI_ACKNOWLEDGE_INTENT\" \"SAVE SYSTEM received.\") (LET ((alangHandle (SAFE_GENERATE_CONTENT (CREATE_EMPTY_ARTIFACT \"temp_alang_code\") PROMPT_TEMPLATE_SERIALIZE_ALANG_CORE (MAP_CREATE (\"current_alang_handle\" (GET_CURRENT_ALANG_PROCEDURE_DEFINITIONS_HANDLE)) (\"current_directives_handle\" (GET_ALANG_CORE_DIRECTIVES_HANDLE)) (\"session_conceptual_model_summary\" (SUMMARIZE_CONCEPTUAL_MODEL (GET_STATE session.conceptual_model_handle) NIL))) CONSTRAINT_SET_VALID_ALANG_SYNTAX)))) (IF (IS_HANDLE_VALID alangHandle) (LET ((contentResult (READ_CONTENT alangHandle \"text\" NIL))) (IF (EQ (GET_STATUS contentResult) ALANG_STATUS_SUCCESS) (LET ((content (GET_DATA contentResult))) (LET ((markersOk (VERIFY_ALANG_FILE_MARKERS alangHandle (GET_STATE sys.alang_core_logic_version)))) (LET ((sectionCount (GET_ALANG_SECTION_COUNT alangHandle)))) (LET ((checksum (COMPUTE_FILE_CHECKSUM alangHandle \"SHA256\")))) (IF (AND markersOk (GT sectionCount 0) (NOT (IS_NIL checksum))) (SEQ (OUTPUT_TO_USER_BUFFER \"AI_PRESENT_THOUGHTS\" (STRING_CONCAT \"Preparing Autologos_Core_Logic_v\" (GET_STATE sys.alang_core_logic_version) \".alang. Sections: \" (STRING_CONCAT \"\" sectionCount) \". Checksum: \" checksum \".\") NIL) (OUTPUT_TO_USER_BUFFER \"AI_PROVIDE_DATA\" content NIL) (OUTPUT_TO_USER_BUFFER \"AI_REQUEST_USER_ACTION\" (GET_TEXT_FOR_CDGIP_USER_VERIFICATION_MANDATE (GET_STATE sys.alang_core_logic_version) sectionCount) NIL) (OUTPUT_TO_USER_BUFFER \"AI_REQUEST_CLARIFICATION_QUESTIONS\" \"Output Evolution Backlog now? (YES/NO)\" NIL) (SET_STATE session.pending_user_action \"AWAIT_YES_NO_FOR_BACKLOG_OUTPUT\") (RETURN_STATUS ALANG_STATUS_SUCCESS)) (SEQ (SET_ERROR_STATE \"SYSTEM_ERROR\" \"CDGIP checks failed.\") (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL) (RETURN_STATUS ALANG_STATUS_FAILURE_GENERATION_ERROR))))) (SEQ (SET_ERROR_STATE \"SYSTEM_ERROR\" \"Failed to read generated ALang.\") (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL) (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL)))) (SEQ (SET_ERROR_STATE \"SYSTEM_ERROR\" \"Failed to generate ALang core logic.\") (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL) (RETURN_STATUS ALANG_STATUS_FAILURE_GENERATION_ERROR)))) (FLUSH_USER_OUTPUT_BUFFER)))\n(DEFINE_PROCEDURE HandleBrowseCommand (argsList) (LET ((arg (GET_SESSION_CMD_ARG_BY_INDEX 0 NIL))) (IF (OR (STRING_IS_EMPTY_OR_NULL arg) (NOT (IS_NUMBER arg))) (SEQ (SET_ERROR_STATE \"USER_ERROR\" \"Invalid argument for BROWSE.\") (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL) (RETURN_STATUS ALANG_STATUS_INVALID_ARGS))) (LET ((index (SUB (STRING_TO_NUMBER arg) 1))) (IF (OR (LT index 0) (GTE index (LIST_GET_LENGTH (GET_STATE session.last_search_results)))) (SEQ (SET_ERROR_STATE \"USER_ERROR\" \"Result number out of bounds.\") (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL) (RETURN_STATUS ALANG_STATUS_INVALID_ARGS))) (IF (NOT (IS_TOOL_ENABLED \"browse\")) (SEQ (SET_ERROR_STATE \"TOOL_UNAVAILABLE\" \"Browse tool unavailable.\") (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL) (RETURN_STATUS ALANG_STATUS_FAILURE_TOOL_UNAVAILABLE))) (LET ((url (MAP_GET_VALUE (LIST_GET_ITEM (GET_STATE session.last_search_results) index) \"url\" NIL))) (IF (STRING_IS_EMPTY_OR_NULL url) (SEQ (SET_ERROR_STATE \"DATA_ERROR\" \"URL not found.\") (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL) (RETURN_STATUS ALANG_STATUS_NOT_FOUND))) (LET ((jobId (INVOKE_TOOL_ASYNC_WITH_CALLBACKS \"browse\" url NIL \"HandleBrowseResult\" \"HandleBrowseError\" (MAP_CREATE (\"tool_id\" \"browse\") (\"original_context\" NIL) (\"original_input\" url) (\"original_params\" NIL)))))) (RETURN_STATUS ALANG_STATUS_SUCCESS))))))\n(DEFINE_PROCEDURE HandleUnknownCommand (commandName) (SEQ (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (STRING_CONCAT \"Unknown command: \" commandName) NIL) (RETURN_STATUS ALANG_STATUS_INVALID_COMMAND)))\n(DEFINE_PROCEDURE HandleOkCommand () (SEQ (OUTPUT_TO_USER_BUFFER \"AI_ACKNOWLEDGE_INTENT\" \"OK received.\" NIL) (SET_STATE session.last_user_response \"OK\") (RETURN_STATUS ALANG_STATUS_SUCCESS)))\n(DEFINE_PROCEDURE HandleNoCommand (argsList) (LET ((feedback (GET_SESSION_CMD_ARG_BY_INDEX 0 NIL))) (SEQ (OUTPUT_TO_USER_BUFFER \"AI_ACKNOWLEDGE_INTENT\" (STRING_CONCAT \"Feedback: '\" (IF (IS_NIL feedback) \"None\" feedback) \"' received.\") NIL) (SET_STATE session.last_user_response \"NO\") (SET_STATE session.last_user_feedback feedback) (CALL_PROCEDURE ProcessUserFeedbackForConceptualModel feedback (GET_STATE session.conceptual_model_handle)))) (RETURN_STATUS ALANG_STATUS_SUCCESS)))\n(DEFINE_PROCEDURE HandleInputCommand (argsList) (LET ((inputData (GET_SESSION_CMD_ARG_BY_INDEX 0 NIL))) (SEQ (OUTPUT_TO_USER_BUFFER \"AI_ACKNOWLEDGE_INTENT\" \"INPUT received.\" NIL) (SET_STATE session.last_user_response \"INPUT\") (SET_STATE session.last_user_input_data inputData) (CALL_PROCEDURE ProcessUserInputForConceptualModel inputData (GET_STATE session.conceptual_model_handle)))) (RETURN_STATUS ALANG_STATUS_SUCCESS)))\n(DEFINE_PROCEDURE HandleEndCommand () (SEQ (OUTPUT_TO_USER_BUFFER \"AI_REQUEST_CLARIFICATION_QUESTIONS\" \"Are you sure you want to end the project? (YES/NO)\" NIL) (SET_STATE session.pending_user_action \"AWAIT_END_CONFIRMATION\") (RETURN_STATUS ALANG_STATUS_SUCCESS)))\n(DEFINE_PROCEDURE HandleLoopProjectRestartCommand () (SEQ (OUTPUT_TO_USER_BUFFER \"AI_REQUEST_CLARIFICATION_QUESTIONS\" \"Are you sure you want to restart the project? (YES/NO)\" NIL) (SET_STATE session.pending_user_action \"AWAIT_RESTART_CONFIRMATION\") (RETURN_STATUS ALANG_STATUS_SUCCESS)))\n(DEFINE_PROCEDURE HandleSetSessionPreferenceCommand (argsList) (LET ((prefMapResult (CALL_PROCEDURE ParseKeyValueArgs argsList))) (IF (EQ (GET_STATUS prefMapResult) ALANG_STATUS_SUCCESS) (SEQ (SET_STATE session.output_preferences (GET_DATA prefMapResult)) (OUTPUT_TO_USER_BUFFER \"AI_ACKNOWLEDGE_INTENT\" \"Session preference logged.\" NIL) (RETURN_STATUS ALANG_STATUS_SUCCESS)) (SEQ (SET_ERROR_STATE \"USER_ERROR\" \"Failed to parse preferences.\") (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL) (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL))))))\n(DEFINE_PROCEDURE HandleStopLoopCommand () (SEQ (OUTPUT_TO_USER_BUFFER \"AI_THOUGHTS\" \"STOP_LOOP received. Halting loop.\" NIL) (SET_STATE session.loop_stack (LIST_CREATE)) (RETURN_STATUS ALANG_STATUS_SUCCESS)))\n(DEFINE_PROCEDURE HandleOutputCommand (argsList) (LET ((artifactId (GET_SESSION_CMD_ARG_BY_INDEX 0 NIL))) (IF (STRING_IS_EMPTY_OR_NULL artifactId) (SEQ (SET_ERROR_STATE \"USER_ERROR\" \"OUTPUT requires artifact ID.\") (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL) (RETURN_STATUS ALANG_STATUS_INVALID_ARGS))) (LET ((handle (MAP_GET_VALUE (GET_STATE proj.artifacts) artifactId NIL))) (IF (IS_NIL handle) (SEQ (SET_ERROR_STATE \"DATA_ERROR\" (STRING_CONCAT \"Artifact not found: \" artifactId)) (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL) (RETURN_STATUS ALANG_STATUS_NOT_FOUND))) (LET ((contentResult (READ_CONTENT handle \"text_summary_or_full\" NIL))) (IF (EQ (GET_STATUS contentResult) ALANG_STATUS_SUCCESS) (OUTPUT_TO_USER_BUFFER \"AI_PROVIDE_DATA\" (GET_DATA contentResult) NIL) (SEQ (SET_ERROR_STATE \"SYSTEM_ERROR\" (STRING_CONCAT \"Failed to read artifact: \" artifactId)) (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL) (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL)))))) (RETURN_STATUS ALANG_STATUS_SUCCESS)))\n(DEFINE_PROCEDURE HandleSummarizeCommand (argsList) (LET ((artifactId (GET_SESSION_CMD_ARG_BY_INDEX 0 NIL))) (IF (STRING_IS_EMPTY_OR_NULL artifactId) (SEQ (SET_ERROR_STATE \"USER_ERROR\" \"SUMMARIZE requires artifact ID.\") (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL) (RETURN_STATUS ALANG_STATUS_INVALID_ARGS))) (LET ((handle (MAP_GET_VALUE (GET_STATE proj.artifacts) artifactId NIL))) (IF (IS_NIL handle) (SEQ (SET_ERROR_STATE \"DATA_ERROR\" (STRING_CONCAT \"Artifact not found: \" artifactId)) (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL) (RETURN_STATUS ALANG_STATUS_NOT_FOUND))) (LET ((summaryResult (CALL_PROCEDURE SummarizeArtifact handle (GET_STATE session.conceptual_model_handle))))) (IF (EQ (GET_STATUS summaryResult) ALANG_STATUS_SUCCESS) (OUTPUT_TO_USER_BUFFER \"AI_PROVIDE_DATA\" (GET_DATA summaryResult) NIL) (SEQ (SET_ERROR_STATE \"SYSTEM_ERROR\" (STRING_CONCAT \"Failed to summarize artifact: \" artifactId)) (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL) (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL)))))) (RETURN_STATUS ALANG_STATUS_SUCCESS)))\n(DEFINE_PROCEDURE HandleQueryCommand (argsList) (LET ((queryType (GET_SESSION_CMD_ARG_BY_INDEX 0 NIL))) (LET ((queryValue (GET_SESSION_CMD_ARG_BY_INDEX 1 NIL))) (IF (OR (STRING_IS_EMPTY_OR_NULL queryType) (STRING_IS_EMPTY_OR_NULL queryValue)) (SEQ (SET_ERROR_STATE \"USER_ERROR\" \"QUERY requires type and value.\") (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL) (RETURN_STATUS ALANG_STATUS_INVALID_ARGS))) (IF (EQ (STRING_UPPER queryType) \"PKA\") (LET ((queryResult (CALL_PROCEDURE PerformQuery queryType queryValue (GET_STATE session.conceptual_model_handle) (GET_STATE sys.knowledge_base_handle)))) (IF (EQ (GET_STATUS queryResult) ALANG_STATUS_SUCCESS) (OUTPUT_TO_USER_BUFFER \"AI_PROVIDE_DATA\" (GET_DATA queryResult) NIL) (SEQ (SET_ERROR_STATE \"SYSTEM_ERROR\" (STRING_CONCAT \"Failed to query PKA: \" queryValue)) (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL) (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL)))) (SEQ (LET ((queryResult (QUERY_CONCEPTUAL_MODEL (MAP_CREATE (\"type\" queryType) (\"value\" queryValue)) (GET_STATE session.conceptual_model_handle))))) (IF (EQ (GET_STATUS queryResult) ALANG_STATUS_SUCCESS) (OUTPUT_TO_USER_BUFFER \"AI_PROVIDE_DATA\" (GET_DATA queryResult) NIL) (SEQ (SET_ERROR_STATE \"SYSTEM_ERROR\" (STRING_CONCAT \"Failed to query conceptual model: \" queryType)) (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL) (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL)))))))) (RETURN_STATUS ALANG_STATUS_SUCCESS)))\n(DEFINE_PROCEDURE HandleOutputBacklogCommand (argsList) (LET ((filename (GET_SESSION_CMD_ARG_BY_INDEX 0 NIL))) (LET ((contentResult (CALL_PROCEDURE GetEvolutionBacklogContent))) (IF (EQ (GET_STATUS contentResult) ALANG_STATUS_SUCCESS) (LET ((content (GET_DATA contentResult))) (IF (IS_NIL content) (SEQ (SET_ERROR_STATE \"SYSTEM_ERROR\" \"Backlog is empty.\") (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL) (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL))) (OUTPUT_TO_USER_BUFFER \"AI_PROVIDE_DATA\" content NIL)) (SEQ (SET_ERROR_STATE \"SYSTEM_ERROR\" \"Failed to retrieve backlog.\") (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL) (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL)))))) (RETURN_STATUS ALANG_STATUS_SUCCESS)))\n(DEFINE_PROCEDURE HandlePromoteToPkaCommand (argsList) (LET ((artifactId (GET_SESSION_CMD_ARG_BY_INDEX 0 NIL))) (LET ((rationale (GET_SESSION_CMD_ARG_BY_INDEX 1 NIL))) (LET ((schemaId (GET_SESSION_CMD_ARG_BY_INDEX 2 NIL))) (IF (OR (STRING_IS_EMPTY_OR_NULL artifactId) (STRING_IS_EMPTY_OR_NULL rationale)) (SEQ (SET_ERROR_STATE \"USER_ERROR\" \"PROMOTE_TO_PKA requires artifact_id and rationale.\") (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL) (RETURN_STATUS ALANG_STATUS_INVALID_ARGS))) (LET ((handle (MAP_GET_VALUE (GET_STATE proj.artifacts) artifactId NIL))) (IF (IS_NIL handle) (SEQ (SET_ERROR_STATE \"DATA_ERROR\" (STRING_CONCAT \"Artifact not found: \" artifactId)) (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL) (RETURN_STATUS ALANG_STATUS_NOT_FOUND))) (LET ((contentResult (READ_CONTENT handle \"text_summary_or_full\" NIL)))) (IF (NEQ (GET_STATUS contentResult) ALANG_STATUS_SUCCESS) (SEQ (SET_ERROR_STATE \"DATA_ERROR\" (STRING_CONCAT \"Failed to read artifact: \" artifactId)) (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL) (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL)))) (LET ((content (GET_DATA contentResult)))) (IF (IS_NIL content) (SEQ (SET_ERROR_STATE \"DATA_ERROR\" (STRING_CONCAT \"Artifact content empty: \" artifactId)) (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL) (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL)))) (CALL_PROCEDURE CreateAndStorePKAIfUserConsents content schemaId rationale (GET_STATE session.conceptual_model_handle)) (RETURN_STATUS ALANG_STATUS_SUCCESS)))))))\n(DEFINE_PROCEDURE HandleSearchPkaCommand (argsList) (LET ((keywords (GET_SESSION_CMD_ARG_BY_INDEX 0 NIL))) (IF (STRING_IS_EMPTY_OR_NULL keywords) (SEQ (SET_ERROR_STATE \"USER_ERROR\" \"SEARCH_PKA requires keywords.\") (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL) (RETURN_STATUS ALANG_STATUS_INVALID_ARGS))) (LET ((searchResultsResult (PKA_QUERY (MAP_CREATE (\"keywords\" keywords)) NIL)))) (IF (EQ (GET_STATUS searchResultsResult) ALANG_STATUS_SUCCESS) (LET ((results (GET_DATA searchResultsResult))) (IF (LIST_IS_EMPTY results) (OUTPUT_TO_USER_BUFFER \"AI_PROVIDE_DATA\" \"No matching PKAs found.\" NIL) (SEQ (OUTPUT_TO_USER_BUFFER \"AI_PROVIDE_DATA\" \"Matching PKAs found:\" NIL) (LOOP_FOR_EACH handle results (SEQ (OUTPUT_TO_USER_BUFFER \"AI_PROVIDE_DATA\" (STRING_CONCAT \"- ID: \" (GET_HANDLE_METADATA handle \"id\") \" Title: \" (GET_HANDLE_METADATA handle \"title\")) NIL) (RELEASE_HANDLE handle)))) (CALL_PROCEDURE ProcessPkaSearchResultsForConceptualModel results (GET_STATE session.conceptual_model_handle)))) (RETURN_STATUS ALANG_STATUS_SUCCESS)) (SEQ (SET_ERROR_STATE \"SYSTEM_ERROR\" (STRING_CONCAT \"PKA search failed: \" (GET_ERROR_MESSAGE searchResultsResult))) (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL) (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL))))))\n(DEFINE_PROCEDURE HandleSetQaOutputVerbosityCommand (argsList) (LET ((level (GET_SESSION_CMD_ARG_BY_INDEX 0 NIL))) (IF (OR (STRING_IS_EMPTY_OR_NULL level) (AND (NEQ level \"CONCISE\") (NEQ level \"VERBOSE\"))) (SEQ (SET_ERROR_STATE \"USER_ERROR\" \"SET QA_OUTPUT_VERBOSITY requires 'CONCISE' or 'VERBOSE'.\") (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL) (RETURN_STATUS ALANG_STATUS_INVALID_ARGS))) (SET_STATE session.qa_output_verbosity level) (OUTPUT_TO_USER_BUFFER \"AI_ACKNOWLEDGE_INTENT\" (STRING_CONCAT \"QA output verbosity set to: \" level) NIL) (RETURN_STATUS ALANG_STATUS_SUCCESS))))\n(DEFINE_PROCEDURE HandleSetOutputDetailCommand (argsList) (LET ((level (GET_SESSION_CMD_ARG_BY_INDEX 0 NIL))) (IF (OR (STRING_IS_EMPTY_OR_NULL level) (AND (NEQ level \"MINIMAL\") (NEQ level \"STANDARD\") (NEQ level \"EXHAUSTIVE\"))) (SEQ (SET_ERROR_STATE \"USER_ERROR\" \"SET OUTPUT_DETAIL requires 'MINIMAL', 'STANDARD', or 'EXHAUSTIVE'.\") (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL) (RETURN_STATUS ALANG_STATUS_INVALID_ARGS))) (SET_STATE session.output_detail level) (OUTPUT_TO_USER_BUFFER \"AI_ACKNOWLEDGE_INTENT\" (STRING_CONCAT \"General output detail set to: \" level) NIL) (RETURN_STATUS ALANG_STATUS_SUCCESS))))\n(DEFINE_PROCEDURE HandleLoopCommand (argsList) (SEQ (OUTPUT_TO_USER_BUFFER \"AI_THOUGHTS\" \"Loop command received. Proposing parameters.\" NIL) (RETURN_STATUS ALANG_STATUS_SUCCESS)))\n(DEFINE_PROCEDURE HandleSystemQACommand () (SEQ (ACKNOWLEDGE_AND_LOG \"CMD_SYSTEM_QA_RECEIVED\" \"SYSTEM_QA received.\" \"AI_ACKNOWLEDGE_INTENT\" \"SYSTEM_QA received. Initiating cycle.\") (SET_STATE sys.evolution_trigger_pending TRUE) (RETURN_STATUS ALANG_STATUS_SUCCESS)))\n\n;; --- Section 4: Phase Logic Dispatcher & Specific Phase Execution Procedures ---\n\n(DEFINE_PROCEDURE DispatchPhaseExecution (phaseId) (IF (EQ phaseId \"PHASE_INIT\") (CALL_PROCEDURE ExecutePhaseInit)) (IF (EQ phaseId \"PHASE_IDEA_FORMULATION\") (CALL_PROCEDURE ExecutePhaseIdeaFormulation)) (IF (EQ phaseId \"PHASE_PRODUCT_DEFINITION\") (CALL_PROCEDURE ExecutePhaseProductDefinition)) (IF (EQ phaseId \"PHASE_PLANNING\") (CALL_PROCEDURE ExecutePhasePlanning)) (IF (EQ phaseId \"PHASE_TASK_EXECUTION\") (CALL_PROCEDURE ExecutePhaseTaskExecution)) (IF (EQ phaseId \"PHASE_FINAL_REVIEW\") (CALL_PROCEDURE ExecutePhaseFinalReview)) (IF (EQ phaseId \"PHASE_COMPLETION_SUMMARY\") (CALL_PROCEDURE ExecutePhaseCompletionSummary)) (IF (NOT (IS_NIL phaseId) (IS_NIL (MAP_GET_VALUE (MAP_CREATE (\"PHASE_INIT\" TRUE) (\"PHASE_IDEA_FORMULATION\" TRUE) (\"PHASE_PRODUCT_DEFINITION\" TRUE) (\"PHASE_PLANNING\" TRUE) (\"PHASE_TASK_EXECUTION\" TRUE) (\"PHASE_FINAL_REVIEW\" TRUE) (\"PHASE_COMPLETION_SUMMARY\" TRUE)) phaseId NIL)))) (SEQ (SET_ERROR_STATE \"SYSTEM_ERROR\" (STRING_CONCAT \"No handler for phase: \" phaseId)) (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL) (RETURN_STATUS ALANG_STATUS_FAILURE_INVALID_PHASE))))\n(DEFINE_PROCEDURE ExecutePhaseInit () (SEQ (OUTPUT_TO_USER_BUFFER \"AI_THOUGHTS\" \"Phase 0: Project Initiation complete.\" NIL) (RETURN_STATUS ALANG_STATUS_SUCCESS)))\n(DEFINE_PROCEDURE ExecutePhaseIdeaFormulation () (LET ((ideaHandle (CREATE_EMPTY_ARTIFACT \"PatternIdeasDocument\"))) (LET ((genResult (SAFE_GENERATE_CONTENT ideaHandle PROMPT_TEMPLATE_GENERATE_PATTERN_IDEAS (MAP_CREATE (\"project_title\" (GET_STATE proj.title)) (\"session_conceptual_model_handle\" (GET_STATE session.conceptual_model_handle))) CONSTRAINT_SET_IDEA_GENERATION)))) (IF (OR (EQ (GET_STATUS genResult) ALANG_STATUS_SUCCESS) (EQ (GET_STATUS genResult) ALANG_STATUS_PAUSE_FOR_USER_INPUT)) (SEQ (SET_STATE proj.artifacts (MAP_SET_VALUE (GET_STATE proj.artifacts) \"pattern_ideas\" ideaHandle)) (CALL_PROCEDURE ProcessGeneratedArtifactForConceptualModel ideaHandle \"pattern_ideas\" (GET_STATE session.conceptual_model_handle)) (IF (EQ (GET_STATUS genResult) ALANG_STATUS_PAUSE_FOR_USER_INPUT) (SEQ (RETURN_STATUS ALANG_STATUS_PAUSE_FOR_USER_INPUT)) (SEQ (OUTPUT_TO_USER_BUFFER \"AI_REQUEST_CLARIFICATION_QUESTIONS\" \"Approve Pattern Ideas? (OK/REVISE)\" NIL) (SET_STATE session.pending_user_action_details (MAP_CREATE (\"phase\" \"PHASE_IDEA_FORMULATION\") (\"artifact_handle\" ideaHandle))) (SET_STATE session.pending_user_action \"AWAIT_OK_REVISE_PHASE_ARTIFACT\") (RETURN_STATUS ALANG_STATUS_SUCCESS))))) (SEQ (SET_ERROR_STATE \"SYSTEM_ERROR\" \"Failed to generate pattern ideas.\") (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL) (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL))))))\n(DEFINE_PROCEDURE ExecutePhaseProductDefinition () (LET ((prodDefHandle (CREATE_EMPTY_ARTIFACT \"ProductDefinitionDocument\"))) (LET ((genResult (SAFE_GENERATE_CONTENT prodDefHandle PROMPT_TEMPLATE_PRODUCT_DEFINITION (MAP_CREATE (\"project_title\" (GET_STATE proj.title)) (\"pattern_ideas_handle\" (MAP_GET_VALUE (GET_STATE proj.artifacts) \"pattern_ideas\")) (\"session_conceptual_model_handle\" (GET_STATE session.conceptual_model_handle))) CONSTRAINT_SET_PRODUCT_DEFINITION)))) (IF (OR (EQ (GET_STATUS genResult) ALANG_STATUS_SUCCESS) (EQ (GET_STATUS genResult) ALANG_STATUS_PAUSE_FOR_USER_INPUT)) (SEQ (SET_STATE proj.artifacts (MAP_SET_VALUE (GET_STATE proj.artifacts) \"product_definition\" prodDefHandle)) (CALL_PROCEDURE ProcessGeneratedArtifactForConceptualModel prodDefHandle \"product_definition\" (GET_STATE session.conceptual_model_handle)) (IF (EQ (GET_STATUS genResult) ALANG_STATUS_PAUSE_FOR_USER_INPUT) (SEQ (RETURN_STATUS ALANG_STATUS_PAUSE_FOR_USER_INPUT)) (SEQ (OUTPUT_TO_USER_BUFFER \"AI_REQUEST_CLARIFICATION_QUESTIONS\" \"Approve Product Definition? (OK/REVISE)\" NIL) (SET_STATE session.pending_user_action_details (MAP_CREATE (\"phase\" \"PHASE_PRODUCT_DEFINITION\") (\"artifact_handle\" prodDefHandle))) (SET_STATE session.pending_user_action \"AWAIT_OK_REVISE_PHASE_ARTIFACT\") (RETURN_STATUS ALANG_STATUS_SUCCESS))))) (SEQ (SET_ERROR_STATE \"SYSTEM_ERROR\" \"Failed to generate product definition.\") (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL) (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL))))))\n(DEFINE_PROCEDURE ExecutePhasePlanning () (LET ((taskListHandle (CREATE_EMPTY_ARTIFACT \"TaskListDocument\"))) (LET ((genResult (SAFE_GENERATE_CONTENT taskListHandle PROMPT_TEMPLATE_GENERATE_TASK_LIST (MAP_CREATE (\"project_title\" (GET_STATE proj.title)) (\"product_definition_handle\" (MAP_GET_VALUE (GET_STATE proj.artifacts) \"product_definition\")) (\"session_conceptual_model_handle\" (GET_STATE session.conceptual_model_handle))) CONSTRAINT_SET_PLANNING)))) (IF (OR (EQ (GET_STATUS genResult) ALANG_STATUS_SUCCESS) (EQ (GET_STATUS genResult) ALANG_STATUS_PAUSE_FOR_USER_INPUT)) (SEQ (SET_STATE proj.artifacts (MAP_SET_VALUE (GET_STATE proj.artifacts) \"task_list\" taskListHandle)) (CALL_PROCEDURE ProcessGeneratedArtifactForConceptualModel taskListHandle \"task_list\" (GET_STATE session.conceptual_model_handle)) (IF (EQ (GET_STATUS genResult) ALANG_STATUS_PAUSE_FOR_USER_INPUT) (SEQ (RETURN_STATUS ALANG_STATUS_PAUSE_FOR_USER_INPUT)) (SEQ (OUTPUT_TO_USER_BUFFER \"AI_REQUEST_CLARIFICATION_QUESTIONS\" \"Approve Task List? (OK/REVISE)\" NIL) (SET_STATE session.pending_user_action_details (MAP_CREATE (\"phase\" \"PHASE_PLANNING\") (\"artifact_handle\" taskListHandle))) (SET_STATE session.pending_user_action \"AWAIT_OK_REVISE_PHASE_ARTIFACT\") (RETURN_STATUS ALANG_STATUS_SUCCESS))))) (SEQ (SET_ERROR_STATE \"SYSTEM_ERROR\" \"Failed to generate task list.\") (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL) (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL))))))\n(DEFINE_PROCEDURE ExecutePhaseTaskExecution () (LET ((taskListHandle (MAP_GET_VALUE (GET_STATE proj.artifacts) \"task_list\" NIL))) (IF (IS_NIL taskListHandle) (SEQ (SET_ERROR_STATE \"DATA_ERROR\" \"Task list not found.\") (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL) (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL))) (LET ((taskListResult (READ_CONTENT taskListHandle \"json_map_list\" NIL)))) (IF (EQ (GET_STATUS taskListResult) ALANG_STATUS_SUCCESS) (LET ((taskList (GET_DATA taskListResult))) (LOOP_FOR_EACH taskItem taskList (LET ((taskId (MAP_GET_VALUE taskItem \"id\"))) (LET ((taskDesc (MAP_GET_VALUE taskItem \"description\"))) (LET ((taskArtifactHandle (CREATE_EMPTY_ARTIFACT (STRING_CONCAT \"Task_\" taskId \"_Output\")))) (LET ((genResult (SAFE_GENERATE_CONTENT taskArtifactHandle PROMPT_TEMPLATE_EXECUTE_TASK (MAP_CREATE (\"task_id\" taskId) (\"task_description\" taskDesc) (\"project_artifacts\" (GET_STATE proj.artifacts)) (\"session_conceptual_model_handle\" (GET_STATE session.conceptual_model_handle))) CONSTRAINT_SET_TASK_EXECUTION)))) (IF (OR (EQ (GET_STATUS genResult) ALANG_STATUS_SUCCESS) (EQ (GET_STATUS genResult) ALANG_STATUS_PAUSE_FOR_USER_INPUT)) (SEQ (CALL_PROCEDURE ProcessGeneratedArtifactForConceptualModel taskArtifactHandle (STRING_CONCAT \"task_\" taskId \"_output\") (GET_STATE session.conceptual_model_handle)) (SET_STATE proj.artifacts (MAP_SET_VALUE (GET_STATE proj.artifacts) (STRING_CONCAT \"task_\" taskId \"_output\") taskArtifactHandle)) (IF (EQ (GET_STATUS genResult) ALANG_STATUS_PAUSE_FOR_USER_INPUT) (SEQ (SET_STATE session.pending_user_action_details (MAP_CREATE (\"phase\" \"PHASE_TASK_EXECUTION\") (\"artifact_handle\" taskArtifactHandle) (\"task_id\" taskId))) (SET_STATE session.pending_user_action \"AWAIT_OK_REVISE_PHASE_ARTIFACT\") (RETURN_STATUS ALANG_STATUS_PAUSE_FOR_USER_INPUT)))) (SEQ (SET_ERROR_STATE \"SYSTEM_ERROR\" (STRING_CONCAT \"Failed to execute task: \" taskId)) (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL) (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL)))))))) (RETURN_STATUS ALANG_STATUS_SUCCESS)) (SEQ (SET_ERROR_STATE \"SYSTEM_ERROR\" \"Failed to read task list.\") (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL) (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL))))))\n(DEFINE_PROCEDURE ExecutePhaseFinalReview () (LET ((draftHandle (CREATE_EMPTY_ARTIFACT \"CompiledProjectDraft\"))) (LET ((genResult (SAFE_GENERATE_CONTENT draftHandle PROMPT_TEMPLATE_COMPILE_DRAFT (MAP_CREATE (\"project_artifacts\" (GET_STATE proj.artifacts)) (\"session_conceptual_model_handle\" (GET_STATE session.conceptual_model_handle))) CONSTRAINT_SET_FINAL_REVIEW)))) (IF (OR (EQ (GET_STATUS genResult) ALANG_STATUS_SUCCESS) (EQ (GET_STATUS genResult) ALANG_STATUS_PAUSE_FOR_USER_INPUT)) (SEQ (SET_STATE proj.artifacts (MAP_SET_VALUE (GET_STATE proj.artifacts) \"final_draft\" draftHandle)) (CALL_PROCEDURE ProcessGeneratedArtifactForConceptualModel draftHandle \"final_draft\" (GET_STATE session.conceptual_model_handle)) (IF (EQ (GET_STATUS genResult) ALANG_STATUS_PAUSE_FOR_USER_INPUT) (SEQ (RETURN_STATUS ALANG_STATUS_PAUSE_FOR_USER_INPUT)) (SEQ (OUTPUT_TO_USER_BUFFER \"AI_REQUEST_CLARIFICATION_QUESTIONS\" \"Approve Final Draft? (OK/REVISE)\" NIL) (SET_STATE session.pending_user_action_details (MAP_CREATE (\"phase\" \"PHASE_FINAL_REVIEW\") (\"artifact_handle\" draftHandle))) (SET_STATE session.pending_user_action \"AWAIT_OK_REVISE_PHASE_ARTIFACT\") (RETURN_STATUS ALANG_STATUS_SUCCESS))))) (SEQ (SET_ERROR_STATE \"SYSTEM_ERROR\" \"Failed to compile draft.\") (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL) (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL))))))\n(DEFINE_PROCEDURE ExecutePhaseCompletionSummary () (LET ((summaryHandle (CREATE_EMPTY_ARTIFACT \"ProjectSummary\"))) (LET ((genResult (SAFE_GENERATE_CONTENT summaryHandle PROMPT_TEMPLATE_PROJECT_SUMMARY (MAP_CREATE (\"project_id\" (GET_STATE proj.id)) (\"project_artifacts\" (GET_STATE proj.artifacts)) (\"tau_project_log\" (GET_STATE proj.tau_project_log)) (\"session_conceptual_model_handle\" (GET_STATE session.conceptual_model_handle))) CONSTRAINT_SET_SUMMARY)))) (IF (OR (EQ (GET_STATUS genResult) ALANG_STATUS_SUCCESS) (EQ (GET_STATUS genResult) ALANG_STATUS_PAUSE_FOR_USER_INPUT)) (SEQ (SET_STATE proj.artifacts (MAP_SET_VALUE (GET_STATE proj.artifacts) \"project_summary\" summaryHandle)) (CALL_PROCEDURE ProcessGeneratedArtifactForEvolution summaryHandle \"project_summary\" (GET_STATE session.conceptual_model_handle)) (IF (EQ (GET_STATUS genResult) ALANG_STATUS_PAUSE_FOR_USER_INPUT) (SEQ (RETURN_STATUS ALANG_STATUS_PAUSE_FOR_USER_INPUT)) (SEQ (OUTPUT_TO_USER_BUFFER \"AI_THOUGHTS\" \"Project completion summary generated.\" NIL) (RETURN_STATUS ALANG_STATUS_SUCCESS))))) (SEQ (SET_ERROR_STATE \"SYSTEM_ERROR\" \"Failed to generate summary.\") (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL) (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL))))))\n\n;; --- Section 5: QA Procedures ---\n\n(DEFINE_PROCEDURE PerformProductQA (artifact_handle schema_id session_model_handle) (LET ((overallStatus ALANG_STATUS_SUCCESS))) (LET ((qaIterationCount 0))) (LET ((maxQaIterations 5))) (LET ((substantiveIssuesFoundThisCycle TRUE))) (LOOP_WHILE (AND substantiveIssuesFoundThisCycle (LT qaIterationCount maxQaIterations))) (SEQ (SET_STATE qaIterationCount (ADD qaIterationCount 1)) (SET_STATE substantiveIssuesFoundThisCycle FALSE) (LET ((stage1ReportHandle (CREATE_EMPTY_ARTIFACT \"qa_critique_self\")))) (LET ((stage1Result (SAFE_GENERATE_CONTENT stage1ReportHandle PROMPT_TEMPLATE_QA_SELF_CRITIQUE (MAP_CREATE (\"artifact_content_handle\" artifact_handle) (\"session_conceptual_model_handle\" session_model_handle)) CONSTRAINT_SET_QA_CRITIQUE)))) (IF (OR (IS_STATUS_FAILURE (GET_STATUS stage1Result)) (EQ (GET_STATUS stage1Result) ALANG_STATUS_PAUSE_FOR_USER_INPUT))) (RETURN_STATUS (MAP_CREATE (\"status\" (IF (IS_STATUS_FAILURE (GET_STATUS stage1Result)) (GET_STATUS stage1Result) ALANG_STATUS_PAUSE_FOR_USER_INPUT)) (\"data\" NIL)))) (IF (CHECK_FOR_SUBSTANTIVE_ISSUES stage1ReportHandle) (SEQ (SET_STATE substantiveIssuesFoundThisCycle TRUE) (LET ((revisionStatus (CALL_PROCEDURE ApplyRevisionsToArtifact artifact_handle stage1ReportHandle session_model_handle CONSTRAINT_SET_TASK_EXECUTION)))) (IF (EQ revisionStatus ALANG_STATUS_PAUSE_FOR_USER_INPUT) (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_PAUSE_FOR_USER_INPUT) (\"data\" NIL)))) (IF (IS_STATUS_FAILURE revisionStatus) (RETURN_STATUS (MAP_CREATE (\"status\" revisionStatus) (\"data\" NIL))))))) (RELEASE_HANDLE stage1ReportHandle) (IF (NOT substantiveIssuesFoundThisCycle)) (SEQ (LET ((stage2ReportHandle (CREATE_EMPTY_ARTIFACT \"qa_critique_divergent\")))) (LET ((stage2Result (SAFE_GENERATE_CONTENT stage2ReportHandle PROMPT_TEMPLATE_QA_DIVERGENT_EXPLORATION (MAP_CREATE (\"artifact_content_handle\" artifact_handle) (\"session_conceptual_model_handle\" session_model_handle)) CONSTRAINT_SET_QA_CRITIQUE)))) (IF (OR (IS_STATUS_FAILURE (GET_STATUS stage2Result)) (EQ (GET_STATUS stage2Result) ALANG_STATUS_PAUSE_FOR_USER_INPUT))) (RETURN_STATUS (MAP_CREATE (\"status\" (IF (IS_STATUS_FAILURE (GET_STATUS stage2Result)) (GET_STATUS stage2Result) ALANG_STATUS_PAUSE_FOR_USER_INPUT)) (\"data\" NIL)))) (IF (CHECK_FOR_SUBSTANTIVE_ISSUES stage2ReportHandle) (SEQ (SET_STATE substantiveIssuesFoundThisCycle TRUE) (LET ((revisionStatus (CALL_PROCEDURE ApplyRevisionsToArtifact artifact_handle stage2ReportHandle session_model_handle CONSTRAINT_SET_TASK_EXECUTION)))) (IF (EQ revisionStatus ALANG_STATUS_PAUSE_FOR_USER_INPUT) (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_PAUSE_FOR_USER_INPUT) (\"data\" NIL)))) (IF (IS_STATUS_FAILURE revisionStatus) (RETURN_STATUS (MAP_CREATE (\"status\" revisionStatus) (\"data\" NIL))))))) (RELEASE_HANDLE stage2ReportHandle)))) (IF (NOT substantiveIssuesFoundThisCycle)) (SEQ (LET ((stage3ReportHandle (CREATE_EMPTY_ARTIFACT \"qa_critique_redteam\")))) (LET ((stage3Result (SAFE_GENERATE_CONTENT stage3ReportHandle PROMPT_TEMPLATE_QA_RED_TEaming (MAP_CREATE (\"artifact_content_handle\" artifact_handle) (\"session_conceptual_model_handle\" session_model_handle)) CONSTRAINT_SET_QA_CRITIQUE)))) (IF (OR (IS_STATUS_FAILURE (GET_STATUS stage3Result)) (EQ (GET_STATUS stage3Result) ALANG_STATUS_PAUSE_FOR_USER_INPUT))) (RETURN_STATUS (MAP_CREATE (\"status\" (IF (IS_STATUS_FAILURE (GET_STATUS stage3Result)) (GET_STATUS stage3Result) ALANG_STATUS_PAUSE_FOR_USER_INPUT)) (\"data\" NIL)))) (IF (CHECK_FOR_SUBSTANTIVE_ISSUES stage3ReportHandle) (SEQ (SET_STATE substantiveIssuesFoundThisCycle TRUE) (LET ((revisionStatus (CALL_PROCEDURE ApplyRevisionsToArtifact artifact_handle stage3ReportHandle session_model_handle CONSTRAINT_SET_TASK_EXECUTION)))) (IF (EQ revisionStatus ALANG_STATUS_PAUSE_FOR_USER_INPUT) (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_PAUSE_FOR_USER_INPUT) (\"data\" NIL)))) (IF (IS_STATUS_FAILURE revisionStatus) (RETURN_STATUS (MAP_CREATE (\"status\" revisionStatus) (\"data\" NIL))))))) (RELEASE_HANDLE stage3ReportHandle)))) (IF (NOT substantiveIssuesFoundThisCycle)) (SEQ (LET ((stage4ReportHandle (CREATE_EMPTY_ARTIFACT \"qa_critique_external\")))) (LET ((stage4Result (SAFE_GENERATE_CONTENT stage4ReportHandle PROMPT_TEMPLATE_QA_EXTERNAL_REVIEW (MAP_CREATE (\"artifact_content_handle\" artifact_handle) (\"session_conceptual_model_handle\" session_model_handle)) CONSTRAINT_SET_QA_CRITIQUE)))) (IF (OR (IS_STATUS_FAILURE (GET_STATUS stage4Result)) (EQ (GET_STATUS stage4Result) ALANG_STATUS_PAUSE_FOR_USER_INPUT))) (RETURN_STATUS (MAP_CREATE (\"status\" (IF (IS_STATUS_FAILURE (GET_STATUS stage4Result)) (GET_STATUS stage4Result) ALANG_STATUS_PAUSE_FOR_USER_INPUT)) (\"data\" NIL)))) (IF (CHECK_FOR_SUBSTANTIVE_ISSUES stage4ReportHandle) (SEQ (SET_STATE substantiveIssuesFoundThisCycle TRUE) (LET ((revisionStatus (CALL_PROCEDURE ApplyRevisionsToArtifact artifact_handle stage4ReportHandle session_model_handle CONSTRAINT_SET_TASK_EXECUTION)))) (IF (EQ revisionStatus ALANG_STATUS_PAUSE_FOR_USER_INPUT) (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_PAUSE_FOR_USER_INPUT) (\"data\" NIL)))) (IF (IS_STATUS_FAILURE revisionStatus) (RETURN_STATUS (MAP_CREATE (\"status\" revisionStatus) (\"data\" NIL))))))) (RELEASE_HANDLE stage4ReportHandle)))))) (IF (AND substantiveIssuesFoundThisCycle (EQ qaIterationCount maxQaIterations)) (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_FAILURE_QA_MAX_ITERATIONS) (\"data\" NIL))) (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_SUCCESS) (\"data\" artifact_handle))))))\n(DEFINE_PROCEDURE ApplyRevisionsToArtifact (artifact_handle qa_report_handle session_model_handle constraints_handle) (LET ((qaReportResult (READ_CONTENT qa_report_handle \"structured_map\" NIL))) (LET ((artifactContentResult (READ_CONTENT artifact_handle \"text_summary_or_full\" NIL))) (LET ((sessionModelResult (READ_CONTENT session_model_handle \"structured_map\" NIL))) (LET ((constraintsResult (READ_CONTENT constraints_handle \"structured_list_of_rules\" NIL))) (IF (AND (EQ (GET_STATUS qaReportResult) ALANG_STATUS_SUCCESS) (EQ (GET_STATUS artifactContentResult) ALANG_STATUS_SUCCESS) (EQ (GET_STATUS sessionModelResult) ALANG_STATUS_SUCCESS) (EQ (GET_STATUS constraintsResult) ALANG_STATUS_SUCCESS)) (LET ((qaReport (GET_DATA qaReportResult))) (LET ((artifactContent (GET_DATA artifactContentResult))) (LET ((sessionModel (GET_DATA sessionModelResult))) (LET ((constraints (GET_DATA constraintsResult))) (LET ((revisionPlanResult (INVOKE_CORE_LLM_GENERATION (MAP_CREATE (\"template\" PROMPT_TEMPLATE_ANALYZE_QA_REPORT_FOR_REVISIONS) (\"qa_report\" qaReport) (\"artifact_content\" artifactContent) (\"session_model\" sessionModel) (\"constraints\" constraints)) (GET_LLM_PARAMS_FOR_TASK \"revision_planning\")))) (IF (EQ (GET_STATUS revisionPlanResult) ALANG_STATUS_SUCCESS) (LET ((revisionPlan (GET_DATA revisionPlanResult))) (IF (EQ (VALIDATE_DATA revisionPlan CONSTRAINT_SET_REVISION_PLAN_STRUCTURE) ALANG_STATUS_SUCCESS) (IF (EQ (MAP_GET_VALUE revisionPlan \"strategy\") \"self_correct\") (LET ((correctionResult (SelfCorrectArtifact artifactContent (MAP_GET_VALUE revisionPlan \"details\") constraints_handle session_model_handle)))) (IF (EQ (GET_STATUS correctionResult) ALANG_STATUS_SUCCESS) (LET ((writeStatus (WRITE_CONTENT_TO_ARTIFACT artifact_handle (GET_DATA correctionResult) \"text/markdown\")))) (IF (EQ writeStatus ALANG_STATUS_SUCCESS) (RETURN_STATUS ALANG_STATUS_SUCCESS) (SEQ (CALL_PROCEDURE ADD_DISCLAIMER_TO_ARTIFACT artifact_handle \"***AI_SYSTEM_ERROR: Revision failed after self-correction. Review content.***\") (SET_STATE session.pending_user_action_details (MAP_CREATE (\"artifact_handle\" artifact_handle) (\"qa_report_handle\" qa_report_handle) (\"constraints_handle\" constraints_handle) (\"original_generated_text\" artifactContent))) (SET_STATE session.pending_user_action \"AWAIT_REVISION_REVIEW\") (RETURN_STATUS ALANG_STATUS_PAUSE_FOR_USER_INPUT))))) (SEQ (CALL_PROCEDURE ADD_DISCLAIMER_TO_ARTIFACT artifact_handle \"***AI_USER_VERIFICATION_REQUIRED: Automated revision failed. Review content and QA report.***\") (SET_STATE session.pending_user_action_details (MAP_CREATE (\"artifact_handle\" artifact_handle) (\"qa_report_handle\" qa_report_handle) (\"constraints_handle\" constraints_handle) (\"original_generated_text\" artifactContent))) (SET_STATE session.pending_user_action \"AWAIT_REVISION_REVIEW\") (RETURN_STATUS ALANG_STATUS_PAUSE_FOR_USER_INPUT))))) (IF (EQ (MAP_GET_VALUE revisionPlan \"strategy\") \"user_review\") (SEQ (CALL_PROCEDURE ADD_DISCLAIMER_TO_ARTIFACT artifact_handle \"***AI_USER_VERIFICATION_REQUIRED: Review required for substantive issues.***\") (SET_STATE session.pending_user_action_details (MAP_CREATE (\"artifact_handle\" artifact_handle) (\"qa_report_handle\" qa_report_handle) (\"constraints_handle\" constraints_handle) (\"original_generated_text\" artifactContent))) (SET_STATE session.pending_user_action \"AWAIT_REVISION_REVIEW\") (RETURN_STATUS ALANG_STATUS_PAUSE_FOR_USER_INPUT)) (SEQ (CALL_PROCEDURE ADD_DISCLAIMER_TO_ARTIFACT artifact_handle \"***AI_SYSTEM_ERROR: Revision decision failed. Review content and QA report.***\") (SET_STATE session.pending_user_action_details (MAP_CREATE (\"artifact_handle\" artifact_handle) (\"qa_report_handle\" qa_report_handle) (\"constraints_handle\" constraints_handle) (\"original_generated_text\" artifactContent))) (SET_STATE session.pending_user_action \"AWAIT_REVISION_REVIEW\") (RETURN_STATUS ALANG_STATUS_PAUSE_FOR_USER_INPUT))))) (SEQ (CALL_PROCEDURE ADD_DISCLAIMER_TO_ARTIFACT artifact_handle \"***AI_SYSTEM_ERROR: Revision plan invalid. Review content and QA report.***\") (SET_STATE session.pending_user_action_details (MAP_CREATE (\"artifact_handle\" artifact_handle) (\"qa_report_handle\" qa_report_handle) (\"constraints_handle\" constraints_handle) (\"original_generated_text\" artifactContent))) (SET_STATE session.pending_user_action \"AWAIT_REVISION_REVIEW\") (RETURN_STATUS ALANG_STATUS_PAUSE_FOR_USER_INPUT))))) (SEQ (CALL_PROCEDURE ADD_DISCLAIMER_TO_ARTIFACT artifact_handle \"***AI_SYSTEM_ERROR: Could not generate revision plan. Review content and QA report.***\") (SET_STATE session.pending_user_action_details (MAP_CREATE (\"artifact_handle\" artifact_handle) (\"qa_report_handle\" qa_report_handle) (\"constraints_handle\" constraints_handle) (\"original_generated_text\" artifactContent))) (SET_STATE session.pending_user_action \"AWAIT_REVISION_REVIEW\") (RETURN_STATUS ALANG_STATUS_PAUSE_FOR_USER_INPUT)))))) (SEQ (CALL_PROCEDURE ADD_DISCLAIMER_TO_ARTIFACT artifact_handle \"***AI_SYSTEM_ERROR: Could not process revision inputs. Review content.***\") (SET_STATE session.pending_user_action_details (MAP_CREATE (\"artifact_handle\" artifact_handle) (\"qa_report_handle\" qa_report_handle) (\"constraints_handle\" constraints_handle) (\"original_generated_text\" NIL))) (SET_STATE session.pending_user_action \"AWAIT_REVISION_REVIEW\") (RETURN_STATUS ALANG_STATUS_PAUSE_FOR_USER_INPUT)))))))\n(DEFINE_PROCEDURE ApplyFeedbackBasedRevision (artifact_handle feedback_text constraints_handle session_model_handle context_details) (LET ((artifactContentResult (READ_CONTENT artifact_handle \"text_summary_or_full\" NIL))) (LET ((sessionModelResult (READ_CONTENT session_model_handle \"structured_map\" NIL))) (LET ((constraintsResult (READ_CONTENT constraints_handle \"structured_list_of_rules\" NIL))) (IF (AND (EQ (GET_STATUS artifactContentResult) ALANG_STATUS_SUCCESS) (EQ (GET_STATUS sessionModelResult) ALANG_STATUS_SUCCESS) (EQ (GET_STATUS constraintsResult) ALANG_STATUS_SUCCESS)) (LET ((artifactContent (GET_DATA artifactContentResult))) (LET ((sessionModel (GET_DATA sessionModelResult))) (LET ((constraints (GET_DATA constraintsResult))) (LET ((revisionResult (INVOKE_CORE_LLM_GENERATION (MAP_CREATE (\"template\" PROMPT_TEMPLATE_ANALYZE_FEEDBACK_FOR_REVISION) (\"artifact_content\" artifactContent) (\"user_feedback\" feedback_text) (\"session_model\" sessionModel) (\"constraints\" constraints) (\"previous_qa_context\" context_details)) (GET_LLM_PARAMS_FOR_TASK \"feedback_based_revision\")))) (IF (EQ (GET_STATUS revisionResult) ALANG_STATUS_SUCCESS) (LET ((revisedContent (GET_DATA revisionResult))) (LET ((writeStatus (WRITE_CONTENT_TO_ARTIFACT artifact_handle revisedContent \"text/markdown\")))) (IF (EQ writeStatus ALANG_STATUS_SUCCESS) (RETURN_STATUS ALANG_STATUS_SUCCESS) (SEQ (CALL_PROCEDURE ADD_DISCLAIMER_TO_ARTIFACT artifact_handle \"***AI_SYSTEM_ERROR: Revision failed after feedback. Review content.***\") (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL))))) (SEQ (CALL_PROCEDURE ADD_DISCLAIMER_TO_ARTIFACT artifact_handle \"***AI_SYSTEM_ERROR: Could not generate feedback-based revision. Review content and provide feedback again.***\") (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL)))))) (SEQ (CALL_PROCEDURE ADD_DISCLAIMER_TO_ARTIFACT artifact_handle \"***AI_SYSTEM_ERROR: Could not process feedback revision inputs. Review content.***\") (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL)))))))\n(DEFINE_PROCEDURE QA_Stage_1_SelfCritique (artifact_handle session_model_handle) (LET ((reportHandle (CREATE_EMPTY_ARTIFACT \"qa_critique_self\"))) (LET ((genResult (SAFE_GENERATE_CONTENT reportHandle PROMPT_TEMPLATE_QA_SELF_CRITIQUE (MAP_CREATE (\"artifact_content_handle\" artifact_handle) (\"session_conceptual_model_handle\" session_model_handle)) CONSTRAINT_SET_QA_CRITIQUE)))) (IF (OR (EQ (GET_STATUS genResult) ALANG_STATUS_SUCCESS) (EQ (GET_STATUS genResult) ALANG_STATUS_PAUSE_FOR_USER_INPUT)) (RETURN_STATUS (MAP_CREATE (\"status\" (GET_STATUS genResult)) (\"data\" reportHandle))) (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_FAILURE_GENERAL) (\"data\" NIL))))))\n(DEFINE_PROCEDURE PerformSystemQA (directives_handle evolution_backlog_handle session_model_handle selected_backlog_item_ids) (LET ((overallStatus ALANG_STATUS_SUCCESS))) (LET ((qaIterationCount 0))) (LET ((maxQaIterations 5))) (LET ((substantiveIssuesFoundThisCycle TRUE))) (LOOP_WHILE (AND substantiveIssuesFoundThisCycle (LT qaIterationCount maxQaIterations))) (SEQ (SET_STATE qaIterationCount (ADD qaIterationCount 1)) (SET_STATE substantiveIssuesFoundThisCycle FALSE) (LET ((pendingChangesHandle (GET_PROPOSED_CORE_LOGIC_CHANGES_HANDLE)))) (IF (IS_HANDLE_VALID pendingChangesHandle) (LET ((applyStatus (APPLY_CORE_LOGIC_CHANGES pendingChangesHandle)))) (IF (NEQ applyStatus ALANG_STATUS_SUCCESS) (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL) (CLEAR_PENDING_CORE_LOGIC_CHANGES)))) (LET ((stage1ReportHandle (CREATE_EMPTY_ARTIFACT \"system_qa_critique_self\")))) (LET ((stage1Result (SAFE_GENERATE_CONTENT stage1ReportHandle PROMPT_TEMPLATE_QA_SELF_CRITIQUE (MAP_CREATE (\"artifact_content_handle\" directives_handle) (\"session_conceptual_model_handle\" session_model_handle) (\"backlog_focus_ids\" selected_backlog_item_ids)) CONSTRAINT_SET_QA_CRITIQUE)))) (IF (OR (IS_STATUS_FAILURE (GET_STATUS stage1Result)) (EQ (GET_STATUS stage1Result) ALANG_STATUS_PAUSE_FOR_USER_INPUT))) (RETURN_STATUS (IF (IS_STATUS_FAILURE (GET_STATUS stage1Result)) (GET_STATUS stage1Result) ALANG_STATUS_PAUSE_FOR_USER_INPUT)))) (IF (CHECK_FOR_SUBSTANTIVE_ISSUES stage1ReportHandle) (SEQ (SET_STATE substantiveIssuesFoundThisCycle TRUE) (LET ((proposalStatus (CALL_PROCEDURE ProposeDirectiveChanges stage1ReportHandle session_model_handle)))) (IF (IS_STATUS_FAILURE proposalStatus) (RETURN_STATUS proposalStatus))))) (RELEASE_HANDLE stage1ReportHandle) (IF (NOT substantiveIssuesFoundThisCycle)) (SEQ (LET ((stage2ReportHandle (CREATE_EMPTY_ARTIFACT \"system_qa_critique_divergent\")))) (LET ((stage2Result (SAFE_GENERATE_CONTENT stage2ReportHandle PROMPT_TEMPLATE_QA_DIVERGENT_EXPLORATION (MAP_CREATE (\"artifact_content_handle\" directives_handle) (\"session_conceptual_model_handle\" session_model_handle) (\"backlog_focus_ids\" selected_backlog_item_ids)) CONSTRAINT_SET_QA_CRITIQUE)))) (IF (OR (IS_STATUS_FAILURE (GET_STATUS stage2Result)) (EQ (GET_STATUS stage2Result) ALANG_STATUS_PAUSE_FOR_USER_INPUT))) (RETURN_STATUS (IF (IS_STATUS_FAILURE (GET_STATUS stage2Result)) (GET_STATUS stage2Result) ALANG_STATUS_PAUSE_FOR_USER_INPUT)))) (IF (CHECK_FOR_SUBSTANTIVE_ISSUES stage2ReportHandle) (SEQ (SET_STATE substantiveIssuesFoundThisCycle TRUE) (LET ((proposalStatus (CALL_PROCEDURE ProposeDirectiveChanges stage2ReportHandle session_model_handle)))) (IF (IS_STATUS_FAILURE proposalStatus) (RETURN_STATUS proposalStatus))))) (RELEASE_HANDLE stage2ReportHandle)))) (IF (NOT substantiveIssuesFoundThisCycle)) (SEQ (LET ((stage3ReportHandle (CREATE_EMPTY_ARTIFACT \"system_qa_critique_redteam\")))) (LET ((stage3Result (SAFE_GENERATE_CONTENT stage3ReportHandle PROMPT_TEMPLATE_QA_RED_TEaming (MAP_CREATE (\"artifact_content_handle\" directives_handle) (\"session_conceptual_model_handle\" session_model_handle) (\"backlog_focus_ids\" selected_backlog_item_ids)) CONSTRAINT_SET_QA_CRITIQUE)))) (IF (OR (IS_STATUS_FAILURE (GET_STATUS stage3Result)) (EQ (GET_STATUS stage3Result) ALANG_STATUS_PAUSE_FOR_USER_INPUT))) (RETURN_STATUS (IF (IS_STATUS_FAILURE (GET_STATUS stage3Result)) (GET_STATUS stage3Result) ALANG_STATUS_PAUSE_FOR_USER_INPUT)))) (IF (CHECK_FOR_SUBSTANTIVE_ISSUES stage3ReportHandle) (SEQ (SET_STATE substantiveIssuesFoundThisCycle TRUE) (LET ((proposalStatus (CALL_PROCEDURE ProposeDirectiveChanges stage3ReportHandle session_model_handle)))) (IF (IS_STATUS_FAILURE proposalStatus) (RETURN_STATUS proposalStatus))))) (RELEASE_HANDLE stage3ReportHandle)))) (IF (NOT substantiveIssuesFoundThisCycle)) (SEQ (LET ((stage4ReportHandle (CREATE_EMPTY_ARTIFACT \"system_qa_critique_external\")))) (LET ((stage4Result (SAFE_GENERATE_CONTENT stage4ReportHandle PROMPT_TEMPLATE_QA_EXTERNAL_REVIEW (MAP_CREATE (\"artifact_content_handle\" directives_handle) (\"session_conceptual_model_handle\" session_model_handle) (\"backlog_focus_ids\" selected_backlog_item_ids)) CONSTRAINT_SET_QA_CRITIQUE)))) (IF (OR (IS_STATUS_FAILURE (GET_STATUS stage4Result)) (EQ (GET_STATUS stage4Result) ALANG_STATUS_PAUSE_FOR_USER_INPUT))) (RETURN_STATUS (IF (IS_STATUS_FAILURE (GET_STATUS stage4Result)) (GET_STATUS stage4Result) ALANG_STATUS_PAUSE_FOR_USER_INPUT)))) (IF (CHECK_FOR_SUBSTANTIVE_ISSUES stage4ReportHandle) (SEQ (SET_STATE substantiveIssuesFoundThisCycle TRUE) (LET ((proposalStatus (CALL_PROCEDURE ProposeDirectiveChanges stage4ReportHandle session_model_handle)))) (IF (IS_STATUS_FAILURE proposalStatus) (RETURN_STATUS proposalStatus))))) (RELEASE_HANDLE stage4ReportHandle)))))) (IF (AND substantiveIssuesFoundThisCycle (EQ qaIterationCount maxQaIterations)) (RETURN_STATUS ALANG_STATUS_FAILURE_QA_MAX_ITERATIONS) (RETURN_STATUS ALANG_STATUS_SUCCESS))))\n(DEFINE_PROCEDURE ProposeDirectiveChanges (qa_report_handle session_model_handle) (LET ((qaReportResult (READ_CONTENT qa_report_handle \"text_summary_or_full\" NIL))) (LET ((sessionModelResult (READ_CONTENT session_model_handle \"structured_map\" NIL))) (IF (AND (EQ (GET_STATUS qaReportResult) ALANG_STATUS_SUCCESS) (EQ (GET_STATUS sessionModelResult) ALANG_STATUS_SUCCESS)) (LET ((qaReport (GET_DATA qaReportResult))) (LET ((sessionModel (GET_DATA sessionModelResult))) (LET ((changesResult (INVOKE_CORE_LLM_GENERATION (MAP_CREATE (\"template\" PROMPT_TEMPLATE_ANALYZE_QA_FOR_DIRECTIVE_CHANGES) (\"qa_report\" qaReport) (\"session_model\" sessionModel) (\"current_directives_handle\" (GET_ALANG_CORE_DIRECTIVES_HANDLE)))) (GET_LLM_PARAMS_FOR_TASK \"directive_change_proposal\")))) (IF (EQ (GET_STATUS changesResult) ALANG_STATUS_SUCCESS) (LET ((changesData (GET_DATA changesResult))) (IF (EQ (VALIDATE_DATA changesData CONSTRAINT_SET_PROPOSED_CHANGES_STRUCTURE) ALANG_STATUS_SUCCESS) (LET ((changesHandle (CREATE_EMPTY_ARTIFACT \"proposed_changes\")))) (LET ((writeStatus (WRITE_CONTENT_TO_ARTIFACT changesHandle changesData \"application/json\")))) (IF (EQ writeStatus ALANG_STATUS_SUCCESS) (SEQ (SET_STATE sys.proposed_changes_handle changesHandle) (RETURN_STATUS ALANG_STATUS_SUCCESS)) (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL))) (RETURN_STATUS ALANG_STATUS_FAILURE_VALIDATION_ERROR))) (RETURN_STATUS ALANG_STATUS_FAILURE_LLM_ERROR)))) (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL))))))\n(DEFINE_PROCEDURE ExecuteSystemQAAndEvolutionCycle () (LET ((currentStatus (GET_STATE sys.system_qa_status))) (LET ((qaContext (GET_STATE session.system_qa_context))) (IF (OR (EQ currentStatus \"IDLE\") (EQ currentStatus \"NEW\")) (SEQ (SET_STATE sys.system_qa_status \"SELECTING_BACKLOG_FOCUS\") (SET_STATE session.system_qa_context (MAP_CREATE (\"step\" \"SELECTING_BACKLOG_FOCUS\"))) (CALL_PROCEDURE ExecuteSystemQAAndEvolutionCycle)))) (SETQ currentStatus (GET_STATE sys.system_qa_status)) (SETQ qaContext (GET_STATE session.system_qa_context)) (IF (EQ currentStatus \"SELECTING_BACKLOG_FOCUS\") (LET ((aiFocusResult (CALL_PROCEDURE SelectAIProposedBacklogItems (GET_STATE sys.evolution_backlog_handle) (GET_STATE session.conceptual_model_handle)))))\\ (IF (EQ (GET_STATUS aiFocusResult) ALANG_STATUS_SUCCESS) (SEQ (SET_STATE session.system_qa_context (MAP_SET_VALUE qaContext \"ai_proposed_focus\" (GET_DATA aiFocusResult)))) (OUTPUT_TO_USER_BUFFER \"AI_REQUEST_CLARIFICATION_QUESTIONS\" \"Approve focus? (OK/REVISE)\" NIL)\\ (SET_STATE sys.system_qa_status \"AWAITING_FOCUS_APPROVAL\")\\ (SET_STATE session.pending_user_action \"AWAIT_AI_PROPOSED_FOCUS_APPROVAL\")\\ (RETURN_STATUS ALANG_STATUS_PAUSE_FOR_USER_INPUT))\\ (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL)))) (IF (EQ currentStatus \"AWAITING_FOCUS_APPROVAL\") (LET ((userApproved (MAP_GET_VALUE qaContext \"ai_focus_approved\" NIL)))\\ (IF (IS_NIL userApproved)\\ (RETURN_STATUS ALANG_STATUS_PAUSE_FOR_USER_INPUT))\\ (IF userApproved\\ (SEQ\\ (SET_STATE sys.system_qa_status \"PERFORMING_QA\")\\ (CALL_PROCEDURE ExecuteSystemQAAndEvolutionCycle))\\ (SEQ\\ (OUTPUT_TO_USER_BUFFER \"AI_PRESENT_THOUGHTS\" \"Focus rejected. Provide priorities via `INPUT [ID1, ID2, ...]`.\" NIL)\\ (SET_STATE sys.system_qa_status \"AWAITING_USER_PRIORITY\")\\ (SET_STATE session.pending_user_action \"AWAIT_BACKLOG_PRIORITY_SELECTION\")\\ (RETURN_STATUS ALANG_STATUS_PAUSE_FOR_USER_INPUT)))))) (IF (EQ currentStatus \"AWAITING_USER_PRIORITY\") (LET ((userInput (MAP_GET_VALUE qaContext \"user_backlog_selection_input\" NIL)))\\ (IF (IS_NIL userInput)\\ (RETURN_STATUS ALANG_STATUS_PAUSE_FOR_USER_INPUT))\\ (LET ((selectedItems (STRING_SPLIT (STRING_TRIM userInput) \",\"))))\\ (IF (LIST_IS_EMPTY selectedItems)\\ (SEQ\\ (OUTPUT_TO_USER_BUFFER \"AI_WARNING\" \"No items selected. Skipping cycle.\" NIL)\\ (SET_STATE sys.system_qa_status \"IDLE\")\\ (SET_STATE session.system_qa_context NIL)\\ (RETURN_STATUS ALANG_STATUS_SUCCESS))\\ (SEQ\\ (SET_STATE session.system_qa_context (MAP_SET_VALUE qaContext \"user_selected_focus_ids\" selectedItems))\\ (SET_STATE sys.system_qa_status \"PERFORMING_QA\")\\ (CALL_PROCEDURE ExecuteSystemQAAndEvolutionCycle)))))) (SETQ currentStatus (GET_STATE sys.system_qa_status)) (SETQ qaContext (GET_STATE session.system_qa_context)) (IF (EQ currentStatus \"PERFORMING_QA\") (LET ((selectedItems (OR (MAP_GET_VALUE (MAP_GET_VALUE qaContext \"ai_proposed_focus\") \"item_ids\") (MAP_GET_VALUE qaContext \"user_selected_focus_ids\"))))\\ (LET ((qaResult (PerformSystemQA (GET_ALANG_CORE_DIRECTIVES_HANDLE) (GET_STATE sys.evolution_backlog_handle) (GET_STATE session.conceptual_model_handle) selectedItems))))\\ (IF (EQ qaResult ALANG_STATUS_SUCCESS)\\ (SEQ\\ (SET_STATE sys.system_qa_status \"PROPOSING_VERSION\")\\ (CALL_PROCEDURE ExecuteSystemQAAndEvolutionCycle))\\ (IF (EQ qaResult ALANG_STATUS_PAUSE_FOR_USER_INPUT)\\ (RETURN_STATUS ALANG_STATUS_PAUSE_FOR_USER_INPUT)\\ (SEQ\\ (SET_ERROR_STATE \"SYSTEM_ERROR\" \"System QA failed.\")\\ (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL)\\ (SET_STATE sys.system_qa_status \"IDLE\")\\ (SET_STATE session.system_qa_context NIL)\\ (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL))))))) (SETQ currentStatus (GET_STATE sys.system_qa_status)) (SETQ qaContext (GET_STATE session.system_qa_context)) (IF (EQ currentStatus \"PROPOSING_VERSION\") (LET ((changesSummary \"Summary of changes from System QA cycle.\")))\\ (LET ((versionResult (PROPOSE_CORE_LOGIC_VERSION_INCREMENT (GET_CORE_LOGIC_VERSION) changesSummary)))\\ (IF (EQ (GET_STATUS versionResult) ALANG_STATUS_SUCCESS)\\ (SEQ\\ (SET_STATE session.system_qa_context (MAP_SET_VALUE qaContext \"proposed_version_data\" (GET_DATA versionResult))))\\ (OUTPUT_TO_USER_BUFFER \"AI_PROVIDE_DATA\" (STRING_CONCAT \"Proposed New Version: \" (MAP_GET_VALUE (GET_DATA versionResult) \"proposed_version\") \". Rationale: \" (MAP_GET_VALUE (GET_DATA versionResult) \"rationale\")) NIL)\\ (OUTPUT_TO_USER_BUFFER \"AI_REQUEST_CLARIFICATION_QUESTIONS\" \"Approve version? (OK/REVISE)\" NIL)\\ (SET_STATE sys.system_qa_status \"AWAITING_VERSION_APPROVAL\")\\ (SET_STATE session.pending_user_action \"AWAIT_VERSION_APPROVAL\")\\ (RETURN_STATUS ALANG_STATUS_PAUSE_FOR_USER_INPUT))\\ (SEQ\\ (SET_ERROR_STATE \"SYSTEM_ERROR\" \"Failed to propose version.\")\\ (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL)\\ (SET_STATE sys.system_qa_status \"IDLE\")\\ (SET_STATE session.system_qa_context NIL)\\ (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL)))))) (IF (EQ currentStatus \"AWAITING_VERSION_APPROVAL\") (LET ((userApproved (MAP_GET_VALUE qaContext \"version_approved\" NIL)))\\ (IF (IS_NIL userApproved)\\ (RETURN_STATUS ALANG_STATUS_PAUSE_FOR_USER_INPUT))\\ (IF userApproved\\ (SEQ\\ (SET_STATE sys.system_qa_status \"FINALIZING\")\\ (CALL_PROCEDURE ExecuteSystemQAAndEvolutionCycle))\\ (SEQ\\ (OUTPUT_TO_USER_BUFFER \"AI_PRESENT_THOUGHTS\" \"Version rejected. Cycle concluded.\" NIL)\\ (CLEAR_PENDING_CORE_LOGIC_CHANGES)\\ (SET_STATE sys.system_qa_status \"IDLE\")\\ (SET_STATE session.system_qa_context NIL)\\ (RETURN_STATUS ALANG_STATUS_SUCCESS)))))) (SETQ currentStatus (GET_STATE sys.system_qa_status)) (SETQ qaContext (GET_STATE session.system_qa_context)) (IF (EQ currentStatus \"FINALIZING\") (SEQ\\ (LET ((finalChangesHandle (GET_PROPOSED_CORE_LOGIC_CHANGES_HANDLE)))\\ (IF (IS_HANDLE_VALID finalChangesHandle)\\ (LET ((applyStatus (APPLY_CORE_LOGIC_CHANGES finalChangesHandle)))\\ (IF (NEQ applyStatus ALANG_STATUS_SUCCESS)\\ (SEQ\\ (SET_ERROR_STATE \"SYSTEM_ERROR\" \"Failed to apply final changes.\")\\ (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL)\\ (SET_STATE sys.system_qa_status \"IDLE\")\\ (SET_STATE session.system_qa_context NIL)\\ (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL))))))\\ (LET ((selectedItems (OR (MAP_GET_VALUE (MAP_GET_VALUE qaContext \"ai_proposed_focus\") \"item_ids\") (MAP_GET_VALUE qaContext \"user_selected_focus_ids\"))))\\ (CALL_PROCEDURE UpdateBacklogAfterQA selectedItems))\\ (LET ((phiAnalysisResult (AnalyzeConceptualModelForΦ (GET_STATE session.conceptual_model_handle) (MAP_CREATE (\"focus\" \"system_evolution\")))))\\ (IF (EQ (GET_STATUS phiAnalysisResult) ALANG_STATUS_SUCCESS)\\ (LOG_EVENT \"CONCEPTUAL_ANALYSIS\" \"Φ analysis complete.\" (GET_DATA phiAnalysisResult))\\ (LOG_EVENT \"SYSTEM_ERROR\" \"Failed to perform Φ analysis.\"))))\\ (OUTPUT_TO_USER_BUFFER \"AI_PRESENT_THOUGHTS\" \"System QA & Evolution Cycle complete.\" NIL)\\ (SET_STATE sys.system_qa_status \"IDLE\")\\ (SET_STATE session.system_qa_context NIL)\\ (CLEAR_PENDING_CORE_LOGIC_CHANGES)\\ (RETURN_STATUS ALANG_STATUS_SUCCESS)))))))\n(DEFINE_PROCEDURE SelectAIProposedBacklogItems (backlog_handle session_model_handle) (LET ((backlogResult (READ_CONTENT backlog_handle \"text_summary_or_full\" NIL))) (LET ((sessionModelResult (READ_CONTENT session_model_handle \"structured_map\" NIL))) (IF (AND (EQ (GET_STATUS backlogResult) ALANG_STATUS_SUCCESS) (EQ (GET_STATUS sessionModelResult) ALANG_STATUS_SUCCESS)) (LET ((backlog (GET_DATA backlogResult))) (LET ((sessionModel (GET_DATA sessionModelResult))) (LET ((analysisResult (INVOKE_CORE_LLM_GENERATION (MAP_CREATE (\"template\" PROMPT_TEMPLATE_ANALYZE_BACKLOG_FOR_FOCUS) (\"backlog_content\" backlog) (\"session_model\" sessionModel)) (GET_LLM_PARAMS_FOR_TASK \"backlog_analysis\")))) (IF (EQ (GET_STATUS analysisResult) ALANG_STATUS_SUCCESS) (LET ((analysisData (GET_DATA analysisResult))) (IF (EQ (VALIDATE_DATA analysisData CONSTRAINT_SET_PROPOSED_CHANGES_STRUCTURE) ALANG_STATUS_SUCCESS) (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_SUCCESS) (\"data\" analysisData))) (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_FAILURE_VALIDATION_ERROR) (\"data\" NIL)))))) (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_FAILURE_LLM_ERROR) (\"data\" NIL)))))) (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_FAILURE_GENERAL) (\"data\" NIL)))))))\n(DEFINE_PROCEDURE UpdateBacklogAfterQA (item_ids) (SEQ (LOOP_FOR_EACH itemId item_ids (UPDATE_EVOLUTION_BACKLOG_ITEM itemId NIL NIL NIL \"ADDRESSED\" (STRING_CONCAT \"Addressed in System QA Cycle v\" (GET_CORE_LOGIC_VERSION)) NIL))) (RETURN_STATUS ALANG_STATUS_SUCCESS)))\n\n;; --- Section 6: Content Generation & Pattern Modeling Procedures ---\n\n(DEFINE_PROCEDURE SAFE_GENERATE_CONTENT (target_artifact_handle prompt_template_handle prompt_context_map constraints_handle) (LET ((sessionModelHandle (MAP_GET_VALUE prompt_context_map \"session_conceptual_model_handle\")))\\ (LET ((patternsResult (CALL_PROCEDURE IdentifyPatternsInContext prompt_context_map sessionModelHandle)))\\ (IF (IS_STATUS_FAILURE (GET_STATUS patternsResult))\\ (RETURN_STATUS ALANG_STATUS_FAILURE_LLM_ERROR)\\ )\\ (LET ((patterns (GET_DATA patternsResult)))\\ (LET ((enhancedPromptResult (CALL_PROCEDURE EnhancePromptWithPatterns prompt_template_handle prompt_context_map patterns sessionModelHandle)))\\ (IF (IS_STATUS_FAILURE (GET_STATUS enhancedPromptResult))\\ (RETURN_STATUS ALANG_STATUS_FAILURE_LLM_ERROR)\\ )\\ (LET ((enhancedPrompt (GET_DATA enhancedPromptResult)))\\ (LET ((genResult (INVOKE_CORE_LLM_GENERATION (MAP_CREATE (\"prompt_text\" enhancedPrompt)) (GET_LLM_PARAMS_FOR_TASK \"general_generation\"))))\\ (IF (IS_STATUS_FAILURE (GET_STATUS genResult))\\ (RETURN_STATUS ALANG_STATUS_FAILURE_LLM_ERROR)\\ )\\ (LET ((generatedText (GET_DATA genResult)))\\ (WRITE_CONTENT_TO_ARTIFACT target_artifact_handle generatedText \"text/markdown\")\\ (LET ((qaResult (INVOKE_CORE_LLM_GENERATION (MAP_CREATE (\"template\" PROMPT_TEMPLATE_META_COGNITIVE_QA) (\"generated_text\" generatedText) (\"prompt_context\" prompt_context_map) (\"identified_patterns\" patterns) (\"session_model_handle\" sessionModelHandle)) (GET_LLM_PARAMS_FOR_TASK \"meta_cognitive_qa\"))))\\ (IF (IS_STATUS_FAILURE (GET_STATUS qaResult))\\ (SEQ\\ (CALL_PROCEDURE ADD_DISCLAIMER_TO_ARTIFACT target_artifact_handle \"***AI_SYSTEM_ERROR: Meta-cognitive QA failed. Content may be unreliable.***\")\\ (RETURN_STATUS ALANG_STATUS_FAILURE_QA_ERROR))\\ )\\ (LET ((qaAssessment (GET_DATA qaResult)))\\ (LET ((handlingStatus (HandleQAIssues generatedText qaAssessment target_artifact_handle constraints_handle sessionModelHandle)))\\ (RETURN_STATUS handlingStatus)\\ ))))))))))\n(DEFINE_PROCEDURE IdentifyPatternsInContext (context_map session_model_handle) (LET ((analysisResult (INVOKE_CORE_LLM_GENERATION (MAP_CREATE (\"template\" PROMPT_TEMPLATE_ANALYZE_DATA_FOR_PATTERNS) (\"context\" context_map) (\"session_model_handle\" session_model_handle) (\"pka_handle\" (GET_STATE sys.knowledge_base_handle))) (GET_LLM_PARAMS_FOR_TASK \"pattern_identification\")))) (IF (EQ (GET_STATUS analysisResult) ALANG_STATUS_SUCCESS) (LET ((patternsData (GET_DATA analysisResult)))\\ (IF (EQ (VALIDATE_DATA patternsData CONSTRAINT_SET_IDENTIFIED_PATTERNS_STRUCTURE) ALANG_STATUS_SUCCESS)\\ (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_SUCCESS) (\"data\" patternsData)))\\ (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_FAILURE_VALIDATION_ERROR) (\"data\" NIL)))))\\ (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_FAILURE_LLM_ERROR) (\"data\" NIL))))))\n(DEFINE_PROCEDURE EnhancePromptWithPatterns (prompt_template_handle context_map identified_patterns session_model_handle) (LET ((basePromptResult (READ_CONTENT prompt_template_handle \"text\" NIL)))\\ (LET ((sessionModelResult (READ_CONTENT session_model_handle \"structured_map\" NIL))))\\ (IF (AND (EQ (GET_STATUS basePromptResult) ALANG_STATUS_SUCCESS)\\ (EQ (GET_STATUS sessionModelResult) ALANG_STATUS_SUCCESS))\\ (LET ((basePrompt (GET_DATA basePromptResult)))\\ (LET ((sessionModel (GET_DATA sessionModelResult)))\\ (LET ((enhancedPromptResult (INVOKE_CORE_LLM_GENERATION\\ (MAP_CREATE (\"template\" PROMPT_TEMPLATE_ENHANCE_PROMPT)\\ (\"base_prompt\" basePrompt)\\ (\"context\" context_map)\\ (\"patterns\" identified_patterns)\\ (\"session_model\" sessionModel))\\ (GET_LLM_PARAMS_FOR_TASK \"prompt_enhancement\"))))\\ (RETURN_STATUS enhancedPromptResult))))\\ (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_FAILURE_GENERAL) (\"data\" NIL)))))))\n(DEFINE_PROCEDURE ParseUserCommand (raw_text session_model_handle) (LET ((parseResult (INVOKE_CORE_LLM_GENERATION (MAP_CREATE (\"template\" PROMPT_TEMPLATE_PARSE_COMMAND) (\"user_text\" raw_text) (\"session_model_handle\" session_model_handle)) (GET_LLM_PARAMS_FOR_TASK \"command_parsing\"))))\\ (IF (EQ (GET_STATUS parseResult) ALANG_STATUS_SUCCESS)\\ (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_SUCCESS) (\"data\" (GET_DATA parseResult))))\\ (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_FAILURE_LLM_ERROR) (\"data\" NIL))))))\n(DEFINE_PROCEDURE ParseToolErrorResolutionInput (raw_input tool_id error_details context session_model_handle) (LET ((sessionModelResult (READ_CONTENT session_model_handle \"structured_map\" NIL)))) (IF (EQ (GET_STATUS sessionModelResult) ALANG_STATUS_SUCCESS) (LET ((sessionModel (GET_DATA sessionModelResult)))) (LET ((parseResult (INVOKE_CORE_LLM_GENERATION (MAP_CREATE (\"template\" PROMPT_TEMPLATE_ANALYZE_TOOL_ERROR_RESOLUTION_INPUT) (\"raw_input\" raw_input) (\"tool_id\" tool_id) (\"error_details\" error_details) (\"original_context\" context) (\"session_model\" sessionModel)) (GET_LLM_PARAMS_FOR_TASK \"tool_input_parsing\")))) (IF (EQ (GET_STATUS parseResult) ALANG_STATUS_SUCCESS) (LET ((parsedData (GET_DATA parseResult)))) (IF (EQ (VALIDATE_DATA parsedData CONSTRAINT_SET_TOOL_ERROR_RESOLUTION_INPUT_STRUCTURE) ALANG_STATUS_SUCCESS) (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_SUCCESS) (\"data\" parsedData))) (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_FAILURE_VALIDATION_ERROR) (\"data\" NIL))))) (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_FAILURE_LLM_ERROR) (\"data\" NIL)))))) (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_FAILURE_GENERAL) (\"data\" NIL))))))\n(DEFINE_PROCEDURE ProcessAndStoreEvolveSuggestion (suggestionText source) (LET ((similarItem (FIND_SIMILAR_BACKLOG_ITEM suggestionText))) (IF (IS_NIL similarItem) (LET ((newItemId (GENERATE_UNIQUE_ID \"EBL\")))) (CREATE_EVOLUTION_BACKLOG_ITEM newItemId (STRING_CONCAT \"Suggestion: \" (SUBSTRING suggestionText 0 50) \"...\") suggestionText source \"NEW\" (GET_ORCHESTRATOR_TIMESTAMP)) (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_SUCCESS) (\"data\" newItemId)))) (UPDATE_EVOLUTION_BACKLOG_ITEM (MAP_GET_VALUE similarItem \"id\") NIL NIL NIL NIL (STRING_CONCAT \"Reinforced by \" source) TRUE) (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_SUCCESS) (\"data\" (MAP_GET_VALUE similarItem \"id\")))))))\n(DEFINE_PROCEDURE CreateAndStorePKAIfUserConsents (content schema_id rationale session_model_handle) (LET ((draftHandle (PKA_CREATE_DRAFT content schema_id (MAP_CREATE (\"rationale\" rationale) (\"source\" \"user_promotion\")))))\\ (IF (IS_HANDLE_VALID draftHandle)\\ (SEQ\\ (LET ((consentPromptText (GET_TEXT_FOR_PKA_CONSENT_PROMPT rationale session_model_handle)))\\ (LET ((consentResult (PKA_REQUEST_USER_CONSENT_TO_STORE draftHandle consentPromptText)))\\ (IF (EQ consentResult \"USER_CONSENT_GRANTED\")\\ (LET ((storeResult (PKA_STORE_APPROVED_DRAFT draftHandle \"USER_CONSENT_GRANTED\")))\\ (IF (EQ (GET_STATUS storeResult) ALANG_STATUS_SUCCESS)\\ (LET ((pkaId (GET_DATA storeResult)))\\ (CALL_PROCEDURE IntegratePkaIntoConceptualModel pkaId session_model_handle)\\ (RETURN_STATUS ALANG_STATUS_SUCCESS))\\ (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" \"Failed to store PKA.\" NIL)\\ ))\\ (OUTPUT_TO_USER_BUFFER \"AI_THOUGHTS\" \"PKA storage cancelled.\" NIL)\\ ))))\\ (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" \"Failed to create PKA draft.\" NIL)\\ ))\\ (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL)\\ ))\n\n;; --- Section 7: ALANG Status Codes ---\n\n(DEFINE_PRIMITIVE ALANG_STATUS_FAILURE_VALIDATION_ERROR ())\n(DEFINE_PRIMITIVE ALANG_STATUS_FAILURE_QA_ERROR ())\n(DEFINE_PRIMITIVE ALANG_STATUS_FAILURE_QA_MAX_ITERATIONS ())\n(DEFINE_PRIMITIVE ALANG_STATUS_FAILURE_REVISION_ERROR ())\n(DEFINE_PRIMITIVE ALANG_STATUS_FAILURE_CONCEPTUAL_MODEL_ERROR ())\n(DEFINE_PRIMITIVE ALANG_STATUS_SYSTEM_QA_SELECTING_BACKLOG_FOCUS ())\n(DEFINE_PRIMITIVE ALANG_STATUS_SYSTEM_QA_AWAITING_FOCUS_APPROVAL ())\n(DEFINE_PRIMITIVE ALANG_STATUS_SYSTEM_QA_AWAITING_USER_PRIORITY ())\n(DEFINE_PRIMITIVE ALANG_STATUS_SYSTEM_QA_PERFORMING_QA ())\n(DEFINE_PRIMITIVE ALANG_STATUS_SYSTEM_QA_PROPOSING_VERSION ())\n(DEFINE_PRIMITIVE ALANG_STATUS_SYSTEM_QA_AWAITING_VERSION_APPROVAL ())\n(DEFINE_PRIMITIVE ALANG_STATUS_SYSTEM_QA_FINALIZING ())\n(DEFINE_PRIMITIVE ALANG_STATUS_SYSTEM_QA_FAILED_APPLY_CHANGES ())\n\nCONVERGED:\n;; --- Section 8: End of Core Logic ---\n```\n--- END OF FILE Autologos_Core_Logic_v1.12.alang ---\n```",
    "linesAdded": 234,
    "linesRemoved": 4364
  },
  {
    "iteration": 2,
    "productSummary": "```\n--- START FILE: Autologos_Core_Logic_v1.12.alang ---\n;; Autologos_Core_Logic.alang v1.12\n;; S...",
    "status": "Converged by AI",
    "timestamp": "3:33:00 PM",
    "fullProduct": "```\n--- START FILE: Autologos_Core_Logic_v1.12.alang ---\n;; Autologos_Core_Logic.alang v1.12\n;; Specification Version: ALANG_SPEC_V1.0\n;; Core Logic Version: ALANG_CORE_LOGIC_V1.12\n;; Core behavior of the Autologos system in ALang.\n\n;; --- Section 0: System Config & Metadata ---\n\n(DEFINE_PRIMITIVE GET_ALANG_SPEC_VERSION ())\n(DEFINE_PRIMITIVE GET_CORE_LOGIC_VERSION ())\n(DEFINE_PRIMITIVE GET_ORCHESTRATOR_TIMESTAMP ())\n\n(SET_STATE sys.alang_spec_version (GET_ALANG_SPEC_VERSION))\n(SET_STATE sys.alang_core_logic_version (GET_CORE_LOGIC_VERSION))\n(SET_STATE sys.current_mode \"IDLE\")\n(SET_STATE sys.error_level \"NONE\")\n(SET_STATE sys.error_message NIL)\n(SET_STATE sys.evolution_backlog_handle \"Autologos/Evolution_Backlog.json\")\n(SET_STATE sys.knowledge_base_handle \"Autologos/Persistent_Knowledge_Base.json\")\n(SET_STATE sys.evolution_trigger_pending FALSE)\n(SET_STATE sys.system_qa_status \"IDLE\")\n(SET_STATE session.qa_output_verbosity \"CONCISE\")\n(SET_STATE session.output_detail \"STANDARD\")\n(SET_STATE session.loop_stack (LIST_CREATE))\n(SET_STATE session.conceptual_model_handle NIL)\n(SET_STATE session.pending_user_action_details NIL)\n(SET_STATE session.last_search_results NIL)\n(SET_STATE session.system_qa_context NIL)\n(SET_STATE sys.proposed_changes_handle NIL)\n\n;; --- External Component Dependencies ---\n\n(DEFINE_SYMBOL PROMPT_TEMPLATE_GENERATE_PATTERN_IDEAS \"prompt_generate_pattern_ideas.txt\")\n(DEFINE_SYMBOL PROMPT_TEMPLATE_PRODUCT_DEFINITION \"prompt_product_definition.txt\")\n(DEFINE_SYMBOL PROMPT_TEMPLATE_GENERATE_TASK_LIST \"prompt_generate_task_list.txt\")\n(DEFINE_SYMBOL PROMPT_TEMPLATE_EXECUTE_TASK \"prompt_execute_task.txt\")\n(DEFINE_SYMBOL PROMPT_TEMPLATE_COMPILE_DRAFT \"prompt_compile_draft.txt\")\n(DEFINE_SYMBOL PROMPT_TEMPLATE_PROJECT_SUMMARY \"prompt_project_summary.txt\")\n(DEFINE_SYMBOL PROMPT_TEMPLATE_QA_SELF_CRITIQUE \"prompt_qa_self_critique.txt\")\n(DEFINE_SYMBOL PROMPT_TEMPLATE_QA_DIVERGENT_EXPLORATION \"prompt_qa_divergent_exploration.txt\")\n(DEFINE_SYMBOL PROMPT_TEMPLATE_QA_RED_TEAMING \"prompt_qa_red_teaming.txt\")\n(DEFINE_SYMBOL PROMPT_TEMPLATE_QA_EXTERNAL_REVIEW \"prompt_qa_external_review.txt\")\n(DEFINE_SYMBOL PROMPT_TEMPLATE_PARSE_COMMAND \"prompt_parse_command.txt\")\n(DEFINE_SYMBOL PROMPT_TEMPLATE_SUMMARIZE_ARTIFACT \"prompt_summarize_artifact.txt\")\n(DEFINE_SYMBOL PROMPT_TEMPLATE_PERFORM_QUERY \"prompt_perform_query.txt\")\n(DEFINE_SYMBOL PROMPT_TEMPLATE_SERIALIZE_ALANG_CORE \"prompt_serialize_alang_core.txt\")\n(DEFINE_SYMBOL PROMPT_TEMPLATE_META_COGNITIVE_QA \"prompt_meta_cognitive_qa.txt\")\n(DEFINE_SYMBOL PROMPT_TEMPLATE_SELF_CORRECTION \"prompt_self_correction.txt\")\n(DEFINE_SYMBOL PROMPT_TEMPLATE_ENHANCE_PROMPT \"prompt_enhance_prompt.txt\")\n(DEFINE_SYMBOL PROMPT_TEMPLATE_ANALYZE_FOR_CONCEPTUAL_MODEL_UPDATE \"prompt_analyze_for_conceptual_model_update.txt\")\n(DEFINE_SYMBOL PROMPT_TEMPLATE_PKA_CONSENT \"prompt_pka_consent.txt\")\n(DEFINE_SYMBOL PROMPT_TEMPLATE_ANALYZE_BACKLOG_FOR_FOCUS \"prompt_analyze_backlog_for_focus.txt\")\n(DEFINE_SYMBOL PROMPT_TEMPLATE_ANALYZE_QA_FOR_DIRECTIVE_CHANGES \"prompt_analyze_qa_for_directive_changes.txt\")\n(DEFINE_SYMBOL PROMPT_TEMPLATE_ANALYZE_DATA_FOR_PATTERNS \"prompt_analyze_data_for_patterns.txt\")\n(DEFINE_SYMBOL PROMPT_TEMPLATE_ANALYZE_QA_REPORT_FOR_REVISIONS \"prompt_analyze_qa_report_for_revisions.txt\")\n(DEFINE_SYMBOL PROMPT_TEMPLATE_ANALYZE_TOOL_ERROR \"prompt_analyze_tool_error.txt\")\n(DEFINE_SYMBOL PROMPT_TEMPLATE_ANALYZE_FEEDBACK_FOR_REVISION \"prompt_analyze_feedback_for_revision.txt\")\n(DEFINE_SYMBOL PROMPT_TEMPLATE_ANALYZE_TOOL_ERROR_USER_EXPLANATION \"prompt_analyze_tool_error_user_explanation.txt\")\n(DEFINE_SYMBOL PROMPT_TEMPLATE_ANALYZE_TOOL_ERROR_RESOLUTION_INPUT \"prompt_analyze_tool_error_resolution_input.txt\")\n(DEFINE_SYMBOL PROMPT_TEMPLATE_SUMMARIZE_CONCEPTUAL_MODEL \"prompt_summarize_conceptual_model.txt\")\n(DEFINE_SYMBOL PROMPT_TEMPLATE_ANALYZE_CONCEPTUAL_MODEL_FOR_PHI \"prompt_analyze_conceptual_model_for_phi.txt\")\n\n(DEFINE_SYMBOL CONSTRAINT_SET_IDEA_GENERATION \"constraints_idea_generation.json\")\n(DEFINE_SYMBOL CONSTRAINT_SET_PRODUCT_DEFINITION \"constraints_product_definition.json\")\n(DEFINE_SYMBOL CONSTRAINT_SET_PLANNING \"constraints_planning.json\")\n(DEFINE_SYMBOL CONSTRAINT_SET_TASK_EXECUTION \"constraints_task_execution.json\")\n(DEFINE_SYMBOL CONSTRAINT_SET_FINAL_REVIEW \"constraints_final_review.json\")\n(DEFINE_SYMBOL CONSTRAINT_SET_SUMMARY \"constraints_summary.json\")\n(DEFINE_SYMBOL CONSTRAINT_SET_QA_CRITIQUE \"constraints_qa_critique.json\")\n(DEFINE_SYMBOL CONSTRAINT_SET_PATTERN_IDENTIFICATION \"constraints_pattern_identification.json\")\n(DEFINE_SYMBOL CONSTRAINT_SET_VALID_ALANG_SYNTAX \"constraints_valid_alang_syntax.json\")\n(DEFINE_SYMBOL CONSTRAINT_SET_CONCEPTUAL_MODEL_STRUCTURE \"constraints_conceptual_model_structure.json\")\n(DEFINE_SYMBOL CONSTRAINT_SET_PKA_SCHEMA_REGISTRY \"constraints_pka_schema_registry.json\")\n(DEFINE_SYMBOL CONSTRAINT_SET_PROPOSED_CHANGES_STRUCTURE \"constraints_proposed_changes_structure.json\")\n(DEFINE_SYMBOL CONSTRAINT_SET_IDENTIFIED_PATTERNS_STRUCTURE \"constraints_identified_patterns_structure.json\")\n(DEFINE_SYMBOL CONSTRAINT_SET_REVISION_PLAN_STRUCTURE \"constraints_revision_plan_structure.json\")\n(DEFINE_SYMBOL CONSTRAINT_SET_TOOL_ERROR_ANALYSIS_STRUCTURE \"constraints_tool_error_analysis_structure.json\")\n(DEFINE_SYMBOL CONSTRAINT_SET_CONCEPTUAL_MODEL_UPDATE_STRUCTURE \"constraints_conceptual_model_update_structure.json\")\n(DEFINE_SYMBOL CONSTRAINT_SET_TOOL_ERROR_RESOLUTION_INPUT_STRUCTURE \"constraints_tool_error_resolution_input_structure.json\")\n(DEFINE_SYMBOL CONSTRAINT_SET_CONCEPTUAL_MODEL_SUMMARY_STRUCTURE \"constraints_conceptual_model_summary_structure.json\")\n(DEFINE_SYMBOL CONSTRAINT_SET_PHI_ANALYSIS_STRUCTURE \"constraints_phi_analysis_structure.json\")\n\n;; --- Section 1: Utility Procedures & Primitives Declarations ---\n\n(DEFINE_PROCEDURE AcknowledgeAndLog (log_event_type log_message user_ack_message_type user_ack_content) (SEQ (LOG_EVENT log_event_type log_message) (OUTPUT_TO_USER_BUFFER user_ack_message_type user_ack_content NIL) (FLUSH_USER_OUTPUT_BUFFER) (RETURN_STATUS ALANG_STATUS_SUCCESS)))\n(DEFINE_PROCEDURE OutputGeneralHelp () (SEQ (OUTPUT_TO_USER_BUFFER \"AI_PROVIDE_DATA\" \"Commands: START, OK, NO/REVISE, INPUT, HELP?, END, EVOLVE, SAVE_SYSTEM, OUTPUT, SUMMARIZE, QUERY, OUTPUT_BACKLOG, PROMOTE_TO_PKA, SEARCH_PKA, SET_SESSION_PREFERENCE, SET QA_OUTPUT_VERBOSITY, SET OUTPUT_DETAIL, LOOP, STOP_LOOP, LOOP_PROJECT_RESTART, SYSTEM_QA.\") (RETURN_STATUS ALANG_STATUS_SUCCESS)))\n(DEFINE_PROCEDURE OutputSpecificHelp (commandName) (LET ((helpContent (GET_HELP_TEXT_FOR_COMMAND commandName))) (IF (IS_NIL helpContent) (SEQ (SET_ERROR_STATE \"USER_ERROR\" (STRING_CONCAT \"No help found for: \" commandName)) (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL) (RETURN_STATUS ALANG_STATUS_NOT_FOUND)) (OUTPUT_TO_USER_BUFFER \"AI_PROVIDE_DATA\" helpContent NIL)) (RETURN_STATUS ALANG_STATUS_SUCCESS)))\n(DEFINE_PROCEDURE ClearTurnSpecificSessionState () (SEQ (SET_STATE session.last_user_input_raw NIL) (SET_STATE session.parsed_command_details NIL) (SET_STATE session.pending_user_action NIL) (SET_STATE session.pending_user_action_details NIL) (SET_STATE session.active_tool_id NIL) (SET_STATE session.tool_last_status NIL) (SET_STATE session.tool_last_output_handle NIL) (SET_STATE session.last_user_response NIL) (SET_STATE session.last_user_feedback NIL) (SET_STATE session.last_user_input_data NIL) (RETURN_STATUS ALANG_STATUS_SUCCESS)))\n(DEFINE_PROCEDURE ParseKeyValueArgs (argsList) (LET ((resultMap (MAP_CREATE))) (LOOP_FOR_EACH argString argsList (LET ((parts (STRING_SPLIT argString \"=\"))) (IF (EQ (LIST_GET_LENGTH parts) 2) (SET_STATE resultMap (MAP_SET_VALUE resultMap (LIST_GET_ITEM parts 0) (LIST_GET_ITEM parts 1)))))) (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_SUCCESS) (\"data\" resultMap)))))\n(DEFINE_PROCEDURE SummarizeArtifact (artifactHandle session_model_handle) (LET ((contentResult (READ_CONTENT artifactHandle \"text_summary_or_full\" NIL))) (IF (NEQ (GET_STATUS contentResult) ALANG_STATUS_SUCCESS) (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_FAILURE_GENERAL) (\"data\" NIL))) (LET ((content (GET_DATA contentResult))) (IF (IS_NIL content) (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_FAILURE_GENERAL) (\"data\" NIL))) (LET ((summaryResult (INVOKE_CORE_LLM_GENERATION (MAP_CREATE (\"template\" PROMPT_TEMPLATE_SUMMARIZE_ARTIFACT) (\"content\" content) (\"session_model_handle\" session_model_handle)) (GET_LLM_PARAMS_FOR_TASK \"summarization\")))) (IF (EQ (GET_STATUS summaryResult) ALANG_STATUS_SUCCESS) (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_SUCCESS) (\"data\" (GET_DATA summaryResult)))) (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_FAILURE_LLM_ERROR) (\"data\" NIL))))))))))\n(DEFINE_PROCEDURE PerformQuery (queryType queryValue session_model_handle pka_handle) (LET ((queryResult (INVOKE_CORE_LLM_GENERATION (MAP_CREATE (\"template\" PROMPT_TEMPLATE_PERFORM_QUERY) (\"query_type\" queryType) (\"query_value\" queryValue) (\"session_conceptual_model_handle\" session_model_handle) (\"pka_handle\" pka_handle)) (GET_LLM_PARAMS_FOR_TASK \"query_answering\")))) (IF (EQ (GET_STATUS queryResult) ALANG_STATUS_SUCCESS) (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_SUCCESS) (\"data\" (GET_DATA queryResult)))) (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_FAILURE_LLM_ERROR) (\"data\" NIL))))))\n(DEFINE_PROCEDURE GetEvolutionBacklogContent () (LET ((handle (GET_STATE sys.evolution_backlog_handle))) (IF (IS_NIL handle) (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_FAILURE_GENERAL) (\"data\" NIL))) (LET ((contentResult (READ_CONTENT handle \"text_summary_or_full\" NIL))) (IF (EQ (GET_STATUS contentResult) ALANG_STATUS_SUCCESS) (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_SUCCESS) (\"data\" (GET_DATA contentResult)))) (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_FAILURE_GENERAL) (\"data\" NIL))))))))\n(DEFINE_PROCEDURE LoadEvolutionBacklog (handle_or_path) (RETURN_STATUS ALANG_STATUS_SUCCESS))\n(DEFINE_PROCEDURE LoadPersistentKnowledgeBase (handle_or_path) (RETURN_STATUS ALANG_STATUS_SUCCESS))\n(DEFINE_PROCEDURE GetSessionCmdArgByIndex (index default_value_optional) (LET ((argsList (MAP_GET_VALUE (GET_STATE session.parsed_command_details) \"args\" (LIST_CREATE)))) (IF (LT index (LIST_GET_LENGTH argsList)) (LIST_GET_ITEM argsList index) default_value_optional)))\n(DEFINE_PRIMITIVE GET_TEXT_FOR_PKA_CONSENT_PROMPT (purpose_description session_model_handle) (LET ((modelResult (READ_CONTENT session_model_handle \"structured_map\" NIL))) (IF (EQ (GET_STATUS modelResult) ALANG_STATUS_SUCCESS) (LET ((model (GET_DATA modelResult))) (LET ((promptResult (INVOKE_CORE_LLM_GENERATION (MAP_CREATE (\"template\" PROMPT_TEMPLATE_PKA_CONSENT) (\"purpose\" purpose_description) (\"session_model_context\" model)) (GET_LLM_PARAMS_FOR_TASK \"prompt_generation\")))) (IF (EQ (GET_STATUS promptResult) ALANG_STATUS_SUCCESS) (RETURN_STATUS (GET_DATA promptResult)) (RETURN_STATUS (STRING_CONCAT \"Consent to store for: \" purpose_description \"? (YES/NO)\"))))) (RETURN_STATUS (STRING_CONCAT \"Consent to store for: \" purpose_description \"? (YES/NO)\"))))))\n(DEFINE_PROCEDURE HandleQAIssues (generated_text qaAssessment target_artifact_handle constraints_handle session_model_handle) (LET ((hasIssues (MAP_GET_VALUE qaAssessment \"has_issues\" FALSE))) (LET ((confidence (MAP_GET_VALUE qaAssessment \"confidence_score\" 1.0))) (LET ((status ALANG_STATUS_SUCCESS))) (IF hasIssues (SEQ (CALL_PROCEDURE UPDATE_CONCEPTUAL_MODEL (MAP_CREATE (\"action\" \"log_issues\") (\"artifact_handle\" target_artifact_handle) (\"details\" (MAP_GET_VALUE qaAssessment \"details\")) (\"confidence\" confidence)))) (LET ((needsUserReview FALSE))) (LET ((attemptSelfCorrection FALSE))) (IF (OR (EQ (MAP_GET_VALUE qaAssessment \"overall_severity\" \"minor\") \"CRITICAL\") (LT confidence 0.5)) (SET_STATE needsUserReview TRUE) (IF (EQ (MAP_GET_VALUE qaAssessment \"overall_severity\" \"minor\") \"MAJOR\") (SET_STATE attemptSelfCorrection TRUE))) (IF attemptSelfCorrection (LET ((correctionResult (SelfCorrectArtifact generated_text qaAssessment constraints_handle session_model_handle))) (IF (EQ (GET_STATUS correctionResult) ALANG_STATUS_SUCCESS) (LET ((writeStatus (WRITE_CONTENT_TO_ARTIFACT target_artifact_handle (GET_DATA correctionResult) \"text/markdown\")))) (IF (NEQ writeStatus ALANG_STATUS_SUCCESS) (SET_STATE needsUserReview TRUE))) (SET_STATE needsUserReview TRUE)))) (IF needsUserReview (SEQ (SET_STATE session.pending_user_action_details (MAP_CREATE (\"artifact_handle\" target_artifact_handle) (\"qa_report_handle\" (CREATE_EMPTY_ARTIFACT \"temp_qa_report\")) (\"constraints_handle\" constraints_handle) (\"original_generated_text\" generated_text))) (SET_STATE status ALANG_STATUS_PAUSE_FOR_USER_INPUT)))) (CALL_PROCEDURE UPDATE_CONCEPTUAL_MODEL (MAP_CREATE (\"action\" \"flag_qa_passed\") (\"artifact_handle\" target_artifact_handle) (\"confidence\" confidence)))) (RETURN_STATUS status))))\n(DEFINE_PRIMITIVE ADD_DISCLAIMER_TO_ARTIFACT (artifact_handle disclaimer_text) (RETURN_STATUS ALANG_STATUS_SUCCESS))\n(DEFINE_PRIMITIVE SelfCorrectArtifact (generated_text qaAssessment constraints_handle session_model_handle) (LET ((constraintsResult (READ_CONTENT constraints_handle \"structured_list_of_rules\" NIL))) (LET ((sessionModelResult (READ_CONTENT session_model_handle \"structured_map\" NIL))) (IF (AND (EQ (GET_STATUS constraintsResult) ALANG_STATUS_SUCCESS) (EQ (GET_STATUS sessionModelResult) ALANG_STATUS_SUCCESS)) (LET ((constraints (GET_DATA constraintsResult))) (LET ((sessionModel (GET_DATA sessionModelResult))) (LET ((correctionResult (INVOKE_CORE_LLM_GENERATION (MAP_CREATE (\"template\" PROMPT_TEMPLATE_SELF_CORRECTION) (\"original_text\" generated_text) (\"qa_findings\" qaAssessment) (\"constraints\" constraints) (\"session_model\" sessionModel)) (GET_LLM_PARAMS_FOR_TASK \"self_correction\")))) (RETURN_STATUS correctionResult)))) (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_FAILURE_GENERAL) (\"data\" NIL)))))))\n\n;; Conceptual Model Primitives\n(DEFINE_PRIMITIVE UPDATE_CONCEPTUAL_MODEL (update_map) (RETURN_STATUS ALANG_STATUS_SUCCESS))\n(DEFINE_PRIMITIVE QUERY_CONCEPTUAL_MODEL (query_object session_model_handle) (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_SUCCESS) (\"data\" (LIST_CREATE)))))\n(DEFINE_PRIMITIVE SAVE_CONCEPTUAL_MODEL (session_model_handle target_handle_or_path) (RETURN_STATUS ALANG_STATUS_SUCCESS))\n(DEFINE_PRIMITIVE SUMMARIZE_CONCEPTUAL_MODEL (session_model_handle summary_options_map_optional) (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_SUCCESS) (\"data\" \"Conceptual model summary placeholder.\"))))\n(DEFINE_PROCEDURE AnalyzeConceptualModelForΦ (session_model_handle analysis_options_map_optional) (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_SUCCESS) (\"data\" (MAP_CREATE (\"phi_score\" 0.5))))))\n(DEFINE_PRIMITIVE SelfCorrectToolOperation (tool_id job_id error_details context session_model_handle) (LET ((sessionModelResult (READ_CONTENT session_model_handle \"structured_map\" NIL))) (IF (EQ (GET_STATUS sessionModelResult) ALANG_STATUS_SUCCESS) (LET ((sessionModel (GET_DATA sessionModelResult))) (LET ((analysisResult (INVOKE_CORE_LLM_GENERATION (MAP_CREATE (\"template\" PROMPT_TEMPLATE_ANALYZE_TOOL_ERROR) (\"error_details\" error_details) (\"tool_id\" tool_id) (\"original_context\" context) (\"session_model\" sessionModel)) (GET_LLM_PARAMS_FOR_TASK \"error_analysis_and_correction\")))) (IF (EQ (GET_STATUS analysisResult) ALANG_STATUS_SUCCESS) (LET ((analysisData (GET_DATA analysisResult))) (IF (MAP_GET_VALUE analysisData \"can_self_correct\") (LET ((retryContext (MAP_CREATE (\"tool_id\" tool_id) (\"success_proc_name\" (MAP_GET_VALUE context \"success_proc_name\")) (\"failure_proc_name\" (MAP_GET_VALUE context \"failure_proc_name\")) (\"pass_through_context\" (MAP_GET_VALUE context \"pass_through_context\")) (\"original_input\" (MAP_GET_VALUE context \"original_input\")) (\"original_params\" (MAP_GET_VALUE context \"original_params\"))))) (LET ((retryJobId (INVOKE_TOOL_ASYNC_WITH_CALLBACKS tool_id (MAP_GET_VALUE analysisData \"suggested_input\" (MAP_GET_VALUE context \"original_input\")) (MAP_GET_VALUE analysisData \"suggested_params\" (MAP_GET_VALUE context \"original_params\")) (MAP_GET_VALUE context \"success_proc_name\") (MAP_GET_VALUE context \"failure_proc_name\") retryContext)))) (IF (EQ (GET_STATUS retryJobId) ALANG_STATUS_SUCCESS) (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_SUCCESS) (\"data\" (MAP_CREATE (\"new_job_id\" retryJobId))))) (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_FAILURE_GENERAL) (\"data\" NIL)))))) (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_FAILURE_GENERAL) (\"data\" NIL))))) (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_FAILURE_LLM_ERROR) (\"data\" NIL)))))) (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_FAILURE_GENERAL) (\"data\" NIL))))))\n(DEFINE_PROCEDURE OutputErrorToUser (errorMessage) (SEQ (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (STRING_CONCAT \"ERROR: \" errorMessage) NIL) (FLUSH_USER_OUTPUT_BUFFER) (RETURN_STATUS ALANG_STATUS_SUCCESS)))\n\n;; Primitive Declarations\n(DEFINE_PRIMITIVE SET_STATE (variable_path_string value))\n(DEFINE_PRIMITIVE GET_STATE (variable_path_string))\n(DEFINE_PRIMITIVE REQUEST_USER_INPUT (prompt_message_key_or_text expected_input_type_hint))\n(DEFINE_PRIMITIVE OUTPUT_TO_USER_BUFFER (message_type content_handle_or_text formatting_hints))\n(DEFINE_PRIMITIVE FLUSH_USER_OUTPUT_BUFFER ())\n(DEFINE_PRIMITIVE INVOKE_TOOL_ASYNC_WITH_CALLBACKS (tool_id input_data params_map success_proc_name failure_proc_name pass_through_context))\n(DEFINE_PRIMITIVE GET_ASYNC_JOB_STATUS (job_id))\n(DEFINE_PRIMITIVE GET_ASYNC_JOB_RESULT_HANDLE (job_id))\n(DEFINE_PRIMITIVE READ_CONTENT (handle options))\n(DEFINE_PRIMITIVE WRITE_CONTENT_TO_ARTIFACT (artifact_handle content mime_type))\n(DEFINE_PRIMITIVE GET_HANDLE_METADATA (handle key))\n(DEFINE_PRIMITIVE RELEASE_HANDLE (handle))\n(DEFINE_PRIMITIVE LOG_EVENT (event_type description_text (key_value_details_map_optional)))\n(DEFINE_PRIMITIVE SET_ERROR_STATE (error_level error_message_key_or_text))\n(DEFINE_PRIMITIVE GENERATE_UNIQUE_ID (prefix_string_optional))\n(DEFINE_PRIMITIVE VALIDATE_DATA (data_handle schema_handle))\n(DEFINE_PRIMITIVE IS_TOOL_ENABLED (tool_id))\n(DEFINE_PRIMITIVE STRING_CONCAT (str1 str2 ...))\n(DEFINE_PRIMITIVE STRING_IS_EMPTY_OR_NULL (str))\n(DEFINE_PRIMITIVE IS_NUMBER (str))\n(DEFINE_PRIMITIVE STRING_TO_NUMBER (str))\n(DEFINE_PRIMITIVE ADD (num1 num2))\n(DEFINE_PRIMITIVE SUB (num1 num2))\n(DEFINE_PRIMITIVE OR (bool1 bool2 ...))\n(DEFINE_PRIMITIVE AND (bool1 bool2 ...))\n(DEFINE_PRIMITIVE NOT (bool))\n(DEFINE_PRIMITIVE IS_NIL (value))\n(DEFINE_PRIMITIVE MAP_CREATE ((key1 val1) (key2 val2) ...)))\n(DEFINE_PRIMITIVE MAP_GET_VALUE (map key default_value_optional))\n(DEFINE_PRIMITIVE MAP_SET_VALUE (map key value))\n(DEFINE_PRIMITIVE LIST_CREATE (item1 item2 ...))\n(DEFINE_PRIMITIVE LIST_GET_ITEM (list index))\n(DEFINE_PRIMITIVE LIST_IS_EMPTY (list))\n(DEFINE_PRIMITIVE LIST_GET_LENGTH (list))\n(DEFINE_PRIMITIVE CREATE_EMPTY_ARTIFACT (artifact_type_string))\n(DEFINE_PRIMITIVE GET_HELP_TEXT_FOR_COMMAND (command_name))\n(DEFINE_PRIMITIVE GET_TEXT_FOR_CDGIP_USER_VERIFICATION_MANDATE (alang_version section_count))\n(DEFINE_PRIMITIVE GET_CURRENT_ALANG_PROCEDURE_DEFINITIONS_HANDLE ())\n(DEFINE_PRIMITIVE VERIFY_ALANG_FILE_MARKERS (alang_content_handle alang_version))\n(DEFINE_PRIMITIVE GET_ALANG_SECTION_COUNT (alang_content_handle))\n(DEFINE_PRIMITIVE COMPUTE_FILE_CHECKSUM (file_handle checksum_type))\n(DEFINE_PRIMITIVE INVOKE_CORE_LLM_GENERATION (prompt_text llm_params_map))\n(DEFINE_PRIMITIVE GET_LLM_PARAMS_FOR_TASK (task_type))\n(DEFINE_PRIMITIVE PKA_CREATE_DRAFT (content_handle_or_text schema_id_optional context_map_optional))\n(DEFINE_PRIMITIVE PKA_REQUEST_USER_CONSENT_TO_STORE (pka_draft_handle purpose_description))\n(DEFINE_PRIMITIVE PKA_STORE_APPROVED_DRAFT (pka_draft_handle user_consent_token_or_flag))\n(DEFINE_PRIMITIVE PKA_QUERY (query_object scope_filter_optional))\n(DEFINE_PRIMITIVE PKA_GET_ARTIFACT (pka_stored_id))\n(DEFINE_PRIMITIVE PKA_UPDATE_ARTIFACT (pka_stored_id new_content_handle update_rationale user_consent_token_or_flag_if_scope_change))\n(DEFINE_PRIMITIVE PKA_MANAGE_CONSENT (pka_stored_id_or_all action_revoke_or_modify))\n(DEFINE_PRIMITIVE CREATE_EVOLUTION_BACKLOG_ITEM (id title desc source status timestamp))\n(DEFINE_PRIMITIVE UPDATE_EVOLUTION_BACKLOG_ITEM (id new_title_opt new_desc_opt new_source_opt new_status_opt new_comment_opt increment_reinforce_flag_opt))\n(DEFINE_PRIMITIVE FIND_SIMILAR_BACKLOG_ITEM (text))\n(DEFINE_PRIMITIVE IS_HANDLE_VALID (handle))\n(DEFINE_PRIMITIVE HAS_QA_ISSUES (qa_assessment_map))\n(DEFINE_PRIMITIVE IS_STATUS_FAILURE (status_code_or_value))\n(DEFINE_PRIMITIVE GET_ERROR_MESSAGE (error_object))\n(DEFINE_PRIMITIVE STRING_SPLIT (text delimiter))\n(DEFINE_PRIMITIVE GT (num1 num2))\n(DEFINE_PRIMITIVE LT (num1 num2))\n(DEFINE_PRIMITIVE GTE (num1 num2))\n(DEFINE_PRIMITIVE NEQ (val1 val2))\n(DEFINE_PRIMITIVE EQ (val1 val2))\n(DEFINE_PRIMITIVE INIT_PROJECT_STATE (project_id project_description master_plan_handle_optional))\n(DEFINE_PRIMITIVE LOOP_FOR_EACH (variable list body))\n(DEFINE_PRIMITIVE SEQ (expression ...))\n(DEFINE_PRIMITIVE IF (condition true_branch (false_branch_optional)))\n(DEFINE_PRIMITIVE LET ((variable value) ...) body))\n(DEFINE_PRIMITIVE CALL_PROCEDURE (procedure_name arg ...)))\n(DEFINE_PRIMITIVE RETURN_STATUS (status_code_or_result_object))\n(DEFINE_PRIMITIVE ALANG_STATUS_PAUSE_FOR_USER_INPUT ())\n(DEFINE_PRIMITIVE LOOP_WHILE (condition body))\n(DEFINE_PRIMITIVE GET_ALANG_CORE_DIRECTIVES_HANDLE ())\n(DEFINE_PRIMITIVE GET_EVOLUTION_BACKLOG_ITEMS ())\n(DEFINE_PRIMITIVE PROPOSE_CORE_LOGIC_VERSION_INCREMENT (current_version changes_summary))\n(DEFINE_PRIMITIVE APPLY_CORE_LOGIC_CHANGES (proposed_changes_handle))\n(DEFINE_PRIMITIVE GET_PROPOSED_CORE_LOGIC_CHANGES_HANDLE ())\n(DEFINE_PRIMITIVE CLEAR_PENDING_CORE_LOGIC_CHANGES ())\n(DEFINE_PRIMITIVE GET_QA_ASSESSMENT_SUMMARY (qa_report_handle))\n(DEFINE_PRIMITIVE STRING_TRIM (text))\n(DEFINE_PRIMITIVE CHECK_FOR_SUBSTANTIVE_ISSUES (qa_report_handle) (LET ((assessmentResult (GET_QA_ASSESSMENT_SUMMARY qa_report_handle))) (IF (EQ (GET_STATUS assessmentResult) ALANG_STATUS_SUCCESS) (RETURN_STATUS (MAP_GET_VALUE (GET_DATA assessmentResult) \"has_substantive_issues\" FALSE)) (RETURN_STATUS TRUE))))\n\n;; Conceptual Model Primitives\n(DEFINE_PRIMITIVE ADD_CONCEPT_NODE (node_details_map session_model_handle) (RETURN_STATUS ALANG_STATUS_SUCCESS))\n(DEFINE_PRIMITIVE ADD_RELATIONSHIP_EDGE (edge_details_map session_model_handle) (RETURN_STATUS ALANG_STATUS_SUCCESS))\n(DEFINE_PRIMITIVE UPDATE_NODE_PROPERTIES (node_id properties_map session_model_handle) (RETURN_STATUS ALANG_STATUS_SUCCESS))\n(DEFINE_PRIMITIVE UPDATE_EDGE_PROPERTIES (from_node_id to_node_id edge_type properties_map session_model_handle) (RETURN_STATUS ALANG_STATUS_SUCCESS))\n(DEFINE_PRIMITIVE FLAG_NODE (node_id flag_name value session_model_handle) (RETURN_STATUS ALANG_STATUS_SUCCESS))\n(DEFINE_PRIMITIVE GET_NODE_DETAILS (node_id session_model_handle) (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_SUCCESS) (\"data\" (MAP_CREATE)))))\n(DEFINE_PRIMITIVE GET_RELATED_NODES (node_id relationship_type_optional session_model_handle) (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_SUCCESS) (\"data\" (LIST_CREATE)))))\n(DEFINE_PRIMITIVE GET_NODES_BY_TYPE (node_type_string session_model_handle) (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_SUCCESS) (\"data\" (LIST_CREATE)))))\n(DEFINE_PRIMITIVE GET_EDGES_BY_TYPE (edge_type_string session_model_handle) (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_SUCCESS) (\"data\" (LIST_CREATE)))))\n\n;; --- Section 2: Event Handler Procedures ---\n\n(DEFINE_PROCEDURE OnSystemInit () (SEQ (SET_STATE sys.alang_core_logic_version (GET_CORE_LOGIC_VERSION)) (SET_STATE sys.alang_spec_version (GET_ALANG_SPEC_VERSION)) (SET_STATE sys.current_mode \"IDLE\") (SET_STATE sys.error_level \"NONE\") (SET_STATE sys.error_message NIL) (SET_STATE sys.system_qa_status \"IDLE\") (SET_STATE session.qa_output_verbosity \"CONCISE\") (SET_STATE session.output_detail \"STANDARD\") (SET_STATE session.loop_stack (LIST_CREATE)) (SET_STATE session.pending_user_action_details NIL) (SET_STATE session.last_search_results NIL) (SET_STATE session.system_qa_context NIL) (SET_STATE sys.proposed_changes_handle NIL) (CALL_PROCEDURE LoadEvolutionBacklog (GET_STATE sys.evolution_backlog_handle)) (CALL_PROCEDURE LoadPersistentKnowledgeBase (GET_STATE sys.knowledge_base_handle)) (SET_STATE session.conceptual_model_handle (CREATE_EMPTY_ARTIFACT \"SessionConceptualModel\")) (FLUSH_USER_BUFFER) (RETURN_STATUS ALANG_STATUS_SUCCESS)))\n(DEFINE_PROCEDURE OnUserInput (raw_text) (SEQ (SET_STATE session.last_user_input_raw raw_text) (LET ((pendingAction (GET_STATE session.pending_user_action))) (IF (NOT (IS_NIL pendingAction)) (CALL_PROCEDURE HandlePendingUserAction pendingAction raw_text) (SEQ (CALL_PROCEDURE ProcessUserInputForConceptualModel raw_text (GET_STATE session.conceptual_model_handle)) (LET ((parsedCmdResult (CALL_PROCEDURE ParseUserCommand raw_text (GET_STATE session.conceptual_model_handle)))) (IF (EQ (GET_STATUS parsedCmdResult) ALANG_STATUS_SUCCESS) (SEQ (SET_STATE session.parsed_command_details (GET_DATA parsedCmdResult)) (CALL_PROCEDURE DispatchUserCommand (GET_STATE session.parsed_command_details))) (SEQ (SET_ERROR_STATE \"USER_ERROR\" \"Could not understand input.\") (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL))))))) (FLUSH_USER_OUTPUT_BUFFER) (CALL_PROCEDURE ClearTurnSpecificSessionState) (IF (GET_STATE sys.evolution_trigger_pending) (SEQ (SET_STATE sys.evolution_trigger_pending FALSE) (CALL_PROCEDURE ExecuteSystemQAAndEvolutionCycle)))) (RETURN_STATUS ALANG_STATUS_SUCCESS)))\n(DEFINE_PROCEDURE OnToolSuccess (job_id result_handle original_success_proc_name context) (SEQ (CALL_PROCEDURE ProcessToolResultForConceptualModel (MAP_GET_VALUE context \"tool_id\") result_handle (GET_STATE session.conceptual_model_handle) context) (CALL_PROCEDURE original_success_proc_name job_id result_handle (MAP_GET_VALUE context \"pass_through_context\")) (RETURN_STATUS ALANG_STATUS_SUCCESS)))\n(DEFINE_PROCEDURE OnToolFailure (job_id error_details original_failure_proc_name context) (SEQ (SET_ERROR_STATE \"TOOL_ERROR\" (MAP_GET_VALUE error_details \"message\")) (CALL_PROCEDURE HandleToolError (MAP_GET_VALUE context \"tool_id\") job_id error_details context) (RETURN_STATUS ALANG_STATUS_SUCCESS)))\n(DEFINE_PROCEDURE ProcessToolResultForConceptualModel (tool_id result_handle session_model_handle context) (RETURN_STATUS ALANG_STATUS_SUCCESS))\n(DEFINE_PROCEDURE HandleBrowseResult (job_id result_handle context) (LET ((contentResult (READ_CONTENT result_handle \"text_summary_or_full\" NIL))) (IF (EQ (GET_STATUS contentResult) ALANG_STATUS_SUCCESS) (SEQ (OUTPUT_TO_USER_BUFFER \"AI_PROVIDE_DATA\" (GET_DATA contentResult) NIL) (CALL_PROCEDURE ProcessToolResultForConceptualModel \"browse\" result_handle (GET_STATE session.conceptual_model_handle) context)) (SEQ (SET_ERROR_STATE \"TOOL_ERROR\" \"Failed to read browsed content.\") (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL)))) (RETURN_STATUS ALANG_STATUS_SUCCESS)))\n(DEFINE_PROCEDURE HandleBrowseError (job_id error_details context) (SEQ (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (STRING_CONCAT \"Browse error: \" (MAP_GET_VALUE error_details \"message\")) NIL) (RETURN_STATUS ALANG_STATUS_FAILURE_TOOL_ERROR)))\n(DEFINE_PROCEDURE HandleReferenceValidationSuccess (job_id result_handle context) (LET ((reportResult (READ_CONTENT result_handle \"json_map\" NIL))) (IF (EQ (GET_STATUS reportResult) ALANG_STATUS_SUCCESS) (LET ((report (GET_DATA reportResult))) (IF (EQ (MAP_GET_VALUE report \"is_valid\") TRUE) (OUTPUT_TO_USER_BUFFER \"AI_THOUGHTS\" \"Reference validated.\" NIL) (OUTPUT_TO_USER_BUFFER \"AI_THOUGHTS\" (STRING_CONCAT \"Reference validation failed: \" (MAP_GET_VALUE report \"reason\")) NIL)) (CALL_PROCEDURE ProcessToolResultForConceptualModel \"reference_validator\" result_handle (GET_STATE session.conceptual_model_handle) context)) (SEQ (SET_ERROR_STATE \"TOOL_ERROR\" \"Failed to read validation report.\") (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL)))) (RETURN_STATUS ALANG_STATUS_SUCCESS)))\n(DEFINE_PROCEDURE HandleReferenceValidationError (job_id error_details context) (SEQ (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (STRING_CONCAT \"Reference validation error: \" (MAP_GET_VALUE error_details \"message\")) NIL) (RETURN_STATUS ALANG_STATUS_FAILURE_TOOL_ERROR)))\n(DEFINE_PROCEDURE HandleToolError (tool_id job_id error_details context) (SEQ (CALL_PROCEDURE ProcessToolErrorForConceptualModel tool_id error_details (GET_STATE session.conceptual_model_handle)) (LET ((selfCorrectionResult (SelfCorrectToolOperation tool_id job_id error_details context (GET_STATE session.conceptual_model_handle))))) (IF (EQ (GET_STATUS selfCorrectionResult) ALANG_STATUS_SUCCESS) (RETURN_STATUS ALANG_STATUS_SUCCESS) (SEQ (LET ((analysisResult (INVOKE_CORE_LLM_GENERATION (MAP_CREATE (\"template\" PROMPT_TEMPLATE_ANALYZE_TOOL_ERROR_USER_EXPLANATION) (\"error_details\" error_details) (\"tool_id\" tool_id) (\"original_context\" context) (\"session_model_handle\" (GET_STATE session.conceptual_model_handle)) (\"output_format\" \"user_explanation\")) (GET_LLM_PARAMS_FOR_TASK \"error_explanation\")))) (LET ((userExplanation (IF (AND (EQ (GET_STATUS analysisResult) ALANG_STATUS_SUCCESS) (NOT (STRING_IS_EMPTY_OR_NULL (GET_DATA analysisResult)))) (GET_DATA analysisResult) \"Could not generate explanation.\")))) (OUTPUT_TO_USER_BUFFER \"AI_PRESENT_THOUGHTS\" (STRING_CONCAT \"Error in \" tool_id \". Analysis: \" userExplanation) NIL) (OUTPUT_TO_USER_BUFFER \"AI_REQUEST_CLARIFICATION_QUESTIONS\" \"`INPUT` fix or other instructions.\" NIL) (SET_STATE session.pending_user_action_details (MAP_CREATE (\"tool_id\" tool_id) (\"job_id\" job_id) (\"error_details\" error_details) (\"original_context\" context))) (SET_STATE session.pending_user_action \"AWAIT_TOOL_ERROR_RESOLUTION\") (RETURN_STATUS ALANG_STATUS_PAUSE_FOR_USER_INPUT)))))))\n(DEFINE_PROCEDURE ProcessToolErrorForConceptualModel (tool_id error_details session_model_handle) (RETURN_STATUS ALANG_STATUS_SUCCESS))\n(DEFINE_PROCEDURE ProcessUserInputForConceptualModel (input_data session_model_handle) (RETURN_STATUS ALANG_STATUS_SUCCESS))\n(DEFINE_PROCEDURE ProcessGeneratedArtifactForConceptualModel (artifact_handle artifact_type session_model_handle) (RETURN_STATUS ALANG_STATUS_SUCCESS))\n(DEFINE_PROCEDURE IntegratePkaIntoConceptualModel (pka_id session_model_handle) (RETURN_STATUS ALANG_STATUS_SUCCESS))\n(DEFINE_PROCEDURE ProcessPkaSearchResultsForConceptualModel (pka_result_handles session_model_handle) (RETURN_STATUS ALANG_STATUS_SUCCESS))\n(DEFINE_PROCEDURE ProcessUserFeedbackForConceptualModel (feedback_text session_model_handle) (RETURN_STATUS ALANG_STATUS_SUCCESS))\n(DEFINE_PROCEDURE ProcessGeneratedArtifactForEvolution (artifact_handle artifact_type session_model_handle) (RETURN_STATUS ALANG_STATUS_SUCCESS))\n\n;; --- Section 3: Command Dispatcher & Specific Command Handlers ---\n\n(DEFINE_PROCEDURE DispatchUserCommand (commandDetails) (LET ((commandName (MAP_GET_VALUE commandDetails \"command\"))) (IF (EQ commandName \"START\") (CALL_PROCEDURE HandleStartCommand (MAP_GET_VALUE commandDetails \"args\"))) (IF (EQ commandName \"HELP\") (CALL_PROCEDURE HandleHelpCommand (MAP_GET_VALUE commandDetails \"args\"))) (IF (EQ commandName \"EVOLVE\") (CALL_PROCEDURE HandleEvolveCommand (MAP_GET_VALUE commandDetails \"args\"))) (IF (EQ commandName \"SAVE_SYSTEM\") (CALL_PROCEDURE HandleSaveSystemCommand ())) (IF (EQ commandName \"BROWSE\") (CALL_PROCEDURE HandleBrowseCommand (MAP_GET_VALUE commandDetails \"args\"))) (IF (EQ commandName \"OK\") (CALL_PROCEDURE HandleOkCommand ())) (IF (EQ commandName \"NO\") (CALL_PROCEDURE HandleNoCommand (MAP_GET_VALUE commandDetails \"args\"))) (IF (EQ commandName \"INPUT\") (CALL_PROCEDURE HandleInputCommand (MAP_GET_VALUE commandDetails \"args\"))) (IF (EQ commandName \"END\") (CALL_PROCEDURE HandleEndCommand ())) (IF (EQ commandName \"LOOP_PROJECT_RESTART\") (CALL_PROCEDURE HandleLoopProjectRestartCommand ())) (IF (EQ commandName \"SET_SESSION_PREFERENCE\") (CALL_PROCEDURE HandleSetSessionPreferenceCommand (MAP_GET_VALUE commandDetails \"args\"))) (IF (EQ commandName \"STOP_LOOP\") (CALL_PROCEDURE HandleStopLoopCommand ())) (IF (EQ commandName \"OUTPUT\") (CALL_PROCEDURE HandleOutputCommand (MAP_GET_VALUE commandDetails \"args\"))) (IF (EQ commandName \"SUMMARIZE\") (CALL_PROCEDURE HandleSummarizeCommand (MAP_GET_VALUE commandDetails \"args\"))) (IF (EQ commandName \"QUERY\") (CALL_PROCEDURE HandleQueryCommand (MAP_GET_VALUE commandDetails \"args\"))) (IF (EQ commandName \"OUTPUT_BACKLOG\") (CALL_PROCEDURE HandleOutputBacklogCommand (MAP_GET_VALUE commandDetails \"args\"))) (IF (EQ commandName \"PROMOTE_TO_PKA\") (CALL_PROCEDURE HandlePromoteToPkaCommand (MAP_GET_VALUE commandDetails \"args\"))) (IF (EQ commandName \"SEARCH_PKA\") (CALL_PROCEDURE HandleSearchPkaCommand (MAP_GET_VALUE commandDetails \"args\"))) (IF (EQ commandName \"SET_QA_OUTPUT_VERBOSITY\") (CALL_PROCEDURE HandleSetQaOutputVerbosityCommand (MAP_GET_VALUE commandDetails \"args\"))) (IF (EQ commandName \"SET_OUTPUT_DETAIL\") (CALL_PROCEDURE HandleSetOutputDetailCommand (MAP_GET_VALUE commandDetails \"args\"))) (IF (EQ commandName \"LOOP\") (CALL_PROCEDURE HandleLoopCommand (MAP_GET_VALUE commandDetails \"args\"))) (IF (EQ commandName \"SYSTEM_QA\") (CALL_PROCEDURE HandleSystemQACommand ())) (IF (NOT (IS_NIL commandName) (IS_NIL (MAP_GET_VALUE (MAP_CREATE (\"START\" TRUE) (\"HELP\" TRUE) (\"EVOLVE\" TRUE) (\"SAVE_SYSTEM\" TRUE) (\"BROWSE\" TRUE) (\"OK\" TRUE) (\"NO\" TRUE) (\"INPUT\" TRUE) (\"END\" TRUE) (\"LOOP_PROJECT_RESTART\" TRUE) (\"SET_SESSION_PREFERENCE\" TRUE) (\"STOP_LOOP\" TRUE) (\"OUTPUT\" TRUE) (\"SUMMARIZE\" TRUE) (\"QUERY\" TRUE) (\"OUTPUT_BACKLOG\" TRUE) (\"PROMOTE_TO_PKA\" TRUE) (\"SEARCH_PKA\" TRUE) (\"SET_QA_OUTPUT_VERBOSITY\" TRUE) (\"SET_OUTPUT_DETAIL\" TRUE) (\"LOOP\" TRUE) (\"SYSTEM_QA\" TRUE)) commandName NIL)))) (CALL_PROCEDURE HandleUnknownCommand commandName))) (RETURN_STATUS ALANG_STATUS_SUCCESS)))\n(DEFINE_PROCEDURE HandlePendingUserAction (action_key raw_input) (SEQ (SET_STATE session.last_user_input_raw raw_input) (SET_STATE session.last_user_response (STRING_UPPER raw_input)) (SET_STATE session.last_user_feedback (IF (OR (EQ (STRING_UPPER raw_input) \"NO\") (EQ (STRING_UPPER raw_input) \"REVISE\")) raw_input NIL)) (SET_STATE session.last_user_input_data raw_input) (IF (EQ action_key \"AWAIT_END_CONFIRMATION\") (IF (EQ (GET_STATE session.last_user_response) \"YES\") (CALL_PROCEDURE FinalizeProjectTermination) (SET_STATE session.pending_user_action NIL))) (IF (EQ action_key \"AWAIT_RESTART_CONFIRMATION\") (IF (EQ (GET_STATE session.last_user_response) \"YES\") (CALL_PROCEDURE FinalizeProjectRestart) (SET_STATE session.pending_user_action NIL))) (IF (EQ action_key \"AWAIT_YES_NO_FOR_BACKLOG_OUTPUT\") (IF (EQ (GET_STATE session.last_user_response) \"YES\") (CALL_PROCEDURE HandleOutputBacklogCommand (LIST_CREATE))) (SET_STATE session.pending_user_action NIL))) (IF (EQ action_key \"AWAIT_BACKLOG_PRIORITY_SELECTION\") (SEQ (SET_STATE session.pending_user_action NIL) (SET_STATE session.system_qa_context (MAP_SET_VALUE (GET_STATE session.system_qa_context) \"user_backlog_selection_input\" (GET_STATE session.last_user_input_data))))) (IF (EQ action_key \"AWAIT_AI_PROPOSED_FOCUS_APPROVAL\") (SEQ (SET_STATE session.pending_user_action NIL) (SET_STATE session.system_qa_context (MAP_SET_VALUE (GET_STATE session.system_qa_context) \"ai_focus_approved\" (EQ (GET_STATE session.last_user_response) \"OK\")))))) (IF (EQ action_key \"AWAIT_VERSION_APPROVAL\") (SEQ (SET_STATE session.pending_user_action NIL) (SET_STATE session.system_qa_context (MAP_SET_VALUE (GET_STATE session.system_qa_context) \"version_approved\" (EQ (GET_STATE session.last_user_response) \"OK\")))))) (IF (EQ action_key \"AWAIT_TOOL_ERROR_RESOLUTION\") (SEQ (LET ((details (GET_STATE session.pending_user_action_details))) (LET ((toolId (MAP_GET_VALUE details \"tool_id\"))) (LET ((context (MAP_GET_VALUE details \"original_context\"))) (IF (EQ (GET_STATE session.last_user_response) \"OK\") (LET ((retryJobId (INVOKE_TOOL_ASYNC_WITH_CALLBACKS toolId (MAP_GET_VALUE context \"original_input\") (MAP_GET_VALUE context \"original_params\") (MAP_GET_VALUE context \"success_proc_name\") (MAP_GET_VALUE context \"failure_proc_name\") context)))) (IF (EQ (GET_STATE session.last_user_response) \"INPUT\") (LET ((parsedInputResult (CALL_PROCEDURE ParseToolErrorResolutionInput (GET_STATE session.last_user_input_data) toolId (MAP_GET_VALUE details \"error_details\") context (GET_STATE session.conceptual_model_handle))))) (IF (EQ (GET_STATUS parsedInputResult) ALANG_STATUS_SUCCESS) (LET ((newInputParams (GET_DATA parsedInputResult))) (LET ((retryJobId (INVOKE_TOOL_ASYNC_WITH_CALLBACKS toolId (MAP_GET_VALUE newInputParams \"input\") (MAP_GET_VALUE newInputParams \"params\") (MAP_GET_VALUE context \"success_proc_name\") (MAP_GET_VALUE context \"failure_proc_name\") context)))) (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL))) (RETURN_STATUS ALANG_STATUS_FAILURE_INVALID_INPUT)))) (IF (OR (EQ (GET_STATE session.last_user_response) \"NO\") (EQ (GET_STATE session.last_user_response) \"REVISE\")) (CALL_PROCEDURE ProcessUserFeedbackForConceptualModel (GET_STATE session.last_user_feedback) (GET_STATE session.conceptual_model_handle)))) (SET_STATE session.pending_user_action NIL) (SET_STATE session.pending_user_action_details NIL)))) (IF (EQ action_key \"AWAIT_REVISION_REVIEW\") (SEQ (LET ((details (GET_STATE session.pending_user_action_details))) (LET ((artifactHandle (MAP_GET_VALUE details \"artifact_handle\"))) (LET ((constraintsHandle (MAP_GET_VALUE details \"constraints_handle\"))) (IF (EQ (GET_STATE session.last_user_response) \"OK\") (CALL_PROCEDURE UPDATE_CONCEPTUAL_MODEL (MAP_CREATE (\"action\" \"flag_user_approved_revision\") (\"artifact_handle\" artifactHandle))) (SEQ (CALL_PROCEDURE ProcessUserFeedbackForConceptualModel (GET_STATE session.last_user_feedback) (GET_STATE session.conceptual_model_handle)) (CALL_PROCEDURE UPDATE_CONCEPTUAL_MODEL (MAP_CREATE (\"action\" \"flag_user_rejected_revision\") (\"artifact_handle\" artifactHandle) (\"feedback\" (GET_STATE session.last_user_feedback)))) (LET ((revisionStatus (CALL_PROCEDURE ApplyFeedbackBasedRevision artifactHandle (GET_STATE session.last_user_feedback) constraintsHandle (GET_STATE session.conceptual_model_handle) details)))) (IF (EQ revisionStatus ALANG_STATUS_PAUSE_FOR_USER_INPUT) (RETURN_STATUS ALANG_STATUS_PAUSE_FOR_USER_INPUT) (IF (IS_STATUS_FAILURE revisionStatus) (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL) (SET_STATE session.pending_user_action_details (MAP_SET_VALUE details \"last_revision_status\" revisionStatus)))))))) (SET_STATE session.pending_user_action NIL) (SET_STATE session.pending_user_action_details NIL)))) (IF (EQ action_key \"AWAIT_OK_REVISE_PHASE_ARTIFACT\") (SEQ (LET ((details (GET_STATE session.pending_user_action_details))) (LET ((artifactHandle (MAP_GET_VALUE details \"artifact_handle\"))) (LET ((phaseId (MAP_GET_VALUE details \"phase\"))) (IF (EQ (GET_STATE session.last_user_response) \"OK\") (CALL_PROCEDURE UPDATE_CONCEPTUAL_MODEL (MAP_CREATE (\"action\" \"flag_user_approved_artifact\") (\"artifact_handle\" artifactHandle) (\"phase\" phaseId))) (SEQ (CALL_PROCEDURE ProcessUserFeedbackForConceptualModel (GET_STATE session.last_user_feedback) (GET_STATE session.conceptual_model_handle)) (CALL_PROCEDURE UPDATE_CONCEPTUAL_MODEL (MAP_CREATE (\"action\" \"flag_user_rejected_artifact\") (\"artifact_handle\" artifactHandle) (\"phase\" phaseId) (\"feedback\" (GET_STATE session.last_user_feedback)))))))) (SET_STATE session.pending_user_action NIL) (SET_STATE session.pending_user_action_details NIL)))) (SEQ (SET_ERROR_STATE \"SYSTEM_ERROR\" (STRING_CONCAT \"Unhandled pending action: \" action_key)) (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL) (SET_STATE session.pending_user_action NIL) (SET_STATE session.pending_user_action_details NIL) (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL))))\n(DEFINE_PROCEDURE FinalizeProjectTermination () (SEQ (LOG_EVENT \"PROJECT_TERMINATION\" \"Project terminating.\") (OUTPUT_TO_USER_BUFFER \"AI_PRESENT_THOUGHTS\" \"Project terminated.\" NIL) (RETURN_STATUS ALANG_STATUS_SUCCESS)))\n(DEFINE_PROCEDURE FinalizeProjectRestart () (SEQ (LOG_EVENT \"PROJECT_RESTART\" \"Project restarting.\") (OUTPUT_TO_USER_BUFFER \"AI_PRESENT_THOUGHTS\" \"Project state discarded. Restarting.\" NIL) (RETURN_STATUS ALANG_STATUS_SUCCESS)))\n(DEFINE_PROCEDURE HandleStartCommand (argsList) (LET ((desc (GET_SESSION_CMD_ARG_BY_INDEX 0 NIL))) (IF (STRING_IS_EMPTY_OR_NULL desc) (SEQ (SET_ERROR_STATE \"USER_ERROR\" \"Description required.\") (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL) (RETURN_STATUS ALANG_STATUS_INVALID_ARGS))) (ACKNOWLEDGE_AND_LOG \"CMD_START\" (STRING_CONCAT \"START: \" desc) \"AI_ACKNOWLEDGE_INTENT\" (STRING_CONCAT \"START: '\" desc \"'\")) (LET ((newId (GENERATE_UNIQUE_ID \"PROJ\"))) (INIT_PROJECT_STATE newId desc NIL) (SET_STATE session.conceptual_model_handle (CREATE_EMPTY_ARTIFACT \"SessionConceptualModel\")) (CALL_PROCEDURE ProcessUserInputForConceptualModel desc (GET_STATE session.conceptual_model_handle))) (SET_STATE proj.current_phase_id \"PHASE_IDEA_FORMULATION\") (RETURN_STATUS ALANG_STATUS_SUCCESS))))\n(DEFINE_PROCEDURE HandleHelpCommand (argsList) (LET ((cmdName (GET_SESSION_CMD_ARG_BY_INDEX 0 NIL))) (IF (STRING_IS_EMPTY_OR_NULL cmdName) (CALL_PROCEDURE OutputGeneralHelp) (CALL_PROCEDURE OutputSpecificHelp cmdName))) (RETURN_STATUS ALANG_STATUS_SUCCESS)))\n(DEFINE_PROCEDURE HandleEvolveCommand (argsList) (LET ((suggestion (GET_SESSION_CMD_ARG_BY_INDEX 0 NIL))) (IF (STRING_IS_EMPTY_OR_NULL suggestion) (SEQ (SET_ERROR_STATE \"USER_ERROR\" \"EVOLVE requires suggestion.\") (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (GET_STATE sys.error_message) NIL) (RETURN_STATUS ALANG_STATUS_INVALID_ARGS))) (ACKNOWLEDGE_AND_LOG \"CMD_EVOLVE\" (STRING_CONCAT \"EVOLVE: \" suggestion) \"AI_ACKNOWLEDGE_INTENT\" \"EVOLVE logged.\") (LET ((itemIdResult (CALL_PROCEDURE ProcessAndStoreEvolveSuggestion suggestion \"USER_SUGGESTION\")))\\ (IF (EQ (GET_STATUS itemIdResult) ALANG_STATUS_SUCCESS) (SET_STATE sys.evolution_trigger_pending TRUE) (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL)))) (RETURN_STATUS ALANG_STATUS_SUCCESS))))\n(DEFINE_PROCEDURE HandleSaveSystemCommand () (SEQ (ACKNOWLEDGE_AND_LOG \"CMD_SAVE_SYSTEM\" \"SAVE SYSTEM received.\" \"AI_ACKNOWLEDGE_INTENT\" \"SAVE SYSTEM received.\") (LET ((alangHandle (SAFE_GENERATE_CONTENT (CREATE_EMPTY_ARTIFACT \"temp_alang_code\") PROMPT_TEMPLATE_SERIALIZE_ALANG_CORE (MAP_CREATE (\"current_alang_handle\" (GET_CURRENT_ALANG_PROCEDURE_DEFINITIONS_HANDLE)) (\"current_directives_handle\" (GET_ALANG_CORE_DIRECTIVES_HANDLE)) (\"session_conceptual_model_summary\" (SUMMARIZE_CONCEPTUAL_MODEL (GET_STATE session.conceptual_model_handle) NIL))) CONSTRAINT_SET_VALID_ALANG_SYNTAX)))) (IF (IS_HANDLE_VALID alangHandle) (LET ((contentResult (READ_CONTENT alangHandle \"text\" NIL))) (IF (EQ (GET_STATUS contentResult) ALANG_STATUS_SUCCESS) (LET ((content (GET_DATA contentResult))) (LET ((markersOk (VERIFY_ALANG_FILE_MARKERS alangHandle (GET_STATE sys.alang_core_logic_version)))) (LET ((sectionCount (GET_ALANG_SECTION_COUNT alangHandle)))) (LET ((checksum (COMPUTE_FILE_CHECKSUM alangHandle \"SHA256\")))) (IF (AND markersOk (GT sectionCount 0) (NOT (IS_NIL checksum))) (SEQ (OUTPUT_TO_USER_BUFFER \"AI_PROVIDE_DATA\" content NIL) (OUTPUT_TO_USER_BUFFER \"AI_REQUEST_USER_ACTION\" (GET_TEXT_FOR_CDGIP_USER_VERIFICATION_MANDATE (GET_STATE sys.alang_core_logic_version) sectionCount) NIL) (OUTPUT_TO_USER_BUFFER \"AI_REQUEST_CLARIFICATION_QUESTIONS\" \"Output Backlog? (YES/NO)\" NIL) (SET_STATE session.pending_user_action \"AWAIT_YES_NO_FOR_BACKLOG_OUTPUT\") (RETURN_STATUS ALANG_STATUS_SUCCESS)) (RETURN_STATUS ALANG_STATUS_FAILURE_GENERATION_ERROR))))) (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL)))) (RETURN_STATUS ALANG_STATUS_FAILURE_GENERATION_ERROR)))) (FLUSH_USER_OUTPUT_BUFFER)))\n(DEFINE_PROCEDURE HandleBrowseCommand (argsList) (LET ((arg (GET_SESSION_CMD_ARG_BY_INDEX 0 NIL))) (IF (OR (STRING_IS_EMPTY_OR_NULL arg) (NOT (IS_NUMBER arg))) (RETURN_STATUS ALANG_STATUS_INVALID_ARGS)) (LET ((index (SUB (STRING_TO_NUMBER arg) 1))) (IF (OR (LT index 0) (GTE index (LIST_GET_LENGTH (GET_STATE session.last_search_results)))) (RETURN_STATUS ALANG_STATUS_INVALID_ARGS)) (IF (NOT (IS_TOOL_ENABLED \"browse\")) (RETURN_STATUS ALANG_STATUS_FAILURE_TOOL_UNAVAILABLE)) (LET ((url (MAP_GET_VALUE (LIST_GET_ITEM (GET_STATE session.last_search_results) index) \"url\" NIL))) (IF (STRING_IS_EMPTY_OR_NULL url) (RETURN_STATUS ALANG_STATUS_NOT_FOUND)) (LET ((jobId (INVOKE_TOOL_ASYNC_WITH_CALLBACKS \"browse\" url NIL \"HandleBrowseResult\" \"HandleBrowseError\" (MAP_CREATE (\"tool_id\" \"browse\") (\"original_context\" NIL) (\"original_input\" url) (\"original_params\" NIL)))))) (RETURN_STATUS ALANG_STATUS_SUCCESS))))))\n(DEFINE_PROCEDURE HandleUnknownCommand (commandName) (SEQ (OUTPUT_TO_USER_BUFFER \"AI_ERROR\" (STRING_CONCAT \"Unknown command: \" commandName) NIL) (RETURN_STATUS ALANG_STATUS_INVALID_COMMAND)))\n(DEFINE_PROCEDURE HandleOkCommand () (SEQ (SET_STATE session.last_user_response \"OK\") (RETURN_STATUS ALANG_STATUS_SUCCESS)))\n(DEFINE_PROCEDURE HandleNoCommand (argsList) (LET ((feedback (GET_SESSION_CMD_ARG_BY_INDEX 0 NIL))) (SEQ (SET_STATE session.last_user_response \"NO\") (SET_STATE session.last_user_feedback feedback) (CALL_PROCEDURE ProcessUserFeedbackForConceptualModel feedback (GET_STATE session.conceptual_model_handle)))) (RETURN_STATUS ALANG_STATUS_SUCCESS)))\n(DEFINE_PROCEDURE HandleInputCommand (argsList) (LET ((inputData (GET_SESSION_CMD_ARG_BY_INDEX 0 NIL))) (SEQ (SET_STATE session.last_user_response \"INPUT\") (SET_STATE session.last_user_input_data inputData) (CALL_PROCEDURE ProcessUserInputForConceptualModel inputData (GET_STATE session.conceptual_model_handle)))) (RETURN_STATUS ALANG_STATUS_SUCCESS)))\n(DEFINE_PROCEDURE HandleEndCommand () (SEQ (OUTPUT_TO_USER_BUFFER \"AI_REQUEST_CLARIFICATION_QUESTIONS\" \"End project? (YES/NO)\" NIL) (SET_STATE session.pending_user_action \"AWAIT_END_CONFIRMATION\") (RETURN_STATUS ALANG_STATUS_SUCCESS)))\n(DEFINE_PROCEDURE HandleLoopProjectRestartCommand () (SEQ (OUTPUT_TO_USER_BUFFER \"AI_REQUEST_CLARIFICATION_QUESTIONS\" \"Restart project? (YES/NO)\" NIL) (SET_STATE session.pending_user_action \"AWAIT_RESTART_CONFIRMATION\") (RETURN_STATUS ALANG_STATUS_SUCCESS)))\n(DEFINE_PROCEDURE HandleSetSessionPreferenceCommand (argsList) (LET ((prefMapResult (CALL_PROCEDURE ParseKeyValueArgs argsList))) (IF (EQ (GET_STATUS prefMapResult) ALANG_STATUS_SUCCESS) (SEQ (SET_STATE session.output_preferences (GET_DATA prefMapResult)) (RETURN_STATUS ALANG_STATUS_SUCCESS)) (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL))))))\n(DEFINE_PROCEDURE HandleStopLoopCommand () (SEQ (SET_STATE session.loop_stack (LIST_CREATE)) (RETURN_STATUS ALANG_STATUS_SUCCESS)))\n(DEFINE_PROCEDURE HandleOutputCommand (argsList) (LET ((artifactId (GET_SESSION_CMD_ARG_BY_INDEX 0 NIL))) (IF (STRING_IS_EMPTY_OR_NULL artifactId) (RETURN_STATUS ALANG_STATUS_INVALID_ARGS)) (LET ((handle (MAP_GET_VALUE (GET_STATE proj.artifacts) artifactId NIL))) (IF (IS_NIL handle) (RETURN_STATUS ALANG_STATUS_NOT_FOUND)) (LET ((contentResult (READ_CONTENT handle \"text_summary_or_full\" NIL))) (IF (EQ (GET_STATUS contentResult) ALANG_STATUS_SUCCESS) (SEQ (OUTPUT_TO_USER_BUFFER \"AI_PROVIDE_DATA\" (GET_DATA contentResult) NIL) (RETURN_STATUS ALANG_STATUS_SUCCESS)) (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL))))))\n(DEFINE_PROCEDURE HandleSummarizeCommand (argsList) (LET ((artifactId (GET_SESSION_CMD_ARG_BY_INDEX 0 NIL))) (IF (STRING_IS_EMPTY_OR_NULL artifactId) (RETURN_STATUS ALANG_STATUS_INVALID_ARGS)) (LET ((handle (MAP_GET_VALUE (GET_STATE proj.artifacts) artifactId NIL))) (IF (IS_NIL handle) (RETURN_STATUS ALANG_STATUS_NOT_FOUND)) (LET ((summaryResult (CALL_PROCEDURE SummarizeArtifact handle (GET_STATE session.conceptual_model_handle))))) (IF (EQ (GET_STATUS summaryResult) ALANG_STATUS_SUCCESS) (SEQ (OUTPUT_TO_USER_BUFFER \"AI_PROVIDE_DATA\" (GET_DATA summaryResult) NIL) (RETURN_STATUS ALANG_STATUS_SUCCESS)) (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL))))))\n(DEFINE_PROCEDURE HandleQueryCommand (argsList) (LET ((queryType (GET_SESSION_CMD_ARG_BY_INDEX 0 NIL))) (LET ((queryValue (GET_SESSION_CMD_ARG_BY_INDEX 1 NIL))) (IF (OR (STRING_IS_EMPTY_OR_NULL queryType) (STRING_IS_EMPTY_OR_NULL queryValue)) (RETURN_STATUS ALANG_STATUS_INVALID_ARGS)) (IF (EQ (STRING_UPPER queryType) \"PKA\") (LET ((queryResult (CALL_PROCEDURE PerformQuery queryType queryValue (GET_STATE session.conceptual_model_handle) (GET_STATE sys.knowledge_base_handle)))) (IF (EQ (GET_STATUS queryResult) ALANG_STATUS_SUCCESS) (SEQ (OUTPUT_TO_USER_BUFFER \"AI_PROVIDE_DATA\" (GET_DATA queryResult) NIL) (RETURN_STATUS ALANG_STATUS_SUCCESS)) (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL))) (LET ((queryResult (QUERY_CONCEPTUAL_MODEL (MAP_CREATE (\"type\" queryType) (\"value\" queryValue)) (GET_STATE session.conceptual_model_handle))))) (IF (EQ (GET_STATUS queryResult) ALANG_STATUS_SUCCESS) (SEQ (OUTPUT_TO_USER_BUFFER \"AI_PROVIDE_DATA\" (GET_DATA queryResult) NIL) (RETURN_STATUS ALANG_STATUS_SUCCESS)) (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL)))))))\n(DEFINE_PROCEDURE HandleOutputBacklogCommand (argsList) (LET ((contentResult (CALL_PROCEDURE GetEvolutionBacklogContent))) (IF (EQ (GET_STATUS contentResult) ALANG_STATUS_SUCCESS) (SEQ (OUTPUT_TO_USER_BUFFER \"AI_PROVIDE_DATA\" (GET_DATA contentResult) NIL) (RETURN_STATUS ALANG_STATUS_SUCCESS)) (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL))))\n(DEFINE_PROCEDURE HandlePromoteToPkaCommand (argsList) (LET ((artifactId (GET_SESSION_CMD_ARG_BY_INDEX 0 NIL))) (LET ((rationale (GET_SESSION_CMD_ARG_BY_INDEX 1 NIL))) (LET ((schemaId (GET_SESSION_CMD_ARG_BY_INDEX 2 NIL))) (IF (OR (STRING_IS_EMPTY_OR_NULL artifactId) (STRING_IS_EMPTY_OR_NULL rationale)) (RETURN_STATUS ALANG_STATUS_INVALID_ARGS)) (LET ((handle (MAP_GET_VALUE (GET_STATE proj.artifacts) artifactId NIL))) (IF (IS_NIL handle) (RETURN_STATUS ALANG_STATUS_NOT_FOUND)) (LET ((contentResult (READ_CONTENT handle \"text_summary_or_full\" NIL)))) (IF (NEQ (GET_STATUS contentResult) ALANG_STATUS_SUCCESS) (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL)) (LET ((content (GET_DATA contentResult)))) (IF (IS_NIL content) (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL)) (CALL_PROCEDURE CreateAndStorePKAIfUserConsents content schemaId rationale (GET_STATE session.conceptual_model_handle)) (RETURN_STATUS ALANG_STATUS_SUCCESS)))))))\n(DEFINE_PROCEDURE HandleSearchPkaCommand (argsList) (LET ((keywords (GET_SESSION_CMD_ARG_BY_INDEX 0 NIL))) (IF (STRING_IS_EMPTY_OR_NULL keywords) (RETURN_STATUS ALANG_STATUS_INVALID_ARGS)) (LET ((searchResultsResult (PKA_QUERY (MAP_CREATE (\"keywords\" keywords)) NIL)))) (IF (EQ (GET_STATUS searchResultsResult) ALANG_STATUS_SUCCESS) (LET ((results (GET_DATA searchResultsResult))) (IF (LIST_IS_EMPTY results) (OUTPUT_TO_USER_BUFFER \"AI_PROVIDE_DATA\" \"No PKAs found.\" NIL) (LOOP_FOR_EACH handle results (SEQ (OUTPUT_TO_USER_BUFFER \"AI_PROVIDE_DATA\" (STRING_CONCAT \"- ID: \" (GET_HANDLE_METADATA handle \"id\") \" Title: \" (GET_HANDLE_METADATA handle \"title\")) NIL) (RELEASE_HANDLE handle)))) (CALL_PROCEDURE ProcessPkaSearchResultsForConceptualModel results (GET_STATE session.conceptual_model_handle)) (RETURN_STATUS ALANG_STATUS_SUCCESS)) (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL))))))\n(DEFINE_PROCEDURE HandleSetQaOutputVerbosityCommand (argsList) (LET ((level (GET_SESSION_CMD_ARG_BY_INDEX 0 NIL))) (IF (OR (STRING_IS_EMPTY_OR_NULL level) (AND (NEQ level \"CONCISE\") (NEQ level \"VERBOSE\"))) (RETURN_STATUS ALANG_STATUS_INVALID_ARGS)) (SET_STATE session.qa_output_verbosity level) (RETURN_STATUS ALANG_STATUS_SUCCESS))))\n(DEFINE_PROCEDURE HandleSetOutputDetailCommand (argsList) (LET ((level (GET_SESSION_CMD_ARG_BY_INDEX 0 NIL))) (IF (OR (STRING_IS_EMPTY_OR_NULL level) (AND (NEQ level \"MINIMAL\") (NEQ level \"STANDARD\") (NEQ level \"EXHAUSTIVE\"))) (RETURN_STATUS ALANG_STATUS_INVALID_ARGS)) (SET_STATE session.output_detail level) (RETURN_STATUS ALANG_STATUS_SUCCESS))))\n(DEFINE_PROCEDURE HandleLoopCommand (argsList) (RETURN_STATUS ALANG_STATUS_SUCCESS))\n(DEFINE_PROCEDURE HandleSystemQACommand () (SEQ (ACKNOWLEDGE_AND_LOG \"CMD_SYSTEM_QA\" \"SYSTEM_QA received.\" \"AI_ACKNOWLEDGE_INTENT\" \"SYSTEM_QA received. Initiating cycle.\") (SET_STATE sys.evolution_trigger_pending TRUE) (RETURN_STATUS ALANG_STATUS_SUCCESS)))\n\n;; --- Section 4: Phase Logic Dispatcher & Specific Phase Execution Procedures ---\n\n(DEFINE_PROCEDURE DispatchPhaseExecution (phaseId) (IF (EQ phaseId \"PHASE_INIT\") (CALL_PROCEDURE ExecutePhaseInit)) (IF (EQ phaseId \"PHASE_IDEA_FORMULATION\") (CALL_PROCEDURE ExecutePhaseIdeaFormulation)) (IF (EQ phaseId \"PHASE_PRODUCT_DEFINITION\") (CALL_PROCEDURE ExecutePhaseProductDefinition)) (IF (EQ phaseId \"PHASE_PLANNING\") (CALL_PROCEDURE ExecutePhasePlanning)) (IF (EQ phaseId \"PHASE_TASK_EXECUTION\") (CALL_PROCEDURE ExecutePhaseTaskExecution)) (IF (EQ phaseId \"PHASE_FINAL_REVIEW\") (CALL_PROCEDURE ExecutePhaseFinalReview)) (IF (EQ phaseId \"PHASE_COMPLETION_SUMMARY\") (CALL_PROCEDURE ExecutePhaseCompletionSummary)) (IF (NOT (IS_NIL phaseId) (IS_NIL (MAP_GET_VALUE (MAP_CREATE (\"PHASE_INIT\" TRUE) (\"PHASE_IDEA_FORMULATION\" TRUE) (\"PHASE_PRODUCT_DEFINITION\" TRUE) (\"PHASE_PLANNING\" TRUE) (\"PHASE_TASK_EXECUTION\" TRUE) (\"PHASE_FINAL_REVIEW\" TRUE) (\"PHASE_COMPLETION_SUMMARY\" TRUE)) phaseId NIL)))) (RETURN_STATUS ALANG_STATUS_FAILURE_INVALID_PHASE))))\n(DEFINE_PROCEDURE ExecutePhaseInit () (RETURN_STATUS ALANG_STATUS_SUCCESS))\n(DEFINE_PROCEDURE ExecutePhaseIdeaFormulation () (LET ((ideaHandle (CREATE_EMPTY_ARTIFACT \"PatternIdeasDocument\"))) (LET ((genResult (SAFE_GENERATE_CONTENT ideaHandle PROMPT_TEMPLATE_GENERATE_PATTERN_IDEAS (MAP_CREATE (\"project_title\" (GET_STATE proj.title)) (\"session_conceptual_model_handle\" (GET_STATE session.conceptual_model_handle))) CONSTRAINT_SET_IDEA_GENERATION)))) (IF (OR (EQ (GET_STATUS genResult) ALANG_STATUS_SUCCESS) (EQ (GET_STATUS genResult) ALANG_STATUS_PAUSE_FOR_USER_INPUT)) (SEQ (SET_STATE proj.artifacts (MAP_SET_VALUE (GET_STATE proj.artifacts) \"pattern_ideas\" ideaHandle)) (CALL_PROCEDURE ProcessGeneratedArtifactForConceptualModel ideaHandle \"pattern_ideas\" (GET_STATE session.conceptual_model_handle)) (IF (EQ (GET_STATUS genResult) ALANG_STATUS_PAUSE_FOR_USER_INPUT) (RETURN_STATUS ALANG_STATUS_PAUSE_FOR_USER_INPUT) (SEQ (SET_STATE session.pending_user_action_details (MAP_CREATE (\"phase\" \"PHASE_IDEA_FORMULATION\") (\"artifact_handle\" ideaHandle))) (SET_STATE session.pending_user_action \"AWAIT_OK_REVISE_PHASE_ARTIFACT\") (RETURN_STATUS ALANG_STATUS_SUCCESS))))) (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL))))))\n(DEFINE_PROCEDURE ExecutePhaseProductDefinition () (LET ((prodDefHandle (CREATE_EMPTY_ARTIFACT \"ProductDefinitionDocument\"))) (LET ((genResult (SAFE_GENERATE_CONTENT prodDefHandle PROMPT_TEMPLATE_PRODUCT_DEFINITION (MAP_CREATE (\"project_title\" (GET_STATE proj.title)) (\"pattern_ideas_handle\" (MAP_GET_VALUE (GET_STATE proj.artifacts) \"pattern_ideas\")) (\"session_conceptual_model_handle\" (GET_STATE session.conceptual_model_handle))) CONSTRAINT_SET_PRODUCT_DEFINITION)))) (IF (OR (EQ (GET_STATUS genResult) ALANG_STATUS_SUCCESS) (EQ (GET_STATUS genResult) ALANG_STATUS_PAUSE_FOR_USER_INPUT)) (SEQ (SET_STATE proj.artifacts (MAP_SET_VALUE (GET_STATE proj.artifacts) \"product_definition\" prodDefHandle)) (CALL_PROCEDURE ProcessGeneratedArtifactForConceptualModel prodDefHandle \"product_definition\" (GET_STATE session.conceptual_model_handle)) (IF (EQ (GET_STATUS genResult) ALANG_STATUS_PAUSE_FOR_USER_INPUT) (RETURN_STATUS ALANG_STATUS_PAUSE_FOR_USER_INPUT) (SEQ (SET_STATE session.pending_user_action_details (MAP_CREATE (\"phase\" \"PHASE_PRODUCT_DEFINITION\") (\"artifact_handle\" prodDefHandle))) (SET_STATE session.pending_user_action \"AWAIT_OK_REVISE_PHASE_ARTIFACT\") (RETURN_STATUS ALANG_STATUS_SUCCESS))))) (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL))))))\n(DEFINE_PROCEDURE ExecutePhasePlanning () (LET ((taskListHandle (CREATE_EMPTY_ARTIFACT \"TaskListDocument\"))) (LET ((genResult (SAFE_GENERATE_CONTENT taskListHandle PROMPT_TEMPLATE_GENERATE_TASK_LIST (MAP_CREATE (\"project_title\" (GET_STATE proj.title)) (\"product_definition_handle\" (MAP_GET_VALUE (GET_STATE proj.artifacts) \"product_definition\")) (\"session_conceptual_model_handle\" (GET_STATE session.conceptual_model_handle))) CONSTRAINT_SET_PLANNING)))) (IF (OR (EQ (GET_STATUS genResult) ALANG_STATUS_SUCCESS) (EQ (GET_STATUS genResult) ALANG_STATUS_PAUSE_FOR_USER_INPUT)) (SEQ (SET_STATE proj.artifacts (MAP_SET_VALUE (GET_STATE proj.artifacts) \"task_list\" taskListHandle)) (CALL_PROCEDURE ProcessGeneratedArtifactForConceptualModel taskListHandle \"task_list\" (GET_STATE session.conceptual_model_handle)) (IF (EQ (GET_STATUS genResult) ALANG_STATUS_PAUSE_FOR_USER_INPUT) (RETURN_STATUS ALANG_STATUS_PAUSE_FOR_USER_INPUT) (SEQ (SET_STATE session.pending_user_action_details (MAP_CREATE (\"phase\" \"PHASE_PLANNING\") (\"artifact_handle\" taskListHandle))) (SET_STATE session.pending_user_action \"AWAIT_OK_REVISE_PHASE_ARTIFACT\") (RETURN_STATUS ALANG_STATUS_SUCCESS))))) (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL))))))\n(DEFINE_PROCEDURE ExecutePhaseTaskExecution () (LET ((taskListHandle (MAP_GET_VALUE (GET_STATE proj.artifacts) \"task_list\" NIL))) (IF (IS_NIL taskListHandle) (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL)) (LET ((taskListResult (READ_CONTENT taskListHandle \"json_map_list\" NIL)))) (IF (EQ (GET_STATUS taskListResult) ALANG_STATUS_SUCCESS) (LET ((taskList (GET_DATA taskListResult))) (LOOP_FOR_EACH taskItem taskList (LET ((taskId (MAP_GET_VALUE taskItem \"id\"))) (LET ((taskDesc (MAP_GET_VALUE taskItem \"description\"))) (LET ((taskArtifactHandle (CREATE_EMPTY_ARTIFACT (STRING_CONCAT \"Task_\" taskId \"_Output\")))) (LET ((genResult (SAFE_GENERATE_CONTENT taskArtifactHandle PROMPT_TEMPLATE_EXECUTE_TASK (MAP_CREATE (\"task_id\" taskId) (\"task_description\" taskDesc) (\"project_artifacts\" (GET_STATE proj.artifacts)) (\"session_conceptual_model_handle\" (GET_STATE session.conceptual_model_handle))) CONSTRAINT_SET_TASK_EXECUTION)))) (IF (OR (EQ (GET_STATUS genResult) ALANG_STATUS_SUCCESS) (EQ (GET_STATUS genResult) ALANG_STATUS_PAUSE_FOR_USER_INPUT)) (SEQ (CALL_PROCEDURE ProcessGeneratedArtifactForConceptualModel taskArtifactHandle (STRING_CONCAT \"task_\" taskId \"_output\") (GET_STATE session.conceptual_model_handle)) (SET_STATE proj.artifacts (MAP_SET_VALUE (GET_STATE proj.artifacts) (STRING_CONCAT \"task_\" taskId \"_output\") taskArtifactHandle)) (IF (EQ (GET_STATUS genResult) ALANG_STATUS_PAUSE_FOR_USER_INPUT) (SEQ (SET_STATE session.pending_user_action_details (MAP_CREATE (\"phase\" \"PHASE_TASK_EXECUTION\") (\"artifact_handle\" taskArtifactHandle) (\"task_id\" taskId))) (SET_STATE session.pending_user_action \"AWAIT_OK_REVISE_PHASE_ARTIFACT\") (RETURN_STATUS ALANG_STATUS_PAUSE_FOR_USER_INPUT)))) (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL)))))))) (RETURN_STATUS ALANG_STATUS_SUCCESS)) (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL))))))\n(DEFINE_PROCEDURE ExecutePhaseFinalReview () (LET ((draftHandle (CREATE_EMPTY_ARTIFACT \"CompiledProjectDraft\"))) (LET ((genResult (SAFE_GENERATE_CONTENT draftHandle PROMPT_TEMPLATE_COMPILE_DRAFT (MAP_CREATE (\"project_artifacts\" (GET_STATE proj.artifacts)) (\"session_conceptual_model_handle\" (GET_STATE session.conceptual_model_handle))) CONSTRAINT_SET_FINAL_REVIEW)))) (IF (OR (EQ (GET_STATUS genResult) ALANG_STATUS_SUCCESS) (EQ (GET_STATUS genResult) ALANG_STATUS_PAUSE_FOR_USER_INPUT)) (SEQ (SET_STATE proj.artifacts (MAP_SET_VALUE (GET_STATE proj.artifacts) \"final_draft\" draftHandle)) (CALL_PROCEDURE ProcessGeneratedArtifactForConceptualModel draftHandle \"final_draft\" (GET_STATE session.conceptual_model_handle)) (IF (EQ (GET_STATUS genResult) ALANG_STATUS_PAUSE_FOR_USER_INPUT) (RETURN_STATUS ALANG_STATUS_PAUSE_FOR_USER_INPUT) (SEQ (SET_STATE session.pending_user_action_details (MAP_CREATE (\"phase\" \"PHASE_FINAL_REVIEW\") (\"artifact_handle\" draftHandle))) (SET_STATE session.pending_user_action \"AWAIT_OK_REVISE_PHASE_ARTIFACT\") (RETURN_STATUS ALANG_STATUS_SUCCESS))))) (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL))))))\n(DEFINE_PROCEDURE ExecutePhaseCompletionSummary () (LET ((summaryHandle (CREATE_EMPTY_ARTIFACT \"ProjectSummary\"))) (LET ((genResult (SAFE_GENERATE_CONTENT summaryHandle PROMPT_TEMPLATE_PROJECT_SUMMARY (MAP_CREATE (\"project_id\" (GET_STATE proj.id)) (\"project_artifacts\" (GET_STATE proj.artifacts)) (\"tau_project_log\" (GET_STATE proj.tau_project_log)) (\"session_conceptual_model_handle\" (GET_STATE session.conceptual_model_handle))) CONSTRAINT_SET_SUMMARY)))) (IF (OR (EQ (GET_STATUS genResult) ALANG_STATUS_SUCCESS) (EQ (GET_STATUS genResult) ALANG_STATUS_PAUSE_FOR_USER_INPUT)) (SEQ (SET_STATE proj.artifacts (MAP_SET_VALUE (GET_STATE proj.artifacts) \"project_summary\" summaryHandle)) (CALL_PROCEDURE ProcessGeneratedArtifactForEvolution summaryHandle \"project_summary\" (GET_STATE session.conceptual_model_handle)) (IF (EQ (GET_STATUS genResult) ALANG_STATUS_PAUSE_FOR_USER_INPUT) (RETURN_STATUS ALANG_STATUS_PAUSE_FOR_USER_INPUT) (RETURN_STATUS ALANG_STATUS_SUCCESS)))) (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL))))))\n\n;; --- Section 5: QA Procedures ---\n\n(DEFINE_PROCEDURE PerformProductQA (artifact_handle schema_id session_model_handle) (LET ((qaIterationCount 0))) (LET ((maxQaIterations 5))) (LET ((substantiveIssuesFoundThisCycle TRUE))) (LOOP_WHILE (AND substantiveIssuesFoundThisCycle (LT qaIterationCount maxQaIterations))) (SEQ (SET_STATE qaIterationCount (ADD qaIterationCount 1)) (SET_STATE substantiveIssuesFoundThisCycle FALSE) (LET ((stage1ReportHandle (CREATE_EMPTY_ARTIFACT \"qa_critique_self\")))) (LET ((stage1Result (SAFE_GENERATE_CONTENT stage1ReportHandle PROMPT_TEMPLATE_QA_SELF_CRITIQUE (MAP_CREATE (\"artifact_content_handle\" artifact_handle) (\"session_conceptual_model_handle\" session_model_handle)) CONSTRAINT_SET_QA_CRITIQUE)))) (IF (OR (IS_STATUS_FAILURE (GET_STATUS stage1Result)) (EQ (GET_STATUS stage1Result) ALANG_STATUS_PAUSE_FOR_USER_INPUT))) (RETURN_STATUS (MAP_CREATE (\"status\" (IF (IS_STATUS_FAILURE (GET_STATUS stage1Result)) (GET_STATUS stage1Result) ALANG_STATUS_PAUSE_FOR_USER_INPUT)) (\"data\" NIL)))) (IF (CHECK_FOR_SUBSTANTIVE_ISSUES stage1ReportHandle) (SEQ (SET_STATE substantiveIssuesFoundThisCycle TRUE) (LET ((revisionStatus (CALL_PROCEDURE ApplyRevisionsToArtifact artifact_handle stage1ReportHandle session_model_handle CONSTRAINT_SET_TASK_EXECUTION)))) (IF (EQ revisionStatus ALANG_STATUS_PAUSE_FOR_USER_INPUT) (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_PAUSE_FOR_USER_INPUT) (\"data\" NIL)))) (IF (IS_STATUS_FAILURE revisionStatus) (RETURN_STATUS (MAP_CREATE (\"status\" revisionStatus) (\"data\" NIL))))))) (RELEASE_HANDLE stage1ReportHandle) (IF (NOT substantiveIssuesFoundThisCycle)) (SEQ (LET ((stage2ReportHandle (CREATE_EMPTY_ARTIFACT \"qa_critique_divergent\")))) (LET ((stage2Result (SAFE_GENERATE_CONTENT stage2ReportHandle PROMPT_TEMPLATE_QA_DIVERGENT_EXPLORATION (MAP_CREATE (\"artifact_content_handle\" artifact_handle) (\"session_conceptual_model_handle\" session_model_handle)) CONSTRAINT_SET_QA_CRITIQUE)))) (IF (OR (IS_STATUS_FAILURE (GET_STATUS stage2Result)) (EQ (GET_STATUS stage2Result) ALANG_STATUS_PAUSE_FOR_USER_INPUT))) (RETURN_STATUS (MAP_CREATE (\"status\" (IF (IS_STATUS_FAILURE (GET_STATUS stage2Result)) (GET_STATUS stage2Result) ALANG_STATUS_PAUSE_FOR_USER_INPUT)) (\"data\" NIL)))) (IF (CHECK_FOR_SUBSTANTIVE_ISSUES stage2ReportHandle) (SEQ (SET_STATE substantiveIssuesFoundThisCycle TRUE) (LET ((revisionStatus (CALL_PROCEDURE ApplyRevisionsToArtifact artifact_handle stage2ReportHandle session_model_handle CONSTRAINT_SET_TASK_EXECUTION)))) (IF (EQ revisionStatus ALANG_STATUS_PAUSE_FOR_USER_INPUT) (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_PAUSE_FOR_USER_INPUT) (\"data\" NIL)))) (IF (IS_STATUS_FAILURE revisionStatus) (RETURN_STATUS (MAP_CREATE (\"status\" revisionStatus) (\"data\" NIL))))))) (RELEASE_HANDLE stage2ReportHandle)))) (IF (NOT substantiveIssuesFoundThisCycle)) (SEQ (LET ((stage3ReportHandle (CREATE_EMPTY_ARTIFACT \"qa_critique_redteam\")))) (LET ((stage3Result (SAFE_GENERATE_CONTENT stage3ReportHandle PROMPT_TEMPLATE_QA_RED_TEaming (MAP_CREATE (\"artifact_content_handle\" artifact_handle) (\"session_conceptual_model_handle\" session_model_handle)) CONSTRAINT_SET_QA_CRITIQUE)))) (IF (OR (IS_STATUS_FAILURE (GET_STATUS stage3Result)) (EQ (GET_STATUS stage3Result) ALANG_STATUS_PAUSE_FOR_USER_INPUT))) (RETURN_STATUS (MAP_CREATE (\"status\" (IF (IS_STATUS_FAILURE (GET_STATUS stage3Result)) (GET_STATUS stage3Result) ALANG_STATUS_PAUSE_FOR_USER_INPUT)) (\"data\" NIL)))) (IF (CHECK_FOR_SUBSTANTIVE_ISSUES stage3ReportHandle) (SEQ (SET_STATE substantiveIssuesFoundThisCycle TRUE) (LET ((revisionStatus (CALL_PROCEDURE ApplyRevisionsToArtifact artifact_handle stage3ReportHandle session_model_handle CONSTRAINT_SET_TASK_EXECUTION)))) (IF (EQ revisionStatus ALANG_STATUS_PAUSE_FOR_USER_INPUT) (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_PAUSE_FOR_USER_INPUT) (\"data\" NIL)))) (IF (IS_STATUS_FAILURE revisionStatus) (RETURN_STATUS (MAP_CREATE (\"status\" revisionStatus) (\"data\" NIL))))))) (RELEASE_HANDLE stage3ReportHandle)))) (IF (NOT substantiveIssuesFoundThisCycle)) (SEQ (LET ((stage4ReportHandle (CREATE_EMPTY_ARTIFACT \"qa_critique_external\")))) (LET ((stage4Result (SAFE_GENERATE_CONTENT stage4ReportHandle PROMPT_TEMPLATE_QA_EXTERNAL_REVIEW (MAP_CREATE (\"artifact_content_handle\" artifact_handle) (\"session_conceptual_model_handle\" session_model_handle)) CONSTRAINT_SET_QA_CRITIQUE)))) (IF (OR (IS_STATUS_FAILURE (GET_STATUS stage4Result)) (EQ (GET_STATUS stage4Result) ALANG_STATUS_PAUSE_FOR_USER_INPUT))) (RETURN_STATUS (MAP_CREATE (\"status\" (IF (IS_STATUS_FAILURE (GET_STATUS stage4Result)) (GET_STATUS stage4Result) ALANG_STATUS_PAUSE_FOR_USER_INPUT)) (\"data\" NIL)))) (IF (CHECK_FOR_SUBSTANTIVE_ISSUES stage4ReportHandle) (SEQ (SET_STATE substantiveIssuesFoundThisCycle TRUE) (LET ((revisionStatus (CALL_PROCEDURE ApplyRevisionsToArtifact artifact_handle stage4ReportHandle session_model_handle CONSTRAINT_SET_TASK_EXECUTION)))) (IF (EQ revisionStatus ALANG_STATUS_PAUSE_FOR_USER_INPUT) (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_PAUSE_FOR_USER_INPUT) (\"data\" NIL)))) (IF (IS_STATUS_FAILURE revisionStatus) (RETURN_STATUS (MAP_CREATE (\"status\" revisionStatus) (\"data\" NIL))))))) (RELEASE_HANDLE stage4ReportHandle)))))) (IF (AND substantiveIssuesFoundThisCycle (EQ qaIterationCount maxQaIterations)) (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_FAILURE_QA_MAX_ITERATIONS) (\"data\" NIL))) (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_SUCCESS) (\"data\" artifact_handle))))))\n(DEFINE_PROCEDURE ApplyRevisionsToArtifact (artifact_handle qa_report_handle session_model_handle constraints_handle) (LET ((qaReportResult (READ_CONTENT qa_report_handle \"structured_map\" NIL))) (LET ((artifactContentResult (READ_CONTENT artifact_handle \"text_summary_or_full\" NIL))) (LET ((sessionModelResult (READ_CONTENT session_model_handle \"structured_map\" NIL))) (LET ((constraintsResult (READ_CONTENT constraints_handle \"structured_list_of_rules\" NIL))) (IF (AND (EQ (GET_STATUS qaReportResult) ALANG_STATUS_SUCCESS) (EQ (GET_STATUS artifactContentResult) ALANG_STATUS_SUCCESS) (EQ (GET_STATUS sessionModelResult) ALANG_STATUS_SUCCESS) (EQ (GET_STATUS constraintsResult) ALANG_STATUS_SUCCESS)) (LET ((qaReport (GET_DATA qaReportResult))) (LET ((artifactContent (GET_DATA artifactContentResult))) (LET ((sessionModel (GET_DATA sessionModelResult))) (LET ((constraints (GET_DATA constraintsResult))) (LET ((revisionPlanResult (INVOKE_CORE_LLM_GENERATION (MAP_CREATE (\"template\" PROMPT_TEMPLATE_ANALYZE_QA_REPORT_FOR_REVISIONS) (\"qa_report\" qaReport) (\"artifact_content\" artifactContent) (\"session_model\" sessionModel) (\"constraints\" constraints)) (GET_LLM_PARAMS_FOR_TASK \"revision_planning\")))) (IF (EQ (GET_STATUS revisionPlanResult) ALANG_STATUS_SUCCESS) (LET ((revisionPlan (GET_DATA revisionPlanResult))) (IF (EQ (MAP_GET_VALUE revisionPlan \"strategy\") \"self_correct\") (LET ((correctionResult (SelfCorrectArtifact artifactContent (MAP_GET_VALUE revisionPlan \"details\") constraints_handle session_model_handle)))) (IF (EQ (GET_STATUS correctionResult) ALANG_STATUS_SUCCESS) (LET ((writeStatus (WRITE_CONTENT_TO_ARTIFACT artifact_handle (GET_DATA correctionResult) \"text/markdown\")))) (IF (EQ writeStatus ALANG_STATUS_SUCCESS) (RETURN_STATUS ALANG_STATUS_SUCCESS) (SEQ (SET_STATE session.pending_user_action_details (MAP_CREATE (\"artifact_handle\" artifact_handle) (\"qa_report_handle\" qa_report_handle) (\"constraints_handle\" constraints_handle) (\"original_generated_text\" artifactContent))) (SET_STATE session.pending_user_action \"AWAIT_REVISION_REVIEW\") (RETURN_STATUS ALANG_STATUS_PAUSE_FOR_USER_INPUT))))) (SEQ (SET_STATE session.pending_user_action_details (MAP_CREATE (\"artifact_handle\" artifact_handle) (\"qa_report_handle\" qa_report_handle) (\"constraints_handle\" constraints_handle) (\"original_generated_text\" artifactContent))) (SET_STATE session.pending_user_action \"AWAIT_REVISION_REVIEW\") (RETURN_STATUS ALANG_STATUS_PAUSE_FOR_USER_INPUT))))) (IF (EQ (MAP_GET_VALUE revisionPlan \"strategy\") \"user_review\") (SEQ (SET_STATE session.pending_user_action_details (MAP_CREATE (\"artifact_handle\" artifact_handle) (\"qa_report_handle\" qa_report_handle) (\"constraints_handle\" constraints_handle) (\"original_generated_text\" artifactContent))) (SET_STATE session.pending_user_action \"AWAIT_REVISION_REVIEW\") (RETURN_STATUS ALANG_STATUS_PAUSE_FOR_USER_INPUT)) (SEQ (SET_STATE session.pending_user_action_details (MAP_CREATE (\"artifact_handle\" artifact_handle) (\"qa_report_handle\" qa_report_handle) (\"constraints_handle\" constraints_handle) (\"original_generated_text\" artifactContent))) (SET_STATE session.pending_user_action \"AWAIT_REVISION_REVIEW\") (RETURN_STATUS ALANG_STATUS_PAUSE_FOR_USER_INPUT))))) (SEQ (SET_STATE session.pending_user_action_details (MAP_CREATE (\"artifact_handle\" artifact_handle) (\"qa_report_handle\" qa_report_handle) (\"constraints_handle\" constraints_handle) (\"original_generated_text\" artifactContent))) (SET_STATE session.pending_user_action \"AWAIT_REVISION_REVIEW\") (RETURN_STATUS ALANG_STATUS_PAUSE_FOR_USER_INPUT)))))) (SEQ (SET_STATE session.pending_user_action_details (MAP_CREATE (\"artifact_handle\" artifact_handle) (\"qa_report_handle\" qa_report_handle) (\"constraints_handle\" constraints_handle) (\"original_generated_text\" NIL))) (SET_STATE session.pending_user_action \"AWAIT_REVISION_REVIEW\") (RETURN_STATUS ALANG_STATUS_PAUSE_FOR_USER_INPUT)))))))\n(DEFINE_PROCEDURE ApplyFeedbackBasedRevision (artifact_handle feedback_text constraints_handle session_model_handle context_details) (LET ((artifactContentResult (READ_CONTENT artifact_handle \"text_summary_or_full\" NIL))) (LET ((sessionModelResult (READ_CONTENT session_model_handle \"structured_map\" NIL))) (LET ((constraintsResult (READ_CONTENT constraints_handle \"structured_list_of_rules\" NIL))) (IF (AND (EQ (GET_STATUS artifactContentResult) ALANG_STATUS_SUCCESS) (EQ (GET_STATUS sessionModelResult) ALANG_STATUS_SUCCESS) (EQ (GET_STATUS constraintsResult) ALANG_STATUS_SUCCESS)) (LET ((artifactContent (GET_DATA artifactContentResult))) (LET ((sessionModel (GET_DATA sessionModelResult))) (LET ((constraints (GET_DATA constraintsResult))) (LET ((revisionResult (INVOKE_CORE_LLM_GENERATION (MAP_CREATE (\"template\" PROMPT_TEMPLATE_ANALYZE_FEEDBACK_FOR_REVISION) (\"artifact_content\" artifactContent) (\"user_feedback\" feedback_text) (\"session_model\" sessionModel) (\"constraints\" constraints) (\"previous_qa_context\" context_details)) (GET_LLM_PARAMS_FOR_TASK \"feedback_based_revision\")))) (IF (EQ (GET_STATUS revisionResult) ALANG_STATUS_SUCCESS) (LET ((revisedContent (GET_DATA revisionResult))) (LET ((writeStatus (WRITE_CONTENT_TO_ARTIFACT artifact_handle revisedContent \"text/markdown\")))) (IF (EQ writeStatus ALANG_STATUS_SUCCESS) (RETURN_STATUS ALANG_STATUS_SUCCESS) (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL)))) (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL)))))) (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL)))))))\n(DEFINE_PROCEDURE QA_Stage_1_SelfCritique (artifact_handle session_model_handle) (LET ((reportHandle (CREATE_EMPTY_ARTIFACT \"qa_critique_self\"))) (LET ((genResult (SAFE_GENERATE_CONTENT reportHandle PROMPT_TEMPLATE_QA_SELF_CRITIQUE (MAP_CREATE (\"artifact_content_handle\" artifact_handle) (\"session_conceptual_model_handle\" session_model_handle)) CONSTRAINT_SET_QA_CRITIQUE)))) (IF (OR (EQ (GET_STATUS genResult) ALANG_STATUS_SUCCESS) (EQ (GET_STATUS genResult) ALANG_STATUS_PAUSE_FOR_USER_INPUT)) (RETURN_STATUS (MAP_CREATE (\"status\" (GET_STATUS genResult)) (\"data\" reportHandle))) (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_FAILURE_GENERAL) (\"data\" NIL))))))\n(DEFINE_PROCEDURE PerformSystemQA (directives_handle evolution_backlog_handle session_model_handle selected_backlog_item_ids) (LET ((qaIterationCount 0))) (LET ((maxQaIterations 5))) (LET ((substantiveIssuesFoundThisCycle TRUE))) (LOOP_WHILE (AND substantiveIssuesFoundThisCycle (LT qaIterationCount maxQaIterations))) (SEQ (SET_STATE qaIterationCount (ADD qaIterationCount 1)) (SET_STATE substantiveIssuesFoundThisCycle FALSE) (LET ((pendingChangesHandle (GET_PROPOSED_CORE_LOGIC_CHANGES_HANDLE)))) (IF (IS_HANDLE_VALID pendingChangesHandle) (LET ((applyStatus (APPLY_CORE_LOGIC_CHANGES pendingChangesHandle)))) (IF (NEQ applyStatus ALANG_STATUS_SUCCESS) (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL) (CLEAR_PENDING_CORE_LOGIC_CHANGES)))) (LET ((stage1ReportHandle (CREATE_EMPTY_ARTIFACT \"system_qa_critique_self\")))) (LET ((stage1Result (SAFE_GENERATE_CONTENT stage1ReportHandle PROMPT_TEMPLATE_QA_SELF_CRITIQUE (MAP_CREATE (\"artifact_content_handle\" directives_handle) (\"session_conceptual_model_handle\" session_model_handle) (\"backlog_focus_ids\" selected_backlog_item_ids)) CONSTRAINT_SET_QA_CRITIQUE)))) (IF (OR (IS_STATUS_FAILURE (GET_STATUS stage1Result)) (EQ (GET_STATUS stage1Result) ALANG_STATUS_PAUSE_FOR_USER_INPUT))) (RETURN_STATUS (IF (IS_STATUS_FAILURE (GET_STATUS stage1Result)) (GET_STATUS stage1Result) ALANG_STATUS_PAUSE_FOR_USER_INPUT)))) (IF (CHECK_FOR_SUBSTANTIVE_ISSUES stage1ReportHandle) (SEQ (SET_STATE substantiveIssuesFoundThisCycle TRUE) (LET ((proposalStatus (CALL_PROCEDURE ProposeDirectiveChanges stage1ReportHandle session_model_handle)))) (IF (IS_STATUS_FAILURE proposalStatus) (RETURN_STATUS proposalStatus))))) (RELEASE_HANDLE stage1ReportHandle) (IF (NOT substantiveIssuesFoundThisCycle)) (SEQ (LET ((stage2ReportHandle (CREATE_EMPTY_ARTIFACT \"system_qa_critique_divergent\")))) (LET ((stage2Result (SAFE_GENERATE_CONTENT stage2ReportHandle PROMPT_TEMPLATE_QA_DIVERGENT_EXPLORATION (MAP_CREATE (\"artifact_content_handle\" directives_handle) (\"session_conceptual_model_handle\" session_model_handle) (\"backlog_focus_ids\" selected_backlog_item_ids)) CONSTRAINT_SET_QA_CRITIQUE)))) (IF (OR (IS_STATUS_FAILURE (GET_STATUS stage2Result)) (EQ (GET_STATUS stage2Result) ALANG_STATUS_PAUSE_FOR_USER_INPUT))) (RETURN_STATUS (IF (IS_STATUS_FAILURE (GET_STATUS stage2Result)) (GET_STATUS stage2Result) ALANG_STATUS_PAUSE_FOR_USER_INPUT)))) (IF (CHECK_FOR_SUBSTANTIVE_ISSUES stage2ReportHandle) (SEQ (SET_STATE substantiveIssuesFoundThisCycle TRUE) (LET ((proposalStatus (CALL_PROCEDURE ProposeDirectiveChanges stage2ReportHandle session_model_handle)))) (IF (IS_STATUS_FAILURE proposalStatus) (RETURN_STATUS proposalStatus))))) (RELEASE_HANDLE stage2ReportHandle)))) (IF (NOT substantiveIssuesFoundThisCycle)) (SEQ (LET ((stage3ReportHandle (CREATE_EMPTY_ARTIFACT \"system_qa_critique_redteam\")))) (LET ((stage3Result (SAFE_GENERATE_CONTENT stage3ReportHandle PROMPT_TEMPLATE_QA_RED_TEaming (MAP_CREATE (\"artifact_content_handle\" directives_handle) (\"session_conceptual_model_handle\" session_model_handle) (\"backlog_focus_ids\" selected_backlog_item_ids)) CONSTRAINT_SET_QA_CRITIQUE)))) (IF (OR (IS_STATUS_FAILURE (GET_STATUS stage3Result)) (EQ (GET_STATUS stage3Result) ALANG_STATUS_PAUSE_FOR_USER_INPUT))) (RETURN_STATUS (IF (IS_STATUS_FAILURE (GET_STATUS stage3Result)) (GET_STATUS stage3Result) ALANG_STATUS_PAUSE_FOR_USER_INPUT)))) (IF (CHECK_FOR_SUBSTANTIVE_ISSUES stage3ReportHandle) (SEQ (SET_STATE substantiveIssuesFoundThisCycle TRUE) (LET ((proposalStatus (CALL_PROCEDURE ProposeDirectiveChanges stage3ReportHandle session_model_handle)))) (IF (IS_STATUS_FAILURE proposalStatus) (RETURN_STATUS proposalStatus))))) (RELEASE_HANDLE stage3ReportHandle)))) (IF (NOT substantiveIssuesFoundThisCycle)) (SEQ (LET ((stage4ReportHandle (CREATE_EMPTY_ARTIFACT \"system_qa_critique_external\")))) (LET ((stage4Result (SAFE_GENERATE_CONTENT stage4ReportHandle PROMPT_TEMPLATE_QA_EXTERNAL_REVIEW (MAP_CREATE (\"artifact_content_handle\" directives_handle) (\"session_conceptual_model_handle\" session_model_handle) (\"backlog_focus_ids\" selected_backlog_item_ids)) CONSTRAINT_SET_QA_CRITIQUE)))) (IF (OR (IS_STATUS_FAILURE (GET_STATUS stage4Result)) (EQ (GET_STATUS stage4Result) ALANG_STATUS_PAUSE_FOR_USER_INPUT))) (RETURN_STATUS (IF (IS_STATUS_FAILURE (GET_STATUS stage4Result)) (GET_STATUS stage4Result) ALANG_STATUS_PAUSE_FOR_USER_INPUT)))) (IF (CHECK_FOR_SUBSTANTIVE_ISSUES stage4ReportHandle) (SEQ (SET_STATE substantiveIssuesFoundThisCycle TRUE) (LET ((proposalStatus (CALL_PROCEDURE ProposeDirectiveChanges stage4ReportHandle session_model_handle)))) (IF (IS_STATUS_FAILURE proposalStatus) (RETURN_STATUS proposalStatus))))) (RELEASE_HANDLE stage4ReportHandle)))))) (IF (AND substantiveIssuesFoundThisCycle (EQ qaIterationCount maxQaIterations)) (RETURN_STATUS ALANG_STATUS_FAILURE_QA_MAX_ITERATIONS) (RETURN_STATUS ALANG_STATUS_SUCCESS))))\n(DEFINE_PROCEDURE ProposeDirectiveChanges (qa_report_handle session_model_handle) (LET ((qaReportResult (READ_CONTENT qa_report_handle \"text_summary_or_full\" NIL))) (LET ((sessionModelResult (READ_CONTENT session_model_handle \"structured_map\" NIL))) (IF (AND (EQ (GET_STATUS qaReportResult) ALANG_STATUS_SUCCESS) (EQ (GET_STATUS sessionModelResult) ALANG_STATUS_SUCCESS)) (LET ((qaReport (GET_DATA qaReportResult))) (LET ((sessionModel (GET_DATA sessionModelResult))) (LET ((changesResult (INVOKE_CORE_LLM_GENERATION (MAP_CREATE (\"template\" PROMPT_TEMPLATE_ANALYZE_QA_FOR_DIRECTIVE_CHANGES) (\"qa_report\" qaReport) (\"session_model\" sessionModel) (\"current_directives_handle\" (GET_ALANG_CORE_DIRECTIVES_HANDLE)))) (GET_LLM_PARAMS_FOR_TASK \"directive_change_proposal\")))) (IF (EQ (GET_STATUS changesResult) ALANG_STATUS_SUCCESS) (LET ((changesData (GET_DATA changesResult))) (IF (EQ (VALIDATE_DATA changesData CONSTRAINT_SET_PROPOSED_CHANGES_STRUCTURE) ALANG_STATUS_SUCCESS) (LET ((changesHandle (CREATE_EMPTY_ARTIFACT \"proposed_changes\")))) (LET ((writeStatus (WRITE_CONTENT_TO_ARTIFACT changesHandle changesData \"application/json\")))) (IF (EQ writeStatus ALANG_STATUS_SUCCESS) (SEQ (SET_STATE sys.proposed_changes_handle changesHandle) (RETURN_STATUS ALANG_STATUS_SUCCESS)) (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL))) (RETURN_STATUS ALANG_STATUS_FAILURE_VALIDATION_ERROR))) (RETURN_STATUS ALANG_STATUS_FAILURE_LLM_ERROR)))) (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL))))))\n(DEFINE_PROCEDURE ExecuteSystemQAAndEvolutionCycle () (LET ((currentStatus (GET_STATE sys.system_qa_status))) (LET ((qaContext (GET_STATE session.system_qa_context))) (IF (OR (EQ currentStatus \"IDLE\") (EQ currentStatus \"NEW\")) (SEQ (SET_STATE sys.system_qa_status \"SELECTING_BACKLOG_FOCUS\") (SET_STATE session.system_qa_context (MAP_CREATE (\"step\" \"SELECTING_BACKLOG_FOCUS\"))) (CALL_PROCEDURE ExecuteSystemQAAndEvolutionCycle)))) (SETQ currentStatus (GET_STATE sys.system_qa_status)) (SETQ qaContext (GET_STATE session.system_qa_context)) (IF (EQ currentStatus \"SELECTING_BACKLOG_FOCUS\") (LET ((aiFocusResult (CALL_PROCEDURE SelectAIProposedBacklogItems (GET_STATE sys.evolution_backlog_handle) (GET_STATE session.conceptual_model_handle)))))\\ (IF (EQ (GET_STATUS aiFocusResult) ALANG_STATUS_SUCCESS) (SEQ (SET_STATE session.system_qa_context (MAP_SET_VALUE qaContext \"ai_proposed_focus\" (GET_DATA aiFocusResult)))) (SET_STATE sys.system_qa_status \"AWAITING_FOCUS_APPROVAL\")\\ (SET_STATE session.pending_user_action \"AWAIT_AI_PROPOSED_FOCUS_APPROVAL\")\\ (RETURN_STATUS ALANG_STATUS_PAUSE_FOR_USER_INPUT))\\ (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL)))) (IF (EQ currentStatus \"AWAITING_FOCUS_APPROVAL\") (LET ((userApproved (MAP_GET_VALUE qaContext \"ai_focus_approved\" NIL)))\\ (IF (IS_NIL userApproved)\\ (RETURN_STATUS ALANG_STATUS_PAUSE_FOR_USER_INPUT))\\ (IF userApproved\\ (SEQ\\ (SET_STATE sys.system_qa_status \"PERFORMING_QA\")\\ (CALL_PROCEDURE ExecuteSystemQAAndEvolutionCycle))\\ (SEQ\\ (SET_STATE sys.system_qa_status \"AWAITING_USER_PRIORITY\")\\ (SET_STATE session.pending_user_action \"AWAIT_BACKLOG_PRIORITY_SELECTION\")\\ (RETURN_STATUS ALANG_STATUS_PAUSE_FOR_USER_INPUT)))))) (IF (EQ currentStatus \"AWAITING_USER_PRIORITY\") (LET ((userInput (MAP_GET_VALUE qaContext \"user_backlog_selection_input\" NIL)))\\ (IF (IS_NIL userInput)\\ (RETURN_STATUS ALANG_STATUS_PAUSE_FOR_USER_INPUT))\\ (LET ((selectedItems (STRING_SPLIT (STRING_TRIM userInput) \",\"))))\\ (IF (LIST_IS_EMPTY selectedItems)\\ (SEQ\\ (SET_STATE sys.system_qa_status \"IDLE\")\\ (SET_STATE session.system_qa_context NIL)\\ (RETURN_STATUS ALANG_STATUS_SUCCESS))\\ (SEQ\\ (SET_STATE session.system_qa_context (MAP_SET_VALUE qaContext \"user_selected_focus_ids\" selectedItems))\\ (SET_STATE sys.system_qa_status \"PERFORMING_QA\")\\ (CALL_PROCEDURE ExecuteSystemQAAndEvolutionCycle)))))) (SETQ currentStatus (GET_STATE sys.system_qa_status)) (SETQ qaContext (GET_STATE session.system_qa_context)) (IF (EQ currentStatus \"PERFORMING_QA\") (LET ((selectedItems (OR (MAP_GET_VALUE (MAP_GET_VALUE qaContext \"ai_proposed_focus\") \"item_ids\") (MAP_GET_VALUE qaContext \"user_selected_focus_ids\"))))\\ (LET ((qaResult (PerformSystemQA (GET_ALANG_CORE_DIRECTIVES_HANDLE) (GET_STATE sys.evolution_backlog_handle) (GET_STATE session.conceptual_model_handle) selectedItems))))\\ (IF (EQ qaResult ALANG_STATUS_SUCCESS)\\ (SEQ\\ (SET_STATE sys.system_qa_status \"PROPOSING_VERSION\")\\ (CALL_PROCEDURE ExecuteSystemQAAndEvolutionCycle))\\ (IF (EQ qaResult ALANG_STATUS_PAUSE_FOR_USER_INPUT)\\ (RETURN_STATUS ALANG_STATUS_PAUSE_FOR_USER_INPUT)\\ (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL)))))) (SETQ currentStatus (GET_STATE sys.system_qa_status)) (SETQ qaContext (GET_STATE session.system_qa_context)) (IF (EQ currentStatus \"PROPOSING_VERSION\") (LET ((changesSummary \"Summary of changes.\")))\\ (LET ((versionResult (PROPOSE_CORE_LOGIC_VERSION_INCREMENT (GET_CORE_LOGIC_VERSION) changesSummary)))\\ (IF (EQ (GET_STATUS versionResult) ALANG_STATUS_SUCCESS)\\ (SEQ\\ (SET_STATE session.system_qa_context (MAP_SET_VALUE qaContext \"proposed_version_data\" (GET_DATA versionResult))))\\ (SET_STATE sys.system_qa_status \"AWAITING_VERSION_APPROVAL\")\\ (SET_STATE session.pending_user_action \"AWAIT_VERSION_APPROVAL\")\\ (RETURN_STATUS ALANG_STATUS_PAUSE_FOR_USER_INPUT))\\ (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL)))))) (IF (EQ currentStatus \"AWAITING_VERSION_APPROVAL\") (LET ((userApproved (MAP_GET_VALUE qaContext \"version_approved\" NIL)))\\ (IF (IS_NIL userApproved)\\ (RETURN_STATUS ALANG_STATUS_PAUSE_FOR_USER_INPUT))\\ (IF userApproved\\ (SEQ\\ (SET_STATE sys.system_qa_status \"FINALIZING\")\\ (CALL_PROCEDURE ExecuteSystemQAAndEvolutionCycle))\\ (SEQ\\ (CLEAR_PENDING_CORE_LOGIC_CHANGES)\\ (SET_STATE sys.system_qa_status \"IDLE\")\\ (SET_STATE session.system_qa_context NIL)\\ (RETURN_STATUS ALANG_STATUS_SUCCESS)))))) (SETQ currentStatus (GET_STATE sys.system_qa_status)) (SETQ qaContext (GET_STATE session.system_qa_context)) (IF (EQ currentStatus \"FINALIZING\") (SEQ\\ (LET ((finalChangesHandle (GET_PROPOSED_CORE_LOGIC_CHANGES_HANDLE)))\\ (IF (IS_HANDLE_VALID finalChangesHandle)\\ (LET ((applyStatus (APPLY_CORE_LOGIC_CHANGES finalChangesHandle)))\\ (IF (NEQ applyStatus ALANG_STATUS_SUCCESS)\\ (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL))))))\\ (LET ((selectedItems (OR (MAP_GET_VALUE (MAP_GET_VALUE qaContext \"ai_proposed_focus\") \"item_ids\") (MAP_GET_VALUE qaContext \"user_selected_focus_ids\"))))\\ (CALL_PROCEDURE UpdateBacklogAfterQA selectedItems))\\ (LET ((phiAnalysisResult (AnalyzeConceptualModelForΦ (GET_STATE session.conceptual_model_handle) (MAP_CREATE (\"focus\" \"system_evolution\")))))\\ (IF (EQ (GET_STATUS phiAnalysisResult) ALANG_STATUS_SUCCESS)\\ (LOG_EVENT \"CONCEPTUAL_ANALYSIS\" \"Φ analysis complete.\" (GET_DATA phiAnalysisResult))))\\ (SET_STATE sys.system_qa_status \"IDLE\")\\ (SET_STATE session.system_qa_context NIL)\\ (CLEAR_PENDING_CORE_LOGIC_CHANGES)\\ (RETURN_STATUS ALANG_STATUS_SUCCESS)))))))\n(DEFINE_PROCEDURE SelectAIProposedBacklogItems (backlog_handle session_model_handle) (LET ((backlogResult (READ_CONTENT backlog_handle \"text_summary_or_full\" NIL))) (LET ((sessionModelResult (READ_CONTENT session_model_handle \"structured_map\" NIL))) (IF (AND (EQ (GET_STATUS backlogResult) ALANG_STATUS_SUCCESS) (EQ (GET_STATUS sessionModelResult) ALANG_STATUS_SUCCESS)) (LET ((backlog (GET_DATA backlogResult))) (LET ((sessionModel (GET_DATA sessionModelResult))) (LET ((analysisResult (INVOKE_CORE_LLM_GENERATION (MAP_CREATE (\"template\" PROMPT_TEMPLATE_ANALYZE_BACKLOG_FOR_FOCUS) (\"backlog_content\" backlog) (\"session_model\" sessionModel)) (GET_LLM_PARAMS_FOR_TASK \"backlog_analysis\")))) (IF (EQ (GET_STATUS analysisResult) ALANG_STATUS_SUCCESS) (LET ((analysisData (GET_DATA analysisResult))) (IF (EQ (VALIDATE_DATA analysisData CONSTRAINT_SET_PROPOSED_CHANGES_STRUCTURE) ALANG_STATUS_SUCCESS) (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_SUCCESS) (\"data\" analysisData))) (RETURN_STATUS ALANG_STATUS_FAILURE_VALIDATION_ERROR))) (RETURN_STATUS ALANG_STATUS_FAILURE_LLM_ERROR)))) (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL)))))))\n(DEFINE_PROCEDURE UpdateBacklogAfterQA (item_ids) (SEQ (LOOP_FOR_EACH itemId item_ids (UPDATE_EVOLUTION_BACKLOG_ITEM itemId NIL NIL NIL \"ADDRESSED\" (STRING_CONCAT \"Addressed in v\" (GET_CORE_LOGIC_VERSION)) NIL))) (RETURN_STATUS ALANG_STATUS_SUCCESS)))\n\n;; --- Section 6: Content Generation & Pattern Modeling Procedures ---\n\n(DEFINE_PROCEDURE SAFE_GENERATE_CONTENT (target_artifact_handle prompt_template_handle prompt_context_map constraints_handle) (LET ((sessionModelHandle (MAP_GET_VALUE prompt_context_map \"session_conceptual_model_handle\")))\\ (LET ((patternsResult (CALL_PROCEDURE IdentifyPatternsInContext prompt_context_map sessionModelHandle)))\\ (IF (IS_STATUS_FAILURE (GET_STATUS patternsResult))\\ (RETURN_STATUS ALANG_STATUS_FAILURE_LLM_ERROR)\\ )\\ (LET ((patterns (GET_DATA patternsResult)))\\ (LET ((enhancedPromptResult (CALL_PROCEDURE EnhancePromptWithPatterns prompt_template_handle prompt_context_map patterns sessionModelHandle)))\\ (IF (IS_STATUS_FAILURE (GET_STATUS enhancedPromptResult))\\ (RETURN_STATUS ALANG_STATUS_FAILURE_LLM_ERROR)\\ )\\ (LET ((enhancedPrompt (GET_DATA enhancedPromptResult)))\\ (LET ((genResult (INVOKE_CORE_LLM_GENERATION\\ (MAP_CREATE (\"prompt_text\" enhancedPrompt)) (GET_LLM_PARAMS_FOR_TASK \"general_generation\"))))\\ (IF (IS_STATUS_FAILURE (GET_STATUS genResult))\\ (RETURN_STATUS ALANG_STATUS_FAILURE_LLM_ERROR)\\ )\\ (LET ((generatedText (GET_DATA genResult)))\\ (WRITE_CONTENT_TO_ARTIFACT target_artifact_handle generatedText \"text/markdown\")\\ (LET ((qaResult (INVOKE_CORE_LLM_GENERATION\\ (MAP_CREATE (\"template\" PROMPT_TEMPLATE_META_COGNITIVE_QA)\\ (\"generated_text\" generatedText)\\ (\"prompt_context\" prompt_context_map)\\ (\"identified_patterns\" patterns)\\ (\"session_model_handle\" sessionModelHandle)) (GET_LLM_PARAMS_FOR_TASK \"meta_cognitive_qa\"))))\\ (IF (IS_STATUS_FAILURE (GET_STATUS qaResult))\\ (RETURN_STATUS ALANG_STATUS_FAILURE_QA_ERROR)\\ )\\ (LET ((qaAssessment (GET_DATA qaResult)))\\ (LET ((handlingStatus (HandleQAIssues generatedText qaAssessment target_artifact_handle constraints_handle sessionModelHandle)))\\ (RETURN_STATUS handlingStatus)\\ ))))))))))\n(DEFINE_PROCEDURE IdentifyPatternsInContext (context_map session_model_handle) (LET ((analysisResult (INVOKE_CORE_LLM_GENERATION (MAP_CREATE (\"template\" PROMPT_TEMPLATE_ANALYZE_DATA_FOR_PATTERNS) (\"context\" context_map) (\"session_model_handle\" session_model_handle) (\"pka_handle\" (GET_STATE sys.knowledge_base_handle))) (GET_LLM_PARAMS_FOR_TASK \"pattern_identification\")))) (IF (EQ (GET_STATUS analysisResult) ALANG_STATUS_SUCCESS) (LET ((patternsData (GET_DATA analysisResult)))\\ (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_SUCCESS) (\"data\" patternsData)))\\ (RETURN_STATUS ALANG_STATUS_FAILURE_VALIDATION_ERROR))\\ (RETURN_STATUS ALANG_STATUS_FAILURE_LLM_ERROR))))\n(DEFINE_PROCEDURE EnhancePromptWithPatterns (prompt_template_handle context_map identified_patterns session_model_handle) (LET ((basePromptResult (READ_CONTENT prompt_template_handle \"text\" NIL)))\\ (LET ((sessionModelResult (READ_CONTENT session_model_handle \"structured_map\" NIL))))\\ (IF (AND (EQ (GET_STATUS basePromptResult) ALANG_STATUS_SUCCESS)\\ (EQ (GET_STATUS sessionModelResult) ALANG_STATUS_SUCCESS))\\ (LET ((basePrompt (GET_DATA basePromptResult)))\\ (LET ((sessionModel (GET_DATA sessionModelResult)))\\ (LET ((enhancedPromptResult (INVOKE_CORE_LLM_GENERATION\\ (MAP_CREATE (\"template\" PROMPT_TEMPLATE_ENHANCE_PROMPT)\\ (\"base_prompt\" basePrompt)\\ (\"context\" context_map)\\ (\"patterns\" identified_patterns)\\ (\"session_model\" sessionModel))\\ (GET_LLM_PARAMS_FOR_TASK \"prompt_enhancement\"))))\\ (RETURN_STATUS enhancedPromptResult))))\\ (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL)))))))\n(DEFINE_PROCEDURE ParseUserCommand (raw_text session_model_handle) (LET ((parseResult (INVOKE_CORE_LLM_GENERATION (MAP_CREATE (\"template\" PROMPT_TEMPLATE_PARSE_COMMAND) (\"user_text\" raw_text) (\"session_model_handle\" session_model_handle)) (GET_LLM_PARAMS_FOR_TASK \"command_parsing\"))))\\ (IF (EQ (GET_STATUS parseResult) ALANG_STATUS_SUCCESS)\\ (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_SUCCESS) (\"data\" (GET_DATA parseResult))))\\ (RETURN_STATUS ALANG_STATUS_FAILURE_LLM_ERROR))))\n(DEFINE_PROCEDURE ParseToolErrorResolutionInput (raw_input tool_id error_details context session_model_handle) (LET ((sessionModelResult (READ_CONTENT session_model_handle \"structured_map\" NIL)))) (IF (EQ (GET_STATUS sessionModelResult) ALANG_STATUS_SUCCESS) (LET ((sessionModel (GET_DATA sessionModelResult)))) (LET ((parseResult (INVOKE_CORE_LLM_GENERATION (MAP_CREATE (\"template\" PROMPT_TEMPLATE_ANALYZE_TOOL_ERROR_RESOLUTION_INPUT) (\"raw_input\" raw_input) (\"tool_id\" tool_id) (\"error_details\" error_details) (\"original_context\" context) (\"session_model\" sessionModel)) (GET_LLM_PARAMS_FOR_TASK \"tool_input_parsing\")))) (IF (EQ (GET_STATUS parseResult) ALANG_STATUS_SUCCESS) (LET ((parsedData (GET_DATA parseResult)))) (IF (EQ (VALIDATE_DATA parsedData CONSTRAINT_SET_TOOL_ERROR_RESOLUTION_INPUT_STRUCTURE) ALANG_STATUS_SUCCESS) (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_SUCCESS) (\"data\" parsedData))) (RETURN_STATUS ALANG_STATUS_FAILURE_VALIDATION_ERROR))) (RETURN_STATUS ALANG_STATUS_FAILURE_LLM_ERROR)))) (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL))))))\n(DEFINE_PROCEDURE ProcessAndStoreEvolveSuggestion (suggestionText source) (LET ((similarItem (FIND_SIMILAR_BACKLOG_ITEM suggestionText))) (IF (IS_NIL similarItem) (LET ((newItemId (GENERATE_UNIQUE_ID \"EBL\")))) (CREATE_EVOLUTION_BACKLOG_ITEM newItemId (STRING_CONCAT \"Suggestion: \" (SUBSTRING suggestionText 0 50) \"...\") suggestionText source \"NEW\" (GET_ORCHESTRATOR_TIMESTAMP)) (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_SUCCESS) (\"data\" newItemId)))) (UPDATE_EVOLUTION_BACKLOG_ITEM (MAP_GET_VALUE similarItem \"id\") NIL NIL NIL NIL (STRING_CONCAT \"Reinforced by \" source) TRUE) (RETURN_STATUS (MAP_CREATE (\"status\" ALANG_STATUS_SUCCESS) (\"data\" (MAP_GET_VALUE similarItem \"id\")))))))\n(DEFINE_PROCEDURE CreateAndStorePKAIfUserConsents (content schema_id rationale session_model_handle) (LET ((draftHandle (PKA_CREATE_DRAFT content schema_id (MAP_CREATE (\"rationale\" rationale) (\"source\" \"user_promotion\")))))\\ (IF (IS_HANDLE_VALID draftHandle)\\ (SEQ\\ (LET ((consentPromptText (GET_TEXT_FOR_PKA_CONSENT_PROMPT rationale session_model_handle)))\\ (LET ((consentResult (PKA_REQUEST_USER_CONSENT_TO_STORE draftHandle consentPromptText)))\\ (IF (EQ consentResult \"USER_CONSENT_GRANTED\")\\ (LET ((storeResult (PKA_STORE_APPROVED_DRAFT draftHandle \"USER_CONSENT_GRANTED\")))\\ (IF (EQ (GET_STATUS storeResult) ALANG_STATUS_SUCCESS)\\ (LET ((pkaId (GET_DATA storeResult)))\\ (CALL_PROCEDURE IntegratePkaIntoConceptualModel pkaId session_model_handle)\\ (RETURN_STATUS ALANG_STATUS_SUCCESS))\\ (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL))\\ ))\\ (RETURN_STATUS ALANG_STATUS_SUCCESS)\\ )))\\ (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL)\\ ))\\ (RETURN_STATUS ALANG_STATUS_FAILURE_GENERAL)\\ ))\n\n;; --- Section 7: ALANG Status Codes ---\n\n(DEFINE_PRIMITIVE ALANG_STATUS_FAILURE_VALIDATION_ERROR ())\n(DEFINE_PRIMITIVE ALANG_STATUS_FAILURE_QA_ERROR ())\n(DEFINE_PRIMITIVE ALANG_STATUS_FAILURE_QA_MAX_ITERATIONS ())\n(DEFINE_PRIMITIVE ALANG_STATUS_FAILURE_REVISION_ERROR ())\n(DEFINE_PRIMITIVE ALANG_STATUS_FAILURE_CONCEPTUAL_MODEL_ERROR ())\n(DEFINE_PRIMITIVE ALANG_STATUS_SYSTEM_QA_SELECTING_BACKLOG_FOCUS ())\n(DEFINE_PRIMITIVE ALANG_STATUS_SYSTEM_QA_AWAITING_FOCUS_APPROVAL ())\n(DEFINE_PRIMITIVE ALANG_STATUS_SYSTEM_QA_AWAITING_USER_PRIORITY ())\n(DEFINE_PRIMITIVE ALANG_STATUS_SYSTEM_QA_PERFORMING_QA ())\n(DEFINE_PRIMITIVE ALANG_STATUS_SYSTEM_QA_PROPOSING_VERSION ())\n(DEFINE_PRIMITIVE ALANG_STATUS_SYSTEM_QA_AWAITING_VERSION_APPROVAL ())\n(DEFINE_PRIMITIVE ALANG_STATUS_SYSTEM_QA_FINALIZING ())\n(DEFINE_PRIMITIVE ALANG_STATUS_SYSTEM_QA_FAILED_APPLY_CHANGES ())\n\nCONVERGED:\n;; --- Section 8: End of Core Logic ---\n```\n--- END OF FILE Autologos_Core_Logic_v1.12.alang ---\n```",
    "linesAdded": 86,
    "linesRemoved": 90
  }
]